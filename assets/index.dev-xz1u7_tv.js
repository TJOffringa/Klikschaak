(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=n(i);fetch(i.href,r)}})();const Sn={nl:{title:"Klikschaak",subtitle:"Combineer stukken voor strategische dominantie",newGame:"Nieuw Spel",whiteToMove:"Wit aan zet",blackToMove:"Zwart aan zet",moves:"Zetten",noMoves:"Nog geen zetten",gameRules:"Spelregels",klik:"Klikken:",unklik:"Ontklikken:",kingWarning:"Koning mag NOOIT klikken!",promotionTip:"Promotie: alleen met een pionzet!",autoPromote:"Automatisch promoveren tot dame",selected:"Geselecteerd",possibleMoves:"mogelijke zetten",choosePromotion:"Kies een stuk voor promotie:",chooseCastling:"Kies rokade optie:",onlyRook:"Alleen toren",bothPieces:"Beide stukken",chooseMove:"Kies zet type:",enPassant:"En passant",normalMove:"Normale zet",pawnCaptures:"(pion slaat)",moves_:"beweegt",checkmate:"Schaakmat!",stalemate:"Pat!",check:"SCHAAK!",wins:"wint!",draw:"Remise",gameEndsDraw:"Het spel eindigt in remise"},en:{title:"Clickchess",subtitle:"Combine pieces for strategic dominance",newGame:"New Game",whiteToMove:"White to move",blackToMove:"Black to move",moves:"Moves",noMoves:"No moves yet",gameRules:"Game Rules",klik:"Click:",unklik:"Unclick:",kingWarning:"King may NEVER click!",promotionTip:"Promotion: only with a pawn move!",autoPromote:"Auto-promote to queen",selected:"Selected",possibleMoves:"possible moves",choosePromotion:"Choose a piece for promotion:",chooseCastling:"Choose castling option:",onlyRook:"Only rook",bothPieces:"Both pieces",chooseMove:"Choose move type:",enPassant:"En passant",normalMove:"Normal move",pawnCaptures:"(pawn captures)",moves_:"moves",checkmate:"Checkmate!",stalemate:"Stalemate!",check:"CHECK!",wins:"wins!",draw:"Draw",gameEndsDraw:"The game ends in a draw"}};let ie="nl";function Cn(t){ie=t,localStorage.setItem("klikschaak-language",t)}function X(){return ie}function Tn(){const t=localStorage.getItem("klikschaak-language");t&&(t==="nl"||t==="en")?ie=t:ie=navigator.language.slice(0,2)==="nl"?"nl":"en"}function C(t){return Sn[ie][t]}function Le(t){const e={nl:{K:"Koning",Q:"Dame",R:"Toren",B:"Loper",N:"Paard",P:"Pion",k:"koning",q:"dame",r:"toren",b:"loper",n:"paard",p:"pion"},en:{K:"King",Q:"Queen",R:"Rook",B:"Bishop",N:"Knight",P:"Pawn",k:"king",q:"queen",r:"rook",b:"bishop",n:"knight",p:"pawn"}},n=t.charAt(0);return e[ie][n]||t}const N={K:"â™”",Q:"â™•",R:"â™–",B:"â™—",N:"â™˜",P:"â™™",k:"â™š",q:"â™›",r:"â™œ",b:"â™",n:"â™ž",p:"â™Ÿ",P0:"â™™",P1:"â™™",P2:"â™™",P3:"â™™",P4:"â™™",P5:"â™™",P6:"â™™",P7:"â™™",p0:"â™Ÿ",p1:"â™Ÿ",p2:"â™Ÿ",p3:"â™Ÿ",p4:"â™Ÿ",p5:"â™Ÿ",p6:"â™Ÿ",p7:"â™Ÿ"},xn={q:5,r:4,b:3,n:2,p:1,k:6},Pn=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]],Bn=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]],On=[[-1,-1],[-1,1],[1,-1],[1,1]],Ln=[[-1,0],[1,0],[0,-1],[0,1]],Nn="abcdefgh",qn="87654321";function v(t){return t===t.toUpperCase()}function $(t){return t.charAt(0).toLowerCase()==="p"}function O(t){return t.charAt(0).toLowerCase()}function Ct(t){return xn[O(t)]||0}function ve(t,e){return Nn[e]+qn[t]}function Fe(t){return t.map(e=>N[e]).join("")}let g=Ht();function Ht(){return{board:An(),currentTurn:"white",selectedSquare:null,selectedUnklikPiece:null,validMoves:[],moveHistory:[],castlingRights:{white:{kingSide:!0,queenSide:!0},black:{kingSide:!0,queenSide:!0}},enPassantTarget:null,movedPawns:new Set,autoPromoteToQueen:!1,pendingPromotion:null,gameOver:!1}}function An(){return Array(8).fill(null).map(()=>Array(8).fill(null).map(()=>({pieces:[]})))}function Gt(){g=Ht(),g.board[7][0].pieces=["R"],g.board[7][1].pieces=["N"],g.board[7][2].pieces=["B"],g.board[7][3].pieces=["Q"],g.board[7][4].pieces=["K"],g.board[7][5].pieces=["B"],g.board[7][6].pieces=["N"],g.board[7][7].pieces=["R"];for(let t=0;t<8;t++)g.board[6][t].pieces=[`P${t}`];g.board[0][0].pieces=["r"],g.board[0][1].pieces=["n"],g.board[0][2].pieces=["b"],g.board[0][3].pieces=["q"],g.board[0][4].pieces=["k"],g.board[0][5].pieces=["b"],g.board[0][6].pieces=["n"],g.board[0][7].pieces=["r"];for(let t=0;t<8;t++)g.board[1][t].pieces=[`p${t}`]}function M(){return g.board}function A(){return g.currentTurn}function lt(){return g.selectedSquare}function Ye(){return g.selectedUnklikPiece}function ye(){return g.validMoves}function je(){return g.moveHistory}function Z(){return g.castlingRights}function ee(){return g.enPassantTarget}function te(){return g.movedPawns}function be(){return g.autoPromoteToQueen}function Ft(){return g.pendingPromotion}function $e(){return g.gameOver}function de(t){g.selectedSquare=t}function Se(t){g.selectedUnklikPiece=t}function se(t){g.validMoves=t}function Je(t){g.enPassantTarget=t}function Mn(t){g.autoPromoteToQueen=t}function fe(t){g.pendingPromotion=t}function In(t){g.gameOver=t}function De(){g.currentTurn=g.currentTurn==="white"?"black":"white"}function Re(t){g.moveHistory.push(t)}function Kt(t){g.movedPawns.add(t)}function ae(t,e,n,s,i){n===7&&s===0&&i.includes("R")&&(g.castlingRights.white.queenSide=!1),n===7&&s===7&&i.includes("R")&&(g.castlingRights.white.kingSide=!1),n===0&&s===0&&i.includes("r")&&(g.castlingRights.black.queenSide=!1),n===0&&s===7&&i.includes("r")&&(g.castlingRights.black.kingSide=!1),i.includes("R")&&t===7&&e===0&&(g.castlingRights.white.queenSide=!1),i.includes("R")&&t===7&&e===7&&(g.castlingRights.white.kingSide=!1),i.includes("r")&&t===0&&e===0&&(g.castlingRights.black.queenSide=!1),i.includes("r")&&t===0&&e===7&&(g.castlingRights.black.kingSide=!1)}function Xe(t){t==="white"?g.castlingRights.white={kingSide:!1,queenSide:!1}:g.castlingRights.black={kingSide:!1,queenSide:!1}}function J(){g.selectedSquare=null,g.selectedUnklikPiece=null,g.validMoves=[]}function S(t,e,n){g.board[t][e].pieces=n}function Qe(t,e){return g.board[t][e].pieces}function Ze(t,e,n,s){for(let i=0;i<8;i++)for(let r=0;r<8;r++){const o=t[i][r].pieces;if(o.length!==0&&v(o[0])!==s){for(const a of o)if($n(t,i,r,a,e,n))return!0}}return!1}function $n(t,e,n,s,i,r){const o=O(s),a=v(s);if(o==="p"){const c=a?-1:1;return Math.abs(n-r)===1&&e+c===i}if(o==="n"){const c=Math.abs(e-i),l=Math.abs(n-r);return c===2&&l===1||c===1&&l===2}if(o==="k")return Math.abs(e-i)<=1&&Math.abs(n-r)<=1;if((o==="b"||o==="q")&&Math.abs(e-i)===Math.abs(n-r)){const c=i>e?1:-1,l=r>n?1:-1;let u=e+c,p=n+l;for(;u!==i||p!==r;){if(t[u][p].pieces.length>0)return!1;u+=c,p+=l}return!0}if((o==="r"||o==="q")&&(e===i||n===r)){const c=e===i?0:i>e?1:-1,l=n===r?0:r>n?1:-1;let u=e+c,p=n+l;for(;u!==i||p!==r;){if(t[u][p].pieces.length>0)return!1;u+=c,p+=l}return!0}return!1}function Ne(t,e,n,s,i,r,o){const a=[],c=v(s),l=O(s);if(l==="p"){const u=c?-1:1,p=c?6:1;e+u>=0&&e+u<8&&t[e+u][n].pieces.length===0&&(a.push([e+u,n]),e===p&&!o.has(s)&&t[e+2*u][n].pieces.length===0&&a.push([e+2*u,n]));for(const h of[-1,1]){const d=n+h;if(d>=0&&d<8&&e+u>=0&&e+u<8){const f=t[e+u][d];f.pieces.length>0&&v(f.pieces[0])!==c&&a.push([e+u,d]),r&&r.row===e+u&&r.col===d&&a.push([e+u,d,"en-passant"])}}}if(l==="n")for(const[u,p]of Pn){const h=e+u,d=n+p;h>=0&&h<8&&d>=0&&d<8&&a.push([h,d])}if(l==="b"||l==="q")for(const[u,p]of On)for(let h=1;h<8;h++){const d=e+u*h,f=n+p*h;if(d<0||d>=8||f<0||f>=8||(a.push([d,f]),t[d][f].pieces.length>0))break}if(l==="r"||l==="q")for(const[u,p]of Ln)for(let h=1;h<8;h++){const d=e+u*h,f=n+p*h;if(d<0||d>=8||f<0||f>=8||(a.push([d,f]),t[d][f].pieces.length>0))break}if(l==="k"){for(const[h,d]of Bn){const f=e+h,k=n+d;if(f>=0&&f<8&&k>=0&&k<8){const m=t[f][k];(m.pieces.length===0||v(m.pieces[0])!==c)&&a.push([f,k])}}const u=c?i.white:i.black,p=c?7:0;if(u.kingSide){const h=t[p][7],d=t[p][5];t[p][6].pieces.length===0&&h.pieces.length>0&&h.pieces.some(k=>O(k)==="r")&&(d.pieces.length===0?h.pieces.length===1?a.push([p,6,"castle-k"]):h.pieces.length===2&&a.push([p,6,"castle-k-choice"]):d.pieces.length===1&&v(d.pieces[0])===c&&(h.pieces.length===1?a.push([p,6,"castle-k-klik"]):h.pieces.length===2&&a.push([p,6,"castle-k-unklik-klik"])))}if(u.queenSide){const h=t[p][0],d=t[p][3],f=t[p][2],k=t[p][1];f.pieces.length===0&&k.pieces.length===0&&h.pieces.length>0&&h.pieces.some(m=>O(m)==="r")&&(d.pieces.length===0?h.pieces.length===1?a.push([p,2,"castle-q"]):h.pieces.length===2&&a.push([p,2,"castle-q-choice"]):d.pieces.length===1&&v(d.pieces[0])===c&&(h.pieces.length===1?a.push([p,2,"castle-q-klik"]):h.pieces.length===2&&a.push([p,2,"castle-q-unklik-klik"])))}}return a}function ge(t,e,n,s,i,r,o,a){const c=t.map(h=>h.map(d=>({pieces:[...d.pieces]}))),l=v(r[0]);if(o==="en-passant"){const h=l?s+1:s-1;c[h][i].pieces=[],c[s][i].pieces=[...r],c[e][n].pieces=[]}else if(o==="en-passant-unklik"){const h=l?s+1:s-1;c[h][i].pieces=[];const d=r[a];c[s][i].pieces=[d],c[e][n].pieces=c[e][n].pieces.filter((f,k)=>k!==a)}else if(o==="unklik"||o==="unklik-klik"){const h=r[a];o==="unklik-klik"?c[s][i].pieces=[...c[s][i].pieces,h]:c[s][i].pieces=[h],c[e][n].pieces=c[e][n].pieces.filter((d,f)=>f!==a)}else if(o==="klik")c[s][i].pieces=[...c[s][i].pieces,...r],c[e][n].pieces=[];else if(o?.startsWith("castle-")){const h=o.startsWith("castle-k"),d=h?7:0,f=h?5:3;c[s][i].pieces=r,c[e][n].pieces=[];const k=[...c[e][d].pieces];if(c[e][d].pieces=[],o.includes("unklik-klik")){const E=k.find(y=>O(y)==="r"),T=[...c[e][f].pieces];c[e][f].pieces=[E,...T]}else if(o.includes("klik")&&!o.includes("unklik")){const E=[...c[e][f].pieces];c[e][f].pieces=[...k,...E]}else if(o.includes("both"))c[e][f].pieces=k;else if(k.length===2){const E=k.find(T=>O(T)==="r");c[e][f].pieces=[E]}else c[e][f].pieces=k;const m=h?n+1:n-1;for(const E of[n,m,i])if(Ze(c,e,E,l))return!0}else c[s][i].pieces=[...r],c[e][n].pieces=[];let u=-1,p=-1;for(let h=0;h<8;h++){for(let d=0;d<8;d++)if(c[h][d].pieces.includes(l?"K":"k")){u=h,p=d;break}if(u!==-1)break}return u===-1?!1:Ze(c,u,p,l)}function pe(t,e,n,s,i,r,o,a){const c=new Map,l=v(s[0]),u=s.length===1,p=s.some(d=>$(d));for(const d of s){const f=Ne(t,e,n,d,i,r,o);for(const k of f){const[m,E,T]=k,y=`${m},${E}`,P=t[m][E],B=$(d),q=l&&m===0||!l&&m===7;if(p&&s.length===2&&!B&&q||p&&(l&&m===7||!l&&m===0))continue;if(T==="en-passant"){const F=c.get(y);F&&F.type!=="en-passant"?c.set(y,{row:m,col:E,type:"en-passant-choice"}):c.set(y,{row:m,col:E,type:"en-passant"});continue}const I=c.get(y);if(I&&I.type==="en-passant"){c.set(y,{row:m,col:E,type:"en-passant-choice"});continue}if(!u)(P.pieces.length===0||v(P.pieces[0])!==l)&&c.set(y,{row:m,col:E,type:T||"normal"});else if(P.pieces.length>0&&v(P.pieces[0])===l){const F=$(d),K=F&&n===E,St=!P.pieces.some(Ge=>O(Ge)==="k")&&!s.some(Ge=>O(Ge)==="k");K&&P.pieces.length<2&&St?c.set(y,{row:m,col:E,type:"klik"}):!F&&P.pieces.length<2&&St&&c.set(y,{row:m,col:E,type:"klik"})}else(P.pieces.length===0||v(P.pieces[0])!==l)&&c.set(y,{row:m,col:E,type:T||"normal"})}}if(u){const d=s.find(f=>$(f));if(d){const f=l?-1:1,k=l?6:1;if(e+f>=0&&e+f<8){const m=t[e+f][n];if(m.pieces.length===1&&v(m.pieces[0])===l&&!m.pieces.some(E=>O(E)==="k")){const E=`${e+f},${n}`;c.set(E,{row:e+f,col:n,type:"klik"})}}if(e===k&&!o.has(d)&&e+2*f>=0&&e+2*f<8){const m=t[e+2*f][n];if(t[e+f][n].pieces.length===0&&m.pieces.length===1&&v(m.pieces[0])===l&&!m.pieces.some(T=>O(T)==="k")){const T=`${e+2*f},${n}`;c.set(T,{row:e+2*f,col:n,type:"klik"})}}}}let h=Array.from(c.values());return h=h.filter(d=>!ge(t,e,n,d.row,d.col,s,d.type,a)),h}function Dn(t,e){const n=e==="white";let s=-1,i=-1;for(let r=0;r<8;r++){for(let o=0;o<8;o++)if(t[r][o].pieces.includes(n?"K":"k")){s=r,i=o;break}if(s!==-1)break}return s===-1?!1:Ze(t,s,i,n)}function Rn(t,e,n,s,i){const r=e==="white";for(let o=0;o<8;o++)for(let a=0;a<8;a++){const c=t[o][a].pieces;if(c.length===0||v(c[0])!==r)continue;if(pe(t,o,a,c,n,s,i,null).length>0)return!0;if(c.length===2)for(let u=0;u<2;u++){const p=c[u],h=Ne(t,o,a,p,n,s,i);for(const d of h){const[f,k]=d,m=t[f][k];if(m.pieces.length===0||v(m.pieces[0])!==r){if(!ge(t,o,a,f,k,c,"unklik",u))return!0}else if(m.pieces.length<2&&v(m.pieces[0])===r&&!m.pieces.some(E=>O(E)==="k")&&!ge(t,o,a,f,k,c,"unklik-klik",u))return!0}}}return!1}window.handleSquareClick=qe;window.handleUnklikSelect=ei;window.initializeBoard=Et;window.toggleAutoPromote=ti;window.executePromotion=dn;window.executeCastling=Ae;window.movePiece=Me;window.switchLanguage=Un;function Un(){const t=X()==="nl"?"en":"nl";Cn(t),D(),R(),Hn()}function Hn(){const t=document.querySelector(".header h1");t&&(t.textContent=`ðŸ‘‘ ${C("title")}`);const e=document.querySelector(".header p");e&&(e.textContent=C("subtitle"));const n=document.querySelector(".new-game-btn");n&&(n.textContent=`ðŸ”„ ${C("newGame")}`);const s=document.querySelector(".panel h2");if(s){const l=document.getElementById("moveCount")?.textContent||"0";s.innerHTML=`ðŸ“‹ ${C("moves")} (<span id="moveCount">${l}</span>)`}const i=document.querySelector(".rules h2");i&&(i.textContent=`âš¡ ${C("gameRules")}`);const r=document.querySelectorAll(".rules p");r.length>=4&&(r[0].innerHTML=`<strong style="color: #c084fc;">${C("klik")}</strong> ${X()==="nl"?"Selecteer stuk, klik op veld met blauwe ring":"Select piece, click square with blue ring"}`,r[1].innerHTML=`<strong style="color: #60a5fa;">${C("unklik")}</strong> ${X()==="nl"?"Klik op driehoek met het stuk":"Click triangle with the piece"}`,r[2].innerHTML=`âš ï¸ ${C("kingWarning")}`,r[3].innerHTML=`ðŸ’¡ ${C("promotionTip")}`);const o=document.querySelector('label[for="autoPromote"]');o&&(o.textContent=C("autoPromote"));const a=document.querySelector("#selectedInfo h2");a&&(a.textContent=C("selected"));const c=document.getElementById("langBtn");c&&(c.textContent=X()==="nl"?"EN":"NL")}function Gn(t,e,n,s){if(t.length===0)return"";const i=k=>v(k)?"piece piece-white":"piece piece-black";if(t.length===1)return`<div class="${i(t[0])}">${N[t[0]]}</div>`;const r=[...t].sort((k,m)=>Ct(m)-Ct(k)),o=r[0],a=r[1],c=v(t[0]),l=Ye(),u=s&&l!==null&&t.indexOf(o)===l,p=s&&l!==null&&t.indexOf(a)===l,h=s&&l===null,d=A(),f=c&&d==="white"||!c&&d==="black";return`<div class="stacked-piece">
    <svg class="stacked-svg" viewBox="0 0 64 64">
      <line x1="32" y1="0" x2="0" y2="64" stroke="rgba(100,100,100,0.4)" stroke-width="2"/>
      <line x1="32" y1="0" x2="64" y2="64" stroke="rgba(100,100,100,0.4)" stroke-width="2"/>
    </svg>
    ${h?'<div class="whole-selected"></div>':""}
    <div class="stacked-center">
      <div class="stacked-top ${i(a)}">${N[a]}</div>
      <div class="stacked-bottom ${i(o)}">${N[o]}</div>
    </div>
    ${f?`
      <div class="triangle-left ${u?"selected":""}" onclick="handleUnklikSelect(${e},${n},${t.indexOf(o)},event)" title="${X()==="nl"?"Zet met":"Move with"} ${Le(o)}">
        <span class="triangle-symbol left ${i(o)}">${N[o]}</span>
      </div>
      <div class="triangle-right ${p?"selected":""}" onclick="handleUnklikSelect(${e},${n},${t.indexOf(a)},event)" title="${X()==="nl"?"Zet met":"Move with"} ${Le(a)}">
        <span class="triangle-symbol right ${i(a)}">${N[a]}</span>
      </div>
    `:""}
    ${!u&&!h?'<div class="triangle-bg-left"></div>':""}
    ${!p&&!h?'<div class="triangle-bg-right"></div>':""}
  </div>`}function D(){const t=document.getElementById("board");if(!t)return;const e=M(),n=lt(),s=ye();t.innerHTML="";for(let i=0;i<8;i++){const r=document.createElement("div");r.className="board-row";for(let o=0;o<8;o++){const a=document.createElement("div"),c=(i+o)%2===0;a.className=`square ${c?"light":"dark"}`,a.dataset.row=String(i),a.dataset.col=String(o),n&&n[0]===i&&n[1]===o&&a.classList.add("selected");const l=e[i][o].pieces,u=n&&n[0]===i&&n[1]===o;a.innerHTML=Gn(l,i,o,!!u);const p=s.find(h=>h.row===i&&h.col===o);if(p){const h=document.createElement("div");p.type==="klik"?h.className="valid-klik":p.type==="unklik-klik"?h.className="valid-unklik-klik":l.length>0?h.className="valid-capture":h.className="valid-move",a.appendChild(h)}a.onclick=h=>{const d=h.target;!d.classList.contains("triangle-left")&&!d.classList.contains("triangle-right")&&qe(i,o)},r.appendChild(a)}t.appendChild(r)}}function R(){const t=document.getElementById("turnIndicator");t&&(t.textContent=A()==="white"?C("whiteToMove"):C("blackToMove"),t.className=`turn-indicator ${A()==="white"?"turn-white":"turn-black"}`);const e=document.getElementById("moveCount");e&&(e.textContent=String(Math.ceil(je().length/2)));const n=document.getElementById("moveHistory"),s=je();if(n)if(s.length===0)n.innerHTML=`<p style="color:#94a3b8;text-align:center;padding:16px 0;">${C("noMoves")}</p>`;else{const i=[];for(let r=0;r<s.length;r+=2){const o=s[r],a=r+1<s.length?s[r+1]:null;i.push({moveNumber:Math.floor(r/2)+1,white:o,black:a})}n.innerHTML=i.slice(-10).reverse().map(r=>{const o=r.white?r.white.notation:"",a=r.black?r.black.notation:"";return`<div class="move-pair">
          <span class="move-number">${r.moveNumber}.</span>
          <span class="move-white">${o}</span>
          <span class="move-black">${a}</span>
        </div>`}).join("")}Fn()}function Fn(){const t=document.getElementById("selectedInfo");if(!t)return;const e=lt();if(e&&M()[e[0]][e[1]].pieces.length>0){t.classList.add("show");const n=M()[e[0]][e[1]].pieces,s=a=>v(a)?"selected-piece-icon piece piece-white":"selected-piece-icon piece piece-black",i=document.getElementById("selectedPieces");i&&(i.innerHTML=n.map(a=>`<div class="${s(a)}">${N[a]}</div>`).join(""));const r=document.getElementById("selectedNames");r&&(r.textContent=n.map(a=>Le(a)).join(" + "));const o=document.getElementById("selectedMoves");o&&(o.textContent=`${ye().length} ${C("possibleMoves")}`)}else t.classList.remove("show")}function Kn(){const t=document.getElementById("checkIndicator");t&&t.remove();const e=document.createElement("div");e.id="checkIndicator",e.className="check-indicator",e.textContent=C("check");const n=document.querySelector(".board-container");n&&(n.style.position="relative",n.appendChild(e)),setTimeout(()=>{const s=document.getElementById("checkIndicator");s&&s.remove()},3e3)}function Tt(t,e){const n=document.createElement("div");n.className="promotion-overlay",n.id="gameOverOverlay";const s=document.createElement("div");s.className="game-over-box";const i=document.createElement("div");i.className="game-over-title",i.textContent=C(t==="checkmate"?"checkmate":"stalemate"),s.appendChild(i);const r=document.createElement("div");if(r.className="game-over-message",t==="stalemate")r.textContent=C("gameEndsDraw");else{const a=e==="white"?X()==="nl"?"Wit":"White":X()==="nl"?"Zwart":"Black";r.textContent=`${a} ${C("wins")}`}s.appendChild(r);const o=document.createElement("button");o.className="game-over-btn",o.textContent=C("newGame"),o.onclick=()=>Et(),s.appendChild(o),n.appendChild(s),document.body.appendChild(n)}function Ke(){const t=Ft();if(!t)return;const e=document.createElement("div");e.className="promotion-overlay",e.id="promotionOverlay";const n=t.isWhite,s=n?["Q","R","B","N"]:["q","r","b","n"],i=document.createElement("div");i.className="promotion-box";const r=document.createElement("div");r.className="promotion-title",r.textContent=C("choosePromotion"),i.appendChild(r);const o=document.createElement("div");o.className="promotion-pieces",s.forEach(a=>{const c=document.createElement("div");c.className="promotion-choice";const l=document.createElement("div");l.className=`promotion-piece piece ${n?"piece-white":"piece-black"}`,l.textContent=N[a],c.appendChild(l),c.onclick=()=>dn(a),o.appendChild(c)}),i.appendChild(o),e.appendChild(i),document.body.appendChild(e)}function Vn(t,e,n,s,i){const r=document.createElement("div");r.className="promotion-overlay",r.id="castlingChoiceOverlay";const a=i.includes("k")?7:0,l=M()[t][a].pieces,u=l.find(I=>O(I)==="r"),p=l.find(I=>O(I)!=="r"),h=v(u),d=document.createElement("div");d.className="promotion-box";const f=document.createElement("div");f.className="promotion-title",f.textContent=C("chooseCastling"),d.appendChild(f);const k=document.createElement("div");k.className="promotion-pieces",k.style.gap="20px";const m=document.createElement("div");m.className="promotion-choice",m.style.cssText="width:120px;height:100px;flex-direction:column;display:flex;justify-content:center;align-items:center;";const E=document.createElement("div");E.className=`promotion-piece piece ${h?"piece-white":"piece-black"}`,E.textContent=N[u],E.style.fontSize="48px",m.appendChild(E);const T=document.createElement("div");T.textContent=C("onlyRook"),T.style.cssText="font-size:12px;margin-top:5px;color:white;",m.appendChild(T),m.onclick=()=>{document.getElementById("castlingChoiceOverlay")?.remove(),Ae(t,e,n,s,i.replace("-choice",""))},k.appendChild(m);const y=document.createElement("div");y.className="promotion-choice",y.style.cssText="width:120px;height:100px;flex-direction:column;display:flex;justify-content:center;align-items:center;";const P=document.createElement("div");P.style.cssText="display:flex;gap:5px;";const B=document.createElement("div");B.className=`piece ${h?"piece-white":"piece-black"}`,B.textContent=N[u],B.style.fontSize="36px";const q=document.createElement("div");q.className=`piece ${h?"piece-white":"piece-black"}`,q.textContent=N[p],q.style.fontSize="36px",P.appendChild(B),P.appendChild(q),y.appendChild(P);const x=document.createElement("div");x.textContent=C("bothPieces"),x.style.cssText="font-size:12px;margin-top:5px;color:white;",y.appendChild(x),y.onclick=()=>{document.getElementById("castlingChoiceOverlay")?.remove(),Ae(t,e,n,s,i.replace("-choice","-both"))},k.appendChild(y),d.appendChild(k),r.appendChild(d),document.body.appendChild(r)}function Wn(t,e,n,s){const i=document.createElement("div");i.className="promotion-overlay",i.id="enPassantChoiceOverlay";const o=M()[t][e].pieces,a=v(o[0]),c=o.find(x=>O(x)==="p"),l=o.find(x=>O(x)!=="p"),u=document.createElement("div");u.className="promotion-box";const p=document.createElement("div");p.className="promotion-title",p.textContent=C("chooseMove"),u.appendChild(p);const h=document.createElement("div");h.className="promotion-pieces",h.style.gap="20px";const d=document.createElement("div");d.className="promotion-choice",d.style.cssText="width:140px;height:110px;flex-direction:column;display:flex;justify-content:center;align-items:center;";const f=document.createElement("div");f.style.cssText="display:flex;gap:5px;";const k=document.createElement("div");k.className=`piece ${a?"piece-white":"piece-black"}`,k.textContent=N[c],k.style.fontSize="48px",f.appendChild(k),d.appendChild(f);const m=document.createElement("div");m.textContent=C("enPassant"),m.style.cssText="font-size:12px;margin-top:5px;color:white;",d.appendChild(m);const E=document.createElement("div");E.textContent=C("pawnCaptures"),E.style.cssText="font-size:10px;color:#64748b;",d.appendChild(E),d.onclick=()=>{document.getElementById("enPassantChoiceOverlay")?.remove(),Me(t,e,n,s,"en-passant")},h.appendChild(d);const T=document.createElement("div");T.className="promotion-choice",T.style.cssText="width:140px;height:110px;flex-direction:column;display:flex;justify-content:center;align-items:center;";const y=document.createElement("div");y.style.cssText="display:flex;gap:5px;";const P=document.createElement("div");P.className=`piece ${a?"piece-white":"piece-black"}`,P.textContent=N[l],P.style.fontSize="48px",y.appendChild(P),T.appendChild(y);const B=document.createElement("div");B.textContent=C("normalMove"),B.style.cssText="font-size:12px;margin-top:5px;color:white;",T.appendChild(B);const q=document.createElement("div");q.textContent=`(${Le(l)} ${C("moves_")})`,q.style.cssText="font-size:10px;color:#64748b;",T.appendChild(q),T.onclick=()=>{document.getElementById("enPassantChoiceOverlay")?.remove(),Me(t,e,n,s,"normal")},h.appendChild(T),u.appendChild(h),i.appendChild(u),document.body.appendChild(i)}const j=Object.create(null);j.open="0";j.close="1";j.ping="2";j.pong="3";j.message="4";j.upgrade="5";j.noop="6";const Ce=Object.create(null);Object.keys(j).forEach(t=>{Ce[j[t]]=t});const et={type:"error",data:"parser error"},Vt=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",Wt=typeof ArrayBuffer=="function",zt=t=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(t):t&&t.buffer instanceof ArrayBuffer,ut=({type:t,data:e},n,s)=>Vt&&e instanceof Blob?n?s(e):xt(e,s):Wt&&(e instanceof ArrayBuffer||zt(e))?n?s(e):xt(new Blob([e]),s):s(j[t]+(e||"")),xt=(t,e)=>{const n=new FileReader;return n.onload=function(){const s=n.result.split(",")[1];e("b"+(s||""))},n.readAsDataURL(t)};function Pt(t){return t instanceof Uint8Array?t:t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}let Ve;function zn(t,e){if(Vt&&t.data instanceof Blob)return t.data.arrayBuffer().then(Pt).then(e);if(Wt&&(t.data instanceof ArrayBuffer||zt(t.data)))return e(Pt(t.data));ut(t,!1,n=>{Ve||(Ve=new TextEncoder),e(Ve.encode(n))})}const Bt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",ue=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let t=0;t<Bt.length;t++)ue[Bt.charCodeAt(t)]=t;const Yn=t=>{let e=t.length*.75,n=t.length,s,i=0,r,o,a,c;t[t.length-1]==="="&&(e--,t[t.length-2]==="="&&e--);const l=new ArrayBuffer(e),u=new Uint8Array(l);for(s=0;s<n;s+=4)r=ue[t.charCodeAt(s)],o=ue[t.charCodeAt(s+1)],a=ue[t.charCodeAt(s+2)],c=ue[t.charCodeAt(s+3)],u[i++]=r<<2|o>>4,u[i++]=(o&15)<<4|a>>2,u[i++]=(a&3)<<6|c&63;return l},jn=typeof ArrayBuffer=="function",ht=(t,e)=>{if(typeof t!="string")return{type:"message",data:Yt(t,e)};const n=t.charAt(0);return n==="b"?{type:"message",data:Jn(t.substring(1),e)}:Ce[n]?t.length>1?{type:Ce[n],data:t.substring(1)}:{type:Ce[n]}:et},Jn=(t,e)=>{if(jn){const n=Yn(t);return Yt(n,e)}else return{base64:!0,data:t}},Yt=(t,e)=>e==="blob"?t instanceof Blob?t:new Blob([t]):t instanceof ArrayBuffer?t:t.buffer,jt="",Xn=(t,e)=>{const n=t.length,s=new Array(n);let i=0;t.forEach((r,o)=>{ut(r,!1,a=>{s[o]=a,++i===n&&e(s.join(jt))})})},Qn=(t,e)=>{const n=t.split(jt),s=[];for(let i=0;i<n.length;i++){const r=ht(n[i],e);if(s.push(r),r.type==="error")break}return s};function Zn(){return new TransformStream({transform(t,e){zn(t,n=>{const s=n.length;let i;if(s<126)i=new Uint8Array(1),new DataView(i.buffer).setUint8(0,s);else if(s<65536){i=new Uint8Array(3);const r=new DataView(i.buffer);r.setUint8(0,126),r.setUint16(1,s)}else{i=new Uint8Array(9);const r=new DataView(i.buffer);r.setUint8(0,127),r.setBigUint64(1,BigInt(s))}t.data&&typeof t.data!="string"&&(i[0]|=128),e.enqueue(i),e.enqueue(n)})}})}let We;function Ee(t){return t.reduce((e,n)=>e+n.length,0)}function we(t,e){if(t[0].length===e)return t.shift();const n=new Uint8Array(e);let s=0;for(let i=0;i<e;i++)n[i]=t[0][s++],s===t[0].length&&(t.shift(),s=0);return t.length&&s<t[0].length&&(t[0]=t[0].slice(s)),n}function es(t,e){We||(We=new TextDecoder);const n=[];let s=0,i=-1,r=!1;return new TransformStream({transform(o,a){for(n.push(o);;){if(s===0){if(Ee(n)<1)break;const c=we(n,1);r=(c[0]&128)===128,i=c[0]&127,i<126?s=3:i===126?s=1:s=2}else if(s===1){if(Ee(n)<2)break;const c=we(n,2);i=new DataView(c.buffer,c.byteOffset,c.length).getUint16(0),s=3}else if(s===2){if(Ee(n)<8)break;const c=we(n,8),l=new DataView(c.buffer,c.byteOffset,c.length),u=l.getUint32(0);if(u>Math.pow(2,21)-1){a.enqueue(et);break}i=u*Math.pow(2,32)+l.getUint32(4),s=3}else{if(Ee(n)<i)break;const c=we(n,i);a.enqueue(ht(r?c:We.decode(c),e)),s=0}if(i===0||i>t){a.enqueue(et);break}}}})}const Jt=4;function L(t){if(t)return ts(t)}function ts(t){for(var e in L.prototype)t[e]=L.prototype[e];return t}L.prototype.on=L.prototype.addEventListener=function(t,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(e),this};L.prototype.once=function(t,e){function n(){this.off(t,n),e.apply(this,arguments)}return n.fn=e,this.on(t,n),this};L.prototype.off=L.prototype.removeListener=L.prototype.removeAllListeners=L.prototype.removeEventListener=function(t,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var n=this._callbacks["$"+t];if(!n)return this;if(arguments.length==1)return delete this._callbacks["$"+t],this;for(var s,i=0;i<n.length;i++)if(s=n[i],s===e||s.fn===e){n.splice(i,1);break}return n.length===0&&delete this._callbacks["$"+t],this};L.prototype.emit=function(t){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),n=this._callbacks["$"+t],s=1;s<arguments.length;s++)e[s-1]=arguments[s];if(n){n=n.slice(0);for(var s=0,i=n.length;s<i;++s)n[s].apply(this,e)}return this};L.prototype.emitReserved=L.prototype.emit;L.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]};L.prototype.hasListeners=function(t){return!!this.listeners(t).length};const Ue=typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,n)=>n(e,0),G=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),ns="arraybuffer";function Xt(t,...e){return e.reduce((n,s)=>(t.hasOwnProperty(s)&&(n[s]=t[s]),n),{})}const ss=G.setTimeout,is=G.clearTimeout;function He(t,e){e.useNativeTimers?(t.setTimeoutFn=ss.bind(G),t.clearTimeoutFn=is.bind(G)):(t.setTimeoutFn=G.setTimeout.bind(G),t.clearTimeoutFn=G.clearTimeout.bind(G))}const rs=1.33;function os(t){return typeof t=="string"?cs(t):Math.ceil((t.byteLength||t.size)*rs)}function cs(t){let e=0,n=0;for(let s=0,i=t.length;s<i;s++)e=t.charCodeAt(s),e<128?n+=1:e<2048?n+=2:e<55296||e>=57344?n+=3:(s++,n+=4);return n}function Qt(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function as(t){let e="";for(let n in t)t.hasOwnProperty(n)&&(e.length&&(e+="&"),e+=encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e}function ls(t){let e={},n=t.split("&");for(let s=0,i=n.length;s<i;s++){let r=n[s].split("=");e[decodeURIComponent(r[0])]=decodeURIComponent(r[1])}return e}class us extends Error{constructor(e,n,s){super(e),this.description=n,this.context=s,this.type="TransportError"}}class dt extends L{constructor(e){super(),this.writable=!1,He(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,n,s){return super.emitReserved("error",new us(e,n,s)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const n=ht(e,this.socket.binaryType);this.onPacket(n)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,n={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(n)}_hostname(){const e=this.opts.hostname;return e.indexOf(":")===-1?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&Number(this.opts.port)!==443||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(e){const n=as(e);return n.length?"?"+n:""}}class hs extends dt{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const n=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let s=0;this._polling&&(s++,this.once("pollComplete",function(){--s||n()})),this.writable||(s++,this.once("drain",function(){--s||n()}))}else n()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const n=s=>{if(this.readyState==="opening"&&s.type==="open"&&this.onOpen(),s.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(s)};Qn(e,this.socket.binaryType).forEach(n),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,Xn(e,n=>{this.doWrite(n,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",n=this.query||{};return this.opts.timestampRequests!==!1&&(n[this.opts.timestampParam]=Qt()),!this.supportsBinary&&!n.sid&&(n.b64=1),this.createUri(e,n)}}let Zt=!1;try{Zt=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const ds=Zt;function fs(){}class ps extends hs{constructor(e){if(super(e),typeof location<"u"){const n=location.protocol==="https:";let s=location.port;s||(s=n?"443":"80"),this.xd=typeof location<"u"&&e.hostname!==location.hostname||s!==e.port}}doWrite(e,n){const s=this.request({method:"POST",data:e});s.on("success",n),s.on("error",(i,r)=>{this.onError("xhr post error",i,r)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(n,s)=>{this.onError("xhr poll error",n,s)}),this.pollXhr=e}}class Y extends L{constructor(e,n,s){super(),this.createRequest=e,He(this,s),this._opts=s,this._method=s.method||"GET",this._uri=n,this._data=s.data!==void 0?s.data:null,this._create()}_create(){var e;const n=Xt(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");n.xdomain=!!this._opts.xd;const s=this._xhr=this.createRequest(n);try{s.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){s.setDisableHeaderCheck&&s.setDisableHeaderCheck(!0);for(let i in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(i)&&s.setRequestHeader(i,this._opts.extraHeaders[i])}}catch{}if(this._method==="POST")try{s.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{s.setRequestHeader("Accept","*/*")}catch{}(e=this._opts.cookieJar)===null||e===void 0||e.addCookies(s),"withCredentials"in s&&(s.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(s.timeout=this._opts.requestTimeout),s.onreadystatechange=()=>{var i;s.readyState===3&&((i=this._opts.cookieJar)===null||i===void 0||i.parseCookies(s.getResponseHeader("set-cookie"))),s.readyState===4&&(s.status===200||s.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof s.status=="number"?s.status:0)},0))},s.send(this._data)}catch(i){this.setTimeoutFn(()=>{this._onError(i)},0);return}typeof document<"u"&&(this._index=Y.requestsCount++,Y.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=fs,e)try{this._xhr.abort()}catch{}typeof document<"u"&&delete Y.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}Y.requestsCount=0;Y.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",Ot);else if(typeof addEventListener=="function"){const t="onpagehide"in G?"pagehide":"unload";addEventListener(t,Ot,!1)}}function Ot(){for(let t in Y.requests)Y.requests.hasOwnProperty(t)&&Y.requests[t].abort()}const ms=(function(){const t=en({xdomain:!1});return t&&t.responseType!==null})();class gs extends ps{constructor(e){super(e);const n=e&&e.forceBase64;this.supportsBinary=ms&&!n}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new Y(en,this.uri(),e)}}function en(t){const e=t.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||ds))return new XMLHttpRequest}catch{}if(!e)try{return new G[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const tn=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class ys extends dt{get name(){return"websocket"}doOpen(){const e=this.uri(),n=this.opts.protocols,s=tn?{}:Xt(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(s.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,n,s)}catch(i){return this.emitReserved("error",i)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let n=0;n<e.length;n++){const s=e[n],i=n===e.length-1;ut(s,this.supportsBinary,r=>{try{this.doWrite(s,r)}catch{}i&&Ue(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",n=this.query||{};return this.opts.timestampRequests&&(n[this.opts.timestampParam]=Qt()),this.supportsBinary||(n.b64=1),this.createUri(e,n)}}const ze=G.WebSocket||G.MozWebSocket;class ks extends ys{createSocket(e,n,s){return tn?new ze(e,n,s):n?new ze(e,n):new ze(e)}doWrite(e,n){this.ws.send(n)}}class vs extends dt{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(e){return this.emitReserved("error",e)}this._transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(e=>{const n=es(Number.MAX_SAFE_INTEGER,this.socket.binaryType),s=e.readable.pipeThrough(n).getReader(),i=Zn();i.readable.pipeTo(e.writable),this._writer=i.writable.getWriter();const r=()=>{s.read().then(({done:a,value:c})=>{a||(this.onPacket(c),r())}).catch(a=>{})};r();const o={type:"open"};this.query.sid&&(o.data=`{"sid":"${this.query.sid}"}`),this._writer.write(o).then(()=>this.onOpen())})})}write(e){this.writable=!1;for(let n=0;n<e.length;n++){const s=e[n],i=n===e.length-1;this._writer.write(s).then(()=>{i&&Ue(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;(e=this._transport)===null||e===void 0||e.close()}}const bs={websocket:ks,webtransport:vs,polling:gs},Es=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,ws=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function tt(t){if(t.length>8e3)throw"URI too long";const e=t,n=t.indexOf("["),s=t.indexOf("]");n!=-1&&s!=-1&&(t=t.substring(0,n)+t.substring(n,s).replace(/:/g,";")+t.substring(s,t.length));let i=Es.exec(t||""),r={},o=14;for(;o--;)r[ws[o]]=i[o]||"";return n!=-1&&s!=-1&&(r.source=e,r.host=r.host.substring(1,r.host.length-1).replace(/;/g,":"),r.authority=r.authority.replace("[","").replace("]","").replace(/;/g,":"),r.ipv6uri=!0),r.pathNames=_s(r,r.path),r.queryKey=Ss(r,r.query),r}function _s(t,e){const n=/\/{2,9}/g,s=e.replace(n,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&s.splice(0,1),e.slice(-1)=="/"&&s.splice(s.length-1,1),s}function Ss(t,e){const n={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(s,i,r){i&&(n[i]=r)}),n}const nt=typeof addEventListener=="function"&&typeof removeEventListener=="function",Te=[];nt&&addEventListener("offline",()=>{Te.forEach(t=>t())},!1);class Q extends L{constructor(e,n){if(super(),this.binaryType=ns,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&typeof e=="object"&&(n=e,e=null),e){const s=tt(e);n.hostname=s.host,n.secure=s.protocol==="https"||s.protocol==="wss",n.port=s.port,s.query&&(n.query=s.query)}else n.host&&(n.hostname=tt(n.host).host);He(this,n),this.secure=n.secure!=null?n.secure:typeof location<"u"&&location.protocol==="https:",n.hostname&&!n.port&&(n.port=this.secure?"443":"80"),this.hostname=n.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=n.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},n.transports.forEach(s=>{const i=s.prototype.name;this.transports.push(i),this._transportsByName[i]=s}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},n),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=ls(this.opts.query)),nt&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},Te.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const n=Object.assign({},this.opts.query);n.EIO=Jt,n.transport=e,this.id&&(n.sid=this.id);const s=Object.assign({},this.opts,{query:n,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](s)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const e=this.opts.rememberUpgrade&&Q.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const n=this.createTransport(e);n.open(),this.setTransport(n)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",n=>this._onClose("transport close",n))}onOpen(){this.readyState="open",Q.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const n=new Error("server error");n.code=e.data,this._onError(n);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let n=1;for(let s=0;s<this.writeBuffer.length;s++){const i=this.writeBuffer[s].data;if(i&&(n+=os(i)),s>0&&n>this._maxPayload)return this.writeBuffer.slice(0,s);n+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,Ue(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,n,s){return this._sendPacket("message",e,n,s),this}send(e,n,s){return this._sendPacket("message",e,n,s),this}_sendPacket(e,n,s,i){if(typeof n=="function"&&(i=n,n=void 0),typeof s=="function"&&(i=s,s=null),this.readyState==="closing"||this.readyState==="closed")return;s=s||{},s.compress=s.compress!==!1;const r={type:e,data:n,options:s};this.emitReserved("packetCreate",r),this.writeBuffer.push(r),i&&this.once("flush",i),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},n=()=>{this.off("upgrade",n),this.off("upgradeError",n),e()},s=()=>{this.once("upgrade",n),this.once("upgradeError",n)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?s():e()}):this.upgrading?s():e()),this}_onError(e){if(Q.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,n){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),nt&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const s=Te.indexOf(this._offlineEventListener);s!==-1&&Te.splice(s,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,n),this.writeBuffer=[],this._prevBufferLen=0}}}Q.protocol=Jt;class Cs extends Q{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let n=this.createTransport(e),s=!1;Q.priorWebsocketSuccess=!1;const i=()=>{s||(n.send([{type:"ping",data:"probe"}]),n.once("packet",p=>{if(!s)if(p.type==="pong"&&p.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",n),!n)return;Q.priorWebsocketSuccess=n.name==="websocket",this.transport.pause(()=>{s||this.readyState!=="closed"&&(u(),this.setTransport(n),n.send([{type:"upgrade"}]),this.emitReserved("upgrade",n),n=null,this.upgrading=!1,this.flush())})}else{const h=new Error("probe error");h.transport=n.name,this.emitReserved("upgradeError",h)}}))};function r(){s||(s=!0,u(),n.close(),n=null)}const o=p=>{const h=new Error("probe error: "+p);h.transport=n.name,r(),this.emitReserved("upgradeError",h)};function a(){o("transport closed")}function c(){o("socket closed")}function l(p){n&&p.name!==n.name&&r()}const u=()=>{n.removeListener("open",i),n.removeListener("error",o),n.removeListener("close",a),this.off("close",c),this.off("upgrading",l)};n.once("open",i),n.once("error",o),n.once("close",a),this.once("close",c),this.once("upgrading",l),this._upgrades.indexOf("webtransport")!==-1&&e!=="webtransport"?this.setTimeoutFn(()=>{s||n.open()},200):n.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const n=[];for(let s=0;s<e.length;s++)~this.transports.indexOf(e[s])&&n.push(e[s]);return n}}let Ts=class extends Cs{constructor(e,n={}){const s=typeof e=="object"?e:n;(!s.transports||s.transports&&typeof s.transports[0]=="string")&&(s.transports=(s.transports||["polling","websocket","webtransport"]).map(i=>bs[i]).filter(i=>!!i)),super(e,s)}};function xs(t,e="",n){let s=t;n=n||typeof location<"u"&&location,t==null&&(t=n.protocol+"//"+n.host),typeof t=="string"&&(t.charAt(0)==="/"&&(t.charAt(1)==="/"?t=n.protocol+t:t=n.host+t),/^(https?|wss?):\/\//.test(t)||(typeof n<"u"?t=n.protocol+"//"+t:t="https://"+t),s=tt(t)),s.port||(/^(http|ws)$/.test(s.protocol)?s.port="80":/^(http|ws)s$/.test(s.protocol)&&(s.port="443")),s.path=s.path||"/";const r=s.host.indexOf(":")!==-1?"["+s.host+"]":s.host;return s.id=s.protocol+"://"+r+":"+s.port+e,s.href=s.protocol+"://"+r+(n&&n.port===s.port?"":":"+s.port),s}const Ps=typeof ArrayBuffer=="function",Bs=t=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(t):t.buffer instanceof ArrayBuffer,nn=Object.prototype.toString,Os=typeof Blob=="function"||typeof Blob<"u"&&nn.call(Blob)==="[object BlobConstructor]",Ls=typeof File=="function"||typeof File<"u"&&nn.call(File)==="[object FileConstructor]";function ft(t){return Ps&&(t instanceof ArrayBuffer||Bs(t))||Os&&t instanceof Blob||Ls&&t instanceof File}function xe(t,e){if(!t||typeof t!="object")return!1;if(Array.isArray(t)){for(let n=0,s=t.length;n<s;n++)if(xe(t[n]))return!0;return!1}if(ft(t))return!0;if(t.toJSON&&typeof t.toJSON=="function"&&arguments.length===1)return xe(t.toJSON(),!0);for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)&&xe(t[n]))return!0;return!1}function Ns(t){const e=[],n=t.data,s=t;return s.data=st(n,e),s.attachments=e.length,{packet:s,buffers:e}}function st(t,e){if(!t)return t;if(ft(t)){const n={_placeholder:!0,num:e.length};return e.push(t),n}else if(Array.isArray(t)){const n=new Array(t.length);for(let s=0;s<t.length;s++)n[s]=st(t[s],e);return n}else if(typeof t=="object"&&!(t instanceof Date)){const n={};for(const s in t)Object.prototype.hasOwnProperty.call(t,s)&&(n[s]=st(t[s],e));return n}return t}function qs(t,e){return t.data=it(t.data,e),delete t.attachments,t}function it(t,e){if(!t)return t;if(t&&t._placeholder===!0){if(typeof t.num=="number"&&t.num>=0&&t.num<e.length)return e[t.num];throw new Error("illegal attachments")}else if(Array.isArray(t))for(let n=0;n<t.length;n++)t[n]=it(t[n],e);else if(typeof t=="object")for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(t[n]=it(t[n],e));return t}const As=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"];var _;(function(t){t[t.CONNECT=0]="CONNECT",t[t.DISCONNECT=1]="DISCONNECT",t[t.EVENT=2]="EVENT",t[t.ACK=3]="ACK",t[t.CONNECT_ERROR=4]="CONNECT_ERROR",t[t.BINARY_EVENT=5]="BINARY_EVENT",t[t.BINARY_ACK=6]="BINARY_ACK"})(_||(_={}));class Ms{constructor(e){this.replacer=e}encode(e){return(e.type===_.EVENT||e.type===_.ACK)&&xe(e)?this.encodeAsBinary({type:e.type===_.EVENT?_.BINARY_EVENT:_.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let n=""+e.type;return(e.type===_.BINARY_EVENT||e.type===_.BINARY_ACK)&&(n+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(n+=e.nsp+","),e.id!=null&&(n+=e.id),e.data!=null&&(n+=JSON.stringify(e.data,this.replacer)),n}encodeAsBinary(e){const n=Ns(e),s=this.encodeAsString(n.packet),i=n.buffers;return i.unshift(s),i}}class pt extends L{constructor(e){super(),this.reviver=e}add(e){let n;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");n=this.decodeString(e);const s=n.type===_.BINARY_EVENT;s||n.type===_.BINARY_ACK?(n.type=s?_.EVENT:_.ACK,this.reconstructor=new Is(n),n.attachments===0&&super.emitReserved("decoded",n)):super.emitReserved("decoded",n)}else if(ft(e)||e.base64)if(this.reconstructor)n=this.reconstructor.takeBinaryData(e),n&&(this.reconstructor=null,super.emitReserved("decoded",n));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let n=0;const s={type:Number(e.charAt(0))};if(_[s.type]===void 0)throw new Error("unknown packet type "+s.type);if(s.type===_.BINARY_EVENT||s.type===_.BINARY_ACK){const r=n+1;for(;e.charAt(++n)!=="-"&&n!=e.length;);const o=e.substring(r,n);if(o!=Number(o)||e.charAt(n)!=="-")throw new Error("Illegal attachments");s.attachments=Number(o)}if(e.charAt(n+1)==="/"){const r=n+1;for(;++n&&!(e.charAt(n)===","||n===e.length););s.nsp=e.substring(r,n)}else s.nsp="/";const i=e.charAt(n+1);if(i!==""&&Number(i)==i){const r=n+1;for(;++n;){const o=e.charAt(n);if(o==null||Number(o)!=o){--n;break}if(n===e.length)break}s.id=Number(e.substring(r,n+1))}if(e.charAt(++n)){const r=this.tryParse(e.substr(n));if(pt.isPayloadValid(s.type,r))s.data=r;else throw new Error("invalid payload")}return s}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,n){switch(e){case _.CONNECT:return Lt(n);case _.DISCONNECT:return n===void 0;case _.CONNECT_ERROR:return typeof n=="string"||Lt(n);case _.EVENT:case _.BINARY_EVENT:return Array.isArray(n)&&(typeof n[0]=="number"||typeof n[0]=="string"&&As.indexOf(n[0])===-1);case _.ACK:case _.BINARY_ACK:return Array.isArray(n)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class Is{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const n=qs(this.reconPack,this.buffers);return this.finishedReconstruction(),n}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}function Lt(t){return Object.prototype.toString.call(t)==="[object Object]"}const $s=Object.freeze(Object.defineProperty({__proto__:null,Decoder:pt,Encoder:Ms,get PacketType(){return _}},Symbol.toStringTag,{value:"Module"}));function W(t,e,n){return t.on(e,n),function(){t.off(e,n)}}const Ds=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class sn extends L{constructor(e,n,s){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=n,s&&s.auth&&(this.auth=s.auth),this._opts=Object.assign({},s),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[W(e,"open",this.onopen.bind(this)),W(e,"packet",this.onpacket.bind(this)),W(e,"error",this.onerror.bind(this)),W(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...n){var s,i,r;if(Ds.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(n.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(n),this;const o={type:_.EVENT,data:n};if(o.options={},o.options.compress=this.flags.compress!==!1,typeof n[n.length-1]=="function"){const u=this.ids++,p=n.pop();this._registerAckCallback(u,p),o.id=u}const a=(i=(s=this.io.engine)===null||s===void 0?void 0:s.transport)===null||i===void 0?void 0:i.writable,c=this.connected&&!(!((r=this.io.engine)===null||r===void 0)&&r._hasPingExpired());return this.flags.volatile&&!a||(c?(this.notifyOutgoingListeners(o),this.packet(o)):this.sendBuffer.push(o)),this.flags={},this}_registerAckCallback(e,n){var s;const i=(s=this.flags.timeout)!==null&&s!==void 0?s:this._opts.ackTimeout;if(i===void 0){this.acks[e]=n;return}const r=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let a=0;a<this.sendBuffer.length;a++)this.sendBuffer[a].id===e&&this.sendBuffer.splice(a,1);n.call(this,new Error("operation has timed out"))},i),o=(...a)=>{this.io.clearTimeoutFn(r),n.apply(this,a)};o.withError=!0,this.acks[e]=o}emitWithAck(e,...n){return new Promise((s,i)=>{const r=(o,a)=>o?i(o):s(a);r.withError=!0,n.push(r),this.emit(e,...n)})}_addToQueue(e){let n;typeof e[e.length-1]=="function"&&(n=e.pop());const s={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((i,...r)=>(this._queue[0],i!==null?s.tryCount>this._opts.retries&&(this._queue.shift(),n&&n(i)):(this._queue.shift(),n&&n(null,...r)),s.pending=!1,this._drainQueue())),this._queue.push(s),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const n=this._queue[0];n.pending&&!e||(n.pending=!0,n.tryCount++,this.flags=n.flags,this.emit.apply(this,n.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:_.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,n){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,n),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(s=>String(s.id)===e)){const s=this.acks[e];delete this.acks[e],s.withError&&s.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case _.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case _.EVENT:case _.BINARY_EVENT:this.onevent(e);break;case _.ACK:case _.BINARY_ACK:this.onack(e);break;case _.DISCONNECT:this.ondisconnect();break;case _.CONNECT_ERROR:this.destroy();const s=new Error(e.data.message);s.data=e.data.data,this.emitReserved("connect_error",s);break}}onevent(e){const n=e.data||[];e.id!=null&&n.push(this.ack(e.id)),this.connected?this.emitEvent(n):this.receiveBuffer.push(Object.freeze(n))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const n=this._anyListeners.slice();for(const s of n)s.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const n=this;let s=!1;return function(...i){s||(s=!0,n.packet({type:_.ACK,id:e,data:i}))}}onack(e){const n=this.acks[e.id];typeof n=="function"&&(delete this.acks[e.id],n.withError&&e.data.unshift(null),n.apply(this,e.data))}onconnect(e,n){this.id=e,this.recovered=n&&this._pid===n,this._pid=n,this.connected=!0,this.emitBuffered(),this._drainQueue(!0),this.emitReserved("connect")}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:_.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const n=this._anyListeners;for(let s=0;s<n.length;s++)if(e===n[s])return n.splice(s,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const n=this._anyOutgoingListeners;for(let s=0;s<n.length;s++)if(e===n[s])return n.splice(s,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const n=this._anyOutgoingListeners.slice();for(const s of n)s.apply(this,e.data)}}}function re(t){t=t||{},this.ms=t.min||100,this.max=t.max||1e4,this.factor=t.factor||2,this.jitter=t.jitter>0&&t.jitter<=1?t.jitter:0,this.attempts=0}re.prototype.duration=function(){var t=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),n=Math.floor(e*this.jitter*t);t=(Math.floor(e*10)&1)==0?t-n:t+n}return Math.min(t,this.max)|0};re.prototype.reset=function(){this.attempts=0};re.prototype.setMin=function(t){this.ms=t};re.prototype.setMax=function(t){this.max=t};re.prototype.setJitter=function(t){this.jitter=t};class rt extends L{constructor(e,n){var s;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(n=e,e=void 0),n=n||{},n.path=n.path||"/socket.io",this.opts=n,He(this,n),this.reconnection(n.reconnection!==!1),this.reconnectionAttempts(n.reconnectionAttempts||1/0),this.reconnectionDelay(n.reconnectionDelay||1e3),this.reconnectionDelayMax(n.reconnectionDelayMax||5e3),this.randomizationFactor((s=n.randomizationFactor)!==null&&s!==void 0?s:.5),this.backoff=new re({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(n.timeout==null?2e4:n.timeout),this._readyState="closed",this.uri=e;const i=n.parser||$s;this.encoder=new i.Encoder,this.decoder=new i.Decoder,this._autoConnect=n.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var n;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(n=this.backoff)===null||n===void 0||n.setMin(e),this)}randomizationFactor(e){var n;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(n=this.backoff)===null||n===void 0||n.setJitter(e),this)}reconnectionDelayMax(e){var n;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(n=this.backoff)===null||n===void 0||n.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new Ts(this.uri,this.opts);const n=this.engine,s=this;this._readyState="opening",this.skipReconnect=!1;const i=W(n,"open",function(){s.onopen(),e&&e()}),r=a=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",a),e?e(a):this.maybeReconnectOnOpen()},o=W(n,"error",r);if(this._timeout!==!1){const a=this._timeout,c=this.setTimeoutFn(()=>{i(),r(new Error("timeout")),n.close()},a);this.opts.autoUnref&&c.unref(),this.subs.push(()=>{this.clearTimeoutFn(c)})}return this.subs.push(i),this.subs.push(o),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(W(e,"ping",this.onping.bind(this)),W(e,"data",this.ondata.bind(this)),W(e,"error",this.onerror.bind(this)),W(e,"close",this.onclose.bind(this)),W(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(n){this.onclose("parse error",n)}}ondecoded(e){Ue(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,n){let s=this.nsps[e];return s?this._autoConnect&&!s.active&&s.connect():(s=new sn(this,e,n),this.nsps[e]=s),s}_destroy(e){const n=Object.keys(this.nsps);for(const s of n)if(this.nsps[s].active)return;this._close()}_packet(e){const n=this.encoder.encode(e);for(let s=0;s<n.length;s++)this.engine.write(n[s],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,n){var s;this.cleanup(),(s=this.engine)===null||s===void 0||s.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,n),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const n=this.backoff.duration();this._reconnecting=!0;const s=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(i=>{i?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",i)):e.onreconnect()}))},n);this.opts.autoUnref&&s.unref(),this.subs.push(()=>{this.clearTimeoutFn(s)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const le={};function Pe(t,e){typeof t=="object"&&(e=t,t=void 0),e=e||{};const n=xs(t,e.path||"/socket.io"),s=n.source,i=n.id,r=n.path,o=le[i]&&r in le[i].nsps,a=e.forceNew||e["force new connection"]||e.multiplex===!1||o;let c;return a?c=new rt(s,e):(le[i]||(le[i]=new rt(s,e)),c=le[i]),n.query&&!e.query&&(e.query=n.queryKey),c.socket(n.path,e)}Object.assign(Pe,{Manager:rt,Socket:sn,io:Pe,connect:Pe});const rn="https://klikschaak-api.onrender.com",mt="klikschaak_token",gt="klikschaak_user";let ne=null;function on(){return localStorage.getItem(mt)}function yt(){if(ne)return ne;const t=localStorage.getItem(gt);if(t)try{return ne=JSON.parse(t),ne}catch{return null}return null}function Rs(){return on()!==null&&yt()!==null}function cn(t,e){localStorage.setItem(mt,e),localStorage.setItem(gt,JSON.stringify(t)),ne=t}function Us(){localStorage.removeItem(mt),localStorage.removeItem(gt),ne=null}async function Hs(t,e,n){try{const s=await fetch(`${rn}/api/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,email:e,password:n})}),i=await s.json();return s.ok?(cn(i.user,i.token),{success:!0}):{success:!1,error:i.error||"Registration failed"}}catch(s){return console.error("Registration error:",s),{success:!1,error:"Network error"}}}async function Gs(t,e){try{const n=await fetch(`${rn}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,password:e})}),s=await n.json();return n.ok?(cn(s.user,s.token),{success:!0}):{success:!1,error:s.error||"Login failed"}}catch(n){return console.error("Login error:",n),{success:!1,error:"Network error"}}}function Fs(){Us()}let H=null;const Ks="https://klikschaak-api.onrender.com";function Vs(){return new Promise((t,e)=>{const n=on();if(!n){e(new Error("Not authenticated"));return}if(H?.connected){t(H);return}H=Pe(Ks,{auth:{token:n},reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3}),H.on("connect",()=>{console.log("Connected to server"),t(H)}),H.on("connect_error",s=>{console.error("Connection error:",s.message),e(s)}),H.on("disconnect",s=>{console.log("Disconnected:",s)}),H.on("reconnect",s=>{console.log("Reconnected after",s,"attempts")})})}function oe(){return H}function Ws(){H&&(H.disconnect(),H=null)}let b=null,me=!1,an=null,ot=null,ct=null,ln=null,un=null,hn=null,at=null;function zs(){const t=oe();t&&(t.on("game:created",e=>{b={gameId:e.gameId,gameCode:e.gameCode,myColor:e.color,board:qt(),currentTurn:"white",timer:{white:Nt(e.timeControl),black:Nt(e.timeControl)},opponent:null,moveHistory:[],enPassantTarget:null,castlingRights:{white:{kingSide:!0,queenSide:!0},black:{kingSide:!0,queenSide:!0}},movedPawns:[],gameStarted:!1,gameOver:!1,result:null},me=!0,an?.(e.gameCode)}),t.on("game:joined",e=>{b={gameId:e.gameId,gameCode:e.gameCode,myColor:e.color,board:qt(),currentTurn:"white",timer:{white:42e4,black:42e4},opponent:e.opponent,moveHistory:[],enPassantTarget:null,castlingRights:{white:{kingSide:!0,queenSide:!0},black:{kingSide:!0,queenSide:!0}},movedPawns:[],gameStarted:!1,gameOver:!1,result:null},me=!0,ot?.(b)}),t.on("game:started",e=>{b&&(b.board=e.board,b.currentTurn=e.currentTurn,b.timer=e.timer,b.gameStarted=!0,b.opponent=b.myColor==="white"?e.black:e.white,ct?.(b))}),t.on("game:move-made",e=>{b&&(b.board=e.board,b.currentTurn=e.currentTurn,b.timer=e.timer,b.enPassantTarget=e.enPassantTarget,b.castlingRights=e.castlingRights,b.movedPawns=e.movedPawns,b.moveHistory.push({turn:e.currentTurn==="white"?"black":"white",notation:e.notation}),ln?.(b))}),t.on("game:move-rejected",e=>{at?.(e.error)}),t.on("game:timer-sync",e=>{b&&(b.timer=e,un?.(e.white,e.black))}),t.on("game:over",e=>{b&&(b.gameOver=!0,b.result=e,hn?.(e))}),t.on("game:error",e=>{at?.(e.message)}),t.on("game:state",e=>{e&&(b={gameId:e.id,gameCode:e.gameCode,myColor:e.yourColor,board:e.board,currentTurn:e.currentTurn,timer:e.timer,opponent:e.yourColor==="white"?e.blackPlayer:e.whitePlayer,moveHistory:e.moveHistory,enPassantTarget:e.enPassantTarget,castlingRights:e.castlingRights,movedPawns:e.movedPawns,gameStarted:e.gameStarted,gameOver:e.gameOver,result:e.result},me=!0,ot?.(b),e.gameStarted&&ct?.(b))}))}function Nt(t){switch(t){case"bullet":return 60*1e3;case"blitz":return 180*1e3;case"standard":return 420*1e3;default:return 420*1e3}}function qt(){return Array(8).fill(null).map(()=>Array(8).fill(null).map(()=>({pieces:[]})))}function Ys(t){t.onGameCreated&&(an=t.onGameCreated),t.onGameJoined&&(ot=t.onGameJoined),t.onGameStarted&&(ct=t.onGameStarted),t.onMoveMade&&(ln=t.onMoveMade),t.onTimerUpdate&&(un=t.onTimerUpdate),t.onGameOver&&(hn=t.onGameOver),t.onError&&(at=t.onError)}function js(t="standard"){oe()?.emit("game:create",{timeControl:t})}function Js(t){oe()?.emit("game:join",{gameCode:t.toUpperCase()})}function kt(t,e,n,s,i){if(!b)return;oe()?.emit("game:move",{gameId:b.gameId,from:t,to:e,moveType:n,unklikIndex:s,promoteTo:i})}function Xs(){if(!b)return;oe()?.emit("game:resign",{gameId:b.gameId})}function At(){return b}function ce(){return me}function vt(){return b!==null&&b.currentTurn===b.myColor}function Qs(){return b?.myColor||null}function Zs(){b=null,me=!1}function qe(t,e){if($e())return;if(ce()&&!vt()){const r=M(),o=r[t][e],a=Qs();if(o.pieces.length>0&&v(o.pieces[0])===(a==="white")){de([t,e]),Se(null);const c=pe(r,t,e,o.pieces,Z(),ee(),te(),null);se(c),D(),R()}return}const n=M(),s=n[t][e],i=lt();if(i){const[r,o]=i,c=ye().find(l=>l.row===t&&l.col===e);if(c){const l=c.type;l==="castle-k"||l==="castle-q"||l==="castle-k-klik"||l==="castle-q-klik"||l==="castle-k-unklik-klik"||l==="castle-q-unklik-klik"?Ae(r,o,t,e,l):l==="castle-k-choice"||l==="castle-q-choice"?Vn(r,o,t,e,l):l==="en-passant-choice"?Wn(r,o,t,e):Me(r,o,t,e,l)}else if(s.pieces.length>0&&v(s.pieces[0])===(A()==="white")){de([t,e]),Se(null);const l=pe(n,t,e,s.pieces,Z(),ee(),te(),null);se(l)}else J()}else if(s.pieces.length>0){const r=v(s.pieces[0]);if(r&&A()==="white"||!r&&A()==="black"){de([t,e]),Se(null);const o=pe(n,t,e,s.pieces,Z(),ee(),te(),null);se(o)}}D(),R()}function ei(t,e,n,s){if($e()||(s.stopPropagation(),ce()&&!vt()))return;const i=M(),r=i[t][e],o=r.pieces[n],a=v(o);if(a&&A()!=="white"||!a&&A()!=="black")return;if(de([t,e]),Se(n),O(o)==="k"){const d=Ne(i,t,e,o,Z(),ee(),te()).map(f=>({row:f[0],col:f[1],type:"unklik"})).filter(f=>!ge(i,t,e,f.row,f.col,r.pieces,"unklik",n));se(d),D(),R();return}const c=Ne(i,t,e,o,Z(),ee(),te()),l=[],u=$(o);for(const h of c){const[d,f,k]=h,m=i[d][f];u&&(a&&d===7||!a&&d===0)||(k==="en-passant"?l.push({row:d,col:f,type:"en-passant-unklik"}):m.pieces.length===0||v(m.pieces[0])!==a?l.push({row:d,col:f,type:"unklik"}):m.pieces.length<2&&v(m.pieces[0])===a&&!m.pieces.some(T=>O(T)==="k")&&l.push({row:d,col:f,type:"unklik-klik"}))}const p=l.filter(h=>!ge(i,t,e,h.row,h.col,r.pieces,h.type,n));se(p),D(),R()}function Ae(t,e,n,s,i){if(ce()){kt({row:t,col:e},{row:n,col:s},i),J(),D(),R();return}const r=M(),o=i.startsWith("castle-k"),a=o?7:0,c=o?5:3,l=r[t][e].pieces;S(n,s,l),S(t,e,[]);const u=[...r[t][a].pieces];S(t,a,[]);let p=`O-O${o?"":"-O"}`;if(i.includes("unklik-klik")){const d=u.find(m=>O(m)==="r"),f=u.find(m=>O(m)!=="r"),k=[...r[t][c].pieces];S(t,c,[d,...k]),S(t,a,[f]),p+=" (toren klikt)"}else if(i.includes("klik")&&!i.includes("unklik")){const d=[...r[t][c].pieces];S(t,c,[...u,...d]),p+=" klikt"}else if(i.includes("both"))S(t,c,u),p+=" (beide)";else if(u.length===2){const d=u.find(k=>O(k)==="r"),f=u.find(k=>O(k)!=="r");S(t,c,[d]),S(t,a,[f]),p+=" (alleen toren)"}else S(t,c,u);Xe(A()),J();const h=A();De(),Re({turn:h,notation:p}),D(),R(),bt()}function Me(t,e,n,s,i,r){if(ce()){const y=Ye(),B=M()[t][e],q=B.pieces.some(K=>$(K)),x=v(B.pieces[0]),I=x&&n===0||!x&&n===7;if(q&&I&&!r&&!be()){const K={row:n,col:s,isWhite:x,moveNotation:""};K.fromRow=t,K.fromCol=e,K.moveType=i,K.unklikIndex=y,fe(K),Ke();return}const F=r||(be()&&q&&I?x?"Q":"q":void 0);kt({row:t,col:e},{row:n,col:s},i,y!==null?y:void 0,F),J(),D(),R();return}const o=M(),a=o[t][e],c=o[n][s];let l,u="";Je(null);const p=c.pieces.length>0,h=ve(t,e),d=ve(n,s),f=Ye();if(i==="unklik"||i==="unklik-klik"||i==="en-passant-unklik"){const y=a.pieces[f],P=a.pieces.filter((x,I)=>I!==f);if(l=[y],S(t,e,P),u=`${N[y]}${h}-${d}`,i==="en-passant-unklik"){const x=A()==="white"?n+1:n-1;S(x,s,[]),S(n,s,[y]),u+=` x${ve(x,s)} e.p.`,ae(t,e,n,s,l),_e(u);return}const B=$(y),q=v(y)&&n===0||!v(y)&&n===7;if(B&&q){if(i==="unklik-klik"?(S(n,s,[...c.pieces,y]),u+=" klikt"):c.pieces.length>0?(S(n,s,[y]),u+=" x"):S(n,s,[y]),be()){const x=v(y)?"Q":"q",F=Qe(n,s).filter(K=>!$(K));F.unshift(x),S(n,s,F),u+="="+N[x],ae(t,e,n,s,F),_e(u)}else{const x={row:n,col:s,isWhite:v(y),moveNotation:u,wasCapture:c.pieces.length>1||i!=="unklik-klik"&&c.pieces.length>0};fe(x),Ke()}return}i==="unklik-klik"?(S(n,s,[...c.pieces,y]),u+=" klikt"):(c.pieces.length>0&&(u=`${N[y]}${h}x${d}`),S(n,s,[y])),ae(t,e,n,s,l)}else if(i==="en-passant"){l=[...a.pieces],S(t,e,[]);const y=A()==="white"?n+1:n-1;S(y,s,[]),S(n,s,l),u=`${Fe(l)}${h}x${ve(y,s)} e.p.`}else{l=[...a.pieces],S(t,e,[]),u=`${Fe(l)}${h}-${d}`;const y=l.some(B=>$(B)),P=v(l[0])&&n===0||!v(l[0])&&n===7;if(y&&P){if(i==="klik"?(S(n,s,[...c.pieces,...l]),u+=" klikt"):(c.pieces.length>0&&(u+=" x"),S(n,s,l)),be()){const B=v(l[0])?"Q":"q",x=Qe(n,s).filter(I=>!$(I));x.unshift(B),S(n,s,x),u+="="+N[B],ae(t,e,n,s,x),_e(u)}else{const B={row:n,col:s,isWhite:v(l[0]),moveNotation:u,otherPieces:l.filter(q=>!$(q)),wasCapture:c.pieces.length>l.length};fe(B),Ke()}return}i==="klik"?(S(n,s,[...c.pieces,...l]),u+=" klikt"):(c.pieces.length>0&&(u=`${Fe(l)}${h}x${d}`),S(n,s,l)),ae(t,e,n,s,l)}const k=l.some(y=>$(y)),m=e===s,E=v(l[0])&&t===6||!v(l[0])&&t===1;if(k&&m&&E&&!p&&Math.abs(t-n)===2){const y=(t+n)/2;Je({row:y,col:s})}l.includes("K")?Xe("white"):l.includes("k")&&Xe("black");for(const y of l)$(y)&&Kt(y);_e(u)}function _e(t){J();const e=A();De(),Re({turn:e,notation:t}),D(),R(),bt()}function dn(t){const e=Ft();if(!e)return;const n=document.getElementById("promotionOverlay");if(n&&n.remove(),ce()){const{fromRow:u,fromCol:p,moveType:h,unklikIndex:d}=e;kt({row:u,col:p},{row:e.row,col:e.col},h||"normal",d,t),J(),fe(null),D(),R();return}const{row:s,col:i,moveNotation:r}=e,a=Qe(s,i).filter(u=>!$(u));a.unshift(t),S(s,i,a);const c=r+"="+N[t];J();const l=A();De(),Re({turn:l,notation:c}),fe(null),D(),R(),bt()}function bt(){const t=M(),e=A(),n=Dn(t,e);Rn(t,e,Z(),ee(),te())?n&&Kn():(In(!0),n?Tt("checkmate",e==="white"?"black":"white"):Tt("stalemate",null))}function Et(){Gt(),D(),R()}function ti(){const t=document.getElementById("autoPromote");Mn(t.checked)}const w={dragging:!1,from:null,pieces:[],ghostElement:null,startX:0,startY:0,hasMoved:!1},Mt=10;function ni(){const t=document.getElementById("board");t&&(t.addEventListener("mousedown",ci),t.addEventListener("touchstart",ui,{passive:!1}),document.addEventListener("mousemove",ai),document.addEventListener("mouseup",li),document.addEventListener("touchmove",hi,{passive:!1}),document.addEventListener("touchend",It),document.addEventListener("touchcancel",It))}function fn(t){const n=t.target.closest(".square");if(!n)return null;const s=parseInt(n.dataset.row||"-1"),i=parseInt(n.dataset.col||"-1");return s<0||i<0?null:{element:n,pos:{row:s,col:i}}}function pn(t,e){const n=document.elementsFromPoint(t,e);for(const s of n)if(s.classList.contains("square")){const i=s,r=parseInt(i.dataset.row||"-1"),o=parseInt(i.dataset.col||"-1");if(r>=0&&o>=0)return{element:i,pos:{row:r,col:o}}}return null}function si(t){const e=document.createElement("div");return e.className="drag-ghost",e.innerHTML=t.map(n=>`<span class="piece ${v(n)?"piece-white":"piece-black"}">${N[n]}</span>`).join(""),document.body.appendChild(e),e}function mn(t,e,n){t.style.left=`${e}px`,t.style.top=`${n}px`}function ii(t){const e=M();document.querySelectorAll(".square").forEach(n=>{const s=n,i=parseInt(s.dataset.row||"-1"),r=parseInt(s.dataset.col||"-1"),o=t.find(a=>a.row===i&&a.col===r);o&&(s.classList.add("drag-valid-target"),e[i][r].pieces.length>0&&(o.type==="klik"||o.type==="unklik-klik"?s.classList.add("drag-klik-target"):s.classList.add("drag-capture-target")))})}function ri(){document.querySelectorAll(".square").forEach(t=>{t.classList.remove("drag-valid-target","drag-capture-target","drag-klik-target","drag-over","dragging")})}function gn(t,e){return e.find(n=>n.row===t.row&&n.col===t.col)}function yn(t,e,n){const i=M()[t.row][t.col].pieces;if(i.length===0)return!1;const r=v(i[0]),o=A();return r&&o!=="white"||!r&&o!=="black"?!1:(w.from=t,w.pieces=i,w.startX=e,w.startY=n,w.hasMoved=!1,w.dragging=!1,!0)}function oi(t,e){if(!w.from)return;w.dragging=!0,w.ghostElement=si(w.pieces),mn(w.ghostElement,t,e);const n=document.querySelector(`.square[data-row="${w.from.row}"][data-col="${w.from.col}"]`);n&&n.classList.add("dragging");const s=pe(M(),w.from.row,w.from.col,w.pieces,Z(),ee(),te(),null);se(s),ii(s)}function kn(t,e){if(!w.from)return;if(!w.dragging){const s=Math.abs(t-w.startX),i=Math.abs(e-w.startY);(s>Mt||i>Mt)&&(w.hasMoved=!0,oi(t,e));return}w.ghostElement&&mn(w.ghostElement,t,e),document.querySelectorAll(".square.drag-over").forEach(s=>{s.classList.remove("drag-over")});const n=pn(t,e);if(n){const s=ye();gn(n.pos,s)&&n.element.classList.add("drag-over")}}function vn(t,e){const n=w.from,s=w.dragging,i=w.hasMoved;if(w.ghostElement&&(w.ghostElement.remove(),w.ghostElement=null),ri(),w.from=null,w.pieces=[],w.dragging=!1,w.hasMoved=!1,!!n){if(!i){qe(n.row,n.col);return}if(s){const r=pn(t,e);if(r){const o=ye();if(gn(r.pos,o)){de([n.row,n.col]),qe(r.pos.row,r.pos.col);return}}J()}}}function ci(t){if(t.button!==0||$e())return;const e=t.target;if(e.classList.contains("triangle-left")||e.classList.contains("triangle-right"))return;const n=fn(t);n&&yn(n.pos,t.clientX,t.clientY)&&t.preventDefault()}function ai(t){w.from&&kn(t.clientX,t.clientY)}function li(t){w.from&&vn(t.clientX,t.clientY)}function ui(t){if($e()||t.touches.length!==1)return;const e=t.target;if(e.classList.contains("triangle-left")||e.classList.contains("triangle-right"))return;const n=t.touches[0],s=fn(n);s&&yn(s.pos,n.clientX,n.clientY)}function hi(t){if(!w.from||t.touches.length!==1)return;t.preventDefault();const e=t.touches[0];kn(e.clientX,e.clientY)}function It(t){if(!w.from)return;const e=t.changedTouches[0];vn(e.clientX,e.clientY)}let V=[],he=null;function di(){const t=oe();t&&(t.on("lobby:users",e=>{V=e,he?.(V)}),t.on("lobby:user-joined",e=>{V.find(s=>s.id===e.id)||(V.push({...e,status:"online"}),he?.(V))}),t.on("lobby:user-left",e=>{V=V.filter(n=>n.id!==e.id),he?.(V)}),t.on("lobby:user-status",e=>{const n=V.find(s=>s.id===e.id);n&&(n.status=e.status,he?.(V))}))}function bn(t){he=t,t(V)}let z=null,Be=null,Oe=null;function fi(){z=document.getElementById("lobbyContainer"),z||(z=document.createElement("div"),z.id="lobbyContainer",document.body.appendChild(z)),En(),_n(),bn(wn)}function pi(){z&&(z.innerHTML="")}function En(){z&&(z.innerHTML=`
    <div class="lobby-panel">
      <h3>Online Play</h3>
      <div class="lobby-actions">
        <div class="create-game">
          <select id="timeControlSelect">
            <option value="bullet">Bullet (1 min)</option>
            <option value="blitz">Blitz (3+2)</option>
            <option value="standard" selected>Standard (7+5)</option>
          </select>
          <button id="createGameBtn" class="lobby-btn">Create Game</button>
        </div>
        <div class="join-game">
          <input type="text" id="gameCodeInput" placeholder="Game Code" maxlength="6">
          <button id="joinGameBtn" class="lobby-btn">Join</button>
        </div>
      </div>
      <div id="gameCodeDisplay" class="game-code-display hidden"></div>
      <div id="waitingMessage" class="waiting-message hidden"></div>
      <div class="online-users">
        <h4>Online (<span id="onlineCount">0</span>)</h4>
        <ul id="onlineUsersList"></ul>
      </div>
    </div>
  `,document.getElementById("createGameBtn")?.addEventListener("click",mi),document.getElementById("joinGameBtn")?.addEventListener("click",$t),document.getElementById("gameCodeInput")?.addEventListener("keyup",t=>{t.key==="Enter"&&$t()}),Be=document.getElementById("gameCodeDisplay"))}function wn(t){const e=document.getElementById("onlineUsersList"),n=document.getElementById("onlineCount"),s=yt();n&&(n.textContent=String(t.length)),e&&(e.innerHTML=t.filter(i=>i.id!==s?.id).map(i=>`
        <li class="online-user ${i.status}">
          <span class="status-dot"></span>
          <span class="username">${i.username}</span>
          <span class="friend-code">#${i.friendCode}</span>
        </li>
      `).join("")||'<li class="no-users">No other players online</li>')}function mi(){const e=document.getElementById("timeControlSelect")?.value||"standard";js(e);const n=document.getElementById("waitingMessage");n&&(n.classList.remove("hidden"),n.textContent="Creating game...")}function $t(){const t=document.getElementById("gameCodeInput"),e=t?.value?.trim();e&&e.length>=4&&(Js(e),t.value="")}function _n(){Ys({onGameCreated:t=>{Be&&(Be.classList.remove("hidden"),Be.innerHTML=`
          <div class="game-code">
            <span>Share code:</span>
            <strong>${t}</strong>
            <button id="copyCodeBtn" class="copy-btn" title="Copy">ðŸ“‹</button>
          </div>
          <p>Waiting for opponent...</p>
        `,document.getElementById("copyCodeBtn")?.addEventListener("click",()=>{navigator.clipboard.writeText(t)}))},onGameJoined:t=>{console.log("Joined game:",t.gameCode)},onGameStarted:t=>{z&&(z.innerHTML=`
          <div class="game-info-panel">
            <div class="opponent-info">
              <span>vs ${t.opponent?.username||"Unknown"}</span>
            </div>
            <div id="timerDisplay" class="timer-display">
              <div class="timer white ${t.currentTurn==="white"?"active":""}">
                <span class="label">White</span>
                <span class="time">${Ie(t.timer.white)}</span>
              </div>
              <div class="timer black ${t.currentTurn==="black"?"active":""}">
                <span class="label">Black</span>
                <span class="time">${Ie(t.timer.black)}</span>
              </div>
            </div>
            <div class="game-actions">
              <button id="resignBtn" class="game-btn danger">Resign</button>
            </div>
          </div>
        `,Oe=document.getElementById("timerDisplay"),document.getElementById("resignBtn")?.addEventListener("click",()=>{confirm("Are you sure you want to resign?")&&Xs()})),Dt(t),D(),R(),Ut()},onMoveMade:t=>{Dt(t),D(),R(),Rt(t.timer.white,t.timer.black,t.currentTurn),Ut()},onTimerUpdate:(t,e)=>{const n=At();n&&Rt(t,e,n.currentTurn)},onGameOver:t=>{if(!t)return;const e=At();let n="";t.type==="checkmate"?n=t.winner===e?.myColor?"You won by checkmate!":"You lost by checkmate.":t.type==="stalemate"?n="Draw by stalemate.":t.type==="timeout"?n=t.winner===e?.myColor?"You won on time!":"You lost on time.":t.type==="resignation"?n=t.winner===e?.myColor?"Opponent resigned. You won!":"You resigned.":t.type==="disconnect"&&(n=t.winner===e?.myColor?"Opponent disconnected. You won!":"Game ended due to disconnection."),gi(n)},onError:t=>{alert(`Error: ${t}`)}})}function Dt(t){Gt();for(let e=0;e<8;e++)for(let n=0;n<8;n++)S(e,n,[...t.board[e][n].pieces]);for(;A()!==t.currentTurn;)De();Je(t.enPassantTarget);for(const e of t.movedPawns)Kt(e);for(const e of t.moveHistory)je().find(n=>n.notation===e.notation)||Re(e);J()}function Rt(t,e,n){if(!Oe)return;const s=Oe.querySelector(".timer.white"),i=Oe.querySelector(".timer.black");if(s){s.classList.toggle("active",n==="white");const r=s.querySelector(".time");r&&(r.textContent=Ie(t))}if(i){i.classList.toggle("active",n==="black");const r=i.querySelector(".time");r&&(r.textContent=Ie(e))}}function Ie(t){const e=Math.max(0,Math.floor(t/1e3)),n=Math.floor(e/60),s=e%60;return`${n}:${s.toString().padStart(2,"0")}`}function Ut(){const t=document.getElementById("currentTurnIndicator");if(t&&ce()){const e=vt();t.classList.toggle("my-turn",e)}}function gi(t){const e=document.createElement("div");e.className="game-over-modal",e.innerHTML=`
    <div class="modal-content">
      <h2>Game Over</h2>
      <p>${t}</p>
      <button id="closeGameOverBtn" class="modal-btn">OK</button>
    </div>
  `,document.body.appendChild(e),document.getElementById("closeGameOverBtn")?.addEventListener("click",()=>{e.remove(),Zs(),En(),_n(),bn(wn)})}let U=null;function yi(){U=document.getElementById("authContainer"),U||(U=document.createElement("div"),U.id="authContainer",document.body.appendChild(U)),Rs()?(wt(),_t()):ke()}function ke(){U&&(U.innerHTML=`
    <div class="auth-buttons">
      <button id="loginBtn" class="auth-btn">Login</button>
      <button id="registerBtn" class="auth-btn">Register</button>
    </div>
  `,document.getElementById("loginBtn")?.addEventListener("click",ki),document.getElementById("registerBtn")?.addEventListener("click",vi))}function wt(){if(!U)return;const t=yt();if(!t){ke();return}U.innerHTML=`
    <div class="user-status">
      <span class="user-info">
        <span class="username">${t.username}</span>
        <span class="friend-code">#${t.friendCode}</span>
      </span>
      <span class="user-stats">${t.stats.wins}W ${t.stats.losses}L ${t.stats.draws}D</span>
      <button id="logoutBtn" class="auth-btn small">Logout</button>
    </div>
  `,document.getElementById("logoutBtn")?.addEventListener("click",wi)}function ki(){U&&(U.innerHTML=`
    <div class="auth-form">
      <h3>Login</h3>
      <form id="loginForm">
        <input type="text" id="loginUsername" placeholder="Username or Email" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <div class="auth-error" id="loginError"></div>
        <div class="auth-form-buttons">
          <button type="submit" class="auth-btn primary">Login</button>
          <button type="button" id="loginCancel" class="auth-btn">Cancel</button>
        </div>
      </form>
    </div>
  `,document.getElementById("loginForm")?.addEventListener("submit",bi),document.getElementById("loginCancel")?.addEventListener("click",ke))}function vi(){U&&(U.innerHTML=`
    <div class="auth-form">
      <h3>Register</h3>
      <form id="registerForm">
        <input type="text" id="regUsername" placeholder="Username" required minlength="3" maxlength="32">
        <input type="email" id="regEmail" placeholder="Email" required>
        <input type="password" id="regPassword" placeholder="Password" required minlength="6">
        <div class="auth-error" id="registerError"></div>
        <div class="auth-form-buttons">
          <button type="submit" class="auth-btn primary">Register</button>
          <button type="button" id="registerCancel" class="auth-btn">Cancel</button>
        </div>
      </form>
    </div>
  `,document.getElementById("registerForm")?.addEventListener("submit",Ei),document.getElementById("registerCancel")?.addEventListener("click",ke))}async function bi(t){t.preventDefault();const e=document.getElementById("loginUsername").value,n=document.getElementById("loginPassword").value,s=document.getElementById("loginError"),i=await Gs(e,n);i.success?(wt(),_t()):s&&(s.textContent=i.error||"Login failed")}async function Ei(t){t.preventDefault();const e=document.getElementById("regUsername").value,n=document.getElementById("regEmail").value,s=document.getElementById("regPassword").value,i=document.getElementById("registerError"),r=await Hs(e,n,s);r.success?(wt(),_t()):i&&(i.textContent=r.error||"Registration failed")}function wi(){Fs(),Ws(),pi(),ke()}async function _t(){try{await Vs(),di(),zs(),fi()}catch(t){console.error("Failed to connect:",t)}}Tn();document.addEventListener("DOMContentLoaded",()=>{Et(),ni(),yi()});
