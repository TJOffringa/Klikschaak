(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();const Ci={nl:{title:"Klikschaak",subtitle:"Combineer stukken voor strategische dominantie",newGame:"Nieuw Spel",whiteToMove:"Wit aan zet",blackToMove:"Zwart aan zet",moves:"Zetten",noMoves:"Nog geen zetten",gameRules:"Spelregels",klik:"Klikken:",unklik:"Ontklikken:",kingWarning:"Koning mag NOOIT klikken!",promotionTip:"Promotie: alleen met een pionzet!",autoPromote:"Automatisch promoveren tot dame",selected:"Geselecteerd",possibleMoves:"mogelijke zetten",choosePromotion:"Kies een stuk voor promotie:",chooseCastling:"Kies rokade optie:",onlyRook:"Alleen toren",bothPieces:"Beide stukken",chooseMove:"Kies zet type:",enPassant:"En passant",normalMove:"Normale zet",pawnCaptures:"(pion slaat)",moves_:"beweegt",checkmate:"Schaakmat!",stalemate:"Pat!",check:"SCHAAK!",wins:"wint!",draw:"Remise",gameEndsDraw:"Het spel eindigt in remise",analysis:"Analyse",analysisMode:"Analysemodus",boardEditor:"Bord Editor",exitEditor:"Verlaat Editor",exportPGN:"Exporteer PGN",importPGN:"Importeer PGN",playFromHere:"Speel vanaf hier",backToGame:"Terug naar Spel",pieces:"Stukken",turnToMove:"Aan zet",white:"Wit",black:"Zwart",clearBoard:"Leeg Bord",standardPosition:"Start Positie",loadFEN:"Laad",copyFEN:"Kopieer",copied:"Gekopieerd!",invalidFEN:"Ongeldige FEN",invalidPosition:"Ongeldige positie",copyToClipboard:"Kopieer naar Klembord",downloadFile:"Download Bestand",close:"Sluiten",loadPGN:"Laad PGN",cancel:"Annuleren",pasteHere:"Plak hier...",chooseFile:"Kies Bestand"},en:{title:"Clickchess",subtitle:"Combine pieces for strategic dominance",newGame:"New Game",whiteToMove:"White to move",blackToMove:"Black to move",moves:"Moves",noMoves:"No moves yet",gameRules:"Game Rules",klik:"Click:",unklik:"Unclick:",kingWarning:"King may NEVER click!",promotionTip:"Promotion: only with a pawn move!",autoPromote:"Auto-promote to queen",selected:"Selected",possibleMoves:"possible moves",choosePromotion:"Choose a piece for promotion:",chooseCastling:"Choose castling option:",onlyRook:"Only rook",bothPieces:"Both pieces",chooseMove:"Choose move type:",enPassant:"En passant",normalMove:"Normal move",pawnCaptures:"(pawn captures)",moves_:"moves",checkmate:"Checkmate!",stalemate:"Stalemate!",check:"CHECK!",wins:"wins!",draw:"Draw",gameEndsDraw:"The game ends in a draw",analysis:"Analysis",analysisMode:"Analysis Mode",boardEditor:"Board Editor",exitEditor:"Exit Editor",exportPGN:"Export PGN",importPGN:"Import PGN",playFromHere:"Play from here",backToGame:"Back to Game",pieces:"Pieces",turnToMove:"Turn to move",white:"White",black:"Black",clearBoard:"Clear Board",standardPosition:"Standard Position",loadFEN:"Load",copyFEN:"Copy",copied:"Copied!",invalidFEN:"Invalid FEN",invalidPosition:"Invalid position",copyToClipboard:"Copy to Clipboard",downloadFile:"Download File",close:"Close",loadPGN:"Load PGN",cancel:"Cancel",pasteHere:"Paste here...",chooseFile:"Choose File"}};let ve="nl";function Pi(t){ve=t,localStorage.setItem("klikschaak-language",t)}function ie(){return ve}function Ii(){const t=localStorage.getItem("klikschaak-language");t&&(t==="nl"||t==="en")?ve=t:ve=navigator.language.slice(0,2)==="nl"?"nl":"en"}function g(t){return Ci[ve][t]}function Xe(t){const e={nl:{K:"Koning",Q:"Dame",R:"Toren",B:"Loper",N:"Paard",P:"Pion",k:"koning",q:"dame",r:"toren",b:"loper",n:"paard",p:"pion"},en:{K:"King",Q:"Queen",R:"Rook",B:"Bishop",N:"Knight",P:"Pawn",k:"king",q:"queen",r:"rook",b:"bishop",n:"knight",p:"pawn"}},n=t.charAt(0);return e[ve][n]||t}const _={K:"‚ôî",Q:"‚ôï",R:"‚ôñ",B:"‚ôó",N:"‚ôò",P:"‚ôô",k:"‚ôö",q:"‚ôõ",r:"‚ôú",b:"‚ôù",n:"‚ôû",p:"‚ôü",P0:"‚ôô",P1:"‚ôô",P2:"‚ôô",P3:"‚ôô",P4:"‚ôô",P5:"‚ôô",P6:"‚ôô",P7:"‚ôô",p0:"‚ôü",p1:"‚ôü",p2:"‚ôü",p3:"‚ôü",p4:"‚ôü",p5:"‚ôü",p6:"‚ôü",p7:"‚ôü"},Ti={q:5,r:4,b:3,n:2,p:1,k:6},xi=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]],Li=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]],_i=[[-1,-1],[-1,1],[1,-1],[1,1]],Ni=[[-1,0],[1,0],[0,-1],[0,1]],$i="abcdefgh",Mi="87654321";function E(t){return t===t.toUpperCase()}function U(t){return t.charAt(0).toLowerCase()==="p"}function M(t){return t.charAt(0).toLowerCase()}function cn(t){return Ti[M(t)]||0}function He(t,e){return $i[e]+Mi[t]}function pt(t){return t.map(e=>_[e]).join("")}let v=xn();function xn(){return{board:Ai(),currentTurn:"white",selectedSquare:null,selectedUnklikPiece:null,validMoves:[],moveHistory:[],castlingRights:{white:{kingSide:!0,queenSide:!0},black:{kingSide:!0,queenSide:!0}},enPassantTarget:null,movedPawns:new Set,autoPromoteToQueen:!1,pendingPromotion:null,gameOver:!1}}function Ai(){return Array(8).fill(null).map(()=>Array(8).fill(null).map(()=>({pieces:[]})))}function rt(){v=xn(),v.board[7][0].pieces=["R"],v.board[7][1].pieces=["N"],v.board[7][2].pieces=["B"],v.board[7][3].pieces=["Q"],v.board[7][4].pieces=["K"],v.board[7][5].pieces=["B"],v.board[7][6].pieces=["N"],v.board[7][7].pieces=["R"];for(let t=0;t<8;t++)v.board[6][t].pieces=[`P${t}`];v.board[0][0].pieces=["r"],v.board[0][1].pieces=["n"],v.board[0][2].pieces=["b"],v.board[0][3].pieces=["q"],v.board[0][4].pieces=["k"],v.board[0][5].pieces=["b"],v.board[0][6].pieces=["n"],v.board[0][7].pieces=["r"];for(let t=0;t<8;t++)v.board[1][t].pieces=[`p${t}`]}function N(){return v.board}function A(){return v.currentTurn}function Ze(){return v.selectedSquare}function et(){return v.selectedUnklikPiece}function be(){return v.validMoves}function $e(){return v.moveHistory}function se(){return v.castlingRights}function oe(){return v.enPassantTarget}function re(){return v.movedPawns}function Fe(){return v.autoPromoteToQueen}function Ln(){return v.pendingPromotion}function ct(){return v.gameOver}function me(t){v.selectedSquare=t}function xe(t){v.selectedUnklikPiece=t}function ge(t){v.validMoves=t}function tt(t){v.enPassantTarget=t}function Oi(t){v.autoPromoteToQueen=t}function Le(t){v.pendingPromotion=t}function qi(t){v.gameOver=t}function Ee(){v.currentTurn=v.currentTurn==="white"?"black":"white"}function at(t){v.moveHistory.push(t)}function _n(t){v.movedPawns.add(t)}function Ce(t,e,n,i,s){n===7&&i===0&&s.includes("R")&&(v.castlingRights.white.queenSide=!1),n===7&&i===7&&s.includes("R")&&(v.castlingRights.white.kingSide=!1),n===0&&i===0&&s.includes("r")&&(v.castlingRights.black.queenSide=!1),n===0&&i===7&&s.includes("r")&&(v.castlingRights.black.kingSide=!1),s.includes("R")&&t===7&&e===0&&(v.castlingRights.white.queenSide=!1),s.includes("R")&&t===7&&e===7&&(v.castlingRights.white.kingSide=!1),s.includes("r")&&t===0&&e===0&&(v.castlingRights.black.queenSide=!1),s.includes("r")&&t===0&&e===7&&(v.castlingRights.black.kingSide=!1)}function Et(t){t==="white"?v.castlingRights.white={kingSide:!1,queenSide:!1}:v.castlingRights.black={kingSide:!1,queenSide:!1}}function H(){v.selectedSquare=null,v.selectedUnklikPiece=null,v.validMoves=[]}function w(t,e,n){v.board[t][e].pieces=n}function Me(t,e){return v.board[t][e].pieces}function wt(t,e,n,i){for(let s=0;s<8;s++)for(let o=0;o<8;o++){const r=t[s][o].pieces;if(r.length!==0&&E(r[0])!==i){for(const c of r)if(Di(t,s,o,c,e,n))return!0}}return!1}function Di(t,e,n,i,s,o){const r=M(i),c=E(i);if(r==="p"){const a=c?-1:1;return Math.abs(n-o)===1&&e+a===s}if(r==="n"){const a=Math.abs(e-s),l=Math.abs(n-o);return a===2&&l===1||a===1&&l===2}if(r==="k")return Math.abs(e-s)<=1&&Math.abs(n-o)<=1;if((r==="b"||r==="q")&&Math.abs(e-s)===Math.abs(n-o)){const a=s>e?1:-1,l=o>n?1:-1;let d=e+a,p=n+l;for(;d!==s||p!==o;){if(t[d][p].pieces.length>0)return!1;d+=a,p+=l}return!0}if((r==="r"||r==="q")&&(e===s||n===o)){const a=e===s?0:s>e?1:-1,l=n===o?0:o>n?1:-1;let d=e+a,p=n+l;for(;d!==s||p!==o;){if(t[d][p].pieces.length>0)return!1;d+=a,p+=l}return!0}return!1}function nt(t,e,n,i,s,o,r){const c=[],a=E(i),l=M(i);if(l==="p"){const d=a?-1:1,p=a?6:1;e+d>=0&&e+d<8&&t[e+d][n].pieces.length===0&&(c.push([e+d,n]),e===p&&!r.has(i)&&t[e+2*d][n].pieces.length===0&&c.push([e+2*d,n]));for(const h of[-1,1]){const u=n+h;if(u>=0&&u<8&&e+d>=0&&e+d<8){const f=t[e+d][u];f.pieces.length>0&&E(f.pieces[0])!==a&&c.push([e+d,u]),o&&o.row===e+d&&o.col===u&&c.push([e+d,u,"en-passant"])}}}if(l==="n")for(const[d,p]of xi){const h=e+d,u=n+p;h>=0&&h<8&&u>=0&&u<8&&c.push([h,u])}if(l==="b"||l==="q")for(const[d,p]of _i)for(let h=1;h<8;h++){const u=e+d*h,f=n+p*h;if(u<0||u>=8||f<0||f>=8||(c.push([u,f]),t[u][f].pieces.length>0))break}if(l==="r"||l==="q")for(const[d,p]of Ni)for(let h=1;h<8;h++){const u=e+d*h,f=n+p*h;if(u<0||u>=8||f<0||f>=8||(c.push([u,f]),t[u][f].pieces.length>0))break}if(l==="k"){for(const[h,u]of Li){const f=e+h,y=n+u;if(f>=0&&f<8&&y>=0&&y<8){const m=t[f][y];(m.pieces.length===0||E(m.pieces[0])!==a)&&c.push([f,y])}}const d=a?s.white:s.black,p=a?7:0;if(d.kingSide){const h=t[p][7],u=t[p][5];t[p][6].pieces.length===0&&h.pieces.length>0&&h.pieces.some(y=>M(y)==="r")&&(u.pieces.length===0?h.pieces.length===1?c.push([p,6,"castle-k"]):h.pieces.length===2&&c.push([p,6,"castle-k-choice"]):u.pieces.length===1&&E(u.pieces[0])===a&&(h.pieces.length===1?c.push([p,6,"castle-k-klik"]):h.pieces.length===2&&c.push([p,6,"castle-k-unklik-klik"])))}if(d.queenSide){const h=t[p][0],u=t[p][3],f=t[p][2],y=t[p][1];f.pieces.length===0&&y.pieces.length===0&&h.pieces.length>0&&h.pieces.some(m=>M(m)==="r")&&(u.pieces.length===0?h.pieces.length===1?c.push([p,2,"castle-q"]):h.pieces.length===2&&c.push([p,2,"castle-q-choice"]):u.pieces.length===1&&E(u.pieces[0])===a&&(h.pieces.length===1?c.push([p,2,"castle-q-klik"]):h.pieces.length===2&&c.push([p,2,"castle-q-unklik-klik"])))}}return c}function Ae(t,e,n,i,s,o,r,c){const a=t.map(h=>h.map(u=>({pieces:[...u.pieces]}))),l=E(o[0]);if(r==="en-passant"){const h=l?i+1:i-1;a[h][s].pieces=[],a[i][s].pieces=[...o],a[e][n].pieces=[]}else if(r==="en-passant-unklik"){const h=l?i+1:i-1;a[h][s].pieces=[];const u=o[c];a[i][s].pieces=[u],a[e][n].pieces=a[e][n].pieces.filter((f,y)=>y!==c)}else if(r==="unklik"||r==="unklik-klik"){const h=o[c];r==="unklik-klik"?a[i][s].pieces=[...a[i][s].pieces,h]:a[i][s].pieces=[h],a[e][n].pieces=a[e][n].pieces.filter((u,f)=>f!==c)}else if(r==="klik")a[i][s].pieces=[...a[i][s].pieces,...o],a[e][n].pieces=[];else if(r?.startsWith("castle-")){const h=r.startsWith("castle-k"),u=h?7:0,f=h?5:3;a[i][s].pieces=o,a[e][n].pieces=[];const y=[...a[e][u].pieces];if(a[e][u].pieces=[],r.includes("unklik-klik")){const B=y.find(b=>M(b)==="r"),I=[...a[e][f].pieces];a[e][f].pieces=[B,...I]}else if(r.includes("klik")&&!r.includes("unklik")){const B=[...a[e][f].pieces];a[e][f].pieces=[...y,...B]}else if(r.includes("both"))a[e][f].pieces=y;else if(y.length===2){const B=y.find(I=>M(I)==="r");a[e][f].pieces=[B]}else a[e][f].pieces=y;const m=h?n+1:n-1;for(const B of[n,m,s])if(wt(a,e,B,l))return!0}else a[i][s].pieces=[...o],a[e][n].pieces=[];let d=-1,p=-1;for(let h=0;h<8;h++){for(let u=0;u<8;u++)if(a[h][u].pieces.includes(l?"K":"k")){d=h,p=u;break}if(d!==-1)break}return d===-1?!1:wt(a,d,p,l)}function ye(t,e,n,i,s,o,r,c){const a=new Map,l=E(i[0]),d=i.length===1,p=i.some(u=>U(u));for(const u of i){const f=nt(t,e,n,u,s,o,r);for(const y of f){const[m,B,I]=y,b=`${m},${B}`,L=t[m][B],$=U(u),D=l&&m===0||!l&&m===7;if(p&&i.length===2&&!$&&D||p&&(l&&m===7||!l&&m===0))continue;if(I==="en-passant"){const V=a.get(b);V&&V.type!=="en-passant"?a.set(b,{row:m,col:B,type:"en-passant-choice"}):a.set(b,{row:m,col:B,type:"en-passant"});continue}const R=a.get(b);if(R&&R.type==="en-passant"){a.set(b,{row:m,col:B,type:"en-passant-choice"});continue}if(!d)(L.pieces.length===0||E(L.pieces[0])!==l)&&a.set(b,{row:m,col:B,type:I||"normal"});else if(L.pieces.length>0&&E(L.pieces[0])===l){const V=U(u),z=V&&n===B,rn=!L.pieces.some(ft=>M(ft)==="k")&&!i.some(ft=>M(ft)==="k");z&&L.pieces.length<2&&rn?a.set(b,{row:m,col:B,type:"klik"}):!V&&L.pieces.length<2&&rn&&a.set(b,{row:m,col:B,type:"klik"})}else(L.pieces.length===0||E(L.pieces[0])!==l)&&a.set(b,{row:m,col:B,type:I||"normal"})}}if(d){const u=i.find(f=>U(f));if(u){const f=l?-1:1,y=l?6:1;if(e+f>=0&&e+f<8){const m=t[e+f][n];if(m.pieces.length===1&&E(m.pieces[0])===l&&!m.pieces.some(B=>M(B)==="k")){const B=`${e+f},${n}`;a.set(B,{row:e+f,col:n,type:"klik"})}}if(e===y&&!r.has(u)&&e+2*f>=0&&e+2*f<8){const m=t[e+2*f][n];if(t[e+f][n].pieces.length===0&&m.pieces.length===1&&E(m.pieces[0])===l&&!m.pieces.some(I=>M(I)==="k")){const I=`${e+2*f},${n}`;a.set(I,{row:e+2*f,col:n,type:"klik"})}}}}let h=Array.from(a.values());return h=h.filter(u=>!Ae(t,e,n,u.row,u.col,i,u.type,c)),h}function Ri(t,e){const n=e==="white";let i=-1,s=-1;for(let o=0;o<8;o++){for(let r=0;r<8;r++)if(t[o][r].pieces.includes(n?"K":"k")){i=o,s=r;break}if(i!==-1)break}return i===-1?!1:wt(t,i,s,n)}function Ui(t,e,n,i,s){const o=e==="white";for(let r=0;r<8;r++)for(let c=0;c<8;c++){const a=t[r][c].pieces;if(a.length===0||E(a[0])!==o)continue;if(ye(t,r,c,a,n,i,s,null).length>0)return!0;if(a.length===2)for(let d=0;d<2;d++){const p=a[d],h=nt(t,r,c,p,n,i,s);for(const u of h){const[f,y]=u,m=t[f][y];if(m.pieces.length===0||E(m.pieces[0])!==o){if(!Ae(t,r,c,f,y,a,"unklik",d))return!0}else if(m.pieces.length<2&&E(m.pieces[0])===o&&!m.pieces.some(B=>M(B)==="k")&&!Ae(t,r,c,f,y,a,"unklik-klik",d))return!0}}}return!1}const Hi="modulepreload",Fi=function(t,e){return new URL(t,e).href},an={},Gi=function(e,n,i){let s=Promise.resolve();if(n&&n.length>0){let l=function(d){return Promise.all(d.map(p=>Promise.resolve(p).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};const r=document.getElementsByTagName("link"),c=document.querySelector("meta[property=csp-nonce]"),a=c?.nonce||c?.getAttribute("nonce");s=l(n.map(d=>{if(d=Fi(d,i),d in an)return;an[d]=!0;const p=d.endsWith(".css"),h=p?'[rel="stylesheet"]':"";if(i)for(let f=r.length-1;f>=0;f--){const y=r[f];if(y.href===d&&(!p||y.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${h}`))return;const u=document.createElement("link");if(u.rel=p?"stylesheet":Hi,p||(u.as="script"),u.crossOrigin="",u.href=d,a&&u.setAttribute("nonce",a),document.head.appendChild(u),p)return new Promise((f,y)=>{u.addEventListener("load",f),u.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${d}`)))})}))}function o(r){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=r,window.dispatchEvent(c),!c.defaultPrevented)throw r}return s.then(r=>{for(const c of r||[])c.status==="rejected"&&o(c.reason);return e().catch(o)})};let P={isActive:!1,initialBoard:[],initialTurn:"white",moveIndex:-1,savedMoves:[],boardStates:[]};function X(){return P.isActive}function Bt(){return P.moveIndex}function Wi(){return P.savedMoves.length}function qt(){return P.savedMoves}function Nn(t,e){P={isActive:!0,initialBoard:it(N()),initialTurn:A(),moveIndex:t.length-1,savedMoves:[...t],boardStates:[]},Xi()}function Ki(t=!0){if(rt(),!t)for(let e=0;e<8;e++)for(let n=0;n<8;n++)w(e,n,[]);P={isActive:!0,initialBoard:it(N()),initialTurn:"white",moveIndex:-1,savedMoves:[],boardStates:[{board:it(N()),turn:"white",enPassantTarget:null,castlingRights:{white:{kingSide:!0,queenSide:!0},black:{kingSide:!0,queenSide:!0}},movedPawns:[]}]}}function Vi(){P={isActive:!1,initialBoard:[],initialTurn:"white",moveIndex:-1,savedMoves:[],boardStates:[]}}function we(t){if(t<-1||t>=P.savedMoves.length)return;P.moveIndex=t;const e=t+1;if(e>=0&&e<P.boardStates.length){const n=P.boardStates[e];Qi(n)}}function zi(){we(-1)}function $n(){we(P.savedMoves.length-1)}function ji(){P.moveIndex>=0&&we(P.moveIndex-1)}function Yi(){P.moveIndex<P.savedMoves.length-1&&we(P.moveIndex+1)}function Dt(t){P.moveIndex<P.savedMoves.length-1&&(P.savedMoves=P.savedMoves.slice(0,P.moveIndex+1),P.boardStates=P.boardStates.slice(0,P.moveIndex+2)),P.savedMoves.push(t),P.boardStates.push(Ji()),P.moveIndex=P.savedMoves.length-1}function it(t){return t.map(e=>e.map(n=>({pieces:[...n.pieces]})))}function Ji(){return{board:it(N()),turn:A(),enPassantTarget:oe(),castlingRights:JSON.parse(JSON.stringify(se())),movedPawns:Array.from(re())}}function Qi(t){for(let e=0;e<8;e++)for(let n=0;n<8;n++)w(e,n,[...t.board[e][n].pieces]);for(;A()!==t.turn;)Ee();tt(t.enPassantTarget),H()}function Xi(){P.boardStates=[{board:P.initialBoard,turn:P.initialTurn,enPassantTarget:null,castlingRights:{white:{kingSide:!0,queenSide:!0},black:{kingSide:!0,queenSide:!0}},movedPawns:[]}]}let ce={isActive:!1,selectedPiece:null,turnToMove:"white"};const ln={white:["K","Q","R","B","N","P0"],black:["k","q","r","b","n","p0"]};function ke(){return ce.isActive}function Mn(){return ce.selectedPiece}function Zi(){return ce.turnToMove}function es(){ce={isActive:!0,selectedPiece:null,turnToMove:"white"}}function St(){ce={isActive:!1,selectedPiece:null,turnToMove:"white"}}function dn(t){ce.selectedPiece=t}function An(t){for(ce.turnToMove=t;A()!==t;)Ee()}function ts(t,e){if(!ce.selectedPiece)return;const n=Me(t,e);let i=ce.selectedPiece;if((i==="P0"||i==="p0")&&(i=is(i[0])),n.length<2)if(n.some(r=>r==="K"||r==="k")||(i==="K"||i==="k"))w(t,e,[i]);else if(n.length>0){const r=n[0].toUpperCase()===n[0],c=i.toUpperCase()===i;r===c?w(t,e,[...n,i]):w(t,e,[i])}else w(t,e,[i]);else w(t,e,[i])}function ns(t,e,n){Me(t,e),w(t,e,[])}function On(){for(let t=0;t<8;t++)for(let e=0;e<8;e++)w(t,e,[])}function qn(){rt()}function is(t){const e=N(),n=new Set;for(let i=0;i<8;i++)for(let s=0;s<8;s++)for(const o of e[i][s].pieces)o.startsWith(t)&&n.add(o);for(let i=0;i<16;i++){const s=`${t}${i}`;if(!n.has(s))return s}return`${t}0`}function ss(){const t=N(),e=[];let n=0,i=0;for(let s=0;s<8;s++)for(let o=0;o<8;o++)for(const r of t[s][o].pieces)r==="K"&&n++,r==="k"&&i++;return n===0&&e.push("White needs a king"),n>1&&e.push("White has too many kings"),i===0&&e.push("Black needs a king"),i>1&&e.push("Black has too many kings"),{valid:e.length===0,errors:e}}function Rt(){const t=N(),e=[];for(let i=0;i<8;i++){let s="",o=0;for(let r=0;r<8;r++){const c=t[i][r].pieces;c.length===0?o++:(o>0&&(s+=o,o=0),c.length===1?s+=un(c[0]):s+="("+c.map(un).join("")+")")}o>0&&(s+=o),e.push(s)}const n=A()==="white"?"w":"b";return`${e.join("/")} ${n}`}function Dn(t){try{const e=t.trim().split(" "),n=e[0],i=e[1]||"w";On();const s=n.split("/");if(s.length!==8)return!1;for(let o=0;o<8;o++){let r=0,c=0;const a=s[o];for(;c<a.length&&r<8;){const l=a[c];if(l>="1"&&l<="8")r+=parseInt(l),c++;else if(l==="("){const d=a.indexOf(")",c);if(d===-1)return!1;const p=a.substring(c+1,d),h=[];for(const u of p){const f=hn(u);f&&h.push(f)}w(o,r,h),r++,c=d+1}else{const d=hn(l);d&&w(o,r,[d]),r++,c++}}}return An(i==="b"?"black":"white"),!0}catch{return!1}}function un(t){const e=t[0];return"KQRBNPkqrbnp".includes(e),e}function hn(t){const e={P:0,p:0};return t==="P"?`P${e.P++%8}`:t==="p"?`p${e.p++%8}`:"KQRBNkqrbn".includes(t)?t:null}function os(t){const i=['[Event "Klikschaak Game"]','[Site "Klikschaak Online"]',`[Date "${new Date().toISOString().split("T")[0].replace(/-/g,".")}"]`,'[Round "-"]',`[White "${t.white||"Player 1"}"]`,`[Black "${t.black||"Player 2"}"]`,`[Result "${t.result||"*"}"]`,'[Variant "Klikschaak"]'];t.fen&&(i.push(`[FEN "${t.fen}"]`),i.push('[SetUp "1"]'));const s=rs(t.moves);return i.join(`
`)+`

`+s+" "+(t.result||"*")}function rs(t){const e=[];let n="";for(let i=0;i<t.length;i+=2){const s=Math.floor(i/2)+1,o=t[i]?.notation||"",r=t[i+1]?.notation||"";let c=`${s}. ${o}`;r&&(c+=` ${r}`),n.length+c.length>75?(e.push(n.trim()),n=c+" "):n+=c+" "}return n.trim()&&e.push(n.trim()),e.join(`
`)}function cs(t){try{const e=t.trim().split(`
`),n={};let i="";for(const o of e){const r=o.trim();if(r.startsWith("[")&&r.endsWith("]")){const c=r.match(/\[(\w+)\s+"(.*)"\]/);c&&(n[c[1].toLowerCase()]=c[2])}else r.length>0&&(i+=" "+r)}const s=as(i);return{event:n.event||"Unknown",site:n.site||"Unknown",date:n.date||"",round:n.round||"-",white:n.white||"White",black:n.black||"Black",result:n.result||"*",variant:n.variant||"Standard",fen:n.fen,moves:s}}catch(e){return console.error("Error parsing PGN:",e),null}}function as(t){const e=[],i=t.replace(/1-0|0-1|1\/2-1\/2|\*/g,"").replace(/\{[^}]*\}/g,"").replace(/\([^)]*\)/g,"").replace(/\$\d+/g,"").trim().split(/\s+/).filter(o=>o.length>0);let s="white";for(const o of i){if(/^\d+\.+$/.test(o)){s="white";continue}const r=o.match(/^(\d+)\.(.*)/);if(r&&r[2]){s="white",e.push({turn:s,notation:r[2]}),s="black";continue}o.length>0&&!o.match(/^\d+$/)&&(e.push({turn:s,notation:o}),s=s==="white"?"black":"white")}return e}function ls(t,e="game.pgn"){const n=new Blob([t],{type:"application/x-chess-pgn"}),i=URL.createObjectURL(n),s=document.createElement("a");s.href=i,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i)}async function ds(t){try{return await navigator.clipboard.writeText(t),!0}catch{return!1}}function us(t){return new Promise((e,n)=>{const i=new FileReader;i.onload=s=>{const o=s.target?.result;typeof o=="string"?e(o):n(new Error("Failed to read file"))},i.onerror=()=>n(i.error),i.readAsText(t)})}let ee=null;function Ut(t,e,n){ee=document.getElementById("analysisContainer"),ee||(ee=document.createElement("div"),ee.id="analysisContainer",document.body.appendChild(ee)),t&&t.length>0?Nn(t):Ki(!0),Ht(e,n),x(),O(),_e()}function mt(){ee&&(ee.innerHTML=""),Vi(),St()}function Ht(t,e){if(!ee)return;const n=qt(),i=Bt();ee.innerHTML=`
    <div class="analysis-panel">
      <div class="analysis-header">
        <h3>${g("analysisMode")}</h3>
        <button id="closeAnalysisBtn" class="analysis-close-btn">&times;</button>
      </div>

      <div class="analysis-players">
        ${t?`<span class="player-white">‚¨ú ${t}</span>`:""}
        ${e?`<span class="player-black">‚¨õ ${e}</span>`:""}
      </div>

      <div class="analysis-controls">
        <button id="goStartBtn" class="nav-btn" title="Go to start">‚èÆ</button>
        <button id="goBackBtn" class="nav-btn" title="Previous move">‚óÄ</button>
        <span class="move-counter">${i+1} / ${n.length}</span>
        <button id="goForwardBtn" class="nav-btn" title="Next move">‚ñ∂</button>
        <button id="goEndBtn" class="nav-btn" title="Go to end">‚è≠</button>
      </div>

      <div class="analysis-moves" id="analysisMoveList">
        ${Rn(n,i)}
      </div>

      <div class="analysis-actions">
        <button id="toggleEditorBtn" class="analysis-btn">
          ${ke()?g("exitEditor"):g("boardEditor")}
        </button>
        <button id="exportPGNBtn" class="analysis-btn">${g("exportPGN")}</button>
        <button id="importPGNBtn" class="analysis-btn">${g("importPGN")}</button>
      </div>

      <div id="editorPanel" class="editor-panel ${ke()?"":"hidden"}">
        ${Un()}
      </div>

      <div class="engine-compare" id="engineComparePanel">
        <div class="compare-header">
          <span class="compare-status" id="engineStatus">Loading...</span>
        </div>
        <div class="compare-counts" id="compareCounts"></div>
        <div class="compare-diff hidden" id="compareDiff"></div>
      </div>

      <div class="analysis-footer">
        <button id="newGameFromHereBtn" class="analysis-btn primary">${g("playFromHere")}</button>
        <button id="exitAnalysisBtn" class="analysis-btn">${g("backToGame")}</button>
      </div>
    </div>
  `,hs()}function Rn(t,e){if(t.length===0)return'<p class="no-moves">No moves yet</p>';const n=[];for(let i=0;i<t.length;i+=2){const s=Math.floor(i/2)+1,o=t[i],r=t[i+1],c=i===e?"active":"",a=i+1===e?"active":"";n.push(`
      <div class="move-pair">
        <span class="move-number">${s}.</span>
        <span class="move-notation ${c}" data-index="${i}">${o?.notation||""}</span>
        <span class="move-notation ${a}" data-index="${i+1}">${r?.notation||""}</span>
      </div>
    `)}return n.join("")}function Un(){const t=Mn(),e=Zi();return`
    <div class="editor-section">
      <h4>${g("pieces")}</h4>
      <div class="piece-palette">
        <div class="palette-row">
          ${ln.white.map(n=>`
            <button class="palette-piece ${t===n?"selected":""}" data-piece="${n}">
              <span class="piece piece-white">${_[n[0]]||_[n]}</span>
            </button>
          `).join("")}
        </div>
        <div class="palette-row">
          ${ln.black.map(n=>`
            <button class="palette-piece ${t===n?"selected":""}" data-piece="${n}">
              <span class="piece piece-black">${_[n[0]]||_[n]}</span>
            </button>
          `).join("")}
        </div>
        <button class="palette-piece erase ${t===null?"selected":""}" data-piece="erase">
          üóëÔ∏è
        </button>
      </div>
    </div>

    <div class="editor-section">
      <h4>${g("turnToMove")}</h4>
      <div class="turn-selector">
        <button class="turn-btn ${e==="white"?"active":""}" data-turn="white">${g("white")}</button>
        <button class="turn-btn ${e==="black"?"active":""}" data-turn="black">${g("black")}</button>
      </div>
    </div>

    <div class="editor-section">
      <h4>Quick actions</h4>
      <div class="editor-actions">
        <button id="clearBoardBtn" class="editor-action-btn">${g("clearBoard")}</button>
        <button id="standardPosBtn" class="editor-action-btn">${g("standardPosition")}</button>
      </div>
    </div>

    <div class="editor-section">
      <h4>FEN</h4>
      <div class="fen-input-group">
        <input type="text" id="fenInput" class="fen-input" placeholder="${g("pasteHere")}" value="${Rt()}">
        <button id="loadFENBtn" class="fen-btn">${g("loadFEN")}</button>
        <button id="copyFENBtn" class="fen-btn">${g("copyFEN")}</button>
      </div>
    </div>
  `}function hs(){document.getElementById("closeAnalysisBtn")?.addEventListener("click",()=>{mt(),Re(),x(),O()}),document.getElementById("goStartBtn")?.addEventListener("click",()=>{zi(),de()}),document.getElementById("goBackBtn")?.addEventListener("click",()=>{ji(),de()}),document.getElementById("goForwardBtn")?.addEventListener("click",()=>{Yi(),de()}),document.getElementById("goEndBtn")?.addEventListener("click",()=>{$n(),de()}),document.getElementById("analysisMoveList")?.addEventListener("click",t=>{const e=t.target;if(e.classList.contains("move-notation")){const n=parseInt(e.dataset.index||"-1");n>=0&&(we(n),de())}}),document.getElementById("toggleEditorBtn")?.addEventListener("click",()=>{ke()?St():es(),Ht(),x()}),document.getElementById("exportPGNBtn")?.addEventListener("click",()=>{fs()}),document.getElementById("importPGNBtn")?.addEventListener("click",()=>{ps()}),document.getElementById("newGameFromHereBtn")?.addEventListener("click",()=>{if(ke()){const t=ss();if(!t.valid){alert(g("invalidPosition")+`:
`+t.errors.join(`
`));return}St()}mt(),H(),x(),O()}),document.getElementById("exitAnalysisBtn")?.addEventListener("click",()=>{mt(),Re(),x(),O()}),Hn()}function Hn(){document.querySelectorAll(".palette-piece").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.piece;dn(e==="erase"?null:e),fn()})}),document.querySelectorAll(".turn-btn").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.turn;An(e),fn()})}),document.getElementById("clearBoardBtn")?.addEventListener("click",()=>{On(),x(),Ct(),_e()}),document.getElementById("standardPosBtn")?.addEventListener("click",()=>{qn(),x(),Ct(),_e()}),document.getElementById("loadFENBtn")?.addEventListener("click",()=>{const t=document.getElementById("fenInput");t?.value&&(Dn(t.value)?(x(),_e()):alert(g("invalidFEN")))}),document.getElementById("copyFENBtn")?.addEventListener("click",async()=>{const t=Rt();try{await navigator.clipboard.writeText(t);const e=document.getElementById("copyFENBtn");e&&(e.textContent=g("copied"),setTimeout(()=>{e.textContent=g("copyFEN")},2e3))}catch{alert(g("invalidFEN"))}})}function de(){x(),O();const t=document.getElementById("analysisMoveList");t&&(t.innerHTML=Rn(qt(),Bt()),t.querySelectorAll(".move-notation").forEach(n=>{n.addEventListener("click",()=>{const i=parseInt(n.dataset.index||"-1");i>=0&&(we(i),de())})}));const e=document.querySelector(".move-counter");e&&(e.textContent=`${Bt()+1} / ${Wi()}`),_e()}function fn(){const t=document.getElementById("editorPanel");t&&(t.innerHTML=Un(),Hn())}function Ct(){const t=document.getElementById("fenInput");t&&(t.value=Rt())}function _e(){const t=document.getElementById("engineStatus"),e=document.getElementById("compareCounts"),n=document.getElementById("compareDiff");!t||!e||(t.textContent="Comparing...",e.innerHTML="",n&&(n.innerHTML="",n.classList.add("hidden")),Gi(async()=>{const{comparePositionMoves:i}=await import("./engineCompare-CxV41qOH.js");return{comparePositionMoves:i}},[],import.meta.url).then(({comparePositionMoves:i})=>i()).then(i=>{const s=document.getElementById("engineStatus"),o=document.getElementById("compareCounts"),r=document.getElementById("compareDiff");if(!(!s||!o)){if(!i.engineOnline){s.textContent="Engine offline",s.className="compare-status offline",o.innerHTML=`<span class="webapp-count">Webapp: ${i.webappCount} moves</span>`;return}if(i.hasMismatch){if(s.textContent="MISMATCH",s.className="compare-status mismatch",o.innerHTML=`
        <span class="webapp-count">Webapp: <strong>${i.webappCount}</strong></span>
        <span class="separator">|</span>
        <span class="engine-count">Engine: <strong>${i.engineCount}</strong></span>
        <button id="toggleDiffBtn" class="diff-toggle-btn">
          Show diff (${i.webappOnly.length+i.engineOnly.length} different)
        </button>
      `,r){let c='<div class="diff-content">';if(i.webappOnly.length>0){c+='<div class="diff-section webapp-only">',c+=`<h5>Only in Webapp (${i.webappOnly.length}):</h5>`,c+='<div class="move-chips">';for(const a of i.webappOnly)c+=`<span class="move-chip webapp">${a}</span>`;c+="</div></div>"}if(i.engineOnly.length>0){c+='<div class="diff-section engine-only">',c+=`<h5>Only in Engine (${i.engineOnly.length}):</h5>`,c+='<div class="move-chips">';for(const a of i.engineOnly)c+=`<span class="move-chip engine">${a}</span>`;c+="</div></div>"}c+='<div class="diff-section matching">',c+=`<h5>Matching (${i.matching.length}):</h5>`,c+='<div class="move-chips">';for(const a of i.matching)c+=`<span class="move-chip match">${a}</span>`;c+="</div></div>",c+="</div>",r.innerHTML=c}document.getElementById("toggleDiffBtn")?.addEventListener("click",()=>{if(r){r.classList.toggle("hidden");const c=document.getElementById("toggleDiffBtn");c&&(c.textContent=r.classList.contains("hidden")?`Show diff (${i.webappOnly.length+i.engineOnly.length} different)`:"Hide diff")}})}else s.textContent="MATCH",s.className="compare-status match",o.innerHTML=`
        <span class="webapp-count">Webapp: <strong>${i.webappCount}</strong></span>
        <span class="separator">|</span>
        <span class="engine-count">Engine: <strong>${i.engineCount}</strong></span>
      `}}))}function fs(){const t=qt(),e=os({moves:t}),n=document.createElement("div");n.className="analysis-overlay",n.id="exportOverlay",n.innerHTML=`
    <div class="analysis-dialog">
      <h3>${g("exportPGN")}</h3>
      <textarea id="pgnOutput" class="pgn-textarea" readonly>${e}</textarea>
      <div class="dialog-buttons">
        <button id="copyPGNBtn" class="analysis-btn primary">${g("copyToClipboard")}</button>
        <button id="downloadPGNBtn" class="analysis-btn">${g("downloadFile")}</button>
        <button id="closeExportBtn" class="analysis-btn">${g("close")}</button>
      </div>
    </div>
  `,document.body.appendChild(n),document.getElementById("copyPGNBtn")?.addEventListener("click",async()=>{const i=await ds(e),s=document.getElementById("copyPGNBtn");s&&(s.textContent=i?g("copied"):"Failed",setTimeout(()=>{s.textContent=g("copyToClipboard")},2e3))}),document.getElementById("downloadPGNBtn")?.addEventListener("click",()=>{const i=`klikschaak_${new Date().toISOString().split("T")[0]}.pgn`;ls(e,i)}),document.getElementById("closeExportBtn")?.addEventListener("click",()=>{n.remove()})}function ps(){const t=document.createElement("div");t.className="analysis-overlay",t.id="importOverlay",t.innerHTML=`
    <div class="analysis-dialog">
      <h3>${g("importPGN")}</h3>
      <textarea id="pgnInput" class="pgn-textarea" placeholder="${g("pasteHere")}"></textarea>
      <div class="file-input-wrapper">
        <input type="file" id="pgnFileInput" accept=".pgn,.txt">
        <label for="pgnFileInput" class="analysis-btn">${g("chooseFile")}</label>
      </div>
      <div class="dialog-buttons">
        <button id="loadPGNBtn" class="analysis-btn primary">${g("loadPGN")}</button>
        <button id="closeImportBtn" class="analysis-btn">${g("cancel")}</button>
      </div>
    </div>
  `,document.body.appendChild(t),document.getElementById("pgnFileInput")?.addEventListener("change",async e=>{const n=e.target;if(n.files&&n.files[0])try{const i=await us(n.files[0]),s=document.getElementById("pgnInput");s&&(s.value=i)}catch{alert("Failed to read file")}}),document.getElementById("loadPGNBtn")?.addEventListener("click",()=>{const e=document.getElementById("pgnInput");if(e?.value){const n=cs(e.value);n?(n.fen?Dn(n.fen):qn(),Nn(n.moves),t.remove(),Ht(n.white,n.black),$n(),de()):alert("Failed to parse PGN")}}),document.getElementById("closeImportBtn")?.addEventListener("click",()=>{t.remove()})}function ms(t,e){if(!ke())return;Mn()===null?ns(t,e):ts(t,e),x(),Ct()}function gs(){return ke()}function Fn(t,e,n){Ut(t,e,n)}function ys(){if(document.getElementById("analysisBtn"))return;const e=document.createElement("button");e.id="analysisBtn",e.className="analysis-mode-btn",e.textContent=g("analysis"),e.title=g("analysisMode"),e.addEventListener("click",()=>{Ut()}),document.body.appendChild(e)}let ne={from:null,to:null,moveType:null,unklikPieceIndex:null,promotionPiece:null};function vs(){return ne}function Ft(){return ne.from!==null&&ne.to!==null}function bs(t,e,n,i,s){ne={from:t,to:e,moveType:n,unklikPieceIndex:i??null,promotionPiece:null}}function te(){ne={from:null,to:null,moveType:null,unklikPieceIndex:null,promotionPiece:null}}function ks(t,e){return ne.from?.row===t&&ne.from?.col===e?"from":ne.to?.row===t&&ne.to?.col===e?"to":null}const Z=Object.create(null);Z.open="0";Z.close="1";Z.ping="2";Z.pong="3";Z.message="4";Z.upgrade="5";Z.noop="6";const Ve=Object.create(null);Object.keys(Z).forEach(t=>{Ve[Z[t]]=t});const Pt={type:"error",data:"parser error"},Gn=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",Wn=typeof ArrayBuffer=="function",Kn=t=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(t):t&&t.buffer instanceof ArrayBuffer,Gt=({type:t,data:e},n,i)=>Gn&&e instanceof Blob?n?i(e):pn(e,i):Wn&&(e instanceof ArrayBuffer||Kn(e))?n?i(e):pn(new Blob([e]),i):i(Z[t]+(e||"")),pn=(t,e)=>{const n=new FileReader;return n.onload=function(){const i=n.result.split(",")[1];e("b"+(i||""))},n.readAsDataURL(t)};function mn(t){return t instanceof Uint8Array?t:t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}let gt;function Es(t,e){if(Gn&&t.data instanceof Blob)return t.data.arrayBuffer().then(mn).then(e);if(Wn&&(t.data instanceof ArrayBuffer||Kn(t.data)))return e(mn(t.data));Gt(t,!1,n=>{gt||(gt=new TextEncoder),e(gt.encode(n))})}const gn="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Ie=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let t=0;t<gn.length;t++)Ie[gn.charCodeAt(t)]=t;const ws=t=>{let e=t.length*.75,n=t.length,i,s=0,o,r,c,a;t[t.length-1]==="="&&(e--,t[t.length-2]==="="&&e--);const l=new ArrayBuffer(e),d=new Uint8Array(l);for(i=0;i<n;i+=4)o=Ie[t.charCodeAt(i)],r=Ie[t.charCodeAt(i+1)],c=Ie[t.charCodeAt(i+2)],a=Ie[t.charCodeAt(i+3)],d[s++]=o<<2|r>>4,d[s++]=(r&15)<<4|c>>2,d[s++]=(c&3)<<6|a&63;return l},Bs=typeof ArrayBuffer=="function",Wt=(t,e)=>{if(typeof t!="string")return{type:"message",data:Vn(t,e)};const n=t.charAt(0);return n==="b"?{type:"message",data:Ss(t.substring(1),e)}:Ve[n]?t.length>1?{type:Ve[n],data:t.substring(1)}:{type:Ve[n]}:Pt},Ss=(t,e)=>{if(Bs){const n=ws(t);return Vn(n,e)}else return{base64:!0,data:t}},Vn=(t,e)=>e==="blob"?t instanceof Blob?t:new Blob([t]):t instanceof ArrayBuffer?t:t.buffer,zn="",Cs=(t,e)=>{const n=t.length,i=new Array(n);let s=0;t.forEach((o,r)=>{Gt(o,!1,c=>{i[r]=c,++s===n&&e(i.join(zn))})})},Ps=(t,e)=>{const n=t.split(zn),i=[];for(let s=0;s<n.length;s++){const o=Wt(n[s],e);if(i.push(o),o.type==="error")break}return i};function Is(){return new TransformStream({transform(t,e){Es(t,n=>{const i=n.length;let s;if(i<126)s=new Uint8Array(1),new DataView(s.buffer).setUint8(0,i);else if(i<65536){s=new Uint8Array(3);const o=new DataView(s.buffer);o.setUint8(0,126),o.setUint16(1,i)}else{s=new Uint8Array(9);const o=new DataView(s.buffer);o.setUint8(0,127),o.setBigUint64(1,BigInt(i))}t.data&&typeof t.data!="string"&&(s[0]|=128),e.enqueue(s),e.enqueue(n)})}})}let yt;function Ge(t){return t.reduce((e,n)=>e+n.length,0)}function We(t,e){if(t[0].length===e)return t.shift();const n=new Uint8Array(e);let i=0;for(let s=0;s<e;s++)n[s]=t[0][i++],i===t[0].length&&(t.shift(),i=0);return t.length&&i<t[0].length&&(t[0]=t[0].slice(i)),n}function Ts(t,e){yt||(yt=new TextDecoder);const n=[];let i=0,s=-1,o=!1;return new TransformStream({transform(r,c){for(n.push(r);;){if(i===0){if(Ge(n)<1)break;const a=We(n,1);o=(a[0]&128)===128,s=a[0]&127,s<126?i=3:s===126?i=1:i=2}else if(i===1){if(Ge(n)<2)break;const a=We(n,2);s=new DataView(a.buffer,a.byteOffset,a.length).getUint16(0),i=3}else if(i===2){if(Ge(n)<8)break;const a=We(n,8),l=new DataView(a.buffer,a.byteOffset,a.length),d=l.getUint32(0);if(d>Math.pow(2,21)-1){c.enqueue(Pt);break}s=d*Math.pow(2,32)+l.getUint32(4),i=3}else{if(Ge(n)<s)break;const a=We(n,s);c.enqueue(Wt(o?a:yt.decode(a),e)),i=0}if(s===0||s>t){c.enqueue(Pt);break}}}})}const jn=4;function q(t){if(t)return xs(t)}function xs(t){for(var e in q.prototype)t[e]=q.prototype[e];return t}q.prototype.on=q.prototype.addEventListener=function(t,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(e),this};q.prototype.once=function(t,e){function n(){this.off(t,n),e.apply(this,arguments)}return n.fn=e,this.on(t,n),this};q.prototype.off=q.prototype.removeListener=q.prototype.removeAllListeners=q.prototype.removeEventListener=function(t,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var n=this._callbacks["$"+t];if(!n)return this;if(arguments.length==1)return delete this._callbacks["$"+t],this;for(var i,s=0;s<n.length;s++)if(i=n[s],i===e||i.fn===e){n.splice(s,1);break}return n.length===0&&delete this._callbacks["$"+t],this};q.prototype.emit=function(t){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),n=this._callbacks["$"+t],i=1;i<arguments.length;i++)e[i-1]=arguments[i];if(n){n=n.slice(0);for(var i=0,s=n.length;i<s;++i)n[i].apply(this,e)}return this};q.prototype.emitReserved=q.prototype.emit;q.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]};q.prototype.hasListeners=function(t){return!!this.listeners(t).length};const lt=typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,n)=>n(e,0),K=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),Ls="arraybuffer";function Yn(t,...e){return e.reduce((n,i)=>(t.hasOwnProperty(i)&&(n[i]=t[i]),n),{})}const _s=K.setTimeout,Ns=K.clearTimeout;function dt(t,e){e.useNativeTimers?(t.setTimeoutFn=_s.bind(K),t.clearTimeoutFn=Ns.bind(K)):(t.setTimeoutFn=K.setTimeout.bind(K),t.clearTimeoutFn=K.clearTimeout.bind(K))}const $s=1.33;function Ms(t){return typeof t=="string"?As(t):Math.ceil((t.byteLength||t.size)*$s)}function As(t){let e=0,n=0;for(let i=0,s=t.length;i<s;i++)e=t.charCodeAt(i),e<128?n+=1:e<2048?n+=2:e<55296||e>=57344?n+=3:(i++,n+=4);return n}function Jn(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function Os(t){let e="";for(let n in t)t.hasOwnProperty(n)&&(e.length&&(e+="&"),e+=encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e}function qs(t){let e={},n=t.split("&");for(let i=0,s=n.length;i<s;i++){let o=n[i].split("=");e[decodeURIComponent(o[0])]=decodeURIComponent(o[1])}return e}class Ds extends Error{constructor(e,n,i){super(e),this.description=n,this.context=i,this.type="TransportError"}}class Kt extends q{constructor(e){super(),this.writable=!1,dt(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,n,i){return super.emitReserved("error",new Ds(e,n,i)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const n=Wt(e,this.socket.binaryType);this.onPacket(n)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,n={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(n)}_hostname(){const e=this.opts.hostname;return e.indexOf(":")===-1?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&Number(this.opts.port)!==443||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(e){const n=Os(e);return n.length?"?"+n:""}}class Rs extends Kt{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const n=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let i=0;this._polling&&(i++,this.once("pollComplete",function(){--i||n()})),this.writable||(i++,this.once("drain",function(){--i||n()}))}else n()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const n=i=>{if(this.readyState==="opening"&&i.type==="open"&&this.onOpen(),i.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(i)};Ps(e,this.socket.binaryType).forEach(n),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,Cs(e,n=>{this.doWrite(n,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",n=this.query||{};return this.opts.timestampRequests!==!1&&(n[this.opts.timestampParam]=Jn()),!this.supportsBinary&&!n.sid&&(n.b64=1),this.createUri(e,n)}}let Qn=!1;try{Qn=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const Us=Qn;function Hs(){}class Fs extends Rs{constructor(e){if(super(e),typeof location<"u"){const n=location.protocol==="https:";let i=location.port;i||(i=n?"443":"80"),this.xd=typeof location<"u"&&e.hostname!==location.hostname||i!==e.port}}doWrite(e,n){const i=this.request({method:"POST",data:e});i.on("success",n),i.on("error",(s,o)=>{this.onError("xhr post error",s,o)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(n,i)=>{this.onError("xhr poll error",n,i)}),this.pollXhr=e}}class Q extends q{constructor(e,n,i){super(),this.createRequest=e,dt(this,i),this._opts=i,this._method=i.method||"GET",this._uri=n,this._data=i.data!==void 0?i.data:null,this._create()}_create(){var e;const n=Yn(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");n.xdomain=!!this._opts.xd;const i=this._xhr=this.createRequest(n);try{i.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){i.setDisableHeaderCheck&&i.setDisableHeaderCheck(!0);for(let s in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(s)&&i.setRequestHeader(s,this._opts.extraHeaders[s])}}catch{}if(this._method==="POST")try{i.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{i.setRequestHeader("Accept","*/*")}catch{}(e=this._opts.cookieJar)===null||e===void 0||e.addCookies(i),"withCredentials"in i&&(i.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(i.timeout=this._opts.requestTimeout),i.onreadystatechange=()=>{var s;i.readyState===3&&((s=this._opts.cookieJar)===null||s===void 0||s.parseCookies(i.getResponseHeader("set-cookie"))),i.readyState===4&&(i.status===200||i.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof i.status=="number"?i.status:0)},0))},i.send(this._data)}catch(s){this.setTimeoutFn(()=>{this._onError(s)},0);return}typeof document<"u"&&(this._index=Q.requestsCount++,Q.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=Hs,e)try{this._xhr.abort()}catch{}typeof document<"u"&&delete Q.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}Q.requestsCount=0;Q.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",yn);else if(typeof addEventListener=="function"){const t="onpagehide"in K?"pagehide":"unload";addEventListener(t,yn,!1)}}function yn(){for(let t in Q.requests)Q.requests.hasOwnProperty(t)&&Q.requests[t].abort()}const Gs=(function(){const t=Xn({xdomain:!1});return t&&t.responseType!==null})();class Ws extends Fs{constructor(e){super(e);const n=e&&e.forceBase64;this.supportsBinary=Gs&&!n}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new Q(Xn,this.uri(),e)}}function Xn(t){const e=t.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||Us))return new XMLHttpRequest}catch{}if(!e)try{return new K[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const Zn=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class Ks extends Kt{get name(){return"websocket"}doOpen(){const e=this.uri(),n=this.opts.protocols,i=Zn?{}:Yn(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(i.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,n,i)}catch(s){return this.emitReserved("error",s)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let n=0;n<e.length;n++){const i=e[n],s=n===e.length-1;Gt(i,this.supportsBinary,o=>{try{this.doWrite(i,o)}catch{}s&&lt(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",n=this.query||{};return this.opts.timestampRequests&&(n[this.opts.timestampParam]=Jn()),this.supportsBinary||(n.b64=1),this.createUri(e,n)}}const vt=K.WebSocket||K.MozWebSocket;class Vs extends Ks{createSocket(e,n,i){return Zn?new vt(e,n,i):n?new vt(e,n):new vt(e)}doWrite(e,n){this.ws.send(n)}}class zs extends Kt{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(e){return this.emitReserved("error",e)}this._transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(e=>{const n=Ts(Number.MAX_SAFE_INTEGER,this.socket.binaryType),i=e.readable.pipeThrough(n).getReader(),s=Is();s.readable.pipeTo(e.writable),this._writer=s.writable.getWriter();const o=()=>{i.read().then(({done:c,value:a})=>{c||(this.onPacket(a),o())}).catch(c=>{})};o();const r={type:"open"};this.query.sid&&(r.data=`{"sid":"${this.query.sid}"}`),this._writer.write(r).then(()=>this.onOpen())})})}write(e){this.writable=!1;for(let n=0;n<e.length;n++){const i=e[n],s=n===e.length-1;this._writer.write(i).then(()=>{s&&lt(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;(e=this._transport)===null||e===void 0||e.close()}}const js={websocket:Vs,webtransport:zs,polling:Ws},Ys=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,Js=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function It(t){if(t.length>8e3)throw"URI too long";const e=t,n=t.indexOf("["),i=t.indexOf("]");n!=-1&&i!=-1&&(t=t.substring(0,n)+t.substring(n,i).replace(/:/g,";")+t.substring(i,t.length));let s=Ys.exec(t||""),o={},r=14;for(;r--;)o[Js[r]]=s[r]||"";return n!=-1&&i!=-1&&(o.source=e,o.host=o.host.substring(1,o.host.length-1).replace(/;/g,":"),o.authority=o.authority.replace("[","").replace("]","").replace(/;/g,":"),o.ipv6uri=!0),o.pathNames=Qs(o,o.path),o.queryKey=Xs(o,o.query),o}function Qs(t,e){const n=/\/{2,9}/g,i=e.replace(n,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&i.splice(0,1),e.slice(-1)=="/"&&i.splice(i.length-1,1),i}function Xs(t,e){const n={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(i,s,o){s&&(n[s]=o)}),n}const Tt=typeof addEventListener=="function"&&typeof removeEventListener=="function",ze=[];Tt&&addEventListener("offline",()=>{ze.forEach(t=>t())},!1);class le extends q{constructor(e,n){if(super(),this.binaryType=Ls,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&typeof e=="object"&&(n=e,e=null),e){const i=It(e);n.hostname=i.host,n.secure=i.protocol==="https"||i.protocol==="wss",n.port=i.port,i.query&&(n.query=i.query)}else n.host&&(n.hostname=It(n.host).host);dt(this,n),this.secure=n.secure!=null?n.secure:typeof location<"u"&&location.protocol==="https:",n.hostname&&!n.port&&(n.port=this.secure?"443":"80"),this.hostname=n.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=n.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},n.transports.forEach(i=>{const s=i.prototype.name;this.transports.push(s),this._transportsByName[s]=i}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},n),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=qs(this.opts.query)),Tt&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},ze.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const n=Object.assign({},this.opts.query);n.EIO=jn,n.transport=e,this.id&&(n.sid=this.id);const i=Object.assign({},this.opts,{query:n,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](i)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const e=this.opts.rememberUpgrade&&le.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const n=this.createTransport(e);n.open(),this.setTransport(n)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",n=>this._onClose("transport close",n))}onOpen(){this.readyState="open",le.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const n=new Error("server error");n.code=e.data,this._onError(n);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let n=1;for(let i=0;i<this.writeBuffer.length;i++){const s=this.writeBuffer[i].data;if(s&&(n+=Ms(s)),i>0&&n>this._maxPayload)return this.writeBuffer.slice(0,i);n+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,lt(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,n,i){return this._sendPacket("message",e,n,i),this}send(e,n,i){return this._sendPacket("message",e,n,i),this}_sendPacket(e,n,i,s){if(typeof n=="function"&&(s=n,n=void 0),typeof i=="function"&&(s=i,i=null),this.readyState==="closing"||this.readyState==="closed")return;i=i||{},i.compress=i.compress!==!1;const o={type:e,data:n,options:i};this.emitReserved("packetCreate",o),this.writeBuffer.push(o),s&&this.once("flush",s),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},n=()=>{this.off("upgrade",n),this.off("upgradeError",n),e()},i=()=>{this.once("upgrade",n),this.once("upgradeError",n)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?i():e()}):this.upgrading?i():e()),this}_onError(e){if(le.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,n){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),Tt&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const i=ze.indexOf(this._offlineEventListener);i!==-1&&ze.splice(i,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,n),this.writeBuffer=[],this._prevBufferLen=0}}}le.protocol=jn;class Zs extends le{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let n=this.createTransport(e),i=!1;le.priorWebsocketSuccess=!1;const s=()=>{i||(n.send([{type:"ping",data:"probe"}]),n.once("packet",p=>{if(!i)if(p.type==="pong"&&p.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",n),!n)return;le.priorWebsocketSuccess=n.name==="websocket",this.transport.pause(()=>{i||this.readyState!=="closed"&&(d(),this.setTransport(n),n.send([{type:"upgrade"}]),this.emitReserved("upgrade",n),n=null,this.upgrading=!1,this.flush())})}else{const h=new Error("probe error");h.transport=n.name,this.emitReserved("upgradeError",h)}}))};function o(){i||(i=!0,d(),n.close(),n=null)}const r=p=>{const h=new Error("probe error: "+p);h.transport=n.name,o(),this.emitReserved("upgradeError",h)};function c(){r("transport closed")}function a(){r("socket closed")}function l(p){n&&p.name!==n.name&&o()}const d=()=>{n.removeListener("open",s),n.removeListener("error",r),n.removeListener("close",c),this.off("close",a),this.off("upgrading",l)};n.once("open",s),n.once("error",r),n.once("close",c),this.once("close",a),this.once("upgrading",l),this._upgrades.indexOf("webtransport")!==-1&&e!=="webtransport"?this.setTimeoutFn(()=>{i||n.open()},200):n.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const n=[];for(let i=0;i<e.length;i++)~this.transports.indexOf(e[i])&&n.push(e[i]);return n}}let eo=class extends Zs{constructor(e,n={}){const i=typeof e=="object"?e:n;(!i.transports||i.transports&&typeof i.transports[0]=="string")&&(i.transports=(i.transports||["polling","websocket","webtransport"]).map(s=>js[s]).filter(s=>!!s)),super(e,i)}};function to(t,e="",n){let i=t;n=n||typeof location<"u"&&location,t==null&&(t=n.protocol+"//"+n.host),typeof t=="string"&&(t.charAt(0)==="/"&&(t.charAt(1)==="/"?t=n.protocol+t:t=n.host+t),/^(https?|wss?):\/\//.test(t)||(typeof n<"u"?t=n.protocol+"//"+t:t="https://"+t),i=It(t)),i.port||(/^(http|ws)$/.test(i.protocol)?i.port="80":/^(http|ws)s$/.test(i.protocol)&&(i.port="443")),i.path=i.path||"/";const o=i.host.indexOf(":")!==-1?"["+i.host+"]":i.host;return i.id=i.protocol+"://"+o+":"+i.port+e,i.href=i.protocol+"://"+o+(n&&n.port===i.port?"":":"+i.port),i}const no=typeof ArrayBuffer=="function",io=t=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(t):t.buffer instanceof ArrayBuffer,ei=Object.prototype.toString,so=typeof Blob=="function"||typeof Blob<"u"&&ei.call(Blob)==="[object BlobConstructor]",oo=typeof File=="function"||typeof File<"u"&&ei.call(File)==="[object FileConstructor]";function Vt(t){return no&&(t instanceof ArrayBuffer||io(t))||so&&t instanceof Blob||oo&&t instanceof File}function je(t,e){if(!t||typeof t!="object")return!1;if(Array.isArray(t)){for(let n=0,i=t.length;n<i;n++)if(je(t[n]))return!0;return!1}if(Vt(t))return!0;if(t.toJSON&&typeof t.toJSON=="function"&&arguments.length===1)return je(t.toJSON(),!0);for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)&&je(t[n]))return!0;return!1}function ro(t){const e=[],n=t.data,i=t;return i.data=xt(n,e),i.attachments=e.length,{packet:i,buffers:e}}function xt(t,e){if(!t)return t;if(Vt(t)){const n={_placeholder:!0,num:e.length};return e.push(t),n}else if(Array.isArray(t)){const n=new Array(t.length);for(let i=0;i<t.length;i++)n[i]=xt(t[i],e);return n}else if(typeof t=="object"&&!(t instanceof Date)){const n={};for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=xt(t[i],e));return n}return t}function co(t,e){return t.data=Lt(t.data,e),delete t.attachments,t}function Lt(t,e){if(!t)return t;if(t&&t._placeholder===!0){if(typeof t.num=="number"&&t.num>=0&&t.num<e.length)return e[t.num];throw new Error("illegal attachments")}else if(Array.isArray(t))for(let n=0;n<t.length;n++)t[n]=Lt(t[n],e);else if(typeof t=="object")for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(t[n]=Lt(t[n],e));return t}const ao=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"];var C;(function(t){t[t.CONNECT=0]="CONNECT",t[t.DISCONNECT=1]="DISCONNECT",t[t.EVENT=2]="EVENT",t[t.ACK=3]="ACK",t[t.CONNECT_ERROR=4]="CONNECT_ERROR",t[t.BINARY_EVENT=5]="BINARY_EVENT",t[t.BINARY_ACK=6]="BINARY_ACK"})(C||(C={}));class lo{constructor(e){this.replacer=e}encode(e){return(e.type===C.EVENT||e.type===C.ACK)&&je(e)?this.encodeAsBinary({type:e.type===C.EVENT?C.BINARY_EVENT:C.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let n=""+e.type;return(e.type===C.BINARY_EVENT||e.type===C.BINARY_ACK)&&(n+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(n+=e.nsp+","),e.id!=null&&(n+=e.id),e.data!=null&&(n+=JSON.stringify(e.data,this.replacer)),n}encodeAsBinary(e){const n=ro(e),i=this.encodeAsString(n.packet),s=n.buffers;return s.unshift(i),s}}class zt extends q{constructor(e){super(),this.reviver=e}add(e){let n;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");n=this.decodeString(e);const i=n.type===C.BINARY_EVENT;i||n.type===C.BINARY_ACK?(n.type=i?C.EVENT:C.ACK,this.reconstructor=new uo(n),n.attachments===0&&super.emitReserved("decoded",n)):super.emitReserved("decoded",n)}else if(Vt(e)||e.base64)if(this.reconstructor)n=this.reconstructor.takeBinaryData(e),n&&(this.reconstructor=null,super.emitReserved("decoded",n));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let n=0;const i={type:Number(e.charAt(0))};if(C[i.type]===void 0)throw new Error("unknown packet type "+i.type);if(i.type===C.BINARY_EVENT||i.type===C.BINARY_ACK){const o=n+1;for(;e.charAt(++n)!=="-"&&n!=e.length;);const r=e.substring(o,n);if(r!=Number(r)||e.charAt(n)!=="-")throw new Error("Illegal attachments");i.attachments=Number(r)}if(e.charAt(n+1)==="/"){const o=n+1;for(;++n&&!(e.charAt(n)===","||n===e.length););i.nsp=e.substring(o,n)}else i.nsp="/";const s=e.charAt(n+1);if(s!==""&&Number(s)==s){const o=n+1;for(;++n;){const r=e.charAt(n);if(r==null||Number(r)!=r){--n;break}if(n===e.length)break}i.id=Number(e.substring(o,n+1))}if(e.charAt(++n)){const o=this.tryParse(e.substr(n));if(zt.isPayloadValid(i.type,o))i.data=o;else throw new Error("invalid payload")}return i}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,n){switch(e){case C.CONNECT:return vn(n);case C.DISCONNECT:return n===void 0;case C.CONNECT_ERROR:return typeof n=="string"||vn(n);case C.EVENT:case C.BINARY_EVENT:return Array.isArray(n)&&(typeof n[0]=="number"||typeof n[0]=="string"&&ao.indexOf(n[0])===-1);case C.ACK:case C.BINARY_ACK:return Array.isArray(n)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class uo{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const n=co(this.reconPack,this.buffers);return this.finishedReconstruction(),n}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}function vn(t){return Object.prototype.toString.call(t)==="[object Object]"}const ho=Object.freeze(Object.defineProperty({__proto__:null,Decoder:zt,Encoder:lo,get PacketType(){return C}},Symbol.toStringTag,{value:"Module"}));function Y(t,e,n){return t.on(e,n),function(){t.off(e,n)}}const fo=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class ti extends q{constructor(e,n,i){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=n,i&&i.auth&&(this.auth=i.auth),this._opts=Object.assign({},i),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[Y(e,"open",this.onopen.bind(this)),Y(e,"packet",this.onpacket.bind(this)),Y(e,"error",this.onerror.bind(this)),Y(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...n){var i,s,o;if(fo.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(n.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(n),this;const r={type:C.EVENT,data:n};if(r.options={},r.options.compress=this.flags.compress!==!1,typeof n[n.length-1]=="function"){const d=this.ids++,p=n.pop();this._registerAckCallback(d,p),r.id=d}const c=(s=(i=this.io.engine)===null||i===void 0?void 0:i.transport)===null||s===void 0?void 0:s.writable,a=this.connected&&!(!((o=this.io.engine)===null||o===void 0)&&o._hasPingExpired());return this.flags.volatile&&!c||(a?(this.notifyOutgoingListeners(r),this.packet(r)):this.sendBuffer.push(r)),this.flags={},this}_registerAckCallback(e,n){var i;const s=(i=this.flags.timeout)!==null&&i!==void 0?i:this._opts.ackTimeout;if(s===void 0){this.acks[e]=n;return}const o=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let c=0;c<this.sendBuffer.length;c++)this.sendBuffer[c].id===e&&this.sendBuffer.splice(c,1);n.call(this,new Error("operation has timed out"))},s),r=(...c)=>{this.io.clearTimeoutFn(o),n.apply(this,c)};r.withError=!0,this.acks[e]=r}emitWithAck(e,...n){return new Promise((i,s)=>{const o=(r,c)=>r?s(r):i(c);o.withError=!0,n.push(o),this.emit(e,...n)})}_addToQueue(e){let n;typeof e[e.length-1]=="function"&&(n=e.pop());const i={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((s,...o)=>(this._queue[0],s!==null?i.tryCount>this._opts.retries&&(this._queue.shift(),n&&n(s)):(this._queue.shift(),n&&n(null,...o)),i.pending=!1,this._drainQueue())),this._queue.push(i),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const n=this._queue[0];n.pending&&!e||(n.pending=!0,n.tryCount++,this.flags=n.flags,this.emit.apply(this,n.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:C.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,n){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,n),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(i=>String(i.id)===e)){const i=this.acks[e];delete this.acks[e],i.withError&&i.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case C.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case C.EVENT:case C.BINARY_EVENT:this.onevent(e);break;case C.ACK:case C.BINARY_ACK:this.onack(e);break;case C.DISCONNECT:this.ondisconnect();break;case C.CONNECT_ERROR:this.destroy();const i=new Error(e.data.message);i.data=e.data.data,this.emitReserved("connect_error",i);break}}onevent(e){const n=e.data||[];e.id!=null&&n.push(this.ack(e.id)),this.connected?this.emitEvent(n):this.receiveBuffer.push(Object.freeze(n))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const n=this._anyListeners.slice();for(const i of n)i.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const n=this;let i=!1;return function(...s){i||(i=!0,n.packet({type:C.ACK,id:e,data:s}))}}onack(e){const n=this.acks[e.id];typeof n=="function"&&(delete this.acks[e.id],n.withError&&e.data.unshift(null),n.apply(this,e.data))}onconnect(e,n){this.id=e,this.recovered=n&&this._pid===n,this._pid=n,this.connected=!0,this.emitBuffered(),this._drainQueue(!0),this.emitReserved("connect")}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:C.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const n=this._anyListeners;for(let i=0;i<n.length;i++)if(e===n[i])return n.splice(i,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const n=this._anyOutgoingListeners;for(let i=0;i<n.length;i++)if(e===n[i])return n.splice(i,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const n=this._anyOutgoingListeners.slice();for(const i of n)i.apply(this,e.data)}}}function Be(t){t=t||{},this.ms=t.min||100,this.max=t.max||1e4,this.factor=t.factor||2,this.jitter=t.jitter>0&&t.jitter<=1?t.jitter:0,this.attempts=0}Be.prototype.duration=function(){var t=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),n=Math.floor(e*this.jitter*t);t=(Math.floor(e*10)&1)==0?t-n:t+n}return Math.min(t,this.max)|0};Be.prototype.reset=function(){this.attempts=0};Be.prototype.setMin=function(t){this.ms=t};Be.prototype.setMax=function(t){this.max=t};Be.prototype.setJitter=function(t){this.jitter=t};class _t extends q{constructor(e,n){var i;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(n=e,e=void 0),n=n||{},n.path=n.path||"/socket.io",this.opts=n,dt(this,n),this.reconnection(n.reconnection!==!1),this.reconnectionAttempts(n.reconnectionAttempts||1/0),this.reconnectionDelay(n.reconnectionDelay||1e3),this.reconnectionDelayMax(n.reconnectionDelayMax||5e3),this.randomizationFactor((i=n.randomizationFactor)!==null&&i!==void 0?i:.5),this.backoff=new Be({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(n.timeout==null?2e4:n.timeout),this._readyState="closed",this.uri=e;const s=n.parser||ho;this.encoder=new s.Encoder,this.decoder=new s.Decoder,this._autoConnect=n.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var n;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(n=this.backoff)===null||n===void 0||n.setMin(e),this)}randomizationFactor(e){var n;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(n=this.backoff)===null||n===void 0||n.setJitter(e),this)}reconnectionDelayMax(e){var n;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(n=this.backoff)===null||n===void 0||n.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new eo(this.uri,this.opts);const n=this.engine,i=this;this._readyState="opening",this.skipReconnect=!1;const s=Y(n,"open",function(){i.onopen(),e&&e()}),o=c=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",c),e?e(c):this.maybeReconnectOnOpen()},r=Y(n,"error",o);if(this._timeout!==!1){const c=this._timeout,a=this.setTimeoutFn(()=>{s(),o(new Error("timeout")),n.close()},c);this.opts.autoUnref&&a.unref(),this.subs.push(()=>{this.clearTimeoutFn(a)})}return this.subs.push(s),this.subs.push(r),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(Y(e,"ping",this.onping.bind(this)),Y(e,"data",this.ondata.bind(this)),Y(e,"error",this.onerror.bind(this)),Y(e,"close",this.onclose.bind(this)),Y(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(n){this.onclose("parse error",n)}}ondecoded(e){lt(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,n){let i=this.nsps[e];return i?this._autoConnect&&!i.active&&i.connect():(i=new ti(this,e,n),this.nsps[e]=i),i}_destroy(e){const n=Object.keys(this.nsps);for(const i of n)if(this.nsps[i].active)return;this._close()}_packet(e){const n=this.encoder.encode(e);for(let i=0;i<n.length;i++)this.engine.write(n[i],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,n){var i;this.cleanup(),(i=this.engine)===null||i===void 0||i.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,n),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const n=this.backoff.duration();this._reconnecting=!0;const i=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(s=>{s?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",s)):e.onreconnect()}))},n);this.opts.autoUnref&&i.unref(),this.subs.push(()=>{this.clearTimeoutFn(i)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const Pe={};function Ye(t,e){typeof t=="object"&&(e=t,t=void 0),e=e||{};const n=to(t,e.path||"/socket.io"),i=n.source,s=n.id,o=n.path,r=Pe[s]&&o in Pe[s].nsps,c=e.forceNew||e["force new connection"]||e.multiplex===!1||r;let a;return c?a=new _t(i,e):(Pe[s]||(Pe[s]=new _t(i,e)),a=Pe[s]),n.query&&!e.query&&(e.query=n.queryKey),a.socket(n.path,e)}Object.assign(Ye,{Manager:_t,Socket:ti,io:Ye,connect:Ye});const ni="https://klikschaak-api.onrender.com",jt="klikschaak_token",Yt="klikschaak_user";let pe=null;function Se(){return localStorage.getItem(jt)}function Oe(){if(pe)return pe;const t=localStorage.getItem(Yt);if(t)try{return pe=JSON.parse(t),pe}catch{return null}return null}function po(){return Se()!==null&&Oe()!==null}function ii(t,e){localStorage.setItem(jt,e),localStorage.setItem(Yt,JSON.stringify(t)),pe=t}function mo(){localStorage.removeItem(jt),localStorage.removeItem(Yt),pe=null}async function go(t,e,n){try{const i=await fetch(`${ni}/api/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,email:e,password:n})}),s=await i.json();return i.ok?(ii(s.user,s.token),{success:!0}):{success:!1,error:s.error||"Registration failed"}}catch(i){return console.error("Registration error:",i),{success:!1,error:"Network error"}}}async function yo(t,e){try{const n=await fetch(`${ni}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,password:e})}),i=await n.json();return n.ok?(ii(i.user,i.token),{success:!0}):{success:!1,error:i.error||"Login failed"}}catch(n){return console.error("Login error:",n),{success:!1,error:"Network error"}}}function vo(){mo()}let W=null;const bo="https://klikschaak-api.onrender.com";function ko(){return new Promise((t,e)=>{const n=Se();if(!n){e(new Error("Not authenticated"));return}if(W?.connected){t(W);return}W=Ye(bo,{auth:{token:n},reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3}),W.on("connect",()=>{console.log("Connected to server"),t(W)}),W.on("connect_error",i=>{console.error("Connection error:",i.message),e(i)}),W.on("disconnect",i=>{console.log("Disconnected:",i)}),W.on("reconnect",i=>{console.log("Reconnected after",i,"attempts")})})}function F(){return W}function Eo(){W&&(W.disconnect(),W=null)}let k=null,Ne=!1,ae=null,si=null,Nt=null,$t=null,oi=null,ri=null,ci=null,Mt=null;function wo(){const t=F();t&&(t.on("game:created",e=>{k={gameId:e.gameId,gameCode:e.gameCode,myColor:e.color,board:kn(),currentTurn:"white",timer:{white:bn(e.timeControl),black:bn(e.timeControl)},opponent:null,moveHistory:[],enPassantTarget:null,castlingRights:{white:{kingSide:!0,queenSide:!0},black:{kingSide:!0,queenSide:!0}},movedPawns:[],gameStarted:!1,gameOver:!1,result:null},Ne=!0,si?.(e.gameCode)}),t.on("game:joined",e=>{k={gameId:e.gameId,gameCode:e.gameCode,myColor:e.color,board:kn(),currentTurn:"white",timer:{white:42e4,black:42e4},opponent:e.opponent,moveHistory:[],enPassantTarget:null,castlingRights:{white:{kingSide:!0,queenSide:!0},black:{kingSide:!0,queenSide:!0}},movedPawns:[],gameStarted:!1,gameOver:!1,result:null},Ne=!0,Nt?.(k)}),t.on("game:started",e=>{k&&(k.board=e.board,k.currentTurn=e.currentTurn,k.timer=e.timer,k.gameStarted=!0,k.opponent=k.myColor==="white"?e.black:e.white,$t?.(k))}),t.on("game:move-made",e=>{k&&(k.board=e.board,k.currentTurn=e.currentTurn,k.timer=e.timer,k.enPassantTarget=e.enPassantTarget,k.castlingRights=e.castlingRights,k.movedPawns=e.movedPawns,k.moveHistory.push({turn:e.currentTurn==="white"?"black":"white",notation:e.notation}),oi?.(k))}),t.on("game:move-rejected",e=>{Mt?.(e.error)}),t.on("game:timer-sync",e=>{k&&(k.timer=e,ri?.(e.white,e.black))}),t.on("game:over",e=>{k&&(k.gameOver=!0,k.result=e,e.whitePlayerId&&e.blackPlayerId&&(ae={opponentId:(e.whitePlayerId===k.myColor||k.myColor==="white"?e.whitePlayerId:e.blackPlayerId)===e.whitePlayerId?e.blackPlayerId:e.whitePlayerId,opponentName:k.opponent?.username||"Unknown",whitePlayerId:e.whitePlayerId,timeControl:e.timeControl||"standard",customSettings:e.customSettings}),ci?.(e))}),t.on("game:error",e=>{Mt?.(e.message)}),t.on("game:state",e=>{e&&(k={gameId:e.id,gameCode:e.gameCode,myColor:e.yourColor,board:e.board,currentTurn:e.currentTurn,timer:e.timer,opponent:e.yourColor==="white"?e.blackPlayer:e.whitePlayer,moveHistory:e.moveHistory,enPassantTarget:e.enPassantTarget,castlingRights:e.castlingRights,movedPawns:e.movedPawns,gameStarted:e.gameStarted,gameOver:e.gameOver,result:e.result},Ne=!0,Nt?.(k),e.gameStarted&&$t?.(k))}))}function bn(t){switch(t){case"bullet":return 60*1e3;case"blitz-3":return 180*1e3;case"blitz-5":return 300*1e3;case"rapid-7":return 420*1e3;case"standard":return 420*1e3;default:return 420*1e3}}function kn(){return Array(8).fill(null).map(()=>Array(8).fill(null).map(()=>({pieces:[]})))}function Bo(t){t.onGameCreated&&(si=t.onGameCreated),t.onGameJoined&&(Nt=t.onGameJoined),t.onGameStarted&&($t=t.onGameStarted),t.onMoveMade&&(oi=t.onMoveMade),t.onTimerUpdate&&(ri=t.onTimerUpdate),t.onGameOver&&(ci=t.onGameOver),t.onError&&(Mt=t.onError)}function So(t="standard",e){F()?.emit("game:create",{timeControl:t,customSettings:e})}function Co(t){F()?.emit("game:join",{gameCode:t.toUpperCase()})}function Jt(t,e,n,i,s){if(!k)return;F()?.emit("game:move",{gameId:k.gameId,from:t,to:e,moveType:n,unklikIndex:i,promoteTo:s})}function Po(){if(!k)return;F()?.emit("game:resign",{gameId:k.gameId})}function Io(){if(!k)return;F()?.emit("game:draw-offer",{gameId:k.gameId})}function En(t){if(!k)return;F()?.emit("game:draw-response",{gameId:k.gameId,accept:t})}function At(){return k}function fe(){return Ne}function ut(){return k!==null&&k.currentTurn===k.myColor}function Qt(){return k?.myColor||null}function ai(){k=null,Ne=!1}function To(){return ae}function xo(){if(!ae)return;F()?.emit("game:rematch-request",{opponentId:ae.opponentId,timeControl:ae.timeControl,customSettings:ae.customSettings,previousWhiteId:ae.whitePlayerId})}function li(){ae=null}let Ot=!1;function Xt(t){Ot=t}window.handleSquareClick=st;window.handleUnklikSelect=qo;window.initializeBoard=Re;window.toggleAutoPromote=Do;window.executePromotion=di;window.executeCastling=qe;window.movePiece=De;window.switchLanguage=Lo;function Lo(){const t=ie()==="nl"?"en":"nl";Pi(t),x(),O(),_o()}function _o(){const t=document.querySelector(".header h1");t&&(t.textContent=`üëë ${g("title")}`);const e=document.querySelector(".header p");e&&(e.textContent=g("subtitle"));const n=document.querySelector(".new-game-btn");n&&(n.textContent=`üîÑ ${g("newGame")}`);const i=document.querySelector(".panel h2");if(i){const l=document.getElementById("moveCount")?.textContent||"0";i.innerHTML=`üìã ${g("moves")} (<span id="moveCount">${l}</span>)`}const s=document.querySelector(".rules h2");s&&(s.textContent=`‚ö° ${g("gameRules")}`);const o=document.querySelectorAll(".rules p");o.length>=4&&(o[0].innerHTML=`<strong style="color: #c084fc;">${g("klik")}</strong> ${ie()==="nl"?"Selecteer stuk, klik op veld met blauwe ring":"Select piece, click square with blue ring"}`,o[1].innerHTML=`<strong style="color: #60a5fa;">${g("unklik")}</strong> ${ie()==="nl"?"Klik op driehoek met het stuk":"Click triangle with the piece"}`,o[2].innerHTML=`‚ö†Ô∏è ${g("kingWarning")}`,o[3].innerHTML=`üí° ${g("promotionTip")}`);const r=document.querySelector('label[for="autoPromote"]');r&&(r.textContent=g("autoPromote"));const c=document.querySelector("#selectedInfo h2");c&&(c.textContent=g("selected"));const a=document.getElementById("langBtn");a&&(a.textContent=ie()==="nl"?"EN":"NL")}function No(t,e,n,i){if(t.length===0)return"";const s=y=>E(y)?"piece piece-white":"piece piece-black";if(t.length===1)return`<div class="${s(t[0])}">${_[t[0]]}</div>`;const o=[...t].sort((y,m)=>cn(m)-cn(y)),r=o[0],c=o[1],a=E(t[0]),l=et(),d=i&&l!==null&&t.indexOf(r)===l,p=i&&l!==null&&t.indexOf(c)===l,h=i&&l===null,u=A();let f;if(fe()){const y=Qt();f=ut()&&(a&&y==="white"||!a&&y==="black")}else f=a&&u==="white"||!a&&u==="black";return`<div class="stacked-piece">
    <svg class="stacked-svg" viewBox="0 0 64 64">
      <line x1="32" y1="0" x2="0" y2="64" stroke="rgba(100,100,100,0.4)" stroke-width="2"/>
      <line x1="32" y1="0" x2="64" y2="64" stroke="rgba(100,100,100,0.4)" stroke-width="2"/>
    </svg>
    ${h?'<div class="whole-selected"></div>':""}
    <div class="stacked-center">
      <div class="stacked-top ${s(c)}">${_[c]}</div>
      <div class="stacked-bottom ${s(r)}">${_[r]}</div>
    </div>
    ${f?`
      <div class="triangle-left ${d?"selected":""}" onclick="handleUnklikSelect(${e},${n},${t.indexOf(r)},event)" title="${ie()==="nl"?"Zet met":"Move with"} ${Xe(r)}">
        <span class="triangle-symbol left ${s(r)}">${_[r]}</span>
      </div>
      <div class="triangle-right ${p?"selected":""}" onclick="handleUnklikSelect(${e},${n},${t.indexOf(c)},event)" title="${ie()==="nl"?"Zet met":"Move with"} ${Xe(c)}">
        <span class="triangle-symbol right ${s(c)}">${_[c]}</span>
      </div>
    `:""}
    ${!d&&!h?'<div class="triangle-bg-left"></div>':""}
    ${!p&&!h?'<div class="triangle-bg-right"></div>':""}
  </div>`}function x(){const t=document.getElementById("board");if(!t)return;const e=N(),n=Ze(),i=be(),s=t.offsetHeight;s>0&&(t.style.minHeight=s+"px"),t.innerHTML="";const o=Ot?[7,6,5,4,3,2,1,0]:[0,1,2,3,4,5,6,7],r=Ot?[7,6,5,4,3,2,1,0]:[0,1,2,3,4,5,6,7];for(const c of o){const a=document.createElement("div");a.className="board-row";for(const l of r){const d=document.createElement("div"),p=(c+l)%2===0;d.className=`square ${p?"light":"dark"}`,d.dataset.row=String(c),d.dataset.col=String(l),n&&n[0]===c&&n[1]===l&&d.classList.add("selected");const h=ks(c,l);h==="from"?d.classList.add("premove-from"):h==="to"&&d.classList.add("premove-to");const u=e[c][l].pieces,f=n&&n[0]===c&&n[1]===l;d.innerHTML=No(u,c,l,!!f);const y=i.find(m=>m.row===c&&m.col===l);if(y){const m=document.createElement("div");y.type==="klik"?m.className="valid-klik":y.type==="unklik-klik"?m.className="valid-unklik-klik":u.length>0?m.className="valid-capture":m.className="valid-move",d.appendChild(m)}d.onclick=m=>{const B=m.target;!B.classList.contains("triangle-left")&&!B.classList.contains("triangle-right")&&(gs()?ms(c,l):st(c,l))},d.oncontextmenu=m=>{m.preventDefault(),Ro()},a.appendChild(d)}t.appendChild(a)}t.style.minHeight=""}function O(){const t=document.getElementById("turnIndicator");t&&(t.textContent=A()==="white"?g("whiteToMove"):g("blackToMove"),t.className=`turn-indicator ${A()==="white"?"turn-white":"turn-black"}`);const e=document.getElementById("moveCount");e&&(e.textContent=String(Math.ceil($e().length/2)));const n=document.getElementById("moveHistory"),i=$e();if(n)if(i.length===0)n.innerHTML=`<p style="color:#94a3b8;text-align:center;padding:16px 0;">${g("noMoves")}</p>`;else{const s=[];for(let o=0;o<i.length;o+=2){const r=i[o],c=o+1<i.length?i[o+1]:null;s.push({moveNumber:Math.floor(o/2)+1,white:r,black:c})}n.innerHTML=s.slice(-10).reverse().map(o=>{const r=o.white?o.white.notation:"",c=o.black?o.black.notation:"";return`<div class="move-pair">
          <span class="move-number">${o.moveNumber}.</span>
          <span class="move-white">${r}</span>
          <span class="move-black">${c}</span>
        </div>`}).join("")}$o()}function $o(){const t=document.getElementById("selectedInfo");if(!t)return;const e=Ze();if(e&&N()[e[0]][e[1]].pieces.length>0){t.classList.add("show");const n=N()[e[0]][e[1]].pieces,i=c=>E(c)?"selected-piece-icon piece piece-white":"selected-piece-icon piece piece-black",s=document.getElementById("selectedPieces");s&&(s.innerHTML=n.map(c=>`<div class="${i(c)}">${_[c]}</div>`).join(""));const o=document.getElementById("selectedNames");o&&(o.textContent=n.map(c=>Xe(c)).join(" + "));const r=document.getElementById("selectedMoves");r&&(r.textContent=`${be().length} ${g("possibleMoves")}`)}else t.classList.remove("show")}function Mo(){const t=document.getElementById("checkIndicator");t&&t.remove();const e=document.createElement("div");e.id="checkIndicator",e.className="check-indicator",e.textContent=g("check");const n=document.querySelector(".board-container");n&&(n.style.position="relative",n.appendChild(e)),setTimeout(()=>{const i=document.getElementById("checkIndicator");i&&i.remove()},3e3)}function wn(t,e){const n=document.createElement("div");n.className="promotion-overlay",n.id="gameOverOverlay";const i=document.createElement("div");i.className="game-over-box";const s=document.createElement("button");s.className="game-over-close",s.textContent="√ó",s.onclick=()=>n.remove(),i.appendChild(s);const o=document.createElement("div");o.className="game-over-title",o.textContent=g(t==="checkmate"?"checkmate":"stalemate"),i.appendChild(o);const r=document.createElement("div");if(r.className="game-over-message",t==="stalemate")r.textContent=g("gameEndsDraw");else{const d=e==="white"?ie()==="nl"?"Wit":"White":ie()==="nl"?"Zwart":"Black";r.textContent=`${d} ${g("wins")}`}i.appendChild(r);const c=document.createElement("div");c.style.cssText="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;";const a=document.createElement("button");a.className="game-over-btn",a.textContent=ie()==="nl"?"Analyse":"Analysis",a.onclick=()=>{n.remove();const d=$e();Fn(d)},c.appendChild(a);const l=document.createElement("button");l.className="game-over-btn",l.textContent=g("newGame"),l.onclick=()=>Re(),c.appendChild(l),i.appendChild(c),n.appendChild(i),n.onclick=d=>{d.target===n&&n.remove()},document.body.appendChild(n)}function bt(){const t=Ln();if(!t)return;const e=document.createElement("div");e.className="promotion-overlay",e.id="promotionOverlay";const n=t.isWhite,i=n?["Q","R","B","N"]:["q","r","b","n"],s=document.createElement("div");s.className="promotion-box";const o=document.createElement("div");o.className="promotion-title",o.textContent=g("choosePromotion"),s.appendChild(o);const r=document.createElement("div");r.className="promotion-pieces",i.forEach(c=>{const a=document.createElement("div");a.className="promotion-choice";const l=document.createElement("div");l.className=`promotion-piece piece ${n?"piece-white":"piece-black"}`,l.textContent=_[c],a.appendChild(l),a.onclick=()=>di(c),r.appendChild(a)}),s.appendChild(r),e.appendChild(s),document.body.appendChild(e)}function Ao(t,e,n,i,s){const o=document.createElement("div");o.className="promotion-overlay",o.id="castlingChoiceOverlay";const c=s.includes("k")?7:0,l=N()[t][c].pieces,d=l.find(R=>M(R)==="r"),p=l.find(R=>M(R)!=="r"),h=E(d),u=document.createElement("div");u.className="promotion-box";const f=document.createElement("div");f.className="promotion-title",f.textContent=g("chooseCastling"),u.appendChild(f);const y=document.createElement("div");y.className="promotion-pieces",y.style.gap="20px";const m=document.createElement("div");m.className="promotion-choice",m.style.cssText="width:120px;height:100px;flex-direction:column;display:flex;justify-content:center;align-items:center;";const B=document.createElement("div");B.className=`promotion-piece piece ${h?"piece-white":"piece-black"}`,B.textContent=_[d],B.style.fontSize="48px",m.appendChild(B);const I=document.createElement("div");I.textContent=g("onlyRook"),I.style.cssText="font-size:12px;margin-top:5px;color:white;",m.appendChild(I),m.onclick=()=>{document.getElementById("castlingChoiceOverlay")?.remove(),qe(t,e,n,i,s.replace("-choice",""))},y.appendChild(m);const b=document.createElement("div");b.className="promotion-choice",b.style.cssText="width:120px;height:100px;flex-direction:column;display:flex;justify-content:center;align-items:center;";const L=document.createElement("div");L.style.cssText="display:flex;gap:5px;";const $=document.createElement("div");$.className=`piece ${h?"piece-white":"piece-black"}`,$.textContent=_[d],$.style.fontSize="36px";const D=document.createElement("div");D.className=`piece ${h?"piece-white":"piece-black"}`,D.textContent=_[p],D.style.fontSize="36px",L.appendChild($),L.appendChild(D),b.appendChild(L);const T=document.createElement("div");T.textContent=g("bothPieces"),T.style.cssText="font-size:12px;margin-top:5px;color:white;",b.appendChild(T),b.onclick=()=>{document.getElementById("castlingChoiceOverlay")?.remove(),qe(t,e,n,i,s.replace("-choice","-both"))},y.appendChild(b),u.appendChild(y),o.appendChild(u),document.body.appendChild(o)}function Oo(t,e,n,i){const s=document.createElement("div");s.className="promotion-overlay",s.id="enPassantChoiceOverlay";const r=N()[t][e].pieces,c=E(r[0]),a=r.find(T=>M(T)==="p"),l=r.find(T=>M(T)!=="p"),d=document.createElement("div");d.className="promotion-box";const p=document.createElement("div");p.className="promotion-title",p.textContent=g("chooseMove"),d.appendChild(p);const h=document.createElement("div");h.className="promotion-pieces",h.style.gap="20px";const u=document.createElement("div");u.className="promotion-choice",u.style.cssText="width:140px;height:110px;flex-direction:column;display:flex;justify-content:center;align-items:center;";const f=document.createElement("div");f.style.cssText="display:flex;gap:5px;";const y=document.createElement("div");y.className=`piece ${c?"piece-white":"piece-black"}`,y.textContent=_[a],y.style.fontSize="48px",f.appendChild(y),u.appendChild(f);const m=document.createElement("div");m.textContent=g("enPassant"),m.style.cssText="font-size:12px;margin-top:5px;color:white;",u.appendChild(m);const B=document.createElement("div");B.textContent=g("pawnCaptures"),B.style.cssText="font-size:10px;color:#64748b;",u.appendChild(B),u.onclick=()=>{document.getElementById("enPassantChoiceOverlay")?.remove(),De(t,e,n,i,"en-passant")},h.appendChild(u);const I=document.createElement("div");I.className="promotion-choice",I.style.cssText="width:140px;height:110px;flex-direction:column;display:flex;justify-content:center;align-items:center;";const b=document.createElement("div");b.style.cssText="display:flex;gap:5px;";const L=document.createElement("div");L.className=`piece ${c?"piece-white":"piece-black"}`,L.textContent=_[l],L.style.fontSize="48px",b.appendChild(L),I.appendChild(b);const $=document.createElement("div");$.textContent=g("normalMove"),$.style.cssText="font-size:12px;margin-top:5px;color:white;",I.appendChild($);const D=document.createElement("div");D.textContent=`(${Xe(l)} ${g("moves_")})`,D.style.cssText="font-size:10px;color:#64748b;",I.appendChild(D),I.onclick=()=>{document.getElementById("enPassantChoiceOverlay")?.remove(),De(t,e,n,i,"normal")},h.appendChild(I),d.appendChild(h),s.appendChild(d),document.body.appendChild(s)}function st(t,e){if(ct()&&!X())return;if(fe()&&!ut()&&!X()){const o=N(),r=o[t][e],c=Qt(),a=Ze();if(a){const d=be().find(p=>p.row===t&&p.col===e);if(d){const[p,h]=a,u=et();bs({row:p,col:h},{row:t,col:e},d.type,u!==null?u:void 0),H(),x(),O();return}}if(Ft()&&te(),r.pieces.length>0&&E(r.pieces[0])===(c==="white")){me([t,e]),xe(null);const l=ye(o,t,e,r.pieces,se(),oe(),re(),null);ge(l)}else H();x(),O();return}const n=N(),i=n[t][e],s=Ze();if(s){const[o,r]=s,a=be().find(l=>l.row===t&&l.col===e);if(a){const l=a.type;l==="castle-k"||l==="castle-q"||l==="castle-k-klik"||l==="castle-q-klik"||l==="castle-k-unklik-klik"||l==="castle-q-unklik-klik"?qe(o,r,t,e,l):l==="castle-k-choice"||l==="castle-q-choice"?Ao(o,r,t,e,l):l==="en-passant-choice"?Oo(o,r,t,e):De(o,r,t,e,l)}else if(i.pieces.length>0&&E(i.pieces[0])===(A()==="white")){me([t,e]),xe(null);const l=ye(n,t,e,i.pieces,se(),oe(),re(),null);ge(l)}else H()}else if(i.pieces.length>0){const o=E(i.pieces[0]);if(o&&A()==="white"||!o&&A()==="black"){me([t,e]),xe(null);const r=ye(n,t,e,i.pieces,se(),oe(),re(),null);ge(r)}}x(),O()}function qo(t,e,n,i){if(ct()&&!X()||(i.stopPropagation(),fe()&&!ut()&&!X()))return;const s=N(),o=s[t][e],r=o.pieces[n],c=E(r);if(c&&A()!=="white"||!c&&A()!=="black")return;if(me([t,e]),xe(n),M(r)==="k"){const u=nt(s,t,e,r,se(),oe(),re()).map(f=>({row:f[0],col:f[1],type:"unklik"})).filter(f=>!Ae(s,t,e,f.row,f.col,o.pieces,"unklik",n));ge(u),x(),O();return}const a=nt(s,t,e,r,se(),oe(),re()),l=[],d=U(r);for(const h of a){const[u,f,y]=h,m=s[u][f];d&&(c&&u===7||!c&&u===0)||(y==="en-passant"?l.push({row:u,col:f,type:"en-passant-unklik"}):m.pieces.length===0||E(m.pieces[0])!==c?l.push({row:u,col:f,type:"unklik"}):m.pieces.length<2&&E(m.pieces[0])===c&&!m.pieces.some(I=>M(I)==="k")&&l.push({row:u,col:f,type:"unklik-klik"}))}const p=l.filter(h=>!Ae(s,t,e,h.row,h.col,o.pieces,h.type,n));ge(p),x(),O()}function qe(t,e,n,i,s){if(fe()&&!X()){Jt({row:t,col:e},{row:n,col:i},s),H(),x(),O();return}const o=N(),r=s.startsWith("castle-k"),c=r?7:0,a=r?5:3,l=o[t][e].pieces;w(n,i,l),w(t,e,[]);const d=[...o[t][c].pieces];w(t,c,[]);let p=`O-O${r?"":"-O"}`;if(s.includes("unklik-klik")){const u=d.find(m=>M(m)==="r"),f=d.find(m=>M(m)!=="r"),y=[...o[t][a].pieces];w(t,a,[u,...y]),w(t,c,[f]),p+=" (toren klikt)"}else if(s.includes("klik")&&!s.includes("unklik")){const u=[...o[t][a].pieces];w(t,a,[...d,...u]),p+=" klikt"}else if(s.includes("both"))w(t,a,d),p+=" (beide)";else if(d.length===2){const u=d.find(y=>M(y)==="r"),f=d.find(y=>M(y)!=="r");w(t,a,[u]),w(t,c,[f]),p+=" (alleen toren)"}else w(t,a,d);Et(A()),H();const h=A();Ee(),at({turn:h,notation:p}),X()&&Dt({turn:h,notation:p}),x(),O(),Zt()}function De(t,e,n,i,s,o){if(fe()&&!X()){const b=et(),$=N()[t][e],D=$.pieces.some(z=>U(z)),T=E($.pieces[0]),R=T&&n===0||!T&&n===7;if(D&&R&&!o&&!Fe()){const z={row:n,col:i,isWhite:T,moveNotation:""};z.fromRow=t,z.fromCol=e,z.moveType=s,z.unklikIndex=b,Le(z),bt();return}const V=o||(Fe()&&D&&R?T?"Q":"q":void 0);Jt({row:t,col:e},{row:n,col:i},s,b!==null?b:void 0,V),H(),x(),O();return}const r=N(),c=r[t][e],a=r[n][i];let l,d="";tt(null);const p=a.pieces.length>0,h=He(t,e),u=He(n,i),f=et();if(s==="unklik"||s==="unklik-klik"||s==="en-passant-unklik"){const b=c.pieces[f],L=c.pieces.filter((T,R)=>R!==f);if(l=[b],w(t,e,L),d=`${_[b]}${h}-${u}`,s==="en-passant-unklik"){const T=A()==="white"?n+1:n-1;w(T,i,[]),w(n,i,[b]),d+=` x${He(T,i)} e.p.`,Ce(t,e,n,i,l),Ke(d);return}const $=U(b),D=E(b)&&n===0||!E(b)&&n===7;if($&&D){if(s==="unklik-klik"?(w(n,i,[...a.pieces,b]),d+=" klikt"):a.pieces.length>0?(w(n,i,[b]),d+=" x"):w(n,i,[b]),Fe()){const T=E(b)?"Q":"q",V=Me(n,i).filter(z=>!U(z));V.unshift(T),w(n,i,V),d+="="+_[T],Ce(t,e,n,i,V),Ke(d)}else{const T={row:n,col:i,isWhite:E(b),moveNotation:d,wasCapture:a.pieces.length>1||s!=="unklik-klik"&&a.pieces.length>0};Le(T),bt()}return}s==="unklik-klik"?(w(n,i,[...a.pieces,b]),d+=" klikt"):(a.pieces.length>0&&(d=`${_[b]}${h}x${u}`),w(n,i,[b])),Ce(t,e,n,i,l)}else if(s==="en-passant"){l=[...c.pieces],w(t,e,[]);const b=A()==="white"?n+1:n-1;w(b,i,[]),w(n,i,l),d=`${pt(l)}${h}x${He(b,i)} e.p.`}else{l=[...c.pieces],w(t,e,[]),d=`${pt(l)}${h}-${u}`;const b=l.some($=>U($)),L=E(l[0])&&n===0||!E(l[0])&&n===7;if(b&&L){if(s==="klik"?(w(n,i,[...a.pieces,...l]),d+=" klikt"):(a.pieces.length>0&&(d+=" x"),w(n,i,l)),Fe()){const $=E(l[0])?"Q":"q",T=Me(n,i).filter(R=>!U(R));T.unshift($),w(n,i,T),d+="="+_[$],Ce(t,e,n,i,T),Ke(d)}else{const $={row:n,col:i,isWhite:E(l[0]),moveNotation:d,otherPieces:l.filter(D=>!U(D)),wasCapture:a.pieces.length>l.length};Le($),bt()}return}s==="klik"?(w(n,i,[...a.pieces,...l]),d+=" klikt"):(a.pieces.length>0&&(d=`${pt(l)}${h}x${u}`),w(n,i,l)),Ce(t,e,n,i,l)}const y=l.some(b=>U(b)),m=e===i,B=E(l[0])&&t===6||!E(l[0])&&t===1;if(y&&m&&B&&!p&&Math.abs(t-n)===2){const b=(t+n)/2;tt({row:b,col:i})}l.includes("K")?Et("white"):l.includes("k")&&Et("black");for(const b of l)U(b)&&_n(b);Ke(d)}function Ke(t){H();const e=A();Ee(),at({turn:e,notation:t}),X()&&Dt({turn:e,notation:t}),x(),O(),Zt()}function di(t){const e=Ln();if(!e)return;const n=document.getElementById("promotionOverlay");if(n&&n.remove(),fe()&&!X()){const{fromRow:d,fromCol:p,moveType:h,unklikIndex:u}=e;Jt({row:d,col:p},{row:e.row,col:e.col},h||"normal",u,t),H(),Le(null),x(),O();return}const{row:i,col:s,moveNotation:o}=e,c=Me(i,s).filter(d=>!U(d));c.unshift(t),w(i,s,c);const a=o+"="+_[t];H();const l=A();Ee(),at({turn:l,notation:a}),Le(null),X()&&Dt({turn:l,notation:a}),x(),O(),Zt()}function Zt(){const t=N(),e=A(),n=Ri(t,e);Ui(t,e,se(),oe(),re())?n&&Mo():(qi(!0),n?wn("checkmate",e==="white"?"black":"white"):wn("stalemate",null))}function Re(){const t=document.getElementById("gameOverOverlay");t&&t.remove(),rt(),x(),O()}function Do(){const t=document.getElementById("autoPromote");Oi(t.checked)}function Ro(){Ft()&&(te(),H(),x(),O())}function Uo(){if(!Ft())return!1;const t=vs();if(!t.from||!t.to||!t.moveType)return te(),!1;const e=N(),n=e[t.from.row][t.from.col];if(n.pieces.length===0)return te(),!1;const i=Qt();if(!(E(n.pieces[0])===(i==="white")))return te(),!1;const r=ye(e,t.from.row,t.from.col,n.pieces,se(),oe(),re(),t.unklikPieceIndex).find(h=>h.row===t.to.row&&h.col===t.to.col);if(!r)return te(),!1;const{from:c,to:a,unklikPieceIndex:l,promotionPiece:d}=t;me([c.row,c.col]),l!==null&&xe(l),te();const p=r.type;return p.startsWith("castle")?qe(c.row,c.col,a.row,a.col,p):De(c.row,c.col,a.row,a.col,p,d||void 0),!0}const S={dragging:!1,from:null,pieces:[],ghostElement:null,startX:0,startY:0,hasMoved:!1},Bn=10;function Ho(){const t=document.getElementById("board");t&&(t.addEventListener("mousedown",Vo),t.addEventListener("touchstart",Yo,{passive:!1}),document.addEventListener("mousemove",zo),document.addEventListener("mouseup",jo),document.addEventListener("touchmove",Jo,{passive:!1}),document.addEventListener("touchend",Sn),document.addEventListener("touchcancel",Sn))}function ui(t){const n=t.target.closest(".square");if(!n)return null;const i=parseInt(n.dataset.row||"-1"),s=parseInt(n.dataset.col||"-1");return i<0||s<0?null:{element:n,pos:{row:i,col:s}}}function hi(t,e){const n=document.elementsFromPoint(t,e);for(const i of n)if(i.classList.contains("square")){const s=i,o=parseInt(s.dataset.row||"-1"),r=parseInt(s.dataset.col||"-1");if(o>=0&&r>=0)return{element:s,pos:{row:o,col:r}}}return null}function Fo(t){const e=document.createElement("div");return e.className="drag-ghost",e.innerHTML=t.map(n=>`<span class="piece ${E(n)?"piece-white":"piece-black"}">${_[n]}</span>`).join(""),document.body.appendChild(e),e}function fi(t,e,n){t.style.left=`${e}px`,t.style.top=`${n}px`}function Go(t){const e=N();document.querySelectorAll(".square").forEach(n=>{const i=n,s=parseInt(i.dataset.row||"-1"),o=parseInt(i.dataset.col||"-1"),r=t.find(c=>c.row===s&&c.col===o);r&&(i.classList.add("drag-valid-target"),e[s][o].pieces.length>0&&(r.type==="klik"||r.type==="unklik-klik"?i.classList.add("drag-klik-target"):i.classList.add("drag-capture-target")))})}function Wo(){document.querySelectorAll(".square").forEach(t=>{t.classList.remove("drag-valid-target","drag-capture-target","drag-klik-target","drag-over","dragging")})}function pi(t,e){return e.find(n=>n.row===t.row&&n.col===t.col)}function mi(t,e,n){const s=N()[t.row][t.col].pieces;if(s.length===0)return!1;const o=E(s[0]),r=A();return o&&r!=="white"||!o&&r!=="black"?!1:(S.from=t,S.pieces=s,S.startX=e,S.startY=n,S.hasMoved=!1,S.dragging=!1,!0)}function Ko(t,e){if(!S.from)return;S.dragging=!0,S.ghostElement=Fo(S.pieces),fi(S.ghostElement,t,e);const n=document.querySelector(`.square[data-row="${S.from.row}"][data-col="${S.from.col}"]`);n&&n.classList.add("dragging");const i=ye(N(),S.from.row,S.from.col,S.pieces,se(),oe(),re(),null);ge(i),Go(i)}function gi(t,e){if(!S.from)return;if(!S.dragging){const i=Math.abs(t-S.startX),s=Math.abs(e-S.startY);(i>Bn||s>Bn)&&(S.hasMoved=!0,Ko(t,e));return}S.ghostElement&&fi(S.ghostElement,t,e),document.querySelectorAll(".square.drag-over").forEach(i=>{i.classList.remove("drag-over")});const n=hi(t,e);if(n){const i=be();pi(n.pos,i)&&n.element.classList.add("drag-over")}}function yi(t,e){const n=S.from,i=S.dragging,s=S.hasMoved;if(S.ghostElement&&(S.ghostElement.remove(),S.ghostElement=null),Wo(),S.from=null,S.pieces=[],S.dragging=!1,S.hasMoved=!1,!!n){if(!s){st(n.row,n.col);return}if(i){const o=hi(t,e);if(o){const r=be();if(pi(o.pos,r)){me([n.row,n.col]),st(o.pos.row,o.pos.col);return}}H()}}}function Vo(t){if(t.button!==0||ct())return;const e=t.target;if(e.classList.contains("triangle-left")||e.classList.contains("triangle-right"))return;const n=ui(t);n&&mi(n.pos,t.clientX,t.clientY)&&t.preventDefault()}function zo(t){S.from&&gi(t.clientX,t.clientY)}function jo(t){S.from&&yi(t.clientX,t.clientY)}function Yo(t){if(ct()||t.touches.length!==1)return;const e=t.target;if(e.classList.contains("triangle-left")||e.classList.contains("triangle-right"))return;const n=t.touches[0],i=ui(n);i&&mi(i.pos,n.clientX,n.clientY)}function Jo(t){if(!S.from||t.touches.length!==1)return;t.preventDefault();const e=t.touches[0];gi(e.clientX,e.clientY)}function Sn(t){if(!S.from)return;const e=t.changedTouches[0];yi(e.clientX,e.clientY)}let j=[],Te=null;function Qo(){const t=F();t&&(t.on("lobby:users",e=>{j=e,Te?.(j)}),t.on("lobby:user-joined",e=>{j.find(i=>i.id===e.id)||(j.push({...e,status:"online"}),Te?.(j))}),t.on("lobby:user-left",e=>{j=j.filter(n=>n.id!==e.id),Te?.(j)}),t.on("lobby:user-status",e=>{const n=j.find(i=>i.id===e.id);n&&(n.status=e.status,Te?.(j))}))}function vi(t){Te=t,t(j)}let J=null,Je=null,Qe=null,he=null;function Xo(){J=document.getElementById("lobbyContainer"),J||(J=document.createElement("div"),J.id="lobbyContainer",document.body.appendChild(J)),ki(),wi(),vi(Ei)}function bi(){J&&(J.innerHTML="")}function ki(){if(!J)return;if(J.innerHTML=`
    <div class="lobby-panel">
      <div class="lobby-header">
        <h3>Online Play</h3>
        <button id="lobbyToggleBtn" class="lobby-toggle" title="Minimize">‚àí</button>
      </div>
      <div id="lobbyBody" class="lobby-body">
      <div class="lobby-actions">
        <div class="create-game">
          <select id="timeControlSelect">
            <option value="bullet">1+0</option>
            <option value="blitz-3">3+0</option>
            <option value="blitz-5">5+0</option>
            <option value="rapid-7">7+0</option>
            <option value="standard" selected>7+5</option>
            <option value="custom">Custom</option>
          </select>
          <button id="createGameBtn" class="lobby-btn">Create</button>
        </div>
        <div class="custom-time hidden" id="customTimeInputs">
          <div class="custom-time-row">
            <input type="number" id="customMinutes" placeholder="Min" min="1" max="60" value="10">
            <span>+</span>
            <input type="number" id="customIncrement" placeholder="Sec" min="0" max="60" value="0">
          </div>
        </div>
        <div class="join-game">
          <input type="text" id="gameCodeInput" placeholder="Game Code" maxlength="6">
          <button id="joinGameBtn" class="lobby-btn">Join</button>
        </div>
      </div>
      <div id="gameCodeDisplay" class="game-code-display hidden"></div>
      <div id="waitingMessage" class="waiting-message hidden"></div>
      <div id="challengeNotification" class="challenge-notification hidden"></div>
      <div class="online-users">
        <h4>Online (<span id="onlineCount">0</span>)</h4>
        <ul id="onlineUsersList"></ul>
      </div>
      <div class="lobby-analysis">
        <button id="lobbyAnalysisBtn" class="lobby-btn analysis">Analyse</button>
      </div>
      </div>
    </div>
  `,window.innerWidth<=768){const n=document.getElementById("lobbyBody"),i=document.getElementById("lobbyToggleBtn");n&&i&&(n.classList.add("collapsed"),i.textContent="+",i.title="Expand")}document.getElementById("lobbyToggleBtn")?.addEventListener("click",()=>{const n=document.getElementById("lobbyBody"),i=document.getElementById("lobbyToggleBtn");if(n&&i){const s=n.classList.toggle("collapsed");i.textContent=s?"+":"‚àí",i.title=s?"Expand":"Minimize"}}),document.getElementById("createGameBtn")?.addEventListener("click",Zo),document.getElementById("joinGameBtn")?.addEventListener("click",Cn),document.getElementById("gameCodeInput")?.addEventListener("keyup",n=>{n.key==="Enter"&&Cn()}),document.getElementById("lobbyAnalysisBtn")?.addEventListener("click",()=>{bi(),Ut()});const e=document.getElementById("timeControlSelect");e?.addEventListener("change",()=>{const n=document.getElementById("customTimeInputs");n&&n.classList.toggle("hidden",e.value!=="custom")}),Je=document.getElementById("gameCodeDisplay"),or()}function Ei(t){const e=document.getElementById("onlineUsersList"),n=document.getElementById("onlineCount"),i=Oe();if(n&&(n.textContent=String(t.length)),e){const s=t.filter(o=>o.id!==i?.id);e.innerHTML=s.map(o=>`
        <li class="online-user ${o.status} ${o.status==="online"?"challengeable":""}"
            data-user-id="${o.id}"
            data-username="${o.username}"
            title="${o.status==="online"?"Click to challenge":o.status==="in-game"?"In a game":"Away"}">
          <span class="status-dot"></span>
          <span class="username">${o.username}</span>
          <span class="friend-code">#${o.friendCode}</span>
          ${o.status==="online"?'<span class="challenge-icon">‚öîÔ∏è</span>':""}
        </li>
      `).join("")||'<li class="no-users">No other players online</li>',e.querySelectorAll(".online-user.challengeable").forEach(o=>{o.addEventListener("click",()=>{const r=o.getAttribute("data-user-id"),c=o.getAttribute("data-username");r&&c&&ir(r,c)})})}}function Zo(){const e=document.getElementById("timeControlSelect")?.value||"standard";let n;if(e==="custom"){const s=parseInt(document.getElementById("customMinutes")?.value||"10"),o=parseInt(document.getElementById("customIncrement")?.value||"0");n={initialTime:s*60*1e3,increment:o*1e3}}So(e,n);const i=document.getElementById("waitingMessage");i&&(i.classList.remove("hidden"),i.textContent="Creating game...")}function Cn(){const t=document.getElementById("gameCodeInput"),e=t?.value?.trim();e&&e.length>=4&&(Co(e),t.value="")}function wi(){Bo({onGameCreated:t=>{Je&&(Je.classList.remove("hidden"),Je.innerHTML=`
          <div class="game-code">
            <span>Share code:</span>
            <strong>${t}</strong>
            <button id="copyCodeBtn" class="copy-btn" title="Copy">üìã</button>
          </div>
          <p>Waiting for opponent...</p>
        `,document.getElementById("copyCodeBtn")?.addEventListener("click",()=>{navigator.clipboard.writeText(t)}))},onGameJoined:t=>{console.log("Joined game:",t.gameCode)},onGameStarted:t=>{const e=t.myColor==="black";if(Xt(e),J){const n=e?"white":"black",i=e?"black":"white",s=e?"White":"Black",o=e?"Black":"White",r=e?t.timer.white:t.timer.black,c=e?t.timer.black:t.timer.white;J.innerHTML=`
          <div class="game-info-panel">
            <div class="opponent-info">
              <span>vs ${t.opponent?.username||"Unknown"}</span>
            </div>
            <div id="timerDisplay" class="timer-display">
              <div class="timer ${n} ${t.currentTurn===n?"active":""}">
                <span class="label">${s}</span>
                <span class="time">${ot(r)}</span>
              </div>
              <div class="timer ${i} ${t.currentTurn===i?"active":""}">
                <span class="label">${o}</span>
                <span class="time">${ot(c)}</span>
              </div>
            </div>
            <div class="game-actions">
              <button id="drawBtn" class="game-btn">Draw</button>
              <button id="resignBtn" class="game-btn danger">Resign</button>
            </div>
            <div id="drawNotification" class="draw-notification hidden"></div>
          </div>
        `,Qe=document.getElementById("timerDisplay"),document.getElementById("resignBtn")?.addEventListener("click",()=>{confirm("Are you sure you want to resign?")&&Po()}),document.getElementById("drawBtn")?.addEventListener("click",()=>{Io();const a=document.getElementById("drawBtn");a&&(a.textContent="Offered",a.disabled=!0)}),nr()}Pn(t),x(),O(),Tn()},onMoveMade:t=>{Pn(t),x(),O(),In(t.timer.white,t.timer.black,t.currentTurn),Tn(),t.currentTurn===t.myColor&&setTimeout(()=>{Uo()},50)},onTimerUpdate:(t,e)=>{const n=At();n&&In(t,e,n.currentTurn)},onGameOver:t=>{if(!t)return;te();const e=At();let n="";t.type==="checkmate"?n=t.winner===e?.myColor?"You won by checkmate!":"You lost by checkmate.":t.type==="stalemate"?n="Draw by stalemate.":t.type==="timeout"?n=t.winner===e?.myColor?"You won on time!":"You lost on time.":t.type==="resignation"?n=t.winner===e?.myColor?"Opponent resigned. You won!":"You resigned.":t.type==="disconnect"?n=t.winner===e?.myColor?"Opponent disconnected. You won!":"Game ended due to disconnection.":t.type==="draw"&&(n="Game drawn by agreement."),er(n)},onError:t=>{alert(`Error: ${t}`)}})}function Pn(t){rt();for(let e=0;e<8;e++)for(let n=0;n<8;n++)w(e,n,[...t.board[e][n].pieces]);for(;A()!==t.currentTurn;)Ee();tt(t.enPassantTarget);for(const e of t.movedPawns)_n(e);for(const e of t.moveHistory)$e().find(n=>n.notation===e.notation)||at(e);H()}function In(t,e,n){if(!Qe)return;const i=Qe.querySelector(".timer.white"),s=Qe.querySelector(".timer.black");if(i){i.classList.toggle("active",n==="white");const o=i.querySelector(".time");o&&(o.textContent=ot(t))}if(s){s.classList.toggle("active",n==="black");const o=s.querySelector(".time");o&&(o.textContent=ot(e))}}function ot(t){const e=Math.max(0,Math.floor(t/1e3)),n=Math.floor(e/60),i=e%60;return`${n}:${i.toString().padStart(2,"0")}`}function Tn(){const t=document.getElementById("currentTurnIndicator");if(t&&fe()){const e=ut();t.classList.toggle("my-turn",e)}}function er(t){const e=document.createElement("div");e.className="game-over-modal",e.id="gameOverModal";const i=To()!==null,s=At();e.innerHTML=`
    <div class="modal-content">
      <button class="modal-close" id="modalCloseBtn">√ó</button>
      <h2>Game Over</h2>
      <p>${t}</p>
      <div class="modal-buttons">
        ${i?'<button id="rematchBtn" class="modal-btn primary">Rematch</button>':""}
        <button id="analyzeGameBtn" class="modal-btn">Analysis</button>
        <button id="closeGameOverBtn" class="modal-btn">Back to Lobby</button>
      </div>
      <div id="rematchStatus" class="rematch-status hidden"></div>
    </div>
  `,document.body.appendChild(e),document.getElementById("modalCloseBtn")?.addEventListener("click",()=>{kt(e)}),e.addEventListener("click",o=>{o.target===e&&kt(e)}),document.getElementById("analyzeGameBtn")?.addEventListener("click",()=>{e.remove();const o=s?.moveHistory||$e(),r=s?.myColor==="white"?Oe()?.username:s?.opponent?.username,c=s?.myColor==="black"?Oe()?.username:s?.opponent?.username;ai(),li(),Xt(!1),Fn(o,r,c)}),tr(e),document.getElementById("rematchBtn")?.addEventListener("click",()=>{xo();const o=document.getElementById("rematchStatus");o&&(o.classList.remove("hidden"),o.textContent="Waiting for opponent...");const r=document.getElementById("rematchBtn");r&&(r.textContent="Waiting...",r.disabled=!0)}),document.getElementById("closeGameOverBtn")?.addEventListener("click",()=>{kt(e)})}function kt(t){t.remove(),ai(),li(),te(),Xt(!1),ki(),wi(),vi(Ei)}function tr(t){const e=F();e&&(e.off("game:rematch-received"),e.off("game:rematch-sent"),e.off("game:rematch-declined"),e.off("game:rematch-expired"),e.off("game:rematch-error"),e.on("game:rematch-received",n=>{const i=document.getElementById("rematchStatus");i&&(i.classList.remove("hidden"),i.innerHTML=`
        <p><strong>${n.requesterName}</strong> wants a rematch!</p>
        <div class="rematch-buttons">
          <button id="acceptRematchBtn" class="lobby-btn primary">Accept</button>
          <button id="declineRematchBtn" class="lobby-btn">Decline</button>
        </div>
      `,document.getElementById("acceptRematchBtn")?.addEventListener("click",()=>{e.emit("game:rematch-accept",{rematchId:n.rematchId}),i.textContent="Starting game..."}),document.getElementById("declineRematchBtn")?.addEventListener("click",()=>{e.emit("game:rematch-decline",{rematchId:n.rematchId}),i.classList.add("hidden")}))}),e.on("game:rematch-declined",()=>{const n=document.getElementById("rematchStatus");n&&(n.textContent="Rematch declined.");const i=document.getElementById("rematchBtn");i&&(i.textContent="Rematch",i.disabled=!1)}),e.on("game:rematch-expired",()=>{const n=document.getElementById("rematchStatus");n&&(n.textContent="Rematch request expired.");const i=document.getElementById("rematchBtn");i&&(i.textContent="Rematch",i.disabled=!1)}),e.on("game:rematch-error",n=>{const i=document.getElementById("rematchStatus");i&&(i.textContent=n.message);const s=document.getElementById("rematchBtn");s&&(s.textContent="Rematch",s.disabled=!1)}),e.on("game:started",()=>{t.remove()}))}function nr(){const t=F();t&&(t.off("game:draw-offered"),t.off("game:draw-declined"),t.on("game:draw-offered",()=>{const e=document.getElementById("drawNotification");e&&(e.classList.remove("hidden"),e.innerHTML=`
        <p>Opponent offers a draw</p>
        <div class="draw-buttons">
          <button id="acceptDrawBtn" class="game-btn primary-sm">Accept</button>
          <button id="declineDrawBtn" class="game-btn">Decline</button>
        </div>
      `,document.getElementById("acceptDrawBtn")?.addEventListener("click",()=>{En(!0),e.classList.add("hidden")}),document.getElementById("declineDrawBtn")?.addEventListener("click",()=>{En(!1),e.classList.add("hidden")}))}),t.on("game:draw-declined",()=>{const e=document.getElementById("drawNotification");e&&(e.classList.remove("hidden"),e.innerHTML="<p>Draw declined</p>",setTimeout(()=>e.classList.add("hidden"),3e3));const n=document.getElementById("drawBtn");n&&(n.textContent="Draw",n.disabled=!1)}))}function ir(t,e){const n=document.getElementById("challengeNotification");if(!n)return;const s=document.getElementById("timeControlSelect")?.value||"standard";let o=Bi(s);if(s==="custom"){const r=document.getElementById("customMinutes")?.value||"10",c=document.getElementById("customIncrement")?.value||"0";o=`${r}+${c}`}n.classList.remove("hidden"),n.innerHTML=`
    <div class="challenge-confirm">
      <p>Challenge <strong>${e}</strong> to a ${o} game?</p>
      <div class="challenge-buttons">
        <button id="confirmChallengeBtn" class="lobby-btn primary">Challenge</button>
        <button id="cancelChallengeBtn" class="lobby-btn">Cancel</button>
      </div>
    </div>
  `,document.getElementById("confirmChallengeBtn")?.addEventListener("click",()=>{sr(t,s),n.innerHTML=`
      <div class="challenge-pending">
        <p>Waiting for ${e} to accept...</p>
        <button id="cancelPendingChallengeBtn" class="lobby-btn small">Cancel</button>
      </div>
    `,document.getElementById("cancelPendingChallengeBtn")?.addEventListener("click",()=>{he&&(F()?.emit("lobby:challenge-cancel",{challengeId:he}),he=null),n.classList.add("hidden")})}),document.getElementById("cancelChallengeBtn")?.addEventListener("click",()=>{n.classList.add("hidden")})}function sr(t,e){const n=F();if(!n)return;let i;if(e==="custom"){const s=parseInt(document.getElementById("customMinutes")?.value||"10"),o=parseInt(document.getElementById("customIncrement")?.value||"0");i={initialTime:s*60*1e3,increment:o*1e3}}n.emit("lobby:challenge",{targetId:t,timeControl:e,customSettings:i})}function or(){const t=F();t&&(t.off("lobby:challenge-received"),t.off("lobby:challenge-sent"),t.off("lobby:challenge-declined"),t.off("lobby:challenge-cancelled"),t.off("lobby:challenge-expired"),t.off("lobby:challenge-error"),t.on("lobby:challenge-received",e=>{const n=document.getElementById("challengeNotification");if(!n)return;let i=Bi(e.timeControl);if(e.timeControl==="custom"&&e.customSettings){const s=Math.floor(e.customSettings.initialTime/6e4),o=Math.floor(e.customSettings.increment/1e3);i=`${s}+${o}`}n.classList.remove("hidden"),n.innerHTML=`
      <div class="challenge-received">
        <p><strong>${e.challengerName}</strong> challenges you to a ${i} game!</p>
        <div class="challenge-buttons">
          <button id="acceptChallengeBtn" class="lobby-btn primary">Accept</button>
          <button id="declineChallengeBtn" class="lobby-btn">Decline</button>
        </div>
      </div>
    `,document.getElementById("acceptChallengeBtn")?.addEventListener("click",()=>{t.emit("lobby:challenge-accept",{challengeId:e.challengeId}),n.innerHTML="<p>Starting game...</p>"}),document.getElementById("declineChallengeBtn")?.addEventListener("click",()=>{t.emit("lobby:challenge-decline",{challengeId:e.challengeId}),n.classList.add("hidden")})}),t.on("lobby:challenge-sent",e=>{he=e.challengeId}),t.on("lobby:challenge-declined",e=>{he=null;const n=document.getElementById("challengeNotification");n&&(n.innerHTML=`<p>${e.declinedBy} declined the challenge.</p>`,setTimeout(()=>n.classList.add("hidden"),3e3))}),t.on("lobby:challenge-cancelled",()=>{const e=document.getElementById("challengeNotification");e&&(e.innerHTML="<p>Challenge was cancelled.</p>",setTimeout(()=>e.classList.add("hidden"),3e3))}),t.on("lobby:challenge-expired",()=>{he=null;const e=document.getElementById("challengeNotification");e&&(e.innerHTML="<p>Challenge expired.</p>",setTimeout(()=>e.classList.add("hidden"),3e3))}),t.on("lobby:challenge-error",e=>{he=null;const n=document.getElementById("challengeNotification");n&&(n.innerHTML=`<p class="error">${e.message}</p>`,setTimeout(()=>n.classList.add("hidden"),3e3))}))}function Bi(t){switch(t){case"bullet":return"1+0";case"blitz-3":return"3+0";case"blitz-5":return"5+0";case"rapid-7":return"7+0";case"standard":return"7+5";case"custom":return"Custom";default:return"7+5"}}const ht="https://klikschaak-api.onrender.com";let ue=null,en=!1;async function rr(){const t=Se();if(!t)return!1;try{const e=await fetch(`${ht}/api/auth/me`,{headers:{Authorization:`Bearer ${t}`}});return e.ok?(await e.json()).isAdmin===!0:!1}catch{return!1}}async function tn(){if(!await rr())return;const e=document.getElementById("authContainer");if(!e)return;const n=document.createElement("button");n.id="adminBtn",n.className="auth-btn admin-btn",n.textContent="Admin",n.onclick=cr;const i=e.querySelector(".user-status");i&&i.appendChild(n)}function cr(){en?Si():ar()}async function ar(){en=!0,ue=document.createElement("div"),ue.id="adminPanel",ue.className="admin-panel",ue.innerHTML=`
    <div class="admin-panel-header">
      <h2>Admin Dashboard</h2>
      <button id="closeAdminBtn" class="admin-close-btn">&times;</button>
    </div>
    <div class="admin-panel-content">
      <div id="adminUserList">Loading...</div>
    </div>
  `,document.body.appendChild(ue),document.getElementById("closeAdminBtn")?.addEventListener("click",Si),await nn()}function Si(){en=!1,ue?.remove(),ue=null}async function nn(){const t=Se();if(!t)return;const e=document.getElementById("adminUserList");if(e)try{const n=await fetch(`${ht}/api/admin/users`,{headers:{Authorization:`Bearer ${t}`}});if(!n.ok){e.innerHTML='<p class="error">Failed to load users</p>';return}const{users:i}=await n.json();if(i.length===0){e.innerHTML="<p>No users found</p>";return}e.innerHTML=`
      <table class="admin-table">
        <thead>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Code</th>
            <th>Stats</th>
            <th>Admin</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${i.map(s=>`
            <tr data-user-id="${s.id}">
              <td>${s.username}</td>
              <td>${s.email}</td>
              <td>${s.friend_code}</td>
              <td>${s.stats.wins}W ${s.stats.losses}L ${s.stats.draws}D</td>
              <td>${s.is_admin?"‚úì":""}</td>
              <td>
                <button class="admin-action-btn toggle-admin" data-id="${s.id}" title="Toggle admin">
                  ${s.is_admin?"üë§":"üëë"}
                </button>
                <button class="admin-action-btn delete-user" data-id="${s.id}" title="Delete user">
                  üóëÔ∏è
                </button>
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `,e.querySelectorAll(".toggle-admin").forEach(s=>{s.addEventListener("click",()=>lr(s.getAttribute("data-id")))}),e.querySelectorAll(".delete-user").forEach(s=>{s.addEventListener("click",()=>dr(s.getAttribute("data-id")))})}catch{e.innerHTML='<p class="error">Error loading users</p>'}}async function lr(t){const e=Se();if(e)try{const n=await fetch(`${ht}/api/admin/users/${t}/toggle-admin`,{method:"POST",headers:{Authorization:`Bearer ${e}`}});if(n.ok)await nn();else{const i=await n.json();alert(i.error||"Failed to toggle admin status")}}catch{alert("Error toggling admin status")}}async function dr(t){if(!confirm("Are you sure you want to delete this user?"))return;const e=Se();if(e)try{const n=await fetch(`${ht}/api/admin/users/${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${e}`}});if(n.ok)await nn();else{const i=await n.json();alert(i.error||"Failed to delete user")}}catch{alert("Error deleting user")}}let G=null;function ur(){G=document.getElementById("authContainer"),G||(G=document.createElement("div"),G.id="authContainer",document.body.appendChild(G)),po()?(sn(),on(),tn()):Ue()}function Ue(){G&&(G.innerHTML=`
    <div class="auth-buttons">
      <button id="loginBtn" class="auth-btn">Login</button>
      <button id="registerBtn" class="auth-btn">Register</button>
    </div>
  `,document.getElementById("loginBtn")?.addEventListener("click",hr),document.getElementById("registerBtn")?.addEventListener("click",fr))}function sn(){if(!G)return;const t=Oe();if(!t){Ue();return}G.innerHTML=`
    <div class="user-status">
      <span class="user-info">
        <span class="username">${t.username}</span>
        <span class="friend-code">#${t.friendCode}</span>
      </span>
      <span class="user-stats">${t.stats.wins}W ${t.stats.losses}L ${t.stats.draws}D</span>
      <button id="logoutBtn" class="auth-btn small">Logout</button>
    </div>
  `,document.getElementById("logoutBtn")?.addEventListener("click",gr)}function hr(){G&&(G.innerHTML=`
    <div class="auth-form">
      <h3>Login</h3>
      <form id="loginForm">
        <input type="text" id="loginUsername" placeholder="Username or Email" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <div class="auth-error" id="loginError"></div>
        <div class="auth-form-buttons">
          <button type="submit" class="auth-btn primary">Login</button>
          <button type="button" id="loginCancel" class="auth-btn">Cancel</button>
        </div>
      </form>
    </div>
  `,document.getElementById("loginForm")?.addEventListener("submit",pr),document.getElementById("loginCancel")?.addEventListener("click",Ue))}function fr(){G&&(G.innerHTML=`
    <div class="auth-form">
      <h3>Register</h3>
      <form id="registerForm">
        <input type="text" id="regUsername" placeholder="Username" required minlength="3" maxlength="32">
        <input type="email" id="regEmail" placeholder="Email" required>
        <input type="password" id="regPassword" placeholder="Password" required minlength="6">
        <div class="auth-error" id="registerError"></div>
        <div class="auth-form-buttons">
          <button type="submit" class="auth-btn primary">Register</button>
          <button type="button" id="registerCancel" class="auth-btn">Cancel</button>
        </div>
      </form>
    </div>
  `,document.getElementById("registerForm")?.addEventListener("submit",mr),document.getElementById("registerCancel")?.addEventListener("click",Ue))}async function pr(t){t.preventDefault();const e=document.getElementById("loginUsername").value,n=document.getElementById("loginPassword").value,i=document.getElementById("loginError"),s=await yo(e,n);s.success?(sn(),on(),tn()):i&&(i.textContent=s.error||"Login failed")}async function mr(t){t.preventDefault();const e=document.getElementById("regUsername").value,n=document.getElementById("regEmail").value,i=document.getElementById("regPassword").value,s=document.getElementById("registerError"),o=await go(e,n,i);o.success?(sn(),on(),tn()):s&&(s.textContent=o.error||"Registration failed")}function gr(){vo(),Eo(),bi(),Ue()}async function on(){try{await ko(),Qo(),wo(),Xo()}catch(t){console.error("Failed to connect:",t)}}Ii();document.addEventListener("DOMContentLoaded",()=>{Re(),Ho(),ur(),ys()});export{A as a,se as b,oe as c,re as d,ye as e,U as f,N as g,nt as h,E as i,M as j,Ae as w};
