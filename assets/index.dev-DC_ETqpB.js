(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();const ps={nl:{title:"Klikschaak",subtitle:"Combineer stukken voor strategische dominantie",newGame:"Nieuw Spel",whiteToMove:"Wit aan zet",blackToMove:"Zwart aan zet",moves:"Zetten",noMoves:"Nog geen zetten",gameRules:"Spelregels",klik:"Klikken:",unklik:"Ontklikken:",kingWarning:"Koning mag NOOIT klikken!",promotionTip:"Promotie: alleen met een pionzet!",autoPromote:"Automatisch promoveren tot dame",selected:"Geselecteerd",possibleMoves:"mogelijke zetten",choosePromotion:"Kies een stuk voor promotie:",chooseCastling:"Kies rokade optie:",onlyRook:"Alleen toren",bothPieces:"Beide stukken",chooseMove:"Kies zet type:",enPassant:"En passant",normalMove:"Normale zet",pawnCaptures:"(pion slaat)",moves_:"beweegt",checkmate:"Schaakmat!",stalemate:"Pat!",check:"SCHAAK!",wins:"wint!",draw:"Remise",gameEndsDraw:"Het spel eindigt in remise",analysis:"Analyse",analysisMode:"Analysemodus",boardEditor:"Bord Editor",exitEditor:"Verlaat Editor",exportPGN:"Exporteer PGN",importPGN:"Importeer PGN",playFromHere:"Speel vanaf hier",backToGame:"Terug naar Spel",pieces:"Stukken",turnToMove:"Aan zet",white:"Wit",black:"Zwart",clearBoard:"Leeg Bord",standardPosition:"Start Positie",loadFEN:"Laad",copyFEN:"Kopieer",copied:"Gekopieerd!",invalidFEN:"Ongeldige FEN",invalidPosition:"Ongeldige positie",copyToClipboard:"Kopieer naar Klembord",downloadFile:"Download Bestand",close:"Sluiten",loadPGN:"Laad PGN",cancel:"Annuleren",pasteHere:"Plak hier...",chooseFile:"Kies Bestand"},en:{title:"Clickchess",subtitle:"Combine pieces for strategic dominance",newGame:"New Game",whiteToMove:"White to move",blackToMove:"Black to move",moves:"Moves",noMoves:"No moves yet",gameRules:"Game Rules",klik:"Click:",unklik:"Unclick:",kingWarning:"King may NEVER click!",promotionTip:"Promotion: only with a pawn move!",autoPromote:"Auto-promote to queen",selected:"Selected",possibleMoves:"possible moves",choosePromotion:"Choose a piece for promotion:",chooseCastling:"Choose castling option:",onlyRook:"Only rook",bothPieces:"Both pieces",chooseMove:"Choose move type:",enPassant:"En passant",normalMove:"Normal move",pawnCaptures:"(pawn captures)",moves_:"moves",checkmate:"Checkmate!",stalemate:"Stalemate!",check:"CHECK!",wins:"wins!",draw:"Draw",gameEndsDraw:"The game ends in a draw",analysis:"Analysis",analysisMode:"Analysis Mode",boardEditor:"Board Editor",exitEditor:"Exit Editor",exportPGN:"Export PGN",importPGN:"Import PGN",playFromHere:"Play from here",backToGame:"Back to Game",pieces:"Pieces",turnToMove:"Turn to move",white:"White",black:"Black",clearBoard:"Clear Board",standardPosition:"Standard Position",loadFEN:"Load",copyFEN:"Copy",copied:"Copied!",invalidFEN:"Invalid FEN",invalidPosition:"Invalid position",copyToClipboard:"Copy to Clipboard",downloadFile:"Download File",close:"Close",loadPGN:"Load PGN",cancel:"Cancel",pasteHere:"Paste here...",chooseFile:"Choose File"}};let Me="nl";function ms(t){Me=t,localStorage.setItem("klikschaak-language",t)}function oe(){return Me}function gs(){const t=localStorage.getItem("klikschaak-language");t&&(t==="nl"||t==="en")?Me=t:Me=navigator.language.slice(0,2)==="nl"?"nl":"en"}function v(t){return ps[Me][t]}function yt(t){const e={nl:{K:"Koning",Q:"Dame",R:"Toren",B:"Loper",N:"Paard",P:"Pion",k:"koning",q:"dame",r:"toren",b:"loper",n:"paard",p:"pion"},en:{K:"King",Q:"Queen",R:"Rook",B:"Bishop",N:"Knight",P:"Pawn",k:"king",q:"queen",r:"rook",b:"bishop",n:"knight",p:"pawn"}},n=t.charAt(0);return e[Me][n]||t}const q={K:"‚ôî",Q:"‚ôï",R:"‚ôñ",B:"‚ôó",N:"‚ôò",P:"‚ôô",k:"‚ôö",q:"‚ôõ",r:"‚ôú",b:"‚ôù",n:"‚ôû",p:"‚ôü",P0:"‚ôô",P1:"‚ôô",P2:"‚ôô",P3:"‚ôô",P4:"‚ôô",P5:"‚ôô",P6:"‚ôô",P7:"‚ôô",p0:"‚ôü",p1:"‚ôü",p2:"‚ôü",p3:"‚ôü",p4:"‚ôü",p5:"‚ôü",p6:"‚ôü",p7:"‚ôü"},ys={q:5,r:4,b:3,n:2,p:1,k:6},vs=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]],bs=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]],ks=[[-1,-1],[-1,1],[1,-1],[1,1]],Es=[[-1,0],[1,0],[0,-1],[0,1]],ws="abcdefgh",Bs="87654321";function E(t){return t===t.toUpperCase()}function G(t){return t.charAt(0).toLowerCase()==="p"}function M(t){return t.charAt(0).toLowerCase()}function Gn(t){return ys[M(t)]||0}function st(t,e){return ws[e]+Bs[t]}function Rt(t){return t.map(e=>q[e]).join("")}let k=ui();function ui(){return{board:Ss(),currentTurn:"white",selectedSquare:null,selectedUnklikPiece:null,validMoves:[],moveHistory:[],castlingRights:{white:{kingSide:!0,queenSide:!0},black:{kingSide:!0,queenSide:!0}},enPassantTarget:null,movedPawns:new Set,autoPromoteToQueen:!1,pendingPromotion:null,gameOver:!1}}function Ss(){return Array(8).fill(null).map(()=>Array(8).fill(null).map(()=>({pieces:[]})))}function Ue(){k=ui(),k.board[7][0].pieces=["R"],k.board[7][1].pieces=["N"],k.board[7][2].pieces=["B"],k.board[7][3].pieces=["Q"],k.board[7][4].pieces=["K"],k.board[7][5].pieces=["B"],k.board[7][6].pieces=["N"],k.board[7][7].pieces=["R"];for(let t=0;t<8;t++)k.board[6][t].pieces=[`P${t}`];k.board[0][0].pieces=["r"],k.board[0][1].pieces=["n"],k.board[0][2].pieces=["b"],k.board[0][3].pieces=["q"],k.board[0][4].pieces=["k"],k.board[0][5].pieces=["b"],k.board[0][6].pieces=["n"],k.board[0][7].pieces=["r"];for(let t=0;t<8;t++)k.board[1][t].pieces=[`p${t}`]}function A(){return k.board}function O(){return k.currentTurn}function vt(){return k.selectedSquare}function bt(){return k.selectedUnklikPiece}function Ne(){return k.validMoves}function X(){return k.moveHistory}function j(){return k.castlingRights}function V(){return k.enPassantTarget}function Y(){return k.movedPawns}function ot(){return k.autoPromoteToQueen}function hi(){return k.pendingPromotion}function Z(){return k.gameOver}function Se(t){k.selectedSquare=t}function _e(t){k.selectedUnklikPiece=t}function Le(t){k.validMoves=t}function kt(t){k.enPassantTarget=t}function Cs(t){k.autoPromoteToQueen=t}function Ye(t){k.pendingPromotion=t}function et(t){k.gameOver=t}function Ge(){k.currentTurn=k.currentTurn==="white"?"black":"white"}function It(t){k.moveHistory.push(t)}function fi(t){k.movedPawns.add(t)}function Ke(t,e,n,i,s){n===7&&i===0&&s.includes("R")&&(k.castlingRights.white.queenSide=!1),n===7&&i===7&&s.includes("R")&&(k.castlingRights.white.kingSide=!1),n===0&&i===0&&s.includes("r")&&(k.castlingRights.black.queenSide=!1),n===0&&i===7&&s.includes("r")&&(k.castlingRights.black.kingSide=!1),s.includes("R")&&t===7&&e===0&&(k.castlingRights.white.queenSide=!1),s.includes("R")&&t===7&&e===7&&(k.castlingRights.white.kingSide=!1),s.includes("r")&&t===0&&e===0&&(k.castlingRights.black.queenSide=!1),s.includes("r")&&t===0&&e===7&&(k.castlingRights.black.kingSide=!1)}function Vt(t){t==="white"?k.castlingRights.white={kingSide:!1,queenSide:!1}:k.castlingRights.black={kingSide:!1,queenSide:!1}}function H(){k.selectedSquare=null,k.selectedUnklikPiece=null,k.validMoves=[]}function S(t,e,n){k.board[t][e].pieces=n}function Xe(t,e){return k.board[t][e].pieces}function Yt(t,e,n,i){for(let s=0;s<8;s++)for(let o=0;o<8;o++){const r=t[s][o].pieces;if(r.length!==0&&E(r[0])!==i){for(const a of r)if(Is(t,s,o,a,e,n))return!0}}return!1}function Is(t,e,n,i,s,o){const r=M(i),a=E(i);if(r==="p"){const c=a?-1:1;return Math.abs(n-o)===1&&e+c===s}if(r==="n"){const c=Math.abs(e-s),l=Math.abs(n-o);return c===2&&l===1||c===1&&l===2}if(r==="k")return Math.abs(e-s)<=1&&Math.abs(n-o)<=1;if((r==="b"||r==="q")&&Math.abs(e-s)===Math.abs(n-o)){const c=s>e?1:-1,l=o>n?1:-1;let d=e+c,f=n+l;for(;d!==s||f!==o;){if(t[d][f].pieces.length>0)return!1;d+=c,f+=l}return!0}if((r==="r"||r==="q")&&(e===s||n===o)){const c=e===s?0:s>e?1:-1,l=n===o?0:o>n?1:-1;let d=e+c,f=n+l;for(;d!==s||f!==o;){if(t[d][f].pieces.length>0)return!1;d+=c,f+=l}return!0}return!1}function $e(t,e,n,i,s,o,r){const a=[],c=E(i),l=M(i);if(l==="p"){const d=c?-1:1,f=c?6:1;e+d>=0&&e+d<8&&t[e+d][n].pieces.length===0&&(a.push([e+d,n]),e===f&&!r.has(i)&&t[e+2*d][n].pieces.length===0&&a.push([e+2*d,n]));for(const h of[-1,1]){const u=n+h;if(u>=0&&u<8&&e+d>=0&&e+d<8){const p=t[e+d][u];p.pieces.length>0&&E(p.pieces[0])!==c&&a.push([e+d,u]),o&&o.row===e+d&&o.col===u&&a.push([e+d,u,"en-passant"])}}}if(l==="n")for(const[d,f]of vs){const h=e+d,u=n+f;h>=0&&h<8&&u>=0&&u<8&&a.push([h,u])}if(l==="b"||l==="q")for(const[d,f]of ks)for(let h=1;h<8;h++){const u=e+d*h,p=n+f*h;if(u<0||u>=8||p<0||p>=8||(a.push([u,p]),t[u][p].pieces.length>0))break}if(l==="r"||l==="q")for(const[d,f]of Es)for(let h=1;h<8;h++){const u=e+d*h,p=n+f*h;if(u<0||u>=8||p<0||p>=8||(a.push([u,p]),t[u][p].pieces.length>0))break}if(l==="k"){for(const[h,u]of bs){const p=e+h,g=n+u;if(p>=0&&p<8&&g>=0&&g<8){const m=t[p][g];(m.pieces.length===0||E(m.pieces[0])!==c)&&a.push([p,g])}}const d=c?s.white:s.black,f=c?7:0;if(d.kingSide){const h=t[f][7],u=t[f][5];t[f][6].pieces.length===0&&h.pieces.length>0&&h.pieces.some(g=>M(g)==="r")&&(u.pieces.length===0?h.pieces.length===1?a.push([f,6,"castle-k"]):h.pieces.length===2&&a.push([f,6,"castle-k-choice"]):u.pieces.length===1&&E(u.pieces[0])===c&&(h.pieces.length===1?a.push([f,6,"castle-k-klik"]):h.pieces.length===2&&a.push([f,6,"castle-k-unklik-klik"])))}if(d.queenSide){const h=t[f][0],u=t[f][3],p=t[f][2],g=t[f][1];p.pieces.length===0&&g.pieces.length===0&&h.pieces.length>0&&h.pieces.some(m=>M(m)==="r")&&(u.pieces.length===0?h.pieces.length===1?a.push([f,2,"castle-q"]):h.pieces.length===2&&a.push([f,2,"castle-q-choice"]):u.pieces.length===1&&E(u.pieces[0])===c&&(h.pieces.length===1?a.push([f,2,"castle-q-klik"]):h.pieces.length===2&&a.push([f,2,"castle-q-unklik-klik"])))}}return a}function Ce(t,e,n,i,s,o,r,a){const c=t.map(h=>h.map(u=>({pieces:[...u.pieces]}))),l=E(o[0]);if(r==="en-passant"){const h=l?i+1:i-1;c[h][s].pieces=[],c[i][s].pieces=[...o],c[e][n].pieces=[]}else if(r==="en-passant-unklik"){const h=l?i+1:i-1;c[h][s].pieces=[];const u=o[a];c[i][s].pieces=[u],c[e][n].pieces=c[e][n].pieces.filter((p,g)=>g!==a)}else if(r==="unklik"||r==="unklik-klik"){const h=o[a];r==="unklik-klik"?c[i][s].pieces=[...c[i][s].pieces,h]:c[i][s].pieces=[h],c[e][n].pieces=c[e][n].pieces.filter((u,p)=>p!==a)}else if(r==="klik")c[i][s].pieces=[...c[i][s].pieces,...o],c[e][n].pieces=[];else if(r?.startsWith("castle-")){const h=r.startsWith("castle-k"),u=h?7:0,p=h?5:3;c[i][s].pieces=o,c[e][n].pieces=[];const g=[...c[e][u].pieces];if(c[e][u].pieces=[],r.includes("unklik-klik")){const b=g.find(y=>M(y)==="r"),w=[...c[e][p].pieces];c[e][p].pieces=[b,...w]}else if(r.includes("klik")&&!r.includes("unklik")){const b=[...c[e][p].pieces];c[e][p].pieces=[...g,...b]}else if(r.includes("both"))c[e][p].pieces=g;else if(g.length===2){const b=g.find(w=>M(w)==="r");c[e][p].pieces=[b]}else c[e][p].pieces=g;const m=h?n+1:n-1;for(const b of[n,m,s])if(Yt(c,e,b,l))return!0}else c[i][s].pieces=[...o],c[e][n].pieces=[];let d=-1,f=-1;for(let h=0;h<8;h++){for(let u=0;u<8;u++)if(c[h][u].pieces.includes(l?"K":"k")){d=h,f=u;break}if(d!==-1)break}return d===-1?!1:Yt(c,d,f,l)}function ge(t,e,n,i,s,o,r,a){const c=new Map,l=E(i[0]),d=i.length===1,f=i.some(u=>G(u));for(const u of i){const p=$e(t,e,n,u,s,o,r);for(const g of p){const[m,b,w]=g,y=`${m},${b}`,T=t[m][b],x=G(u),U=l&&m===0||!l&&m===7;if(f&&i.length===2&&!x&&U||f&&(l&&m===7||!l&&m===0))continue;if(w==="en-passant"){const ee=c.get(y);ee&&ee.type!=="en-passant"?c.set(y,{row:m,col:b,type:"en-passant-choice"}):c.set(y,{row:m,col:b,type:"en-passant"});continue}const R=c.get(y);if(R&&R.type==="en-passant"){c.set(y,{row:m,col:b,type:"en-passant-choice"});continue}if(!d)(T.pieces.length===0||E(T.pieces[0])!==l)&&c.set(y,{row:m,col:b,type:w||"normal"});else if(T.pieces.length>0&&E(T.pieces[0])===l){const ee=G(u),te=ee&&n===b,Un=!T.pieces.some(qt=>M(qt)==="k")&&!i.some(qt=>M(qt)==="k");te&&T.pieces.length<2&&Un?c.set(y,{row:m,col:b,type:"klik"}):!ee&&T.pieces.length<2&&Un&&c.set(y,{row:m,col:b,type:"klik"})}else(T.pieces.length===0||E(T.pieces[0])!==l)&&c.set(y,{row:m,col:b,type:w||"normal"})}}if(d){const u=i.find(p=>G(p));if(u){const p=l?-1:1,g=l?6:1;if(e+p>=0&&e+p<8){const m=t[e+p][n];if(m.pieces.length===1&&E(m.pieces[0])===l&&!m.pieces.some(b=>M(b)==="k")){const b=`${e+p},${n}`;c.set(b,{row:e+p,col:n,type:"klik"})}}if(e===g&&!r.has(u)&&e+2*p>=0&&e+2*p<8){const m=t[e+2*p][n];if(t[e+p][n].pieces.length===0&&m.pieces.length===1&&E(m.pieces[0])===l&&!m.pieces.some(w=>M(w)==="k")){const w=`${e+2*p},${n}`;c.set(w,{row:e+2*p,col:n,type:"klik"})}}}}let h=Array.from(c.values());return h=h.filter(u=>!Ce(t,e,n,u.row,u.col,i,u.type,a)),h}function Ps(t,e){const n=e==="white";let i=-1,s=-1;for(let o=0;o<8;o++){for(let r=0;r<8;r++)if(t[o][r].pieces.includes(n?"K":"k")){i=o,s=r;break}if(i!==-1)break}return i===-1?!1:Yt(t,i,s,n)}function Ts(t,e,n,i,s){const o=e==="white";for(let r=0;r<8;r++)for(let a=0;a<8;a++){const c=t[r][a].pieces;if(c.length===0||E(c[0])!==o)continue;if(ge(t,r,a,c,n,i,s,null).length>0)return!0;if(c.length===2)for(let d=0;d<2;d++){const f=c[d],h=$e(t,r,a,f,n,i,s);if(G(f)){const u=o?-1:1,p=o?6:1,g=o?0:7,m=r+u;if(m>=0&&m<8&&m!==g){const b=t[m][a];b.pieces.length===1&&E(b.pieces[0])===o&&M(b.pieces[0])!=="k"&&h.push([m,a])}if(r===p&&!s.has(f)){const b=r+u,w=r+2*u;if(t[b][a].pieces.length===0&&w!==g){const y=t[w][a];y.pieces.length===1&&E(y.pieces[0])===o&&M(y.pieces[0])!=="k"&&h.push([w,a])}}}for(const u of h){const[p,g]=u,m=t[p][g];if(m.pieces.length===0||E(m.pieces[0])!==o){if(!Ce(t,r,a,p,g,c,"unklik",d))return!0}else if(m.pieces.length<2&&E(m.pieces[0])===o&&!m.pieces.some(b=>M(b)==="k")&&!Ce(t,r,a,p,g,c,"unklik-klik",d))return!0}}}return!1}const xs="modulepreload",_s=function(t,e){return new URL(t,e).href},Fn={},Pt=function(e,n,i){let s=Promise.resolve();if(n&&n.length>0){let l=function(d){return Promise.all(d.map(f=>Promise.resolve(f).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};const r=document.getElementsByTagName("link"),a=document.querySelector("meta[property=csp-nonce]"),c=a?.nonce||a?.getAttribute("nonce");s=l(n.map(d=>{if(d=_s(d,i),d in Fn)return;Fn[d]=!0;const f=d.endsWith(".css"),h=f?'[rel="stylesheet"]':"";if(i)for(let p=r.length-1;p>=0;p--){const g=r[p];if(g.href===d&&(!f||g.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${h}`))return;const u=document.createElement("link");if(u.rel=f?"stylesheet":xs,f||(u.as="script"),u.crossOrigin="",u.href=d,c&&u.setAttribute("nonce",c),document.head.appendChild(u),f)return new Promise((p,g)=>{u.addEventListener("load",p),u.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${d}`)))})}))}function o(r){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=r,window.dispatchEvent(a),!a.defaultPrevented)throw r}return s.then(r=>{for(const a of r||[])a.status==="rejected"&&o(a.reason);return e().catch(o)})};let P={isActive:!1,initialBoard:[],initialTurn:"white",moveIndex:-1,savedMoves:[],boardStates:[]};function ae(){return P.isActive}function Jt(){return P.moveIndex}function Ls(){return P.savedMoves.length}function un(){return P.savedMoves}function pi(t,e){P={isActive:!0,initialBoard:Et(A()),initialTurn:O(),moveIndex:t.length-1,savedMoves:[...t],boardStates:[]},Ds()}function Ms(t=!0){if(Ue(),!t)for(let e=0;e<8;e++)for(let n=0;n<8;n++)S(e,n,[]);P={isActive:!0,initialBoard:Et(A()),initialTurn:"white",moveIndex:-1,savedMoves:[],boardStates:[{board:Et(A()),turn:"white",enPassantTarget:null,castlingRights:{white:{kingSide:!0,queenSide:!0},black:{kingSide:!0,queenSide:!0}},movedPawns:[]}]}}function Ns(){P={isActive:!1,initialBoard:[],initialTurn:"white",moveIndex:-1,savedMoves:[],boardStates:[]}}function Fe(t){if(t<-1||t>=P.savedMoves.length)return;P.moveIndex=t;const e=t+1;if(e>=0&&e<P.boardStates.length){const n=P.boardStates[e];Rs(n)}}function $s(){Fe(-1)}function mi(){Fe(P.savedMoves.length-1)}function As(){P.moveIndex>=0&&Fe(P.moveIndex-1)}function Os(){P.moveIndex<P.savedMoves.length-1&&Fe(P.moveIndex+1)}function hn(t){P.moveIndex<P.savedMoves.length-1&&(P.savedMoves=P.savedMoves.slice(0,P.moveIndex+1),P.boardStates=P.boardStates.slice(0,P.moveIndex+2)),P.savedMoves.push(t),P.boardStates.push(qs()),P.moveIndex=P.savedMoves.length-1}function Et(t){return t.map(e=>e.map(n=>({pieces:[...n.pieces]})))}function qs(){return{board:Et(A()),turn:O(),enPassantTarget:V(),castlingRights:JSON.parse(JSON.stringify(j())),movedPawns:Array.from(Y())}}function Rs(t){for(let e=0;e<8;e++)for(let n=0;n<8;n++)S(e,n,[...t.board[e][n].pieces]);for(;O()!==t.turn;)Ge();kt(t.enPassantTarget),H()}function Ds(){P.boardStates=[{board:P.initialBoard,turn:P.initialTurn,enPassantTarget:null,castlingRights:{white:{kingSide:!0,queenSide:!0},black:{kingSide:!0,queenSide:!0}},movedPawns:[]}]}let pe={isActive:!1,selectedPiece:null,turnToMove:"white"};const Hn={white:["K","Q","R","B","N","P0"],black:["k","q","r","b","n","p0"]};function Ae(){return pe.isActive}function gi(){return pe.selectedPiece}function Us(){return pe.turnToMove}function Gs(){pe={isActive:!0,selectedPiece:null,turnToMove:"white"}}function Qt(){pe={isActive:!1,selectedPiece:null,turnToMove:"white"}}function Wn(t){pe.selectedPiece=t}function yi(t){for(pe.turnToMove=t;O()!==t;)Ge()}function Fs(t,e){if(!pe.selectedPiece)return;const n=Xe(t,e);let i=pe.selectedPiece;if((i==="P0"||i==="p0")&&(i=Ws(i[0])),n.length<2)if(n.some(r=>r==="K"||r==="k")||(i==="K"||i==="k"))S(t,e,[i]);else if(n.length>0){const r=n[0].toUpperCase()===n[0],a=i.toUpperCase()===i;r===a?S(t,e,[...n,i]):S(t,e,[i])}else S(t,e,[i]);else S(t,e,[i])}function Hs(t,e,n){Xe(t,e),S(t,e,[])}function vi(){for(let t=0;t<8;t++)for(let e=0;e<8;e++)S(t,e,[])}function bi(){Ue()}function Ws(t){const e=A(),n=new Set;for(let i=0;i<8;i++)for(let s=0;s<8;s++)for(const o of e[i][s].pieces)o.startsWith(t)&&n.add(o);for(let i=0;i<16;i++){const s=`${t}${i}`;if(!n.has(s))return s}return`${t}0`}function Ks(){const t=A(),e=[];let n=0,i=0;for(let s=0;s<8;s++)for(let o=0;o<8;o++)for(const r of t[s][o].pieces)r==="K"&&n++,r==="k"&&i++;return n===0&&e.push("White needs a king"),n>1&&e.push("White has too many kings"),i===0&&e.push("Black needs a king"),i>1&&e.push("Black has too many kings"),{valid:e.length===0,errors:e}}function fn(){const t=A(),e=[];for(let i=0;i<8;i++){let s="",o=0;for(let r=0;r<8;r++){const a=t[i][r].pieces;a.length===0?o++:(o>0&&(s+=o,o=0),a.length===1?s+=Kn(a[0]):s+="("+a.map(Kn).join("")+")")}o>0&&(s+=o),e.push(s)}const n=O()==="white"?"w":"b";return`${e.join("/")} ${n}`}function ki(t){try{const e=t.trim().split(" "),n=e[0],i=e[1]||"w";vi();const s=n.split("/");if(s.length!==8)return!1;for(let o=0;o<8;o++){let r=0,a=0;const c=s[o];for(;a<c.length&&r<8;){const l=c[a];if(l>="1"&&l<="8")r+=parseInt(l),a++;else if(l==="("){const d=c.indexOf(")",a);if(d===-1)return!1;const f=c.substring(a+1,d),h=[];for(const u of f){const p=zn(u);p&&h.push(p)}S(o,r,h),r++,a=d+1}else{const d=zn(l);d&&S(o,r,[d]),r++,a++}}}return yi(i==="b"?"black":"white"),!0}catch{return!1}}function Kn(t){const e=t[0];return"KQRBNPkqrbnp".includes(e),e}function zn(t){const e={P:0,p:0};return t==="P"?`P${e.P++%8}`:t==="p"?`p${e.p++%8}`:"KQRBNkqrbn".includes(t)?t:null}function zs(t){const i=['[Event "Klikschaak Game"]','[Site "Klikschaak Online"]',`[Date "${new Date().toISOString().split("T")[0].replace(/-/g,".")}"]`,'[Round "-"]',`[White "${t.white||"Player 1"}"]`,`[Black "${t.black||"Player 2"}"]`,`[Result "${t.result||"*"}"]`,'[Variant "Klikschaak"]'];t.fen&&(i.push(`[FEN "${t.fen}"]`),i.push('[SetUp "1"]'));const s=js(t.moves);return i.join(`
`)+`

`+s+" "+(t.result||"*")}function js(t){const e=[];let n="";for(let i=0;i<t.length;i+=2){const s=Math.floor(i/2)+1,o=t[i]?.notation||"",r=t[i+1]?.notation||"";let a=`${s}. ${o}`;r&&(a+=` ${r}`),n.length+a.length>75?(e.push(n.trim()),n=a+" "):n+=a+" "}return n.trim()&&e.push(n.trim()),e.join(`
`)}function Vs(t){try{const e=t.trim().split(`
`),n={};let i="";for(const o of e){const r=o.trim();if(r.startsWith("[")&&r.endsWith("]")){const a=r.match(/\[(\w+)\s+"(.*)"\]/);a&&(n[a[1].toLowerCase()]=a[2])}else r.length>0&&(i+=" "+r)}const s=Ys(i);return{event:n.event||"Unknown",site:n.site||"Unknown",date:n.date||"",round:n.round||"-",white:n.white||"White",black:n.black||"Black",result:n.result||"*",variant:n.variant||"Standard",fen:n.fen,moves:s}}catch(e){return console.error("Error parsing PGN:",e),null}}function Ys(t){const e=[],i=t.replace(/1-0|0-1|1\/2-1\/2|\*/g,"").replace(/\{[^}]*\}/g,"").replace(/\([^)]*\)/g,"").replace(/\$\d+/g,"").trim().split(/\s+/).filter(o=>o.length>0);let s="white";for(const o of i){if(/^\d+\.+$/.test(o)){s="white";continue}const r=o.match(/^(\d+)\.(.*)/);if(r&&r[2]){s="white",e.push({turn:s,notation:r[2]}),s="black";continue}o.length>0&&!o.match(/^\d+$/)&&(e.push({turn:s,notation:o}),s=s==="white"?"black":"white")}return e}function Js(t,e="game.pgn"){const n=new Blob([t],{type:"application/x-chess-pgn"}),i=URL.createObjectURL(n),s=document.createElement("a");s.href=i,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i)}async function Qs(t){try{return await navigator.clipboard.writeText(t),!0}catch{return!1}}function Xs(t){return new Promise((e,n)=>{const i=new FileReader;i.onload=s=>{const o=s.target?.result;typeof o=="string"?e(o):n(new Error("Failed to read file"))},i.onerror=()=>n(i.error),i.readAsText(t)})}let ue=null;function pn(t,e,n){ue=document.getElementById("analysisContainer"),ue||(ue=document.createElement("div"),ue.id="analysisContainer",document.body.appendChild(ue)),t&&t.length>0?pi(t):Ms(!0),mn(e,n),_(),$(),Je(),gn()}function Dt(){ue&&(ue.innerHTML=""),Ns(),Qt()}function mn(t,e){if(!ue)return;const n=un(),i=Jt();ue.innerHTML=`
    <div class="analysis-panel">
      <div class="analysis-header">
        <h3>${v("analysisMode")}</h3>
        <button id="closeAnalysisBtn" class="analysis-close-btn">&times;</button>
      </div>

      <div class="analysis-players">
        ${t?`<span class="player-white">‚¨ú ${t}</span>`:""}
        ${e?`<span class="player-black">‚¨õ ${e}</span>`:""}
      </div>

      <div class="analysis-controls">
        <button id="goStartBtn" class="nav-btn" title="Go to start">‚èÆ</button>
        <button id="goBackBtn" class="nav-btn" title="Previous move">‚óÄ</button>
        <span class="move-counter">${i+1} / ${n.length}</span>
        <button id="goForwardBtn" class="nav-btn" title="Next move">‚ñ∂</button>
        <button id="goEndBtn" class="nav-btn" title="Go to end">‚è≠</button>
      </div>

      <div class="analysis-moves" id="analysisMoveList">
        ${Ei(n,i)}
      </div>

      <div class="analysis-actions">
        <button id="toggleEditorBtn" class="analysis-btn">
          ${Ae()?v("exitEditor"):v("boardEditor")}
        </button>
        <button id="exportPGNBtn" class="analysis-btn">${v("exportPGN")}</button>
        <button id="importPGNBtn" class="analysis-btn">${v("importPGN")}</button>
      </div>

      <div id="editorPanel" class="editor-panel ${Ae()?"":"hidden"}">
        ${wi()}
      </div>

      <div class="engine-eval" id="engineEvalPanel">
        <div class="eval-header">
          <button id="engineToggleBtn" class="engine-toggle-btn active" title="Toggle engine">&#9881; Engine</button>
        </div>
        <div class="eval-content" id="evalContent">
          <div class="eval-bar-container">
            <div class="eval-bar" id="evalBar">
              <div class="eval-fill" id="evalFill"></div>
            </div>
            <span class="eval-score" id="evalScore">...</span>
          </div>
          <div class="eval-info" id="evalInfo"></div>
        </div>
      </div>

      <div class="engine-compare" id="engineComparePanel">
        <div class="compare-header">
          <span class="compare-status" id="engineStatus">Loading...</span>
        </div>
        <div class="compare-counts" id="compareCounts"></div>
        <div class="compare-diff hidden" id="compareDiff"></div>
      </div>

      <div class="analysis-footer">
        <button id="newGameFromHereBtn" class="analysis-btn primary">${v("playFromHere")}</button>
        <button id="exitAnalysisBtn" class="analysis-btn">${v("backToGame")}</button>
      </div>
    </div>
  `,Zs()}function Ei(t,e){if(t.length===0)return'<p class="no-moves">No moves yet</p>';const n=[];for(let i=0;i<t.length;i+=2){const s=Math.floor(i/2)+1,o=t[i],r=t[i+1],a=i===e?"active":"",c=i+1===e?"active":"";n.push(`
      <div class="move-pair">
        <span class="move-number">${s}.</span>
        <span class="move-notation ${a}" data-index="${i}">${o?.notation||""}</span>
        <span class="move-notation ${c}" data-index="${i+1}">${r?.notation||""}</span>
      </div>
    `)}return n.join("")}function wi(){const t=gi(),e=Us();return`
    <div class="editor-section">
      <h4>${v("pieces")}</h4>
      <div class="piece-palette">
        <div class="palette-row">
          ${Hn.white.map(n=>`
            <button class="palette-piece ${t===n?"selected":""}" data-piece="${n}">
              <span class="piece piece-white">${q[n[0]]||q[n]}</span>
            </button>
          `).join("")}
        </div>
        <div class="palette-row">
          ${Hn.black.map(n=>`
            <button class="palette-piece ${t===n?"selected":""}" data-piece="${n}">
              <span class="piece piece-black">${q[n[0]]||q[n]}</span>
            </button>
          `).join("")}
        </div>
        <button class="palette-piece erase ${t===null?"selected":""}" data-piece="erase">
          üóëÔ∏è
        </button>
      </div>
    </div>

    <div class="editor-section">
      <h4>${v("turnToMove")}</h4>
      <div class="turn-selector">
        <button class="turn-btn ${e==="white"?"active":""}" data-turn="white">${v("white")}</button>
        <button class="turn-btn ${e==="black"?"active":""}" data-turn="black">${v("black")}</button>
      </div>
    </div>

    <div class="editor-section">
      <h4>Quick actions</h4>
      <div class="editor-actions">
        <button id="clearBoardBtn" class="editor-action-btn">${v("clearBoard")}</button>
        <button id="standardPosBtn" class="editor-action-btn">${v("standardPosition")}</button>
      </div>
    </div>

    <div class="editor-section">
      <h4>FEN</h4>
      <div class="fen-input-group">
        <input type="text" id="fenInput" class="fen-input" placeholder="${v("pasteHere")}" value="${fn()}">
        <button id="loadFENBtn" class="fen-btn">${v("loadFEN")}</button>
        <button id="copyFENBtn" class="fen-btn">${v("copyFEN")}</button>
      </div>
    </div>
  `}function Zs(){document.getElementById("engineToggleBtn")?.addEventListener("click",()=>{Pe=!Pe;const t=document.getElementById("engineToggleBtn"),e=document.getElementById("evalContent");t&&t.classList.toggle("active",Pe),e&&e.classList.toggle("hidden",!Pe),Pe?gn():Te&&Te.abort()}),document.getElementById("closeAnalysisBtn")?.addEventListener("click",()=>{Dt(),De(),_(),$()}),document.getElementById("goStartBtn")?.addEventListener("click",()=>{$s(),se()}),document.getElementById("goBackBtn")?.addEventListener("click",()=>{As(),se()}),document.getElementById("goForwardBtn")?.addEventListener("click",()=>{Os(),se()}),document.getElementById("goEndBtn")?.addEventListener("click",()=>{mi(),se()}),document.getElementById("analysisMoveList")?.addEventListener("click",t=>{const e=t.target;if(e.classList.contains("move-notation")){const n=parseInt(e.dataset.index||"-1");n>=0&&(Fe(n),se())}}),document.getElementById("toggleEditorBtn")?.addEventListener("click",()=>{Ae()?Qt():Gs(),mn(),_()}),document.getElementById("exportPGNBtn")?.addEventListener("click",()=>{to()}),document.getElementById("importPGNBtn")?.addEventListener("click",()=>{no()}),document.getElementById("newGameFromHereBtn")?.addEventListener("click",()=>{if(Ae()){const t=Ks();if(!t.valid){alert(v("invalidPosition")+`:
`+t.errors.join(`
`));return}Qt()}Dt(),H(),_(),$()}),document.getElementById("exitAnalysisBtn")?.addEventListener("click",()=>{Dt(),De(),_(),$()}),Bi()}function Bi(){document.querySelectorAll(".palette-piece").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.piece;Wn(e==="erase"?null:e),jn()})}),document.querySelectorAll(".turn-btn").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.turn;yi(e),jn()})}),document.getElementById("clearBoardBtn")?.addEventListener("click",()=>{vi(),_(),Xt(),Je()}),document.getElementById("standardPosBtn")?.addEventListener("click",()=>{bi(),_(),Xt(),Je()}),document.getElementById("loadFENBtn")?.addEventListener("click",()=>{const t=document.getElementById("fenInput");t?.value&&(ki(t.value)?(_(),Je()):alert(v("invalidFEN")))}),document.getElementById("copyFENBtn")?.addEventListener("click",async()=>{const t=fn();try{await navigator.clipboard.writeText(t);const e=document.getElementById("copyFENBtn");e&&(e.textContent=v("copied"),setTimeout(()=>{e.textContent=v("copyFEN")},2e3))}catch{alert(v("invalidFEN"))}})}function se(){_(),$();const t=document.getElementById("analysisMoveList");t&&(t.innerHTML=Ei(un(),Jt()),t.querySelectorAll(".move-notation").forEach(n=>{n.addEventListener("click",()=>{const i=parseInt(n.dataset.index||"-1");i>=0&&(Fe(i),se())})}));const e=document.querySelector(".move-counter");e&&(e.textContent=`${Jt()+1} / ${Ls()}`),Je(),gn()}function jn(){const t=document.getElementById("editorPanel");t&&(t.innerHTML=wi(),Bi())}function Xt(){const t=document.getElementById("fenInput");t&&(t.value=fn())}function Je(){const t=document.getElementById("engineStatus"),e=document.getElementById("compareCounts"),n=document.getElementById("compareDiff");!t||!e||(t.textContent="Comparing...",e.innerHTML="",n&&(n.innerHTML="",n.classList.add("hidden")),Pt(async()=>{const{comparePositionMoves:i}=await Promise.resolve().then(()=>Qi);return{comparePositionMoves:i}},void 0,import.meta.url).then(({comparePositionMoves:i})=>i()).then(i=>{const s=document.getElementById("engineStatus"),o=document.getElementById("compareCounts"),r=document.getElementById("compareDiff");if(!(!s||!o)){if(!i.engineOnline){s.textContent="Engine offline",s.className="compare-status offline",o.innerHTML=`<span class="webapp-count">Webapp: ${i.webappCount} moves</span>`;return}if(i.hasMismatch){if(s.textContent="MISMATCH",s.className="compare-status mismatch",o.innerHTML=`
        <span class="webapp-count">Webapp: <strong>${i.webappCount}</strong></span>
        <span class="separator">|</span>
        <span class="engine-count">Engine: <strong>${i.engineCount}</strong></span>
        <button id="toggleDiffBtn" class="diff-toggle-btn">
          Show diff (${i.webappOnly.length+i.engineOnly.length} different)
        </button>
      `,r){let a='<div class="diff-content">';if(i.webappOnly.length>0){a+='<div class="diff-section webapp-only">',a+=`<h5>Only in Webapp (${i.webappOnly.length}):</h5>`,a+='<div class="move-chips">';for(const c of i.webappOnly)a+=`<span class="move-chip webapp">${c}</span>`;a+="</div></div>"}if(i.engineOnly.length>0){a+='<div class="diff-section engine-only">',a+=`<h5>Only in Engine (${i.engineOnly.length}):</h5>`,a+='<div class="move-chips">';for(const c of i.engineOnly)a+=`<span class="move-chip engine">${c}</span>`;a+="</div></div>"}a+='<div class="diff-section matching">',a+=`<h5>Matching (${i.matching.length}):</h5>`,a+='<div class="move-chips">';for(const c of i.matching)a+=`<span class="move-chip match">${c}</span>`;a+="</div></div>",a+="</div>",r.innerHTML=a}document.getElementById("toggleDiffBtn")?.addEventListener("click",()=>{if(r){r.classList.toggle("hidden");const a=document.getElementById("toggleDiffBtn");a&&(a.textContent=r.classList.contains("hidden")?`Show diff (${i.webappOnly.length+i.engineOnly.length} different)`:"Hide diff")}})}else s.textContent="MATCH",s.className="compare-status match",o.innerHTML=`
        <span class="webapp-count">Webapp: <strong>${i.webappCount}</strong></span>
        <span class="separator">|</span>
        <span class="engine-count">Engine: <strong>${i.engineCount}</strong></span>
      `}}))}function Vn(t){return t>=1e6?(t/1e6).toFixed(1)+"M":t>=1e3?(t/1e3).toFixed(1)+"k":String(t)}let Pe=!0,Te=null;function gn(){if(!Pe)return;const t=document.getElementById("evalScore");if(!t)return;Te&&Te.abort(),Te=new AbortController;const e=Te.signal;t.textContent="...",Pt(()=>Promise.resolve().then(()=>Qi),void 0,import.meta.url).then(async({fetchEngineEval:n,buildFullFEN:i})=>{const s=i(),o=10;for(let r=1;r<=o;r++){if(e.aborted)return;const a=await n(s,r);if(e.aborted)return;if(a.error){if(r===1){const c=document.getElementById("evalScore"),l=document.getElementById("evalFill"),d=document.getElementById("evalInfo");c&&(c.textContent="--"),l&&(l.style.width="50%"),d&&(d.innerHTML='<span style="color:#64748b">Engine offline</span>')}return}eo(a)}})}function eo(t){const e=document.getElementById("evalScore"),n=document.getElementById("evalFill"),i=document.getElementById("evalInfo");if(e){if(t.scoreType==="mate"){const s=t.score>0?"+":"";e.textContent=`M${s}${t.score}`}else{const s=t.score/100,o=s>0?"+":"";e.textContent=`${o}${s.toFixed(1)}`}if(n){let s;t.scoreType==="mate"?s=t.score>0?95:5:s=50+50*(2/(1+Math.exp(-t.score/400))-1),n.style.width=`${Math.max(2,Math.min(98,s))}%`}if(i){let s="";t.bestMove&&(s+=`<span class="eval-bestmove">Best: ${t.bestMove}</span>`),t.pv.length>1&&(s+=`<div class="eval-pv">${t.pv.slice(0,5).join(" ")}</div>`),s+=`<div class="eval-stats">depth ${t.depth} | ${Vn(t.nodes)} nodes | ${Vn(t.nps)} nps | ${t.time_ms}ms</div>`,i.innerHTML=s}}}function to(){const t=un(),e=zs({moves:t}),n=document.createElement("div");n.className="analysis-overlay",n.id="exportOverlay",n.innerHTML=`
    <div class="analysis-dialog">
      <h3>${v("exportPGN")}</h3>
      <textarea id="pgnOutput" class="pgn-textarea" readonly>${e}</textarea>
      <div class="dialog-buttons">
        <button id="copyPGNBtn" class="analysis-btn primary">${v("copyToClipboard")}</button>
        <button id="downloadPGNBtn" class="analysis-btn">${v("downloadFile")}</button>
        <button id="closeExportBtn" class="analysis-btn">${v("close")}</button>
      </div>
    </div>
  `,document.body.appendChild(n),document.getElementById("copyPGNBtn")?.addEventListener("click",async()=>{const i=await Qs(e),s=document.getElementById("copyPGNBtn");s&&(s.textContent=i?v("copied"):"Failed",setTimeout(()=>{s.textContent=v("copyToClipboard")},2e3))}),document.getElementById("downloadPGNBtn")?.addEventListener("click",()=>{const i=`klikschaak_${new Date().toISOString().split("T")[0]}.pgn`;Js(e,i)}),document.getElementById("closeExportBtn")?.addEventListener("click",()=>{n.remove()})}function no(){const t=document.createElement("div");t.className="analysis-overlay",t.id="importOverlay",t.innerHTML=`
    <div class="analysis-dialog">
      <h3>${v("importPGN")}</h3>
      <textarea id="pgnInput" class="pgn-textarea" placeholder="${v("pasteHere")}"></textarea>
      <div class="file-input-wrapper">
        <input type="file" id="pgnFileInput" accept=".pgn,.txt">
        <label for="pgnFileInput" class="analysis-btn">${v("chooseFile")}</label>
      </div>
      <div class="dialog-buttons">
        <button id="loadPGNBtn" class="analysis-btn primary">${v("loadPGN")}</button>
        <button id="closeImportBtn" class="analysis-btn">${v("cancel")}</button>
      </div>
    </div>
  `,document.body.appendChild(t),document.getElementById("pgnFileInput")?.addEventListener("change",async e=>{const n=e.target;if(n.files&&n.files[0])try{const i=await Xs(n.files[0]),s=document.getElementById("pgnInput");s&&(s.value=i)}catch{alert("Failed to read file")}}),document.getElementById("loadPGNBtn")?.addEventListener("click",()=>{const e=document.getElementById("pgnInput");if(e?.value){const n=Vs(e.value);n?(n.fen?ki(n.fen):bi(),pi(n.moves),t.remove(),mn(n.white,n.black),mi(),se()):alert("Failed to parse PGN")}}),document.getElementById("closeImportBtn")?.addEventListener("click",()=>{t.remove()})}function io(t,e){if(!Ae())return;gi()===null?Hs(t,e):Fs(t,e),_(),Xt()}function so(){return Ae()}function Tt(t,e,n){pn(t,e,n)}function oo(){if(document.getElementById("analysisBtn"))return;const e=document.createElement("button");e.id="analysisBtn",e.className="analysis-mode-btn",e.textContent=v("analysis"),e.title=v("analysisMode"),e.addEventListener("click",()=>{pn()}),document.body.appendChild(e)}let fe={from:null,to:null,moveType:null,unklikPieceIndex:null,promotionPiece:null};function ro(){return fe}function yn(){return fe.from!==null&&fe.to!==null}function ao(t,e,n,i,s){fe={from:t,to:e,moveType:n,unklikPieceIndex:i??null,promotionPiece:null}}function he(){fe={from:null,to:null,moveType:null,unklikPieceIndex:null,promotionPiece:null}}function co(t,e){return fe.from?.row===t&&fe.from?.col===e?"from":fe.to?.row===t&&fe.to?.col===e?"to":null}const ce=Object.create(null);ce.open="0";ce.close="1";ce.ping="2";ce.pong="3";ce.message="4";ce.upgrade="5";ce.noop="6";const dt=Object.create(null);Object.keys(ce).forEach(t=>{dt[ce[t]]=t});const Zt={type:"error",data:"parser error"},Si=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",Ci=typeof ArrayBuffer=="function",Ii=t=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(t):t&&t.buffer instanceof ArrayBuffer,vn=({type:t,data:e},n,i)=>Si&&e instanceof Blob?n?i(e):Yn(e,i):Ci&&(e instanceof ArrayBuffer||Ii(e))?n?i(e):Yn(new Blob([e]),i):i(ce[t]+(e||"")),Yn=(t,e)=>{const n=new FileReader;return n.onload=function(){const i=n.result.split(",")[1];e("b"+(i||""))},n.readAsDataURL(t)};function Jn(t){return t instanceof Uint8Array?t:t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}let Ut;function lo(t,e){if(Si&&t.data instanceof Blob)return t.data.arrayBuffer().then(Jn).then(e);if(Ci&&(t.data instanceof ArrayBuffer||Ii(t.data)))return e(Jn(t.data));vn(t,!1,n=>{Ut||(Ut=new TextEncoder),e(Ut.encode(n))})}const Qn="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",je=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let t=0;t<Qn.length;t++)je[Qn.charCodeAt(t)]=t;const uo=t=>{let e=t.length*.75,n=t.length,i,s=0,o,r,a,c;t[t.length-1]==="="&&(e--,t[t.length-2]==="="&&e--);const l=new ArrayBuffer(e),d=new Uint8Array(l);for(i=0;i<n;i+=4)o=je[t.charCodeAt(i)],r=je[t.charCodeAt(i+1)],a=je[t.charCodeAt(i+2)],c=je[t.charCodeAt(i+3)],d[s++]=o<<2|r>>4,d[s++]=(r&15)<<4|a>>2,d[s++]=(a&3)<<6|c&63;return l},ho=typeof ArrayBuffer=="function",bn=(t,e)=>{if(typeof t!="string")return{type:"message",data:Pi(t,e)};const n=t.charAt(0);return n==="b"?{type:"message",data:fo(t.substring(1),e)}:dt[n]?t.length>1?{type:dt[n],data:t.substring(1)}:{type:dt[n]}:Zt},fo=(t,e)=>{if(ho){const n=uo(t);return Pi(n,e)}else return{base64:!0,data:t}},Pi=(t,e)=>e==="blob"?t instanceof Blob?t:new Blob([t]):t instanceof ArrayBuffer?t:t.buffer,Ti="",po=(t,e)=>{const n=t.length,i=new Array(n);let s=0;t.forEach((o,r)=>{vn(o,!1,a=>{i[r]=a,++s===n&&e(i.join(Ti))})})},mo=(t,e)=>{const n=t.split(Ti),i=[];for(let s=0;s<n.length;s++){const o=bn(n[s],e);if(i.push(o),o.type==="error")break}return i};function go(){return new TransformStream({transform(t,e){lo(t,n=>{const i=n.length;let s;if(i<126)s=new Uint8Array(1),new DataView(s.buffer).setUint8(0,i);else if(i<65536){s=new Uint8Array(3);const o=new DataView(s.buffer);o.setUint8(0,126),o.setUint16(1,i)}else{s=new Uint8Array(9);const o=new DataView(s.buffer);o.setUint8(0,127),o.setBigUint64(1,BigInt(i))}t.data&&typeof t.data!="string"&&(s[0]|=128),e.enqueue(s),e.enqueue(n)})}})}let Gt;function rt(t){return t.reduce((e,n)=>e+n.length,0)}function at(t,e){if(t[0].length===e)return t.shift();const n=new Uint8Array(e);let i=0;for(let s=0;s<e;s++)n[s]=t[0][i++],i===t[0].length&&(t.shift(),i=0);return t.length&&i<t[0].length&&(t[0]=t[0].slice(i)),n}function yo(t,e){Gt||(Gt=new TextDecoder);const n=[];let i=0,s=-1,o=!1;return new TransformStream({transform(r,a){for(n.push(r);;){if(i===0){if(rt(n)<1)break;const c=at(n,1);o=(c[0]&128)===128,s=c[0]&127,s<126?i=3:s===126?i=1:i=2}else if(i===1){if(rt(n)<2)break;const c=at(n,2);s=new DataView(c.buffer,c.byteOffset,c.length).getUint16(0),i=3}else if(i===2){if(rt(n)<8)break;const c=at(n,8),l=new DataView(c.buffer,c.byteOffset,c.length),d=l.getUint32(0);if(d>Math.pow(2,21)-1){a.enqueue(Zt);break}s=d*Math.pow(2,32)+l.getUint32(4),i=3}else{if(rt(n)<s)break;const c=at(n,s);a.enqueue(bn(o?c:Gt.decode(c),e)),i=0}if(s===0||s>t){a.enqueue(Zt);break}}}})}const xi=4;function D(t){if(t)return vo(t)}function vo(t){for(var e in D.prototype)t[e]=D.prototype[e];return t}D.prototype.on=D.prototype.addEventListener=function(t,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(e),this};D.prototype.once=function(t,e){function n(){this.off(t,n),e.apply(this,arguments)}return n.fn=e,this.on(t,n),this};D.prototype.off=D.prototype.removeListener=D.prototype.removeAllListeners=D.prototype.removeEventListener=function(t,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var n=this._callbacks["$"+t];if(!n)return this;if(arguments.length==1)return delete this._callbacks["$"+t],this;for(var i,s=0;s<n.length;s++)if(i=n[s],i===e||i.fn===e){n.splice(s,1);break}return n.length===0&&delete this._callbacks["$"+t],this};D.prototype.emit=function(t){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),n=this._callbacks["$"+t],i=1;i<arguments.length;i++)e[i-1]=arguments[i];if(n){n=n.slice(0);for(var i=0,s=n.length;i<s;++i)n[i].apply(this,e)}return this};D.prototype.emitReserved=D.prototype.emit;D.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]};D.prototype.hasListeners=function(t){return!!this.listeners(t).length};const xt=typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,n)=>n(e,0),Q=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),bo="arraybuffer";function _i(t,...e){return e.reduce((n,i)=>(t.hasOwnProperty(i)&&(n[i]=t[i]),n),{})}const ko=Q.setTimeout,Eo=Q.clearTimeout;function _t(t,e){e.useNativeTimers?(t.setTimeoutFn=ko.bind(Q),t.clearTimeoutFn=Eo.bind(Q)):(t.setTimeoutFn=Q.setTimeout.bind(Q),t.clearTimeoutFn=Q.clearTimeout.bind(Q))}const wo=1.33;function Bo(t){return typeof t=="string"?So(t):Math.ceil((t.byteLength||t.size)*wo)}function So(t){let e=0,n=0;for(let i=0,s=t.length;i<s;i++)e=t.charCodeAt(i),e<128?n+=1:e<2048?n+=2:e<55296||e>=57344?n+=3:(i++,n+=4);return n}function Li(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function Co(t){let e="";for(let n in t)t.hasOwnProperty(n)&&(e.length&&(e+="&"),e+=encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e}function Io(t){let e={},n=t.split("&");for(let i=0,s=n.length;i<s;i++){let o=n[i].split("=");e[decodeURIComponent(o[0])]=decodeURIComponent(o[1])}return e}class Po extends Error{constructor(e,n,i){super(e),this.description=n,this.context=i,this.type="TransportError"}}class kn extends D{constructor(e){super(),this.writable=!1,_t(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,n,i){return super.emitReserved("error",new Po(e,n,i)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const n=bn(e,this.socket.binaryType);this.onPacket(n)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,n={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(n)}_hostname(){const e=this.opts.hostname;return e.indexOf(":")===-1?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&Number(this.opts.port)!==443||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(e){const n=Co(e);return n.length?"?"+n:""}}class To extends kn{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const n=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let i=0;this._polling&&(i++,this.once("pollComplete",function(){--i||n()})),this.writable||(i++,this.once("drain",function(){--i||n()}))}else n()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const n=i=>{if(this.readyState==="opening"&&i.type==="open"&&this.onOpen(),i.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(i)};mo(e,this.socket.binaryType).forEach(n),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,po(e,n=>{this.doWrite(n,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",n=this.query||{};return this.opts.timestampRequests!==!1&&(n[this.opts.timestampParam]=Li()),!this.supportsBinary&&!n.sid&&(n.b64=1),this.createUri(e,n)}}let Mi=!1;try{Mi=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const xo=Mi;function _o(){}class Lo extends To{constructor(e){if(super(e),typeof location<"u"){const n=location.protocol==="https:";let i=location.port;i||(i=n?"443":"80"),this.xd=typeof location<"u"&&e.hostname!==location.hostname||i!==e.port}}doWrite(e,n){const i=this.request({method:"POST",data:e});i.on("success",n),i.on("error",(s,o)=>{this.onError("xhr post error",s,o)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(n,i)=>{this.onError("xhr poll error",n,i)}),this.pollXhr=e}}class re extends D{constructor(e,n,i){super(),this.createRequest=e,_t(this,i),this._opts=i,this._method=i.method||"GET",this._uri=n,this._data=i.data!==void 0?i.data:null,this._create()}_create(){var e;const n=_i(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");n.xdomain=!!this._opts.xd;const i=this._xhr=this.createRequest(n);try{i.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){i.setDisableHeaderCheck&&i.setDisableHeaderCheck(!0);for(let s in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(s)&&i.setRequestHeader(s,this._opts.extraHeaders[s])}}catch{}if(this._method==="POST")try{i.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{i.setRequestHeader("Accept","*/*")}catch{}(e=this._opts.cookieJar)===null||e===void 0||e.addCookies(i),"withCredentials"in i&&(i.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(i.timeout=this._opts.requestTimeout),i.onreadystatechange=()=>{var s;i.readyState===3&&((s=this._opts.cookieJar)===null||s===void 0||s.parseCookies(i.getResponseHeader("set-cookie"))),i.readyState===4&&(i.status===200||i.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof i.status=="number"?i.status:0)},0))},i.send(this._data)}catch(s){this.setTimeoutFn(()=>{this._onError(s)},0);return}typeof document<"u"&&(this._index=re.requestsCount++,re.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=_o,e)try{this._xhr.abort()}catch{}typeof document<"u"&&delete re.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}re.requestsCount=0;re.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",Xn);else if(typeof addEventListener=="function"){const t="onpagehide"in Q?"pagehide":"unload";addEventListener(t,Xn,!1)}}function Xn(){for(let t in re.requests)re.requests.hasOwnProperty(t)&&re.requests[t].abort()}const Mo=(function(){const t=Ni({xdomain:!1});return t&&t.responseType!==null})();class No extends Lo{constructor(e){super(e);const n=e&&e.forceBase64;this.supportsBinary=Mo&&!n}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new re(Ni,this.uri(),e)}}function Ni(t){const e=t.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||xo))return new XMLHttpRequest}catch{}if(!e)try{return new Q[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const $i=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class $o extends kn{get name(){return"websocket"}doOpen(){const e=this.uri(),n=this.opts.protocols,i=$i?{}:_i(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(i.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,n,i)}catch(s){return this.emitReserved("error",s)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let n=0;n<e.length;n++){const i=e[n],s=n===e.length-1;vn(i,this.supportsBinary,o=>{try{this.doWrite(i,o)}catch{}s&&xt(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",n=this.query||{};return this.opts.timestampRequests&&(n[this.opts.timestampParam]=Li()),this.supportsBinary||(n.b64=1),this.createUri(e,n)}}const Ft=Q.WebSocket||Q.MozWebSocket;class Ao extends $o{createSocket(e,n,i){return $i?new Ft(e,n,i):n?new Ft(e,n):new Ft(e)}doWrite(e,n){this.ws.send(n)}}class Oo extends kn{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(e){return this.emitReserved("error",e)}this._transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(e=>{const n=yo(Number.MAX_SAFE_INTEGER,this.socket.binaryType),i=e.readable.pipeThrough(n).getReader(),s=go();s.readable.pipeTo(e.writable),this._writer=s.writable.getWriter();const o=()=>{i.read().then(({done:a,value:c})=>{a||(this.onPacket(c),o())}).catch(a=>{})};o();const r={type:"open"};this.query.sid&&(r.data=`{"sid":"${this.query.sid}"}`),this._writer.write(r).then(()=>this.onOpen())})})}write(e){this.writable=!1;for(let n=0;n<e.length;n++){const i=e[n],s=n===e.length-1;this._writer.write(i).then(()=>{s&&xt(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;(e=this._transport)===null||e===void 0||e.close()}}const qo={websocket:Ao,webtransport:Oo,polling:No},Ro=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,Do=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function en(t){if(t.length>8e3)throw"URI too long";const e=t,n=t.indexOf("["),i=t.indexOf("]");n!=-1&&i!=-1&&(t=t.substring(0,n)+t.substring(n,i).replace(/:/g,";")+t.substring(i,t.length));let s=Ro.exec(t||""),o={},r=14;for(;r--;)o[Do[r]]=s[r]||"";return n!=-1&&i!=-1&&(o.source=e,o.host=o.host.substring(1,o.host.length-1).replace(/;/g,":"),o.authority=o.authority.replace("[","").replace("]","").replace(/;/g,":"),o.ipv6uri=!0),o.pathNames=Uo(o,o.path),o.queryKey=Go(o,o.query),o}function Uo(t,e){const n=/\/{2,9}/g,i=e.replace(n,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&i.splice(0,1),e.slice(-1)=="/"&&i.splice(i.length-1,1),i}function Go(t,e){const n={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(i,s,o){s&&(n[s]=o)}),n}const tn=typeof addEventListener=="function"&&typeof removeEventListener=="function",ut=[];tn&&addEventListener("offline",()=>{ut.forEach(t=>t())},!1);class ye extends D{constructor(e,n){if(super(),this.binaryType=bo,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&typeof e=="object"&&(n=e,e=null),e){const i=en(e);n.hostname=i.host,n.secure=i.protocol==="https"||i.protocol==="wss",n.port=i.port,i.query&&(n.query=i.query)}else n.host&&(n.hostname=en(n.host).host);_t(this,n),this.secure=n.secure!=null?n.secure:typeof location<"u"&&location.protocol==="https:",n.hostname&&!n.port&&(n.port=this.secure?"443":"80"),this.hostname=n.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=n.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},n.transports.forEach(i=>{const s=i.prototype.name;this.transports.push(s),this._transportsByName[s]=i}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},n),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=Io(this.opts.query)),tn&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},ut.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const n=Object.assign({},this.opts.query);n.EIO=xi,n.transport=e,this.id&&(n.sid=this.id);const i=Object.assign({},this.opts,{query:n,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](i)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const e=this.opts.rememberUpgrade&&ye.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const n=this.createTransport(e);n.open(),this.setTransport(n)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",n=>this._onClose("transport close",n))}onOpen(){this.readyState="open",ye.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const n=new Error("server error");n.code=e.data,this._onError(n);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let n=1;for(let i=0;i<this.writeBuffer.length;i++){const s=this.writeBuffer[i].data;if(s&&(n+=Bo(s)),i>0&&n>this._maxPayload)return this.writeBuffer.slice(0,i);n+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,xt(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,n,i){return this._sendPacket("message",e,n,i),this}send(e,n,i){return this._sendPacket("message",e,n,i),this}_sendPacket(e,n,i,s){if(typeof n=="function"&&(s=n,n=void 0),typeof i=="function"&&(s=i,i=null),this.readyState==="closing"||this.readyState==="closed")return;i=i||{},i.compress=i.compress!==!1;const o={type:e,data:n,options:i};this.emitReserved("packetCreate",o),this.writeBuffer.push(o),s&&this.once("flush",s),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},n=()=>{this.off("upgrade",n),this.off("upgradeError",n),e()},i=()=>{this.once("upgrade",n),this.once("upgradeError",n)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?i():e()}):this.upgrading?i():e()),this}_onError(e){if(ye.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,n){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),tn&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const i=ut.indexOf(this._offlineEventListener);i!==-1&&ut.splice(i,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,n),this.writeBuffer=[],this._prevBufferLen=0}}}ye.protocol=xi;class Fo extends ye{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let n=this.createTransport(e),i=!1;ye.priorWebsocketSuccess=!1;const s=()=>{i||(n.send([{type:"ping",data:"probe"}]),n.once("packet",f=>{if(!i)if(f.type==="pong"&&f.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",n),!n)return;ye.priorWebsocketSuccess=n.name==="websocket",this.transport.pause(()=>{i||this.readyState!=="closed"&&(d(),this.setTransport(n),n.send([{type:"upgrade"}]),this.emitReserved("upgrade",n),n=null,this.upgrading=!1,this.flush())})}else{const h=new Error("probe error");h.transport=n.name,this.emitReserved("upgradeError",h)}}))};function o(){i||(i=!0,d(),n.close(),n=null)}const r=f=>{const h=new Error("probe error: "+f);h.transport=n.name,o(),this.emitReserved("upgradeError",h)};function a(){r("transport closed")}function c(){r("socket closed")}function l(f){n&&f.name!==n.name&&o()}const d=()=>{n.removeListener("open",s),n.removeListener("error",r),n.removeListener("close",a),this.off("close",c),this.off("upgrading",l)};n.once("open",s),n.once("error",r),n.once("close",a),this.once("close",c),this.once("upgrading",l),this._upgrades.indexOf("webtransport")!==-1&&e!=="webtransport"?this.setTimeoutFn(()=>{i||n.open()},200):n.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const n=[];for(let i=0;i<e.length;i++)~this.transports.indexOf(e[i])&&n.push(e[i]);return n}}let Ho=class extends Fo{constructor(e,n={}){const i=typeof e=="object"?e:n;(!i.transports||i.transports&&typeof i.transports[0]=="string")&&(i.transports=(i.transports||["polling","websocket","webtransport"]).map(s=>qo[s]).filter(s=>!!s)),super(e,i)}};function Wo(t,e="",n){let i=t;n=n||typeof location<"u"&&location,t==null&&(t=n.protocol+"//"+n.host),typeof t=="string"&&(t.charAt(0)==="/"&&(t.charAt(1)==="/"?t=n.protocol+t:t=n.host+t),/^(https?|wss?):\/\//.test(t)||(typeof n<"u"?t=n.protocol+"//"+t:t="https://"+t),i=en(t)),i.port||(/^(http|ws)$/.test(i.protocol)?i.port="80":/^(http|ws)s$/.test(i.protocol)&&(i.port="443")),i.path=i.path||"/";const o=i.host.indexOf(":")!==-1?"["+i.host+"]":i.host;return i.id=i.protocol+"://"+o+":"+i.port+e,i.href=i.protocol+"://"+o+(n&&n.port===i.port?"":":"+i.port),i}const Ko=typeof ArrayBuffer=="function",zo=t=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(t):t.buffer instanceof ArrayBuffer,Ai=Object.prototype.toString,jo=typeof Blob=="function"||typeof Blob<"u"&&Ai.call(Blob)==="[object BlobConstructor]",Vo=typeof File=="function"||typeof File<"u"&&Ai.call(File)==="[object FileConstructor]";function En(t){return Ko&&(t instanceof ArrayBuffer||zo(t))||jo&&t instanceof Blob||Vo&&t instanceof File}function ht(t,e){if(!t||typeof t!="object")return!1;if(Array.isArray(t)){for(let n=0,i=t.length;n<i;n++)if(ht(t[n]))return!0;return!1}if(En(t))return!0;if(t.toJSON&&typeof t.toJSON=="function"&&arguments.length===1)return ht(t.toJSON(),!0);for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)&&ht(t[n]))return!0;return!1}function Yo(t){const e=[],n=t.data,i=t;return i.data=nn(n,e),i.attachments=e.length,{packet:i,buffers:e}}function nn(t,e){if(!t)return t;if(En(t)){const n={_placeholder:!0,num:e.length};return e.push(t),n}else if(Array.isArray(t)){const n=new Array(t.length);for(let i=0;i<t.length;i++)n[i]=nn(t[i],e);return n}else if(typeof t=="object"&&!(t instanceof Date)){const n={};for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=nn(t[i],e));return n}return t}function Jo(t,e){return t.data=sn(t.data,e),delete t.attachments,t}function sn(t,e){if(!t)return t;if(t&&t._placeholder===!0){if(typeof t.num=="number"&&t.num>=0&&t.num<e.length)return e[t.num];throw new Error("illegal attachments")}else if(Array.isArray(t))for(let n=0;n<t.length;n++)t[n]=sn(t[n],e);else if(typeof t=="object")for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(t[n]=sn(t[n],e));return t}const Qo=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"];var I;(function(t){t[t.CONNECT=0]="CONNECT",t[t.DISCONNECT=1]="DISCONNECT",t[t.EVENT=2]="EVENT",t[t.ACK=3]="ACK",t[t.CONNECT_ERROR=4]="CONNECT_ERROR",t[t.BINARY_EVENT=5]="BINARY_EVENT",t[t.BINARY_ACK=6]="BINARY_ACK"})(I||(I={}));class Xo{constructor(e){this.replacer=e}encode(e){return(e.type===I.EVENT||e.type===I.ACK)&&ht(e)?this.encodeAsBinary({type:e.type===I.EVENT?I.BINARY_EVENT:I.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let n=""+e.type;return(e.type===I.BINARY_EVENT||e.type===I.BINARY_ACK)&&(n+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(n+=e.nsp+","),e.id!=null&&(n+=e.id),e.data!=null&&(n+=JSON.stringify(e.data,this.replacer)),n}encodeAsBinary(e){const n=Yo(e),i=this.encodeAsString(n.packet),s=n.buffers;return s.unshift(i),s}}class wn extends D{constructor(e){super(),this.reviver=e}add(e){let n;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");n=this.decodeString(e);const i=n.type===I.BINARY_EVENT;i||n.type===I.BINARY_ACK?(n.type=i?I.EVENT:I.ACK,this.reconstructor=new Zo(n),n.attachments===0&&super.emitReserved("decoded",n)):super.emitReserved("decoded",n)}else if(En(e)||e.base64)if(this.reconstructor)n=this.reconstructor.takeBinaryData(e),n&&(this.reconstructor=null,super.emitReserved("decoded",n));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let n=0;const i={type:Number(e.charAt(0))};if(I[i.type]===void 0)throw new Error("unknown packet type "+i.type);if(i.type===I.BINARY_EVENT||i.type===I.BINARY_ACK){const o=n+1;for(;e.charAt(++n)!=="-"&&n!=e.length;);const r=e.substring(o,n);if(r!=Number(r)||e.charAt(n)!=="-")throw new Error("Illegal attachments");i.attachments=Number(r)}if(e.charAt(n+1)==="/"){const o=n+1;for(;++n&&!(e.charAt(n)===","||n===e.length););i.nsp=e.substring(o,n)}else i.nsp="/";const s=e.charAt(n+1);if(s!==""&&Number(s)==s){const o=n+1;for(;++n;){const r=e.charAt(n);if(r==null||Number(r)!=r){--n;break}if(n===e.length)break}i.id=Number(e.substring(o,n+1))}if(e.charAt(++n)){const o=this.tryParse(e.substr(n));if(wn.isPayloadValid(i.type,o))i.data=o;else throw new Error("invalid payload")}return i}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,n){switch(e){case I.CONNECT:return Zn(n);case I.DISCONNECT:return n===void 0;case I.CONNECT_ERROR:return typeof n=="string"||Zn(n);case I.EVENT:case I.BINARY_EVENT:return Array.isArray(n)&&(typeof n[0]=="number"||typeof n[0]=="string"&&Qo.indexOf(n[0])===-1);case I.ACK:case I.BINARY_ACK:return Array.isArray(n)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class Zo{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const n=Jo(this.reconPack,this.buffers);return this.finishedReconstruction(),n}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}function Zn(t){return Object.prototype.toString.call(t)==="[object Object]"}const er=Object.freeze(Object.defineProperty({__proto__:null,Decoder:wn,Encoder:Xo,get PacketType(){return I}},Symbol.toStringTag,{value:"Module"}));function ie(t,e,n){return t.on(e,n),function(){t.off(e,n)}}const tr=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Oi extends D{constructor(e,n,i){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=n,i&&i.auth&&(this.auth=i.auth),this._opts=Object.assign({},i),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[ie(e,"open",this.onopen.bind(this)),ie(e,"packet",this.onpacket.bind(this)),ie(e,"error",this.onerror.bind(this)),ie(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...n){var i,s,o;if(tr.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(n.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(n),this;const r={type:I.EVENT,data:n};if(r.options={},r.options.compress=this.flags.compress!==!1,typeof n[n.length-1]=="function"){const d=this.ids++,f=n.pop();this._registerAckCallback(d,f),r.id=d}const a=(s=(i=this.io.engine)===null||i===void 0?void 0:i.transport)===null||s===void 0?void 0:s.writable,c=this.connected&&!(!((o=this.io.engine)===null||o===void 0)&&o._hasPingExpired());return this.flags.volatile&&!a||(c?(this.notifyOutgoingListeners(r),this.packet(r)):this.sendBuffer.push(r)),this.flags={},this}_registerAckCallback(e,n){var i;const s=(i=this.flags.timeout)!==null&&i!==void 0?i:this._opts.ackTimeout;if(s===void 0){this.acks[e]=n;return}const o=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let a=0;a<this.sendBuffer.length;a++)this.sendBuffer[a].id===e&&this.sendBuffer.splice(a,1);n.call(this,new Error("operation has timed out"))},s),r=(...a)=>{this.io.clearTimeoutFn(o),n.apply(this,a)};r.withError=!0,this.acks[e]=r}emitWithAck(e,...n){return new Promise((i,s)=>{const o=(r,a)=>r?s(r):i(a);o.withError=!0,n.push(o),this.emit(e,...n)})}_addToQueue(e){let n;typeof e[e.length-1]=="function"&&(n=e.pop());const i={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((s,...o)=>(this._queue[0],s!==null?i.tryCount>this._opts.retries&&(this._queue.shift(),n&&n(s)):(this._queue.shift(),n&&n(null,...o)),i.pending=!1,this._drainQueue())),this._queue.push(i),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const n=this._queue[0];n.pending&&!e||(n.pending=!0,n.tryCount++,this.flags=n.flags,this.emit.apply(this,n.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:I.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,n){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,n),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(i=>String(i.id)===e)){const i=this.acks[e];delete this.acks[e],i.withError&&i.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case I.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case I.EVENT:case I.BINARY_EVENT:this.onevent(e);break;case I.ACK:case I.BINARY_ACK:this.onack(e);break;case I.DISCONNECT:this.ondisconnect();break;case I.CONNECT_ERROR:this.destroy();const i=new Error(e.data.message);i.data=e.data.data,this.emitReserved("connect_error",i);break}}onevent(e){const n=e.data||[];e.id!=null&&n.push(this.ack(e.id)),this.connected?this.emitEvent(n):this.receiveBuffer.push(Object.freeze(n))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const n=this._anyListeners.slice();for(const i of n)i.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const n=this;let i=!1;return function(...s){i||(i=!0,n.packet({type:I.ACK,id:e,data:s}))}}onack(e){const n=this.acks[e.id];typeof n=="function"&&(delete this.acks[e.id],n.withError&&e.data.unshift(null),n.apply(this,e.data))}onconnect(e,n){this.id=e,this.recovered=n&&this._pid===n,this._pid=n,this.connected=!0,this.emitBuffered(),this._drainQueue(!0),this.emitReserved("connect")}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:I.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const n=this._anyListeners;for(let i=0;i<n.length;i++)if(e===n[i])return n.splice(i,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const n=this._anyOutgoingListeners;for(let i=0;i<n.length;i++)if(e===n[i])return n.splice(i,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const n=this._anyOutgoingListeners.slice();for(const i of n)i.apply(this,e.data)}}}function He(t){t=t||{},this.ms=t.min||100,this.max=t.max||1e4,this.factor=t.factor||2,this.jitter=t.jitter>0&&t.jitter<=1?t.jitter:0,this.attempts=0}He.prototype.duration=function(){var t=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),n=Math.floor(e*this.jitter*t);t=(Math.floor(e*10)&1)==0?t-n:t+n}return Math.min(t,this.max)|0};He.prototype.reset=function(){this.attempts=0};He.prototype.setMin=function(t){this.ms=t};He.prototype.setMax=function(t){this.max=t};He.prototype.setJitter=function(t){this.jitter=t};class on extends D{constructor(e,n){var i;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(n=e,e=void 0),n=n||{},n.path=n.path||"/socket.io",this.opts=n,_t(this,n),this.reconnection(n.reconnection!==!1),this.reconnectionAttempts(n.reconnectionAttempts||1/0),this.reconnectionDelay(n.reconnectionDelay||1e3),this.reconnectionDelayMax(n.reconnectionDelayMax||5e3),this.randomizationFactor((i=n.randomizationFactor)!==null&&i!==void 0?i:.5),this.backoff=new He({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(n.timeout==null?2e4:n.timeout),this._readyState="closed",this.uri=e;const s=n.parser||er;this.encoder=new s.Encoder,this.decoder=new s.Decoder,this._autoConnect=n.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var n;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(n=this.backoff)===null||n===void 0||n.setMin(e),this)}randomizationFactor(e){var n;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(n=this.backoff)===null||n===void 0||n.setJitter(e),this)}reconnectionDelayMax(e){var n;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(n=this.backoff)===null||n===void 0||n.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new Ho(this.uri,this.opts);const n=this.engine,i=this;this._readyState="opening",this.skipReconnect=!1;const s=ie(n,"open",function(){i.onopen(),e&&e()}),o=a=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",a),e?e(a):this.maybeReconnectOnOpen()},r=ie(n,"error",o);if(this._timeout!==!1){const a=this._timeout,c=this.setTimeoutFn(()=>{s(),o(new Error("timeout")),n.close()},a);this.opts.autoUnref&&c.unref(),this.subs.push(()=>{this.clearTimeoutFn(c)})}return this.subs.push(s),this.subs.push(r),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(ie(e,"ping",this.onping.bind(this)),ie(e,"data",this.ondata.bind(this)),ie(e,"error",this.onerror.bind(this)),ie(e,"close",this.onclose.bind(this)),ie(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(n){this.onclose("parse error",n)}}ondecoded(e){xt(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,n){let i=this.nsps[e];return i?this._autoConnect&&!i.active&&i.connect():(i=new Oi(this,e,n),this.nsps[e]=i),i}_destroy(e){const n=Object.keys(this.nsps);for(const i of n)if(this.nsps[i].active)return;this._close()}_packet(e){const n=this.encoder.encode(e);for(let i=0;i<n.length;i++)this.engine.write(n[i],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,n){var i;this.cleanup(),(i=this.engine)===null||i===void 0||i.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,n),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const n=this.backoff.duration();this._reconnecting=!0;const i=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(s=>{s?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",s)):e.onreconnect()}))},n);this.opts.autoUnref&&i.unref(),this.subs.push(()=>{this.clearTimeoutFn(i)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const ze={};function ft(t,e){typeof t=="object"&&(e=t,t=void 0),e=e||{};const n=Wo(t,e.path||"/socket.io"),i=n.source,s=n.id,o=n.path,r=ze[s]&&o in ze[s].nsps,a=e.forceNew||e["force new connection"]||e.multiplex===!1||r;let c;return a?c=new on(i,e):(ze[s]||(ze[s]=new on(i,e)),c=ze[s]),n.query&&!e.query&&(e.query=n.queryKey),c.socket(n.path,e)}Object.assign(ft,{Manager:on,Socket:Oi,io:ft,connect:ft});const qi="https://klikschaak-api.onrender.com",Bn="klikschaak_token",Sn="klikschaak_user";let xe=null;function We(){return localStorage.getItem(Bn)}function Ee(){if(xe)return xe;const t=localStorage.getItem(Sn);if(t)try{return xe=JSON.parse(t),xe}catch{return null}return null}function nr(){return We()!==null&&Ee()!==null}function Ri(t,e){localStorage.setItem(Bn,e),localStorage.setItem(Sn,JSON.stringify(t)),xe=t}function ir(){localStorage.removeItem(Bn),localStorage.removeItem(Sn),xe=null}async function sr(t,e,n){try{const i=await fetch(`${qi}/api/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,email:e,password:n})}),s=await i.json();return i.ok?(Ri(s.user,s.token),{success:!0}):{success:!1,error:s.error||"Registration failed"}}catch(i){return console.error("Registration error:",i),{success:!1,error:"Network error"}}}async function or(t,e){try{const n=await fetch(`${qi}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,password:e})}),i=await n.json();return n.ok?(Ri(i.user,i.token),{success:!0}):{success:!1,error:i.error||"Login failed"}}catch(n){return console.error("Login error:",n),{success:!1,error:"Network error"}}}function rr(){ir()}let J=null;const ar="https://klikschaak-api.onrender.com";function cr(){return new Promise((t,e)=>{const n=We();if(!n){e(new Error("Not authenticated"));return}if(J?.connected){t(J);return}J=ft(ar,{auth:{token:n},reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3}),J.on("connect",()=>{console.log("Connected to server"),t(J)}),J.on("connect_error",i=>{console.error("Connection error:",i.message),e(i)}),J.on("disconnect",i=>{console.log("Disconnected:",i)}),J.on("reconnect",i=>{console.log("Reconnected after",i,"attempts")})})}function W(){return J}function lr(){J&&(J.disconnect(),J=null)}let B=null,Qe=!1,me=null,Di=null,rn=null,an=null,Ui=null,Gi=null,Fi=null,cn=null;function dr(){const t=W();t&&(t.on("game:created",e=>{B={gameId:e.gameId,gameCode:e.gameCode,myColor:e.color,board:ti(),currentTurn:"white",timer:{white:ei(e.timeControl),black:ei(e.timeControl)},opponent:null,moveHistory:[],enPassantTarget:null,castlingRights:{white:{kingSide:!0,queenSide:!0},black:{kingSide:!0,queenSide:!0}},movedPawns:[],gameStarted:!1,gameOver:!1,result:null},Qe=!0,Di?.(e.gameCode)}),t.on("game:joined",e=>{B={gameId:e.gameId,gameCode:e.gameCode,myColor:e.color,board:ti(),currentTurn:"white",timer:{white:42e4,black:42e4},opponent:e.opponent,moveHistory:[],enPassantTarget:null,castlingRights:{white:{kingSide:!0,queenSide:!0},black:{kingSide:!0,queenSide:!0}},movedPawns:[],gameStarted:!1,gameOver:!1,result:null},Qe=!0,rn?.(B)}),t.on("game:started",e=>{B&&(B.board=e.board,B.currentTurn=e.currentTurn,B.timer=e.timer,B.gameStarted=!0,B.opponent=B.myColor==="white"?e.black:e.white,an?.(B))}),t.on("game:move-made",e=>{B&&(B.board=e.board,B.currentTurn=e.currentTurn,B.timer=e.timer,B.enPassantTarget=e.enPassantTarget,B.castlingRights=e.castlingRights,B.movedPawns=e.movedPawns,B.moveHistory.push({turn:e.currentTurn==="white"?"black":"white",notation:e.notation}),Ui?.(B))}),t.on("game:move-rejected",e=>{cn?.(e.error)}),t.on("game:timer-sync",e=>{B&&(B.timer=e,Gi?.(e.white,e.black))}),t.on("game:over",e=>{B&&(B.gameOver=!0,B.result=e,e.whitePlayerId&&e.blackPlayerId&&(me={opponentId:(e.whitePlayerId===B.myColor||B.myColor==="white"?e.whitePlayerId:e.blackPlayerId)===e.whitePlayerId?e.blackPlayerId:e.whitePlayerId,opponentName:B.opponent?.username||"Unknown",whitePlayerId:e.whitePlayerId,timeControl:e.timeControl||"standard",customSettings:e.customSettings}),Fi?.(e))}),t.on("game:error",e=>{cn?.(e.message)}),t.on("game:state",e=>{e&&(B={gameId:e.id,gameCode:e.gameCode,myColor:e.yourColor,board:e.board,currentTurn:e.currentTurn,timer:e.timer,opponent:e.yourColor==="white"?e.blackPlayer:e.whitePlayer,moveHistory:e.moveHistory,enPassantTarget:e.enPassantTarget,castlingRights:e.castlingRights,movedPawns:e.movedPawns,gameStarted:e.gameStarted,gameOver:e.gameOver,result:e.result},Qe=!0,rn?.(B),e.gameStarted&&an?.(B))}))}function ei(t){switch(t){case"bullet":return 60*1e3;case"blitz-3":return 180*1e3;case"blitz-5":return 300*1e3;case"rapid-7":return 420*1e3;case"standard":return 420*1e3;default:return 420*1e3}}function ti(){return Array(8).fill(null).map(()=>Array(8).fill(null).map(()=>({pieces:[]})))}function ur(t){t.onGameCreated&&(Di=t.onGameCreated),t.onGameJoined&&(rn=t.onGameJoined),t.onGameStarted&&(an=t.onGameStarted),t.onMoveMade&&(Ui=t.onMoveMade),t.onTimerUpdate&&(Gi=t.onTimerUpdate),t.onGameOver&&(Fi=t.onGameOver),t.onError&&(cn=t.onError)}function hr(t="standard",e){W()?.emit("game:create",{timeControl:t,customSettings:e})}function fr(t){W()?.emit("game:join",{gameCode:t.toUpperCase()})}function Cn(t,e,n,i,s){if(!B)return;W()?.emit("game:move",{gameId:B.gameId,from:t,to:e,moveType:n,unklikIndex:i,promoteTo:s})}function pr(){if(!B)return;W()?.emit("game:resign",{gameId:B.gameId})}function mr(){if(!B)return;W()?.emit("game:draw-offer",{gameId:B.gameId})}function ni(t){if(!B)return;W()?.emit("game:draw-response",{gameId:B.gameId,accept:t})}function ln(){return B}function ke(){return Qe}function Lt(){return B!==null&&B.currentTurn===B.myColor}function In(){return B?.myColor||null}function Hi(){B=null,Qe=!1}function gr(){return me}function yr(){if(!me)return;W()?.emit("game:rematch-request",{opponentId:me.opponentId,timeControl:me.timeControl,customSettings:me.customSettings,previousWhiteId:me.whitePlayerId})}function Wi(){me=null}let dn=!1;function tt(t){dn=t}window.handleSquareClick=Ze;window.handleUnklikSelect=es;window.initializeBoard=De;window.toggleAutoPromote=ts;window.executePromotion=Ln;window.executeCastling=Oe;window.movePiece=qe;window.switchLanguage=vr;function vr(){const t=oe()==="nl"?"en":"nl";ms(t),_(),$(),br()}function br(){const t=document.querySelector(".header h1");t&&(t.textContent=`üëë ${v("title")}`);const e=document.querySelector(".header p");e&&(e.textContent=v("subtitle"));const n=document.querySelector(".new-game-btn");n&&(n.textContent=`üîÑ ${v("newGame")}`);const i=document.querySelector(".panel h2");if(i){const l=document.getElementById("moveCount")?.textContent||"0";i.innerHTML=`üìã ${v("moves")} (<span id="moveCount">${l}</span>)`}const s=document.querySelector(".rules h2");s&&(s.textContent=`‚ö° ${v("gameRules")}`);const o=document.querySelectorAll(".rules p");o.length>=4&&(o[0].innerHTML=`<strong style="color: #c084fc;">${v("klik")}</strong> ${oe()==="nl"?"Selecteer stuk, klik op veld met blauwe ring":"Select piece, click square with blue ring"}`,o[1].innerHTML=`<strong style="color: #60a5fa;">${v("unklik")}</strong> ${oe()==="nl"?"Klik op driehoek met het stuk":"Click triangle with the piece"}`,o[2].innerHTML=`‚ö†Ô∏è ${v("kingWarning")}`,o[3].innerHTML=`üí° ${v("promotionTip")}`);const r=document.querySelector('label[for="autoPromote"]');r&&(r.textContent=v("autoPromote"));const a=document.querySelector("#selectedInfo h2");a&&(a.textContent=v("selected"));const c=document.getElementById("langBtn");c&&(c.textContent=oe()==="nl"?"EN":"NL")}function kr(t,e,n,i){if(t.length===0)return"";const s=g=>E(g)?"piece piece-white":"piece piece-black";if(t.length===1)return`<div class="${s(t[0])}">${q[t[0]]}</div>`;const o=[...t].sort((g,m)=>Gn(m)-Gn(g)),r=o[0],a=o[1],c=E(t[0]),l=bt(),d=i&&l!==null&&t.indexOf(r)===l,f=i&&l!==null&&t.indexOf(a)===l,h=i&&l===null,u=O();let p;if(ke()){const g=In();p=Lt()&&(c&&g==="white"||!c&&g==="black")}else p=c&&u==="white"||!c&&u==="black";return`<div class="stacked-piece">
    <svg class="stacked-svg" viewBox="0 0 64 64">
      <line x1="32" y1="0" x2="0" y2="64" stroke="rgba(100,100,100,0.4)" stroke-width="2"/>
      <line x1="32" y1="0" x2="64" y2="64" stroke="rgba(100,100,100,0.4)" stroke-width="2"/>
    </svg>
    ${h?'<div class="whole-selected"></div>':""}
    <div class="stacked-center">
      <div class="stacked-top ${s(a)}">${q[a]}</div>
      <div class="stacked-bottom ${s(r)}">${q[r]}</div>
    </div>
    ${p?`
      <div class="triangle-left ${d?"selected":""}" onclick="handleUnklikSelect(${e},${n},${t.indexOf(r)},event)" title="${oe()==="nl"?"Zet met":"Move with"} ${yt(r)}">
        <span class="triangle-symbol left ${s(r)}">${q[r]}</span>
      </div>
      <div class="triangle-right ${f?"selected":""}" onclick="handleUnklikSelect(${e},${n},${t.indexOf(a)},event)" title="${oe()==="nl"?"Zet met":"Move with"} ${yt(a)}">
        <span class="triangle-symbol right ${s(a)}">${q[a]}</span>
      </div>
    `:""}
    ${!d&&!h?'<div class="triangle-bg-left"></div>':""}
    ${!f&&!h?'<div class="triangle-bg-right"></div>':""}
  </div>`}function _(){const t=document.getElementById("board");if(!t)return;const e=A(),n=vt(),i=Ne(),s=t.offsetHeight;s>0&&(t.style.minHeight=s+"px"),t.innerHTML="";const o=dn?[7,6,5,4,3,2,1,0]:[0,1,2,3,4,5,6,7],r=dn?[7,6,5,4,3,2,1,0]:[0,1,2,3,4,5,6,7];for(const a of o){const c=document.createElement("div");c.className="board-row";for(const l of r){const d=document.createElement("div"),f=(a+l)%2===0;d.className=`square ${f?"light":"dark"}`,d.dataset.row=String(a),d.dataset.col=String(l),n&&n[0]===a&&n[1]===l&&d.classList.add("selected");const h=co(a,l);h==="from"?d.classList.add("premove-from"):h==="to"&&d.classList.add("premove-to");const u=e[a][l].pieces,p=n&&n[0]===a&&n[1]===l;d.innerHTML=kr(u,a,l,!!p);const g=i.find(m=>m.row===a&&m.col===l);if(g){const m=document.createElement("div");g.type==="klik"?m.className="valid-klik":g.type==="unklik-klik"?m.className="valid-unklik-klik":u.length>0?m.className="valid-capture":m.className="valid-move",d.appendChild(m)}d.onclick=m=>{const b=m.target;!b.classList.contains("triangle-left")&&!b.classList.contains("triangle-right")&&(so()?io(a,l):Ze(a,l))},d.oncontextmenu=m=>{m.preventDefault(),ns()},c.appendChild(d)}t.appendChild(c)}t.style.minHeight=""}function $(){const t=document.getElementById("turnIndicator");t&&(t.textContent=O()==="white"?v("whiteToMove"):v("blackToMove"),t.className=`turn-indicator ${O()==="white"?"turn-white":"turn-black"}`);const e=document.getElementById("moveCount");e&&(e.textContent=String(Math.ceil(X().length/2)));const n=document.getElementById("moveHistory"),i=X();if(n)if(i.length===0)n.innerHTML=`<p style="color:#94a3b8;text-align:center;padding:16px 0;">${v("noMoves")}</p>`;else{const s=[];for(let o=0;o<i.length;o+=2){const r=i[o],a=o+1<i.length?i[o+1]:null;s.push({moveNumber:Math.floor(o/2)+1,white:r,black:a})}n.innerHTML=s.slice(-10).reverse().map(o=>{const r=o.white?o.white.notation:"",a=o.black?o.black.notation:"";return`<div class="move-pair">
          <span class="move-number">${o.moveNumber}.</span>
          <span class="move-white">${r}</span>
          <span class="move-black">${a}</span>
        </div>`}).join("")}Er()}function Er(){const t=document.getElementById("selectedInfo");if(!t)return;const e=vt();if(e&&A()[e[0]][e[1]].pieces.length>0){t.classList.add("show");const n=A()[e[0]][e[1]].pieces,i=a=>E(a)?"selected-piece-icon piece piece-white":"selected-piece-icon piece piece-black",s=document.getElementById("selectedPieces");s&&(s.innerHTML=n.map(a=>`<div class="${i(a)}">${q[a]}</div>`).join(""));const o=document.getElementById("selectedNames");o&&(o.textContent=n.map(a=>yt(a)).join(" + "));const r=document.getElementById("selectedMoves");r&&(r.textContent=`${Ne().length} ${v("possibleMoves")}`)}else t.classList.remove("show")}function wr(){const t=document.getElementById("checkIndicator");t&&t.remove();const e=document.createElement("div");e.id="checkIndicator",e.className="check-indicator",e.textContent=v("check");const n=document.querySelector(".board-container");n&&(n.style.position="relative",n.appendChild(e)),setTimeout(()=>{const i=document.getElementById("checkIndicator");i&&i.remove()},3e3)}function wt(t,e){const n=document.createElement("div");n.className="promotion-overlay",n.id="gameOverOverlay";const i=document.createElement("div");i.className="game-over-box";const s=document.createElement("button");s.className="game-over-close",s.textContent="√ó",s.onclick=()=>n.remove(),i.appendChild(s);const o=document.createElement("div");o.className="game-over-title",t==="checkmate"?o.textContent=v("checkmate"):t==="stalemate"?o.textContent=v("stalemate"):o.textContent=oe()==="nl"?"Opgegeven":"Resigned",i.appendChild(o);const r=document.createElement("div");if(r.className="game-over-message",t==="stalemate")r.textContent=v("gameEndsDraw");else{const d=e==="white"?oe()==="nl"?"Wit":"White":oe()==="nl"?"Zwart":"Black";r.textContent=`${d} ${v("wins")}`}i.appendChild(r);const a=document.createElement("div");a.style.cssText="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;";const c=document.createElement("button");c.className="game-over-btn",c.textContent=oe()==="nl"?"Analyse":"Analysis",c.onclick=()=>{n.remove();const d=X();Tt(d)},a.appendChild(c);const l=document.createElement("button");l.className="game-over-btn",l.textContent=v("newGame"),l.onclick=()=>De(),a.appendChild(l),i.appendChild(a),n.appendChild(i),n.onclick=d=>{d.target===n&&n.remove()},document.body.appendChild(n)}function Ht(){const t=hi();if(!t)return;const e=document.createElement("div");e.className="promotion-overlay",e.id="promotionOverlay";const n=t.isWhite,i=n?["Q","R","B","N"]:["q","r","b","n"],s=document.createElement("div");s.className="promotion-box";const o=document.createElement("div");o.className="promotion-title",o.textContent=v("choosePromotion"),s.appendChild(o);const r=document.createElement("div");r.className="promotion-pieces",i.forEach(a=>{const c=document.createElement("div");c.className="promotion-choice";const l=document.createElement("div");l.className=`promotion-piece piece ${n?"piece-white":"piece-black"}`,l.textContent=q[a],c.appendChild(l),c.onclick=()=>Ln(a),r.appendChild(c)}),s.appendChild(r),e.appendChild(s),document.body.appendChild(e)}function Br(t,e,n,i,s){const o=document.createElement("div");o.className="promotion-overlay",o.id="castlingChoiceOverlay";const a=s.includes("k")?7:0,l=A()[t][a].pieces,d=l.find(R=>M(R)==="r"),f=l.find(R=>M(R)!=="r"),h=E(d),u=document.createElement("div");u.className="promotion-box";const p=document.createElement("div");p.className="promotion-title",p.textContent=v("chooseCastling"),u.appendChild(p);const g=document.createElement("div");g.className="promotion-pieces",g.style.gap="20px";const m=document.createElement("div");m.className="promotion-choice",m.style.cssText="width:120px;height:100px;flex-direction:column;display:flex;justify-content:center;align-items:center;";const b=document.createElement("div");b.className=`promotion-piece piece ${h?"piece-white":"piece-black"}`,b.textContent=q[d],b.style.fontSize="48px",m.appendChild(b);const w=document.createElement("div");w.textContent=v("onlyRook"),w.style.cssText="font-size:12px;margin-top:5px;color:white;",m.appendChild(w),m.onclick=()=>{document.getElementById("castlingChoiceOverlay")?.remove(),Oe(t,e,n,i,s.replace("-choice",""))},g.appendChild(m);const y=document.createElement("div");y.className="promotion-choice",y.style.cssText="width:120px;height:100px;flex-direction:column;display:flex;justify-content:center;align-items:center;";const T=document.createElement("div");T.style.cssText="display:flex;gap:5px;";const x=document.createElement("div");x.className=`piece ${h?"piece-white":"piece-black"}`,x.textContent=q[d],x.style.fontSize="36px";const U=document.createElement("div");U.className=`piece ${h?"piece-white":"piece-black"}`,U.textContent=q[f],U.style.fontSize="36px",T.appendChild(x),T.appendChild(U),y.appendChild(T);const L=document.createElement("div");L.textContent=v("bothPieces"),L.style.cssText="font-size:12px;margin-top:5px;color:white;",y.appendChild(L),y.onclick=()=>{document.getElementById("castlingChoiceOverlay")?.remove(),Oe(t,e,n,i,s.replace("-choice","-both"))},g.appendChild(y),u.appendChild(g),o.appendChild(u),document.body.appendChild(o)}function Sr(t,e,n,i){const s=document.createElement("div");s.className="promotion-overlay",s.id="enPassantChoiceOverlay";const r=A()[t][e].pieces,a=E(r[0]),c=r.find(L=>M(L)==="p"),l=r.find(L=>M(L)!=="p"),d=document.createElement("div");d.className="promotion-box";const f=document.createElement("div");f.className="promotion-title",f.textContent=v("chooseMove"),d.appendChild(f);const h=document.createElement("div");h.className="promotion-pieces",h.style.gap="20px";const u=document.createElement("div");u.className="promotion-choice",u.style.cssText="width:140px;height:110px;flex-direction:column;display:flex;justify-content:center;align-items:center;";const p=document.createElement("div");p.style.cssText="display:flex;gap:5px;";const g=document.createElement("div");g.className=`piece ${a?"piece-white":"piece-black"}`,g.textContent=q[c],g.style.fontSize="48px",p.appendChild(g),u.appendChild(p);const m=document.createElement("div");m.textContent=v("enPassant"),m.style.cssText="font-size:12px;margin-top:5px;color:white;",u.appendChild(m);const b=document.createElement("div");b.textContent=v("pawnCaptures"),b.style.cssText="font-size:10px;color:#64748b;",u.appendChild(b),u.onclick=()=>{document.getElementById("enPassantChoiceOverlay")?.remove(),qe(t,e,n,i,"en-passant")},h.appendChild(u);const w=document.createElement("div");w.className="promotion-choice",w.style.cssText="width:140px;height:110px;flex-direction:column;display:flex;justify-content:center;align-items:center;";const y=document.createElement("div");y.style.cssText="display:flex;gap:5px;";const T=document.createElement("div");T.className=`piece ${a?"piece-white":"piece-black"}`,T.textContent=q[l],T.style.fontSize="48px",y.appendChild(T),w.appendChild(y);const x=document.createElement("div");x.textContent=v("normalMove"),x.style.cssText="font-size:12px;margin-top:5px;color:white;",w.appendChild(x);const U=document.createElement("div");U.textContent=`(${yt(l)} ${v("moves_")})`,U.style.cssText="font-size:10px;color:#64748b;",w.appendChild(U),w.onclick=()=>{document.getElementById("enPassantChoiceOverlay")?.remove(),qe(t,e,n,i,"normal")},h.appendChild(w),d.appendChild(h),s.appendChild(d),document.body.appendChild(s)}const Pn="http://localhost:5005";let F="loading",le=null,Cr=0;const we=new Map;let Ki=null,zi=null;function Ir(){try{le=new Worker(new URL(""+new URL("engineWorker-CzxGyjzE.js",import.meta.url).href,import.meta.url),{type:"module"});const t=setTimeout(()=>{F==="loading"&&(console.warn("[Engine] Worker timeout, trying direct WASM"),le?.terminate(),le=null,ct())},5e3);le.onmessage=e=>{const{id:n,result:i,error:s,type:o}=e.data;if(o==="ready"){clearTimeout(t),F="worker",console.log("[Engine] WASM worker ready");return}if(o==="error"){clearTimeout(t),console.warn("[Engine] Worker init failed:",s,"- trying direct WASM"),le=null,ct();return}const r=we.get(n);r&&(we.delete(n),s?r.reject(new Error(s)):r.resolve(i))},le.onerror=e=>{clearTimeout(t),console.warn("[Engine] Worker error:",e,"- trying direct WASM"),le=null;for(const[,n]of we)n.reject(new Error("Worker error"));we.clear(),ct()}}catch(t){console.warn("[Engine] Worker creation failed:",t,"- trying direct WASM"),ct()}}async function ct(){if(!(F==="direct"||F==="worker"))try{const t=await Pt(()=>import("./klikschaak_engine-D9O90nrE.js"),[],import.meta.url);await t.default(),Ki=t.wasm_eval,zi=t.wasm_get_moves,F="direct",console.log("[Engine] WASM direct (main thread) ready")}catch(t){console.error("[Engine] WASM direct load failed:",t),F="failed"}}Ir();function ji(t,e,n){return F==="worker"&&le?new Promise((i,s)=>{const o=Cr++;we.set(o,{resolve:i,reject:s}),le.postMessage({id:o,type:t,fen:e,depth:n}),setTimeout(()=>{we.has(o)&&(we.delete(o),s(new Error("WASM timeout")))},6e4)}):F==="direct"?new Promise((i,s)=>{try{setTimeout(()=>{try{let o;if(t==="eval")o=Ki(e,n??4);else if(t==="moves")o=zi(e);else{s(new Error(`Unknown type: ${t}`));return}i(JSON.parse(o))}catch(o){s(o)}},0)}catch(o){s(o)}}):Promise.reject(new Error("WASM not available"))}function Ie(){return F==="worker"||F==="direct"}function Mt(t=8e3){return Ie()?Promise.resolve(!0):F==="failed"?Promise.resolve(!1):new Promise(e=>{const n=Date.now(),i=()=>{if(Ie()){e(!0);return}if(F==="failed"||Date.now()-n>t){e(!1);return}setTimeout(i,100)};i()})}function pt(t,e){const n=String.fromCharCode(97+e),i=String(8-t);return n+i}function ii(t){return t[0]}function Nt(){const t=A(),e=O(),n=j(),i=V(),s=[];for(let c=0;c<8;c++){let l="",d=0;for(let f=0;f<8;f++){const h=t[c][f].pieces;h.length===0?d++:(d>0&&(l+=d,d=0),h.length===1?l+=ii(h[0]):l+="("+h.map(ii).join("")+")")}d>0&&(l+=d),s.push(l)}const o=e==="white"?"w":"b";let r="";n.white.kingSide&&(r+="K"),n.white.queenSide&&(r+="Q"),n.black.kingSide&&(r+="k"),n.black.queenSide&&(r+="q"),r||(r="-");let a="-";return i&&(a=pt(i.row,i.col)),`${s.join("/")} ${o} ${r} ${a} 0 1`}function Vi(){const t=A(),e=O(),n=j(),i=V(),s=Y(),o=e==="white",r=[],a=new Set;for(let c=0;c<8;c++)for(let l=0;l<8;l++){const d=t[c][l].pieces;if(d.length===0||E(d[0])!==o)continue;const f=pt(c,l),h=ge(t,c,l,d,n,i,s,null);for(const u of h){const p=pt(u.row,u.col);let g=f+p;u.type==="klik"?g+="k":u.type?.startsWith("castle-")&&(g+=":"+u.type);const m=o&&u.row===0||!o&&u.row===7,b=d.some(w=>G(w));if(m&&b&&u.type!=="klik"&&!u.type?.startsWith("castle-")){for(const w of["q","r","b","n"]){const y=f+p+w;a.has(y)||(a.add(y),r.push({uci:y,type:u.type||"promotion"}))}continue}a.has(g)||(a.add(g),r.push({uci:g,type:u.type||"normal"}))}if(d.length===2)for(let u=0;u<2;u++){const p=d[u],g=$e(t,c,l,p,n,i,s);for(const m of g){const[b,w]=m,y=pt(b,w),T=t[b][w];if((T.pieces.length===0||E(T.pieces[0])!==o)&&!Ce(t,c,l,b,w,d,"unklik",u)){let x=f+y+`u${u}`;if((o&&b===0||!o&&b===7)&&G(p)){for(const L of["q","r","b","n"]){const R=f+y+L+`u${u}`;a.has(R)||(a.add(R),r.push({uci:R,type:"unklik-promotion"}))}continue}a.has(x)||(a.add(x),r.push({uci:x,type:"unklik"}))}if(T.pieces.length>0&&T.pieces.length<2&&E(T.pieces[0])===o&&!T.pieces.some(x=>M(x)==="k")&&M(p)!=="k"&&!Ce(t,c,l,b,w,d,"unklik-klik",u)){const x=f+y+`U${u}`;a.has(x)||(a.add(x),r.push({uci:x,type:"unklik-klik"}))}}}}return{count:r.length,moves:r}}async function Yi(t){if(!Ie()&&F==="loading"&&await Mt(3e3),Ie())try{const e=await ji("moves",t);return e.error?{count:0,moves:[],error:e.error}:{count:e.count,moves:e.moves.map(n=>({uci:n.uci,type:n.type})),error:null}}catch{}try{const n=await(await fetch(`${Pn}/moves`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fen:t}),signal:AbortSignal.timeout(5e3)})).json();return n.error?{count:0,moves:[],error:n.error}:{count:n.count,moves:n.moves.map(i=>({uci:i.uci,type:i.type})),error:null}}catch(e){const n=e instanceof Error?e.message:String(e);return n.includes("fetch")||n.includes("network")||n.includes("Failed")||n.includes("timeout")||n.includes("abort")?{count:0,moves:[],error:"Engine offline"}:{count:0,moves:[],error:n}}}async function Ji(){if(Ie())return!0;try{return(await(await fetch(`${Pn}/health`,{signal:AbortSignal.timeout(2e3)})).json()).status==="ok"}catch{return!1}}async function Tn(t,e=4){const n={score:0,scoreType:"cp",bestMove:null,pv:[],depth:0,nodes:0,nps:0,time_ms:0,error:null};if(!Ie()&&F==="loading"&&await Mt(3e3),Ie())try{const i=await ji("eval",t,e);return i.error?{...n,error:i.error}:{score:i.score,scoreType:i.scoreType,bestMove:i.bestMove,pv:i.pv,depth:i.depth,nodes:i.nodes,nps:i.nps,time_ms:i.time_ms,error:null}}catch{}try{const s=await(await fetch(`${Pn}/eval`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fen:t,depth:e}),signal:AbortSignal.timeout(3e4)})).json();return s.error?{...n,error:s.error}:{score:s.score,scoreType:s.scoreType,bestMove:s.bestMove,pv:s.pv,depth:s.depth,nodes:s.nodes,nps:s.nps,time_ms:s.time_ms,error:null}}catch(i){const s=i instanceof Error?i.message:String(i);return s.includes("fetch")||s.includes("network")||s.includes("Failed")||s.includes("timeout")||s.includes("abort")?{...n,error:"Engine offline"}:{...n,error:s}}}async function Pr(){const t=Nt(),e=Vi(),n=await Yi(t);if(n.error)return{webappCount:e.count,engineCount:0,webappMoves:e.moves,engineMoves:[],matching:[],webappOnly:e.moves.map(c=>c.uci),engineOnly:[],hasMismatch:!1,engineOnline:!1,error:n.error};const i=new Set(e.moves.map(c=>c.uci)),s=new Set(n.moves.map(c=>c.uci)),o=[],r=[],a=[];for(const c of i)s.has(c)?o.push(c):r.push(c);for(const c of s)i.has(c)||a.push(c);return{webappCount:e.count,engineCount:n.count,webappMoves:e.moves,engineMoves:n.moves,matching:o.sort(),webappOnly:r.sort(),engineOnly:a.sort(),hasMismatch:r.length>0||a.length>0,engineOnline:!0,error:null}}const Qi=Object.freeze(Object.defineProperty({__proto__:null,buildFullFEN:Nt,checkEngineHealth:Ji,comparePositionMoves:Pr,countAllWebappMoves:Vi,fetchEngineEval:Tn,fetchEngineMoves:Yi,waitForWasm:Mt},Symbol.toStringTag,{value:"Module"})),Tr="klikschaak",xr=1,ve="games";function xn(){return new Promise((t,e)=>{const n=indexedDB.open(Tr,xr);n.onupgradeneeded=()=>{const i=n.result;i.objectStoreNames.contains(ve)||i.createObjectStore(ve,{keyPath:"id"}).createIndex("date","date",{unique:!1})},n.onsuccess=()=>t(n.result),n.onerror=()=>e(n.error)})}async function _n(t){const e=await xn();return new Promise((n,i)=>{const s=e.transaction(ve,"readwrite");s.objectStore(ve).put(t),s.oncomplete=()=>{e.close(),n()},s.onerror=()=>{e.close(),i(s.error)}})}async function _r(){const t=await xn();return new Promise((e,n)=>{const o=t.transaction(ve,"readonly").objectStore(ve).index("date").getAll();o.onsuccess=()=>{t.close(),e(o.result.reverse())},o.onerror=()=>{t.close(),n(o.error)}})}async function Lr(t){const e=await xn();return new Promise((n,i)=>{const s=e.transaction(ve,"readwrite");s.objectStore(ve).delete(t),s.oncomplete=()=>{e.close(),n()},s.onerror=()=>{e.close(),i(s.error)}})}const Mr=8,N={active:!1,engineColor:"black",thinking:!1};function Nr(t){N.active=!0,N.engineColor=t==="white"?"black":"white",N.thinking=!1;const e=document.getElementById("gameOverOverlay");e&&e.remove(),Ue(),et(!1),_(),$(),N.engineColor==="white"&&$t()}function be(){return N.active}function nt(){return N.active&&O()===N.engineColor}function $r(){return N.thinking}function Xi(){return N.engineColor}function Wt(){N.active=!1,N.thinking=!1}function Zi(t){const e=N.engineColor==="white"?"Engine":"You",n=N.engineColor==="black"?"Engine":"You";_n({id:crypto.randomUUID(),date:new Date().toISOString(),type:"engine",white:e,black:n,result:t,moves:X(),moveCount:Math.ceil(X().length/2)}).catch(i=>console.error("[GameStorage] Failed to save engine game:",i))}function Ar(){!N.active||Z()||(N.thinking=!1,et(!0),Zi(`resignation:${N.engineColor}`),wt("resignation",N.engineColor))}async function Or(){if(!N.active||Z())return!1;const t=Nt(),e=await Tn(t,6);return e.error?!1:(N.engineColor==="white"?e.score:-e.score)<=0?(N.thinking=!1,et(!0),Zi("draw:agreement"),wt("stalemate",null),!0):!1}function si(t){const e=t.charCodeAt(0)-97;return[8-parseInt(t[1]),e]}function qr(t){const e=t.substring(0,2),n=t.substring(2,4),i=t.substring(4),[s,o]=si(e),[r,a]=si(n);let c=null,l="",d=null;if(i)if(i.startsWith("U"))d=parseInt(i[1]),l="unklik-klik";else if(i.includes("u")){const f=i.indexOf("u");f>0&&(c=i.substring(0,f)),d=parseInt(i[f+1]),l="unklik"}else i==="k"?l="klik":"qrbn".includes(i)&&(c=i);return{fromRow:s,fromCol:o,toRow:r,toCol:a,promotion:c,suffix:l,unklikIndex:d}}async function $t(){if(!(!N.active||Z())){N.thinking=!0,Kt();try{const t=Nt();console.log("[Engine] Requesting move for FEN:",t);const e=await Tn(t,Mr);if(!N.active||Z())return;if(e.error||!e.bestMove){console.error("[Engine] Error:",e.error),N.thinking=!1,Kt();return}console.log("[Engine] Best move:",e.bestMove,"depth:",e.depth,"score:",e.score);const n=qr(e.bestMove),i=await Pt(()=>Promise.resolve().then(()=>Dr),void 0,import.meta.url);Rr(n,i)}catch(t){console.error("[Engine] Request failed:",t)}N.thinking=!1,Kt()}}function Rr(t,e){const{fromRow:n,fromCol:i,toRow:s,toCol:o,promotion:r,suffix:a,unklikIndex:c}=t,l=A(),d=l[n][i];let f;if(r&&(f=N.engineColor==="white"?r.toUpperCase():r.toLowerCase()),c!==null){Se([n,i]),_e(c);const g=d.pieces[c],m=$e(l,n,i,g,j(),V(),Y());let b=a==="unklik-klik"?"unklik-klik":"unklik";for(const w of m)if(w[0]===s&&w[1]===o&&w[2]==="en-passant"){b="en-passant-unklik";break}e.movePiece(n,i,s,o,b,f);return}const u=ge(l,n,i,d.pieces,j(),V(),Y(),null).filter(g=>g.row===s&&g.col===o);if(u.length===0){console.error("No matching move found for engine UCI:",t);return}let p;if(a==="klik"?p=u.find(g=>g.type==="klik")||u[0]:p=u.find(g=>g.type!=="klik")||u[0],p.type.startsWith("castle-")){e.executeCastling(n,i,s,o,p.type);return}e.movePiece(n,i,s,o,p.type,f)}function Kt(){const t=document.getElementById("engineThinking");t&&(t.style.display=N.thinking?"flex":"none")}function Ze(t,e){if(Z()&&!ae()||be()&&nt())return;if(ke()&&!Lt()&&!ae()){const o=A(),r=o[t][e],a=In(),c=vt();if(c){const d=Ne().find(f=>f.row===t&&f.col===e);if(d){const[f,h]=c,u=bt();ao({row:f,col:h},{row:t,col:e},d.type,u!==null?u:void 0),H(),_(),$();return}}if(yn()&&he(),r.pieces.length>0&&E(r.pieces[0])===(a==="white")){Se([t,e]),_e(null);const l=ge(o,t,e,r.pieces,j(),V(),Y(),null);Le(l)}else H();_(),$();return}const n=A(),i=n[t][e],s=vt();if(s){const[o,r]=s,c=Ne().find(l=>l.row===t&&l.col===e);if(c){const l=c.type;l==="castle-k"||l==="castle-q"||l==="castle-k-klik"||l==="castle-q-klik"||l==="castle-k-unklik-klik"||l==="castle-q-unklik-klik"?Oe(o,r,t,e,l):l==="castle-k-choice"||l==="castle-q-choice"?Br(o,r,t,e,l):l==="en-passant-choice"?Sr(o,r,t,e):qe(o,r,t,e,l)}else if(i.pieces.length>0&&E(i.pieces[0])===(O()==="white")){Se([t,e]),_e(null);const l=ge(n,t,e,i.pieces,j(),V(),Y(),null);Le(l)}else H()}else if(i.pieces.length>0){const o=E(i.pieces[0]);if(o&&O()==="white"||!o&&O()==="black"){Se([t,e]),_e(null);const r=ge(n,t,e,i.pieces,j(),V(),Y(),null);Le(r)}}_(),$()}function es(t,e,n,i){if(Z()&&!ae()||(i.stopPropagation(),be()&&nt())||ke()&&!Lt()&&!ae())return;const s=A(),o=s[t][e],r=o.pieces[n],a=E(r);if(a&&O()!=="white"||!a&&O()!=="black")return;if(Se([t,e]),_e(n),M(r)==="k"){const u=$e(s,t,e,r,j(),V(),Y()).map(p=>({row:p[0],col:p[1],type:"unklik"})).filter(p=>!Ce(s,t,e,p.row,p.col,o.pieces,"unklik",n));Le(u),_(),$();return}const c=$e(s,t,e,r,j(),V(),Y()),l=[],d=G(r);if(d){const h=a?-1:1,u=a?6:1,p=a?0:7,g=t+h;if(g>=0&&g<8&&g!==p){const m=s[g][e];m.pieces.length===1&&E(m.pieces[0])===a&&M(m.pieces[0])!=="k"&&c.push([g,e])}if(t===u&&!Y().has(r)){const m=t+h,b=t+2*h;if(s[m][e].pieces.length===0&&b!==p){const w=s[b][e];w.pieces.length===1&&E(w.pieces[0])===a&&M(w.pieces[0])!=="k"&&c.push([b,e])}}}for(const h of c){const[u,p,g]=h,m=s[u][p];d&&(a&&u===7||!a&&u===0)||(g==="en-passant"?l.push({row:u,col:p,type:"en-passant-unklik"}):m.pieces.length===0||E(m.pieces[0])!==a?l.push({row:u,col:p,type:"unklik"}):m.pieces.length<2&&E(m.pieces[0])===a&&!m.pieces.some(w=>M(w)==="k")&&l.push({row:u,col:p,type:"unklik-klik"}))}const f=l.filter(h=>!Ce(s,t,e,h.row,h.col,o.pieces,h.type,n));Le(f),_(),$()}function Oe(t,e,n,i,s){if(ke()&&!ae()){Cn({row:t,col:e},{row:n,col:i},s),H(),_(),$();return}const o=A(),r=s.startsWith("castle-k"),a=r?7:0,c=r?5:3,l=o[t][e].pieces;S(n,i,l),S(t,e,[]);const d=[...o[t][a].pieces];S(t,a,[]);let f=`O-O${r?"":"-O"}`;if(s.includes("unklik-klik")){const u=d.find(m=>M(m)==="r"),p=d.find(m=>M(m)!=="r"),g=[...o[t][c].pieces];S(t,c,[u,...g]),S(t,a,[p]),f+=" (toren klikt)"}else if(s.includes("klik")&&!s.includes("unklik")){const u=[...o[t][c].pieces];S(t,c,[...d,...u]),f+=" klikt"}else if(s.includes("both"))S(t,c,d),f+=" (beide)";else if(d.length===2){const u=d.find(g=>M(g)==="r"),p=d.find(g=>M(g)!=="r");S(t,c,[u]),S(t,a,[p]),f+=" (alleen toren)"}else S(t,c,d);Vt(O()),H();const h=O();if(Ge(),It({turn:h,notation:f}),ae()){hn({turn:h,notation:f}),_(),$(),Re(),se();return}_(),$(),Re(),be()&&nt()&&!Z()&&setTimeout(()=>$t(),100)}function qe(t,e,n,i,s,o){if(ke()&&!ae()){const y=bt(),x=A()[t][e],U=x.pieces.some(te=>G(te)),L=E(x.pieces[0]),R=L&&n===0||!L&&n===7;if(U&&R&&!o&&!ot()){const te={row:n,col:i,isWhite:L,moveNotation:""};te.fromRow=t,te.fromCol=e,te.moveType=s,te.unklikIndex=y,Ye(te),Ht();return}const ee=o||(ot()&&U&&R?L?"Q":"q":void 0);Cn({row:t,col:e},{row:n,col:i},s,y!==null?y:void 0,ee),H(),_(),$();return}const r=A(),a=r[t][e],c=r[n][i];let l,d="";kt(null);const f=c.pieces.length>0,h=st(t,e),u=st(n,i),p=bt();if(s==="unklik"||s==="unklik-klik"||s==="en-passant-unklik"){const y=a.pieces[p],T=a.pieces.filter((L,R)=>R!==p);if(l=[y],S(t,e,T),d=`${q[y]}${h}-${u}`,s==="en-passant-unklik"){const L=O()==="white"?n+1:n-1;S(L,i,[]),S(n,i,[y]),d+=` x${st(L,i)} e.p.`,Ke(t,e,n,i,l),lt(d);return}const x=G(y),U=E(y)&&n===0||!E(y)&&n===7;if(x&&U){s==="unklik-klik"?(S(n,i,[...c.pieces,y]),d+=" klikt"):c.pieces.length>0?(S(n,i,[y]),d+=" x"):S(n,i,[y]);const L=o||(ot()?E(y)?"Q":"q":null);if(L){const ee=Xe(n,i).filter(te=>!G(te));ee.unshift(L),S(n,i,ee),d+="="+q[L],Ke(t,e,n,i,ee),lt(d)}else{const R={row:n,col:i,isWhite:E(y),moveNotation:d,wasCapture:c.pieces.length>1||s!=="unklik-klik"&&c.pieces.length>0};Ye(R),Ht()}return}s==="unklik-klik"?(S(n,i,[...c.pieces,y]),d+=" klikt"):(c.pieces.length>0&&(d=`${q[y]}${h}x${u}`),S(n,i,[y])),Ke(t,e,n,i,l)}else if(s==="en-passant"){l=[...a.pieces],S(t,e,[]);const y=O()==="white"?n+1:n-1;S(y,i,[]),S(n,i,l),d=`${Rt(l)}${h}x${st(y,i)} e.p.`}else{l=[...a.pieces],S(t,e,[]),d=`${Rt(l)}${h}-${u}`;const y=l.some(x=>G(x)),T=E(l[0])&&n===0||!E(l[0])&&n===7;if(y&&T){s==="klik"?(S(n,i,[...c.pieces,...l]),d+=" klikt"):(c.pieces.length>0&&(d+=" x"),S(n,i,l));const x=o||(ot()?E(l[0])?"Q":"q":null);if(x){const L=Xe(n,i).filter(R=>!G(R));L.unshift(x),S(n,i,L),d+="="+q[x],Ke(t,e,n,i,L),lt(d)}else{const U={row:n,col:i,isWhite:E(l[0]),moveNotation:d,otherPieces:l.filter(L=>!G(L)),wasCapture:c.pieces.length>l.length};Ye(U),Ht()}return}s==="klik"?(S(n,i,[...c.pieces,...l]),d+=" klikt"):(c.pieces.length>0&&(d=`${Rt(l)}${h}x${u}`),S(n,i,l)),Ke(t,e,n,i,l)}const g=l.some(y=>G(y)),m=e===i,b=E(l[0])&&t===6||!E(l[0])&&t===1;if(g&&m&&b&&!f&&Math.abs(t-n)===2){const y=(t+n)/2;kt({row:y,col:i})}l.includes("K")?Vt("white"):l.includes("k")&&Vt("black");for(const y of l)G(y)&&fi(y);lt(d)}function lt(t){H();const e=O();if(Ge(),It({turn:e,notation:t}),ae()){hn({turn:e,notation:t}),_(),$(),Re(),se();return}_(),$(),Re(),be()&&nt()&&!Z()&&setTimeout(()=>$t(),100)}function Ln(t){const e=hi();if(!e)return;const n=document.getElementById("promotionOverlay");if(n&&n.remove(),ke()&&!ae()){const{fromRow:d,fromCol:f,moveType:h,unklikIndex:u}=e;Cn({row:d,col:f},{row:e.row,col:e.col},h||"normal",u,t),H(),Ye(null),_(),$();return}const{row:i,col:s,moveNotation:o}=e,a=Xe(i,s).filter(d=>!G(d));a.unshift(t),S(i,s,a);const c=o+"="+q[t];H();const l=O();if(Ge(),It({turn:l,notation:c}),Ye(null),ae()){hn({turn:l,notation:c}),_(),$(),Re(),se();return}_(),$(),Re(),be()&&nt()&&!Z()&&setTimeout(()=>$t(),100)}function Re(){const t=A(),e=O(),n=Ps(t,e);if(Ts(t,e,j(),V(),Y()))n&&wr();else{et(!0);const s=n?e==="white"?"black":"white":null,o=n?`checkmate:${s}`:"stalemate:draw";if(!ke()){const r=be()?"engine":"local",a=be()?Xi():null,c=r==="engine"?a==="white"?"Engine":"You":"White",l=r==="engine"?a==="black"?"Engine":"You":"Black";_n({id:crypto.randomUUID(),date:new Date().toISOString(),type:r,white:c,black:l,result:o,moves:X(),moveCount:Math.ceil(X().length/2)}).catch(d=>console.error("[GameStorage] Failed to save game:",d))}n?wt("checkmate",s):wt("stalemate",null)}}function De(){const t=document.getElementById("gameOverOverlay");t&&t.remove(),Ue(),_(),$()}function ts(){const t=document.getElementById("autoPromote");Cs(t.checked)}function ns(){yn()&&(he(),H(),_(),$())}function is(){if(!yn())return!1;const t=ro();if(!t.from||!t.to||!t.moveType)return he(),!1;const e=A(),n=e[t.from.row][t.from.col];if(n.pieces.length===0)return he(),!1;const i=In();if(!(E(n.pieces[0])===(i==="white")))return he(),!1;const r=ge(e,t.from.row,t.from.col,n.pieces,j(),V(),Y(),t.unklikPieceIndex).find(h=>h.row===t.to.row&&h.col===t.to.col);if(!r)return he(),!1;const{from:a,to:c,unklikPieceIndex:l,promotionPiece:d}=t;Se([a.row,a.col]),l!==null&&_e(l),he();const f=r.type;return f.startsWith("castle")?Oe(a.row,a.col,c.row,c.col,f):qe(a.row,a.col,c.row,c.col,f,d||void 0),!0}const Dr=Object.freeze(Object.defineProperty({__proto__:null,executeCastling:Oe,executePromotion:Ln,handleRightClick:ns,handleSquareClick:Ze,handleUnklikSelect:es,initGame:De,movePiece:qe,toggleAutoPromote:ts,tryExecutePremove:is},Symbol.toStringTag,{value:"Module"})),C={dragging:!1,from:null,pieces:[],ghostElement:null,startX:0,startY:0,hasMoved:!1},oi=10;function Ur(){const t=document.getElementById("board");t&&(t.addEventListener("mousedown",Kr),t.addEventListener("touchstart",Vr,{passive:!1}),document.addEventListener("mousemove",zr),document.addEventListener("mouseup",jr),document.addEventListener("touchmove",Yr,{passive:!1}),document.addEventListener("touchend",ri),document.addEventListener("touchcancel",ri))}function ss(t){const n=t.target.closest(".square");if(!n)return null;const i=parseInt(n.dataset.row||"-1"),s=parseInt(n.dataset.col||"-1");return i<0||s<0?null:{element:n,pos:{row:i,col:s}}}function os(t,e){const n=document.elementsFromPoint(t,e);for(const i of n)if(i.classList.contains("square")){const s=i,o=parseInt(s.dataset.row||"-1"),r=parseInt(s.dataset.col||"-1");if(o>=0&&r>=0)return{element:s,pos:{row:o,col:r}}}return null}function Gr(t){const e=document.createElement("div");return e.className="drag-ghost",e.innerHTML=t.map(n=>`<span class="piece ${E(n)?"piece-white":"piece-black"}">${q[n]}</span>`).join(""),document.body.appendChild(e),e}function rs(t,e,n){t.style.left=`${e}px`,t.style.top=`${n}px`}function Fr(t){const e=A();document.querySelectorAll(".square").forEach(n=>{const i=n,s=parseInt(i.dataset.row||"-1"),o=parseInt(i.dataset.col||"-1"),r=t.find(a=>a.row===s&&a.col===o);r&&(i.classList.add("drag-valid-target"),e[s][o].pieces.length>0&&(r.type==="klik"||r.type==="unklik-klik"?i.classList.add("drag-klik-target"):i.classList.add("drag-capture-target")))})}function Hr(){document.querySelectorAll(".square").forEach(t=>{t.classList.remove("drag-valid-target","drag-capture-target","drag-klik-target","drag-over","dragging")})}function as(t,e){return e.find(n=>n.row===t.row&&n.col===t.col)}function cs(t,e,n){const s=A()[t.row][t.col].pieces;if(s.length===0)return!1;const o=E(s[0]),r=O();return o&&r!=="white"||!o&&r!=="black"?!1:(C.from=t,C.pieces=s,C.startX=e,C.startY=n,C.hasMoved=!1,C.dragging=!1,!0)}function Wr(t,e){if(!C.from)return;C.dragging=!0,C.ghostElement=Gr(C.pieces),rs(C.ghostElement,t,e);const n=document.querySelector(`.square[data-row="${C.from.row}"][data-col="${C.from.col}"]`);n&&n.classList.add("dragging");const i=ge(A(),C.from.row,C.from.col,C.pieces,j(),V(),Y(),null);Le(i),Fr(i)}function ls(t,e){if(!C.from)return;if(!C.dragging){const i=Math.abs(t-C.startX),s=Math.abs(e-C.startY);(i>oi||s>oi)&&(C.hasMoved=!0,Wr(t,e));return}C.ghostElement&&rs(C.ghostElement,t,e),document.querySelectorAll(".square.drag-over").forEach(i=>{i.classList.remove("drag-over")});const n=os(t,e);if(n){const i=Ne();as(n.pos,i)&&n.element.classList.add("drag-over")}}function ds(t,e){const n=C.from,i=C.dragging,s=C.hasMoved;if(C.ghostElement&&(C.ghostElement.remove(),C.ghostElement=null),Hr(),C.from=null,C.pieces=[],C.dragging=!1,C.hasMoved=!1,!!n){if(!s){Ze(n.row,n.col);return}if(i){const o=os(t,e);if(o){const r=Ne();if(as(o.pos,r)){Se([n.row,n.col]),Ze(o.pos.row,o.pos.col);return}}H()}}}function Kr(t){if(t.button!==0||Z())return;const e=t.target;if(e.classList.contains("triangle-left")||e.classList.contains("triangle-right"))return;const n=ss(t);n&&cs(n.pos,t.clientX,t.clientY)&&t.preventDefault()}function zr(t){C.from&&ls(t.clientX,t.clientY)}function jr(t){C.from&&ds(t.clientX,t.clientY)}function Vr(t){if(Z()||t.touches.length!==1)return;const e=t.target;if(e.classList.contains("triangle-left")||e.classList.contains("triangle-right"))return;const n=t.touches[0],i=ss(n);i&&cs(i.pos,n.clientX,n.clientY)}function Yr(t){if(!C.from||t.touches.length!==1)return;t.preventDefault();const e=t.touches[0];ls(e.clientX,e.clientY)}function ri(t){if(!C.from)return;const e=t.changedTouches[0];ds(e.clientX,e.clientY)}let ne=[],Ve=null;function Jr(){const t=W();t&&(t.on("lobby:users",e=>{ne=e,Ve?.(ne)}),t.on("lobby:user-joined",e=>{ne.find(i=>i.id===e.id)||(ne.push({...e,status:"online"}),Ve?.(ne))}),t.on("lobby:user-left",e=>{ne=ne.filter(n=>n.id!==e.id),Ve?.(ne)}),t.on("lobby:user-status",e=>{const n=ne.find(i=>i.id===e.id);n&&(n.status=e.status,Ve?.(ne))}))}function Mn(t){Ve=t,t(ne)}let K=null,mt=null,gt=null,Be=null;function Qr(){K=document.getElementById("lobbyContainer"),K||(K=document.createElement("div"),K.id="lobbyContainer",document.body.appendChild(K)),Bt(),$n(),Mn(Nn)}function us(){K&&(K.innerHTML="")}function Bt(){if(!K)return;if(be()){St();return}if(K.innerHTML=`
    <div class="lobby-panel">
      <div class="lobby-header">
        <h3>Klikschaak</h3>
        <button id="lobbyToggleBtn" class="lobby-toggle" title="Minimize">‚àí</button>
      </div>
      <div id="lobbyBody" class="lobby-body">
        <div class="lobby-section">
          <h4 class="section-title">Play vs Engine</h4>
          <div class="engine-play">
            <select id="engineColorSelect">
              <option value="white">White</option>
              <option value="black">Black</option>
              <option value="random">Random</option>
            </select>
            <button id="enginePlayBtn" class="lobby-btn engine">Play</button>
          </div>
          <div id="engineStatus" class="engine-status"></div>
        </div>
        <div class="lobby-section">
          <h4 class="section-title">Online Play</h4>
          <div class="lobby-actions">
            <div class="create-game">
              <select id="timeControlSelect">
                <option value="bullet">1+0</option>
                <option value="blitz-3">3+0</option>
                <option value="blitz-5">5+0</option>
                <option value="rapid-7">7+0</option>
                <option value="standard" selected>7+5</option>
                <option value="custom">Custom</option>
              </select>
              <button id="createGameBtn" class="lobby-btn">Create</button>
            </div>
            <div class="custom-time hidden" id="customTimeInputs">
              <div class="custom-time-row">
                <input type="number" id="customMinutes" placeholder="Min" min="1" max="60" value="10">
                <span>+</span>
                <input type="number" id="customIncrement" placeholder="Sec" min="0" max="60" value="0">
              </div>
            </div>
            <div class="join-game">
              <input type="text" id="gameCodeInput" placeholder="Game Code" maxlength="6">
              <button id="joinGameBtn" class="lobby-btn">Join</button>
            </div>
          </div>
          <div id="gameCodeDisplay" class="game-code-display hidden"></div>
          <div id="waitingMessage" class="waiting-message hidden"></div>
          <div id="challengeNotification" class="challenge-notification hidden"></div>
          <div class="online-users">
            <h4>Online (<span id="onlineCount">0</span>)</h4>
            <ul id="onlineUsersList"></ul>
          </div>
        </div>
        <div class="lobby-section">
          <button id="lobbyAnalysisBtn" class="lobby-btn analysis">Analyse</button>
        </div>
      </div>
    </div>
  `,window.innerWidth<=768){const i=document.getElementById("lobbyBody"),s=document.getElementById("lobbyToggleBtn");i&&s&&(i.classList.add("collapsed"),s.textContent="+",s.title="Expand")}document.getElementById("lobbyToggleBtn")?.addEventListener("click",()=>{const i=document.getElementById("lobbyBody"),s=document.getElementById("lobbyToggleBtn");if(i&&s){const o=i.classList.toggle("collapsed");s.textContent=o?"+":"‚àí",s.title=o?"Expand":"Minimize"}}),document.getElementById("createGameBtn")?.addEventListener("click",Zr),document.getElementById("joinGameBtn")?.addEventListener("click",ai),document.getElementById("gameCodeInput")?.addEventListener("keyup",i=>{i.key==="Enter"&&ai()}),document.getElementById("lobbyAnalysisBtn")?.addEventListener("click",()=>{us(),pn()}),document.getElementById("enginePlayBtn")?.addEventListener("click",Xr);const e=document.getElementById("engineStatus");e&&(e.textContent="Loading engine...",e.className="engine-status"),Mt(1e4).then(async i=>{const s=i||await Ji(),o=document.getElementById("engineStatus");o&&(s?(o.textContent=i?"Engine ready (WASM)":"Engine online",o.className="engine-status online"):(o.textContent="Engine offline",o.className="engine-status offline"))});const n=document.getElementById("timeControlSelect");n?.addEventListener("change",()=>{const i=document.getElementById("customTimeInputs");i&&i.classList.toggle("hidden",n.value!=="custom")}),mt=document.getElementById("gameCodeDisplay"),oa()}function Xr(){let e=document.getElementById("engineColorSelect")?.value||"white";e==="random"&&(e=Math.random()<.5?"white":"black"),tt(e==="black"),Nr(e),St()}function St(){if(!K)return;const t=Xi(),e=t==="white"?"Black":"White",n=Z();K.innerHTML=`
    <div class="lobby-panel engine-game-panel">
      <div class="lobby-header">
        <h3>vs Engine</h3>
        <span class="engine-game-info">You: ${e}</span>
      </div>
      <div class="engine-game-body">
        <div id="engineThinking" class="engine-thinking" style="display: ${$r()?"flex":"none"}">
          <span class="thinking-dots"></span>
          <span>Engine thinking...</span>
        </div>
        <div class="engine-game-actions">
          ${n?`
            <button id="engineAnalyzeBtn" class="lobby-btn analysis">Analyze</button>
          `:`
            <button id="engineResignBtn" class="lobby-btn danger" title="Resign">Resign</button>
            <button id="engineDrawBtn" class="lobby-btn draw" title="Offer Draw">&frac12; Draw</button>
          `}
          <button id="engineNewGameBtn" class="lobby-btn engine">New Game</button>
          <button id="engineStopBtn" class="lobby-btn secondary">Lobby</button>
        </div>
      </div>
    </div>
  `,document.getElementById("engineAnalyzeBtn")?.addEventListener("click",()=>{const i=X(),s=t==="white"?"Engine":"You",o=t==="black"?"Engine":"You",r=document.getElementById("gameOverOverlay");r&&r.remove(),Wt(),Tt(i,s,o)}),document.getElementById("engineResignBtn")?.addEventListener("click",()=>{Ar(),St()}),document.getElementById("engineDrawBtn")?.addEventListener("click",async()=>{const i=document.getElementById("engineDrawBtn");i.disabled=!0,i.textContent="...",await Or()?St():(i.textContent="Declined!",setTimeout(()=>{i.textContent="¬Ω Draw",i.disabled=!1},2e3))}),document.getElementById("engineNewGameBtn")?.addEventListener("click",()=>{Wt(),Bt()}),document.getElementById("engineStopBtn")?.addEventListener("click",()=>{Wt(),tt(!1),Ue(),et(!1);const i=document.getElementById("gameOverOverlay");i&&i.remove(),_(),$(),Bt(),$n(),Mn(Nn)})}function Nn(t){const e=document.getElementById("onlineUsersList"),n=document.getElementById("onlineCount"),i=Ee();if(n&&(n.textContent=String(t.length)),e){const s=t.filter(o=>o.id!==i?.id);e.innerHTML=s.map(o=>`
        <li class="online-user ${o.status} ${o.status==="online"?"challengeable":""}"
            data-user-id="${o.id}"
            data-username="${o.username}"
            title="${o.status==="online"?"Click to challenge":o.status==="in-game"?"In a game":"Away"}">
          <span class="status-dot"></span>
          <span class="username">${o.username}</span>
          <span class="friend-code">#${o.friendCode}</span>
          ${o.status==="online"?'<span class="challenge-icon">‚öîÔ∏è</span>':""}
        </li>
      `).join("")||'<li class="no-users">No other players online</li>',e.querySelectorAll(".online-user.challengeable").forEach(o=>{o.addEventListener("click",()=>{const r=o.getAttribute("data-user-id"),a=o.getAttribute("data-username");r&&a&&ia(r,a)})})}}function Zr(){const e=document.getElementById("timeControlSelect")?.value||"standard";let n;if(e==="custom"){const s=parseInt(document.getElementById("customMinutes")?.value||"10"),o=parseInt(document.getElementById("customIncrement")?.value||"0");n={initialTime:s*60*1e3,increment:o*1e3}}hr(e,n);const i=document.getElementById("waitingMessage");i&&(i.classList.remove("hidden"),i.textContent="Creating game...")}function ai(){const t=document.getElementById("gameCodeInput"),e=t?.value?.trim();e&&e.length>=4&&(fr(e),t.value="")}function $n(){ur({onGameCreated:t=>{mt&&(mt.classList.remove("hidden"),mt.innerHTML=`
          <div class="game-code">
            <span>Share code:</span>
            <strong>${t}</strong>
            <button id="copyCodeBtn" class="copy-btn" title="Copy">üìã</button>
          </div>
          <p>Waiting for opponent...</p>
        `,document.getElementById("copyCodeBtn")?.addEventListener("click",()=>{navigator.clipboard.writeText(t)}))},onGameJoined:t=>{console.log("Joined game:",t.gameCode)},onGameStarted:t=>{const e=t.myColor==="black";if(tt(e),K){const n=e?"white":"black",i=e?"black":"white",s=e?"White":"Black",o=e?"Black":"White",r=e?t.timer.white:t.timer.black,a=e?t.timer.black:t.timer.white;K.innerHTML=`
          <div class="game-info-panel">
            <div class="opponent-info">
              <span>vs ${t.opponent?.username||"Unknown"}</span>
            </div>
            <div id="timerDisplay" class="timer-display">
              <div class="timer ${n} ${t.currentTurn===n?"active":""}">
                <span class="label">${s}</span>
                <span class="time">${Ct(r)}</span>
              </div>
              <div class="timer ${i} ${t.currentTurn===i?"active":""}">
                <span class="label">${o}</span>
                <span class="time">${Ct(a)}</span>
              </div>
            </div>
            <div class="game-actions">
              <button id="drawBtn" class="game-btn">Draw</button>
              <button id="resignBtn" class="game-btn danger">Resign</button>
            </div>
            <div id="drawNotification" class="draw-notification hidden"></div>
          </div>
        `,gt=document.getElementById("timerDisplay"),document.getElementById("resignBtn")?.addEventListener("click",()=>{confirm("Are you sure you want to resign?")&&pr()}),document.getElementById("drawBtn")?.addEventListener("click",()=>{mr();const c=document.getElementById("drawBtn");c&&(c.textContent="Offered",c.disabled=!0)}),na()}ci(t),_(),$(),di()},onMoveMade:t=>{ci(t),_(),$(),li(t.timer.white,t.timer.black,t.currentTurn),di(),t.currentTurn===t.myColor&&setTimeout(()=>{is()},50)},onTimerUpdate:(t,e)=>{const n=ln();n&&li(t,e,n.currentTurn)},onGameOver:t=>{if(!t)return;he();const e=ln();let n="";t.type==="checkmate"?n=t.winner===e?.myColor?"You won by checkmate!":"You lost by checkmate.":t.type==="stalemate"?n="Draw by stalemate.":t.type==="timeout"?n=t.winner===e?.myColor?"You won on time!":"You lost on time.":t.type==="resignation"?n=t.winner===e?.myColor?"Opponent resigned. You won!":"You resigned.":t.type==="disconnect"?n=t.winner===e?.myColor?"Opponent disconnected. You won!":"Game ended due to disconnection.":t.type==="draw"&&(n="Game drawn by agreement."),ea(n)},onError:t=>{alert(`Error: ${t}`)}})}function ci(t){Ue();for(let e=0;e<8;e++)for(let n=0;n<8;n++)S(e,n,[...t.board[e][n].pieces]);for(;O()!==t.currentTurn;)Ge();kt(t.enPassantTarget);for(const e of t.movedPawns)fi(e);for(const e of t.moveHistory)X().find(n=>n.notation===e.notation)||It(e);H()}function li(t,e,n){if(!gt)return;const i=gt.querySelector(".timer.white"),s=gt.querySelector(".timer.black");if(i){i.classList.toggle("active",n==="white");const o=i.querySelector(".time");o&&(o.textContent=Ct(t))}if(s){s.classList.toggle("active",n==="black");const o=s.querySelector(".time");o&&(o.textContent=Ct(e))}}function Ct(t){const e=Math.max(0,Math.floor(t/1e3)),n=Math.floor(e/60),i=e%60;return`${n}:${i.toString().padStart(2,"0")}`}function di(){const t=document.getElementById("currentTurnIndicator");if(t&&ke()){const e=Lt();t.classList.toggle("my-turn",e)}}function ea(t){const e=document.createElement("div");e.className="game-over-modal",e.id="gameOverModal";const i=gr()!==null,s=ln();if(s){const o=s.myColor==="white"?Ee()?.username||"You":s.opponent?.username||"Opponent",r=s.myColor==="black"?Ee()?.username||"You":s.opponent?.username||"Opponent";_n({id:crypto.randomUUID(),date:new Date().toISOString(),type:"online",white:o,black:r,result:t,moves:s.moveHistory||X(),moveCount:Math.ceil((s.moveHistory||X()).length/2)}).catch(a=>console.error("[GameStorage] Failed to save online game:",a))}e.innerHTML=`
    <div class="modal-content">
      <button class="modal-close" id="modalCloseBtn">√ó</button>
      <h2>Game Over</h2>
      <p>${t}</p>
      <div class="modal-buttons">
        ${i?'<button id="rematchBtn" class="modal-btn primary">Rematch</button>':""}
        <button id="analyzeGameBtn" class="modal-btn">Analysis</button>
        <button id="closeGameOverBtn" class="modal-btn">Back to Lobby</button>
      </div>
      <div id="rematchStatus" class="rematch-status hidden"></div>
    </div>
  `,document.body.appendChild(e),document.getElementById("modalCloseBtn")?.addEventListener("click",()=>{zt(e)}),e.addEventListener("click",o=>{o.target===e&&zt(e)}),document.getElementById("analyzeGameBtn")?.addEventListener("click",()=>{e.remove();const o=s?.moveHistory||X(),r=s?.myColor==="white"?Ee()?.username:s?.opponent?.username,a=s?.myColor==="black"?Ee()?.username:s?.opponent?.username;Hi(),Wi(),tt(!1),Tt(o,r,a)}),ta(e),document.getElementById("rematchBtn")?.addEventListener("click",()=>{yr();const o=document.getElementById("rematchStatus");o&&(o.classList.remove("hidden"),o.textContent="Waiting for opponent...");const r=document.getElementById("rematchBtn");r&&(r.textContent="Waiting...",r.disabled=!0)}),document.getElementById("closeGameOverBtn")?.addEventListener("click",()=>{zt(e)})}function zt(t){t.remove(),Hi(),Wi(),he(),tt(!1),Bt(),$n(),Mn(Nn)}function ta(t){const e=W();e&&(e.off("game:rematch-received"),e.off("game:rematch-sent"),e.off("game:rematch-declined"),e.off("game:rematch-expired"),e.off("game:rematch-error"),e.on("game:rematch-received",n=>{const i=document.getElementById("rematchStatus");i&&(i.classList.remove("hidden"),i.innerHTML=`
        <p><strong>${n.requesterName}</strong> wants a rematch!</p>
        <div class="rematch-buttons">
          <button id="acceptRematchBtn" class="lobby-btn primary">Accept</button>
          <button id="declineRematchBtn" class="lobby-btn">Decline</button>
        </div>
      `,document.getElementById("acceptRematchBtn")?.addEventListener("click",()=>{e.emit("game:rematch-accept",{rematchId:n.rematchId}),i.textContent="Starting game..."}),document.getElementById("declineRematchBtn")?.addEventListener("click",()=>{e.emit("game:rematch-decline",{rematchId:n.rematchId}),i.classList.add("hidden")}))}),e.on("game:rematch-declined",()=>{const n=document.getElementById("rematchStatus");n&&(n.textContent="Rematch declined.");const i=document.getElementById("rematchBtn");i&&(i.textContent="Rematch",i.disabled=!1)}),e.on("game:rematch-expired",()=>{const n=document.getElementById("rematchStatus");n&&(n.textContent="Rematch request expired.");const i=document.getElementById("rematchBtn");i&&(i.textContent="Rematch",i.disabled=!1)}),e.on("game:rematch-error",n=>{const i=document.getElementById("rematchStatus");i&&(i.textContent=n.message);const s=document.getElementById("rematchBtn");s&&(s.textContent="Rematch",s.disabled=!1)}),e.on("game:started",()=>{t.remove()}))}function na(){const t=W();t&&(t.off("game:draw-offered"),t.off("game:draw-declined"),t.on("game:draw-offered",()=>{const e=document.getElementById("drawNotification");e&&(e.classList.remove("hidden"),e.innerHTML=`
        <p>Opponent offers a draw</p>
        <div class="draw-buttons">
          <button id="acceptDrawBtn" class="game-btn primary-sm">Accept</button>
          <button id="declineDrawBtn" class="game-btn">Decline</button>
        </div>
      `,document.getElementById("acceptDrawBtn")?.addEventListener("click",()=>{ni(!0),e.classList.add("hidden")}),document.getElementById("declineDrawBtn")?.addEventListener("click",()=>{ni(!1),e.classList.add("hidden")}))}),t.on("game:draw-declined",()=>{const e=document.getElementById("drawNotification");e&&(e.classList.remove("hidden"),e.innerHTML="<p>Draw declined</p>",setTimeout(()=>e.classList.add("hidden"),3e3));const n=document.getElementById("drawBtn");n&&(n.textContent="Draw",n.disabled=!1)}))}function ia(t,e){const n=document.getElementById("challengeNotification");if(!n)return;const s=document.getElementById("timeControlSelect")?.value||"standard";let o=hs(s);if(s==="custom"){const r=document.getElementById("customMinutes")?.value||"10",a=document.getElementById("customIncrement")?.value||"0";o=`${r}+${a}`}n.classList.remove("hidden"),n.innerHTML=`
    <div class="challenge-confirm">
      <p>Challenge <strong>${e}</strong> to a ${o} game?</p>
      <div class="challenge-buttons">
        <button id="confirmChallengeBtn" class="lobby-btn primary">Challenge</button>
        <button id="cancelChallengeBtn" class="lobby-btn">Cancel</button>
      </div>
    </div>
  `,document.getElementById("confirmChallengeBtn")?.addEventListener("click",()=>{sa(t,s),n.innerHTML=`
      <div class="challenge-pending">
        <p>Waiting for ${e} to accept...</p>
        <button id="cancelPendingChallengeBtn" class="lobby-btn small">Cancel</button>
      </div>
    `,document.getElementById("cancelPendingChallengeBtn")?.addEventListener("click",()=>{Be&&(W()?.emit("lobby:challenge-cancel",{challengeId:Be}),Be=null),n.classList.add("hidden")})}),document.getElementById("cancelChallengeBtn")?.addEventListener("click",()=>{n.classList.add("hidden")})}function sa(t,e){const n=W();if(!n)return;let i;if(e==="custom"){const s=parseInt(document.getElementById("customMinutes")?.value||"10"),o=parseInt(document.getElementById("customIncrement")?.value||"0");i={initialTime:s*60*1e3,increment:o*1e3}}n.emit("lobby:challenge",{targetId:t,timeControl:e,customSettings:i})}function oa(){const t=W();t&&(t.off("lobby:challenge-received"),t.off("lobby:challenge-sent"),t.off("lobby:challenge-declined"),t.off("lobby:challenge-cancelled"),t.off("lobby:challenge-expired"),t.off("lobby:challenge-error"),t.on("lobby:challenge-received",e=>{const n=document.getElementById("challengeNotification");if(!n)return;let i=hs(e.timeControl);if(e.timeControl==="custom"&&e.customSettings){const s=Math.floor(e.customSettings.initialTime/6e4),o=Math.floor(e.customSettings.increment/1e3);i=`${s}+${o}`}n.classList.remove("hidden"),n.innerHTML=`
      <div class="challenge-received">
        <p><strong>${e.challengerName}</strong> challenges you to a ${i} game!</p>
        <div class="challenge-buttons">
          <button id="acceptChallengeBtn" class="lobby-btn primary">Accept</button>
          <button id="declineChallengeBtn" class="lobby-btn">Decline</button>
        </div>
      </div>
    `,document.getElementById("acceptChallengeBtn")?.addEventListener("click",()=>{t.emit("lobby:challenge-accept",{challengeId:e.challengeId}),n.innerHTML="<p>Starting game...</p>"}),document.getElementById("declineChallengeBtn")?.addEventListener("click",()=>{t.emit("lobby:challenge-decline",{challengeId:e.challengeId}),n.classList.add("hidden")})}),t.on("lobby:challenge-sent",e=>{Be=e.challengeId}),t.on("lobby:challenge-declined",e=>{Be=null;const n=document.getElementById("challengeNotification");n&&(n.innerHTML=`<p>${e.declinedBy} declined the challenge.</p>`,setTimeout(()=>n.classList.add("hidden"),3e3))}),t.on("lobby:challenge-cancelled",()=>{const e=document.getElementById("challengeNotification");e&&(e.innerHTML="<p>Challenge was cancelled.</p>",setTimeout(()=>e.classList.add("hidden"),3e3))}),t.on("lobby:challenge-expired",()=>{Be=null;const e=document.getElementById("challengeNotification");e&&(e.innerHTML="<p>Challenge expired.</p>",setTimeout(()=>e.classList.add("hidden"),3e3))}),t.on("lobby:challenge-error",e=>{Be=null;const n=document.getElementById("challengeNotification");n&&(n.innerHTML=`<p class="error">${e.message}</p>`,setTimeout(()=>n.classList.add("hidden"),3e3))}))}function hs(t){switch(t){case"bullet":return"1+0";case"blitz-3":return"3+0";case"blitz-5":return"5+0";case"rapid-7":return"7+0";case"standard":return"7+5";case"custom":return"Custom";default:return"7+5"}}const At="https://klikschaak-api.onrender.com";let de=null,An=!1;async function ra(){const t=We();if(!t)return!1;try{const e=await fetch(`${At}/api/auth/me`,{headers:{Authorization:`Bearer ${t}`}});return e.ok?(await e.json()).isAdmin===!0:!1}catch{return!1}}async function On(){if(!await ra())return;const e=document.getElementById("authContainer");if(!e)return;const n=document.createElement("button");n.id="adminBtn",n.className="auth-btn admin-btn",n.textContent="Admin",n.onclick=aa;const i=e.querySelector(".user-status");i&&i.appendChild(n)}function aa(){An?qn():ca()}async function ca(){An=!0,de=document.createElement("div"),de.id="adminPanel",de.className="admin-panel",de.innerHTML=`
    <div class="admin-panel-header">
      <h2>Admin Dashboard</h2>
      <div class="admin-tabs">
        <button class="admin-tab active" data-tab="users">Users</button>
        <button class="admin-tab" data-tab="games">Games</button>
      </div>
      <button id="closeAdminBtn" class="admin-close-btn">&times;</button>
    </div>
    <div class="admin-panel-content">
      <div id="adminTabContent">Loading...</div>
    </div>
  `,document.body.appendChild(de),document.getElementById("closeAdminBtn")?.addEventListener("click",qn),de.querySelectorAll(".admin-tab").forEach(t=>{t.addEventListener("click",()=>{const e=t.getAttribute("data-tab");la(e)})}),await Ot()}function la(t){de?.querySelectorAll(".admin-tab").forEach(e=>{e.classList.toggle("active",e.getAttribute("data-tab")===t)}),t==="users"?Ot():fs()}function qn(){An=!1,de?.remove(),de=null}async function Ot(){const t=We();if(!t)return;const e=document.getElementById("adminTabContent");if(e)try{const n=await fetch(`${At}/api/admin/users`,{headers:{Authorization:`Bearer ${t}`}});if(!n.ok){e.innerHTML='<p class="error">Failed to load users</p>';return}const{users:i}=await n.json();if(i.length===0){e.innerHTML="<p>No users found</p>";return}e.innerHTML=`
      <table class="admin-table">
        <thead>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Code</th>
            <th>Stats</th>
            <th>Admin</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${i.map(s=>`
            <tr data-user-id="${s.id}">
              <td>${s.username}</td>
              <td>${s.email}</td>
              <td>${s.friend_code}</td>
              <td>${s.stats.wins}W ${s.stats.losses}L ${s.stats.draws}D</td>
              <td>${s.is_admin?"‚úì":""}</td>
              <td>
                <button class="admin-action-btn toggle-admin" data-id="${s.id}" title="Toggle admin">
                  ${s.is_admin?"üë§":"üëë"}
                </button>
                <button class="admin-action-btn delete-user" data-id="${s.id}" title="Delete user">
                  üóëÔ∏è
                </button>
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `,e.querySelectorAll(".toggle-admin").forEach(s=>{s.addEventListener("click",()=>ua(s.getAttribute("data-id")))}),e.querySelectorAll(".delete-user").forEach(s=>{s.addEventListener("click",()=>ha(s.getAttribute("data-id")))})}catch{e.innerHTML='<p class="error">Error loading users</p>'}}async function fs(){const t=document.getElementById("adminTabContent");if(t){t.innerHTML="Loading games...";try{const e=await _r();if(e.length===0){t.innerHTML='<p style="color:#94a3b8;text-align:center;padding:20px;">No saved games yet.</p>';return}t.innerHTML=`
      <table class="admin-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>White vs Black</th>
            <th>Result</th>
            <th>Moves</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${e.map(n=>`
            <tr data-game-id="${n.id}">
              <td>${da(n.date)}</td>
              <td><span class="game-type-badge ${n.type}">${n.type}</span></td>
              <td>${jt(n.white)} vs ${jt(n.black)}</td>
              <td>${jt(n.result)}</td>
              <td>${n.moveCount}</td>
              <td>
                <button class="admin-action-btn analyze-game" data-id="${n.id}" title="Analyze">
                  &#128269;
                </button>
                <button class="admin-action-btn delete-game" data-id="${n.id}" title="Delete">
                  üóëÔ∏è
                </button>
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `,t.querySelectorAll(".analyze-game").forEach(n=>{n.addEventListener("click",()=>{const i=n.getAttribute("data-id"),s=e.find(o=>o.id===i);s&&(qn(),Tt(s.moves,s.white,s.black))})}),t.querySelectorAll(".delete-game").forEach(n=>{n.addEventListener("click",async()=>{const i=n.getAttribute("data-id");confirm("Delete this game?")&&(await Lr(i),await fs())})})}catch{t.innerHTML='<p class="error">Error loading games</p>'}}}function da(t){const e=new Date(t),n=i=>String(i).padStart(2,"0");return`${n(e.getDate())}/${n(e.getMonth()+1)} ${n(e.getHours())}:${n(e.getMinutes())}`}function jt(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}async function ua(t){const e=We();if(e)try{const n=await fetch(`${At}/api/admin/users/${t}/toggle-admin`,{method:"POST",headers:{Authorization:`Bearer ${e}`}});if(n.ok)await Ot();else{const i=await n.json();alert(i.error||"Failed to toggle admin status")}}catch{alert("Error toggling admin status")}}async function ha(t){if(!confirm("Are you sure you want to delete this user?"))return;const e=We();if(e)try{const n=await fetch(`${At}/api/admin/users/${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${e}`}});if(n.ok)await Ot();else{const i=await n.json();alert(i.error||"Failed to delete user")}}catch{alert("Error deleting user")}}let z=null;function fa(){z=document.getElementById("authContainer"),z||(z=document.createElement("div"),z.id="authContainer",document.body.appendChild(z)),nr()?(Rn(),Dn(),On()):it()}function it(){z&&(z.innerHTML=`
    <div class="auth-buttons">
      <button id="loginBtn" class="auth-btn">Login</button>
      <button id="registerBtn" class="auth-btn">Register</button>
    </div>
  `,document.getElementById("loginBtn")?.addEventListener("click",pa),document.getElementById("registerBtn")?.addEventListener("click",ma))}function Rn(){if(!z)return;const t=Ee();if(!t){it();return}z.innerHTML=`
    <div class="user-status">
      <span class="user-info">
        <span class="username">${t.username}</span>
        <span class="friend-code">#${t.friendCode}</span>
      </span>
      <span class="user-stats">${t.stats.wins}W ${t.stats.losses}L ${t.stats.draws}D</span>
      <button id="logoutBtn" class="auth-btn small">Logout</button>
    </div>
  `,document.getElementById("logoutBtn")?.addEventListener("click",va)}function pa(){z&&(z.innerHTML=`
    <div class="auth-form">
      <h3>Login</h3>
      <form id="loginForm">
        <input type="text" id="loginUsername" placeholder="Username or Email" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <div class="auth-error" id="loginError"></div>
        <div class="auth-form-buttons">
          <button type="submit" class="auth-btn primary">Login</button>
          <button type="button" id="loginCancel" class="auth-btn">Cancel</button>
        </div>
      </form>
    </div>
  `,document.getElementById("loginForm")?.addEventListener("submit",ga),document.getElementById("loginCancel")?.addEventListener("click",it))}function ma(){z&&(z.innerHTML=`
    <div class="auth-form">
      <h3>Register</h3>
      <form id="registerForm">
        <input type="text" id="regUsername" placeholder="Username" required minlength="3" maxlength="32">
        <input type="email" id="regEmail" placeholder="Email" required>
        <input type="password" id="regPassword" placeholder="Password" required minlength="6">
        <div class="auth-error" id="registerError"></div>
        <div class="auth-form-buttons">
          <button type="submit" class="auth-btn primary">Register</button>
          <button type="button" id="registerCancel" class="auth-btn">Cancel</button>
        </div>
      </form>
    </div>
  `,document.getElementById("registerForm")?.addEventListener("submit",ya),document.getElementById("registerCancel")?.addEventListener("click",it))}async function ga(t){t.preventDefault();const e=document.getElementById("loginUsername").value,n=document.getElementById("loginPassword").value,i=document.getElementById("loginError"),s=await or(e,n);s.success?(Rn(),Dn(),On()):i&&(i.textContent=s.error||"Login failed")}async function ya(t){t.preventDefault();const e=document.getElementById("regUsername").value,n=document.getElementById("regEmail").value,i=document.getElementById("regPassword").value,s=document.getElementById("registerError"),o=await sr(e,n,i);o.success?(Rn(),Dn(),On()):s&&(s.textContent=o.error||"Registration failed")}function va(){rr(),lr(),us(),it()}async function Dn(){try{await cr(),Jr(),dr(),Qr()}catch(t){console.error("Failed to connect:",t)}}gs();document.addEventListener("DOMContentLoaded",()=>{De(),Ur(),fa(),oo()});
