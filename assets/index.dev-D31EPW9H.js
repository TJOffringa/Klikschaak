(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();const cs={nl:{title:"Klikschaak",subtitle:"Combineer stukken voor strategische dominantie",newGame:"Nieuw Spel",whiteToMove:"Wit aan zet",blackToMove:"Zwart aan zet",moves:"Zetten",noMoves:"Nog geen zetten",gameRules:"Spelregels",klik:"Klikken:",unklik:"Ontklikken:",kingWarning:"Koning mag NOOIT klikken!",promotionTip:"Promotie: alleen met een pionzet!",autoPromote:"Automatisch promoveren tot dame",selected:"Geselecteerd",possibleMoves:"mogelijke zetten",choosePromotion:"Kies een stuk voor promotie:",chooseCastling:"Kies rokade optie:",onlyRook:"Alleen toren",bothPieces:"Beide stukken",chooseMove:"Kies zet type:",enPassant:"En passant",normalMove:"Normale zet",pawnCaptures:"(pion slaat)",moves_:"beweegt",checkmate:"Schaakmat!",stalemate:"Pat!",check:"SCHAAK!",wins:"wint!",draw:"Remise",gameEndsDraw:"Het spel eindigt in remise",analysis:"Analyse",analysisMode:"Analysemodus",boardEditor:"Bord Editor",exitEditor:"Verlaat Editor",exportPGN:"Exporteer PGN",importPGN:"Importeer PGN",playFromHere:"Speel vanaf hier",backToGame:"Terug naar Spel",pieces:"Stukken",turnToMove:"Aan zet",white:"Wit",black:"Zwart",clearBoard:"Leeg Bord",standardPosition:"Start Positie",loadFEN:"Laad",copyFEN:"Kopieer",copied:"Gekopieerd!",invalidFEN:"Ongeldige FEN",invalidPosition:"Ongeldige positie",copyToClipboard:"Kopieer naar Klembord",downloadFile:"Download Bestand",close:"Sluiten",loadPGN:"Laad PGN",cancel:"Annuleren",pasteHere:"Plak hier...",chooseFile:"Kies Bestand"},en:{title:"Clickchess",subtitle:"Combine pieces for strategic dominance",newGame:"New Game",whiteToMove:"White to move",blackToMove:"Black to move",moves:"Moves",noMoves:"No moves yet",gameRules:"Game Rules",klik:"Click:",unklik:"Unclick:",kingWarning:"King may NEVER click!",promotionTip:"Promotion: only with a pawn move!",autoPromote:"Auto-promote to queen",selected:"Selected",possibleMoves:"possible moves",choosePromotion:"Choose a piece for promotion:",chooseCastling:"Choose castling option:",onlyRook:"Only rook",bothPieces:"Both pieces",chooseMove:"Choose move type:",enPassant:"En passant",normalMove:"Normal move",pawnCaptures:"(pawn captures)",moves_:"moves",checkmate:"Checkmate!",stalemate:"Stalemate!",check:"CHECK!",wins:"wins!",draw:"Draw",gameEndsDraw:"The game ends in a draw",analysis:"Analysis",analysisMode:"Analysis Mode",boardEditor:"Board Editor",exitEditor:"Exit Editor",exportPGN:"Export PGN",importPGN:"Import PGN",playFromHere:"Play from here",backToGame:"Back to Game",pieces:"Pieces",turnToMove:"Turn to move",white:"White",black:"Black",clearBoard:"Clear Board",standardPosition:"Standard Position",loadFEN:"Load",copyFEN:"Copy",copied:"Copied!",invalidFEN:"Invalid FEN",invalidPosition:"Invalid position",copyToClipboard:"Copy to Clipboard",downloadFile:"Download File",close:"Close",loadPGN:"Load PGN",cancel:"Cancel",pasteHere:"Paste here...",chooseFile:"Choose File"}};let Te="nl";function as(t){Te=t,localStorage.setItem("klikschaak-language",t)}function ue(){return Te}function ls(){const t=localStorage.getItem("klikschaak-language");t&&(t==="nl"||t==="en")?Te=t:Te=navigator.language.slice(0,2)==="nl"?"nl":"en"}function y(t){return cs[Te][t]}function gt(t){const e={nl:{K:"Koning",Q:"Dame",R:"Toren",B:"Loper",N:"Paard",P:"Pion",k:"koning",q:"dame",r:"toren",b:"loper",n:"paard",p:"pion"},en:{K:"King",Q:"Queen",R:"Rook",B:"Bishop",N:"Knight",P:"Pawn",k:"king",q:"queen",r:"rook",b:"bishop",n:"knight",p:"pawn"}},n=t.charAt(0);return e[Te][n]||t}const q={K:"‚ôî",Q:"‚ôï",R:"‚ôñ",B:"‚ôó",N:"‚ôò",P:"‚ôô",k:"‚ôö",q:"‚ôõ",r:"‚ôú",b:"‚ôù",n:"‚ôû",p:"‚ôü",P0:"‚ôô",P1:"‚ôô",P2:"‚ôô",P3:"‚ôô",P4:"‚ôô",P5:"‚ôô",P6:"‚ôô",P7:"‚ôô",p0:"‚ôü",p1:"‚ôü",p2:"‚ôü",p3:"‚ôü",p4:"‚ôü",p5:"‚ôü",p6:"‚ôü",p7:"‚ôü"},ds={q:5,r:4,b:3,n:2,p:1,k:6},us=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]],hs=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]],fs=[[-1,-1],[-1,1],[1,-1],[1,1]],ps=[[-1,0],[1,0],[0,-1],[0,1]],ms="abcdefgh",gs="87654321";function w(t){return t===t.toUpperCase()}function F(t){return t.charAt(0).toLowerCase()==="p"}function O(t){return t.charAt(0).toLowerCase()}function $n(t){return ds[O(t)]||0}function it(t,e){return ms[e]+gs[t]}function At(t){return t.map(e=>q[e]).join("")}let b=oi();function oi(){return{board:ys(),currentTurn:"white",selectedSquare:null,selectedUnklikPiece:null,validMoves:[],moveHistory:[],castlingRights:{white:{kingSide:!0,queenSide:!0},black:{kingSide:!0,queenSide:!0}},enPassantTarget:null,movedPawns:new Set,autoPromoteToQueen:!1,pendingPromotion:null,gameOver:!1}}function ys(){return Array(8).fill(null).map(()=>Array(8).fill(null).map(()=>({pieces:[]})))}function Oe(){b=oi(),b.board[7][0].pieces=["R"],b.board[7][1].pieces=["N"],b.board[7][2].pieces=["B"],b.board[7][3].pieces=["Q"],b.board[7][4].pieces=["K"],b.board[7][5].pieces=["B"],b.board[7][6].pieces=["N"],b.board[7][7].pieces=["R"];for(let t=0;t<8;t++)b.board[6][t].pieces=[`P${t}`];b.board[0][0].pieces=["r"],b.board[0][1].pieces=["n"],b.board[0][2].pieces=["b"],b.board[0][3].pieces=["q"],b.board[0][4].pieces=["k"],b.board[0][5].pieces=["b"],b.board[0][6].pieces=["n"],b.board[0][7].pieces=["r"];for(let t=0;t<8;t++)b.board[1][t].pieces=[`p${t}`]}function N(){return b.board}function $(){return b.currentTurn}function yt(){return b.selectedSquare}function vt(){return b.selectedUnklikPiece}function _e(){return b.validMoves}function Ye(){return b.moveHistory}function z(){return b.castlingRights}function j(){return b.enPassantTarget}function Q(){return b.movedPawns}function st(){return b.autoPromoteToQueen}function ri(){return b.pendingPromotion}function ne(){return b.gameOver}function be(t){b.selectedSquare=t}function Pe(t){b.selectedUnklikPiece=t}function Ie(t){b.validMoves=t}function bt(t){b.enPassantTarget=t}function vs(t){b.autoPromoteToQueen=t}function Ve(t){b.pendingPromotion=t}function Ze(t){b.gameOver=t}function qe(){b.currentTurn=b.currentTurn==="white"?"black":"white"}function Ct(t){b.moveHistory.push(t)}function ci(t){b.movedPawns.add(t)}function Ge(t,e,n,i,s){n===7&&i===0&&s.includes("R")&&(b.castlingRights.white.queenSide=!1),n===7&&i===7&&s.includes("R")&&(b.castlingRights.white.kingSide=!1),n===0&&i===0&&s.includes("r")&&(b.castlingRights.black.queenSide=!1),n===0&&i===7&&s.includes("r")&&(b.castlingRights.black.kingSide=!1),s.includes("R")&&t===7&&e===0&&(b.castlingRights.white.queenSide=!1),s.includes("R")&&t===7&&e===7&&(b.castlingRights.white.kingSide=!1),s.includes("r")&&t===0&&e===0&&(b.castlingRights.black.queenSide=!1),s.includes("r")&&t===0&&e===7&&(b.castlingRights.black.kingSide=!1)}function Ht(t){t==="white"?b.castlingRights.white={kingSide:!1,queenSide:!1}:b.castlingRights.black={kingSide:!1,queenSide:!1}}function H(){b.selectedSquare=null,b.selectedUnklikPiece=null,b.validMoves=[]}function B(t,e,n){b.board[t][e].pieces=n}function Je(t,e){return b.board[t][e].pieces}function Wt(t,e,n,i){for(let s=0;s<8;s++)for(let o=0;o<8;o++){const r=t[s][o].pieces;if(r.length!==0&&w(r[0])!==i){for(const c of r)if(bs(t,s,o,c,e,n))return!0}}return!1}function bs(t,e,n,i,s,o){const r=O(i),c=w(i);if(r==="p"){const a=c?-1:1;return Math.abs(n-o)===1&&e+a===s}if(r==="n"){const a=Math.abs(e-s),l=Math.abs(n-o);return a===2&&l===1||a===1&&l===2}if(r==="k")return Math.abs(e-s)<=1&&Math.abs(n-o)<=1;if((r==="b"||r==="q")&&Math.abs(e-s)===Math.abs(n-o)){const a=s>e?1:-1,l=o>n?1:-1;let d=e+a,f=n+l;for(;d!==s||f!==o;){if(t[d][f].pieces.length>0)return!1;d+=a,f+=l}return!0}if((r==="r"||r==="q")&&(e===s||n===o)){const a=e===s?0:s>e?1:-1,l=n===o?0:o>n?1:-1;let d=e+a,f=n+l;for(;d!==s||f!==o;){if(t[d][f].pieces.length>0)return!1;d+=a,f+=l}return!0}return!1}function xe(t,e,n,i,s,o,r){const c=[],a=w(i),l=O(i);if(l==="p"){const d=a?-1:1,f=a?6:1;e+d>=0&&e+d<8&&t[e+d][n].pieces.length===0&&(c.push([e+d,n]),e===f&&!r.has(i)&&t[e+2*d][n].pieces.length===0&&c.push([e+2*d,n]));for(const h of[-1,1]){const u=n+h;if(u>=0&&u<8&&e+d>=0&&e+d<8){const p=t[e+d][u];p.pieces.length>0&&w(p.pieces[0])!==a&&c.push([e+d,u]),o&&o.row===e+d&&o.col===u&&c.push([e+d,u,"en-passant"])}}}if(l==="n")for(const[d,f]of us){const h=e+d,u=n+f;h>=0&&h<8&&u>=0&&u<8&&c.push([h,u])}if(l==="b"||l==="q")for(const[d,f]of fs)for(let h=1;h<8;h++){const u=e+d*h,p=n+f*h;if(u<0||u>=8||p<0||p>=8||(c.push([u,p]),t[u][p].pieces.length>0))break}if(l==="r"||l==="q")for(const[d,f]of ps)for(let h=1;h<8;h++){const u=e+d*h,p=n+f*h;if(u<0||u>=8||p<0||p>=8||(c.push([u,p]),t[u][p].pieces.length>0))break}if(l==="k"){for(const[h,u]of hs){const p=e+h,m=n+u;if(p>=0&&p<8&&m>=0&&m<8){const g=t[p][m];(g.pieces.length===0||w(g.pieces[0])!==a)&&c.push([p,m])}}const d=a?s.white:s.black,f=a?7:0;if(d.kingSide){const h=t[f][7],u=t[f][5];t[f][6].pieces.length===0&&h.pieces.length>0&&h.pieces.some(m=>O(m)==="r")&&(u.pieces.length===0?h.pieces.length===1?c.push([f,6,"castle-k"]):h.pieces.length===2&&c.push([f,6,"castle-k-choice"]):u.pieces.length===1&&w(u.pieces[0])===a&&(h.pieces.length===1?c.push([f,6,"castle-k-klik"]):h.pieces.length===2&&c.push([f,6,"castle-k-unklik-klik"])))}if(d.queenSide){const h=t[f][0],u=t[f][3],p=t[f][2],m=t[f][1];p.pieces.length===0&&m.pieces.length===0&&h.pieces.length>0&&h.pieces.some(g=>O(g)==="r")&&(u.pieces.length===0?h.pieces.length===1?c.push([f,2,"castle-q"]):h.pieces.length===2&&c.push([f,2,"castle-q-choice"]):u.pieces.length===1&&w(u.pieces[0])===a&&(h.pieces.length===1?c.push([f,2,"castle-q-klik"]):h.pieces.length===2&&c.push([f,2,"castle-q-unklik-klik"])))}}return c}function ke(t,e,n,i,s,o,r,c){const a=t.map(h=>h.map(u=>({pieces:[...u.pieces]}))),l=w(o[0]);if(r==="en-passant"){const h=l?i+1:i-1;a[h][s].pieces=[],a[i][s].pieces=[...o],a[e][n].pieces=[]}else if(r==="en-passant-unklik"){const h=l?i+1:i-1;a[h][s].pieces=[];const u=o[c];a[i][s].pieces=[u],a[e][n].pieces=a[e][n].pieces.filter((p,m)=>m!==c)}else if(r==="unklik"||r==="unklik-klik"){const h=o[c];r==="unklik-klik"?a[i][s].pieces=[...a[i][s].pieces,h]:a[i][s].pieces=[h],a[e][n].pieces=a[e][n].pieces.filter((u,p)=>p!==c)}else if(r==="klik")a[i][s].pieces=[...a[i][s].pieces,...o],a[e][n].pieces=[];else if(r?.startsWith("castle-")){const h=r.startsWith("castle-k"),u=h?7:0,p=h?5:3;a[i][s].pieces=o,a[e][n].pieces=[];const m=[...a[e][u].pieces];if(a[e][u].pieces=[],r.includes("unklik-klik")){const k=m.find(v=>O(v)==="r"),S=[...a[e][p].pieces];a[e][p].pieces=[k,...S]}else if(r.includes("klik")&&!r.includes("unklik")){const k=[...a[e][p].pieces];a[e][p].pieces=[...m,...k]}else if(r.includes("both"))a[e][p].pieces=m;else if(m.length===2){const k=m.find(S=>O(S)==="r");a[e][p].pieces=[k]}else a[e][p].pieces=m;const g=h?n+1:n-1;for(const k of[n,g,s])if(Wt(a,e,k,l))return!0}else a[i][s].pieces=[...o],a[e][n].pieces=[];let d=-1,f=-1;for(let h=0;h<8;h++){for(let u=0;u<8;u++)if(a[h][u].pieces.includes(l?"K":"k")){d=h,f=u;break}if(d!==-1)break}return d===-1?!1:Wt(a,d,f,l)}function pe(t,e,n,i,s,o,r,c){const a=new Map,l=w(i[0]),d=i.length===1,f=i.some(u=>F(u));for(const u of i){const p=xe(t,e,n,u,s,o,r);for(const m of p){const[g,k,S]=m,v=`${g},${k}`,T=t[g][k],_=F(u),U=l&&g===0||!l&&g===7;if(f&&i.length===2&&!_&&U||f&&(l&&g===7||!l&&g===0))continue;if(S==="en-passant"){const X=a.get(v);X&&X.type!=="en-passant"?a.set(v,{row:g,col:k,type:"en-passant-choice"}):a.set(v,{row:g,col:k,type:"en-passant"});continue}const R=a.get(v);if(R&&R.type==="en-passant"){a.set(v,{row:g,col:k,type:"en-passant-choice"});continue}if(!d)(T.pieces.length===0||w(T.pieces[0])!==l)&&a.set(v,{row:g,col:k,type:S||"normal"});else if(T.pieces.length>0&&w(T.pieces[0])===l){const X=F(u),Z=X&&n===k,Nn=!T.pieces.some($t=>O($t)==="k")&&!i.some($t=>O($t)==="k");Z&&T.pieces.length<2&&Nn?a.set(v,{row:g,col:k,type:"klik"}):!X&&T.pieces.length<2&&Nn&&a.set(v,{row:g,col:k,type:"klik"})}else(T.pieces.length===0||w(T.pieces[0])!==l)&&a.set(v,{row:g,col:k,type:S||"normal"})}}if(d){const u=i.find(p=>F(p));if(u){const p=l?-1:1,m=l?6:1;if(e+p>=0&&e+p<8){const g=t[e+p][n];if(g.pieces.length===1&&w(g.pieces[0])===l&&!g.pieces.some(k=>O(k)==="k")){const k=`${e+p},${n}`;a.set(k,{row:e+p,col:n,type:"klik"})}}if(e===m&&!r.has(u)&&e+2*p>=0&&e+2*p<8){const g=t[e+2*p][n];if(t[e+p][n].pieces.length===0&&g.pieces.length===1&&w(g.pieces[0])===l&&!g.pieces.some(S=>O(S)==="k")){const S=`${e+2*p},${n}`;a.set(S,{row:e+2*p,col:n,type:"klik"})}}}}let h=Array.from(a.values());return h=h.filter(u=>!ke(t,e,n,u.row,u.col,i,u.type,c)),h}function ks(t,e){const n=e==="white";let i=-1,s=-1;for(let o=0;o<8;o++){for(let r=0;r<8;r++)if(t[o][r].pieces.includes(n?"K":"k")){i=o,s=r;break}if(i!==-1)break}return i===-1?!1:Wt(t,i,s,n)}function Es(t,e,n,i,s){const o=e==="white";for(let r=0;r<8;r++)for(let c=0;c<8;c++){const a=t[r][c].pieces;if(a.length===0||w(a[0])!==o)continue;if(pe(t,r,c,a,n,i,s,null).length>0)return!0;if(a.length===2)for(let d=0;d<2;d++){const f=a[d],h=xe(t,r,c,f,n,i,s);for(const u of h){const[p,m]=u,g=t[p][m];if(g.pieces.length===0||w(g.pieces[0])!==o){if(!ke(t,r,c,p,m,a,"unklik",d))return!0}else if(g.pieces.length<2&&w(g.pieces[0])===o&&!g.pieces.some(k=>O(k)==="k")&&!ke(t,r,c,p,m,a,"unklik-klik",d))return!0}}}return!1}const ws="modulepreload",Bs=function(t,e){return new URL(t,e).href},An={},Pt=function(e,n,i){let s=Promise.resolve();if(n&&n.length>0){let l=function(d){return Promise.all(d.map(f=>Promise.resolve(f).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};const r=document.getElementsByTagName("link"),c=document.querySelector("meta[property=csp-nonce]"),a=c?.nonce||c?.getAttribute("nonce");s=l(n.map(d=>{if(d=Bs(d,i),d in An)return;An[d]=!0;const f=d.endsWith(".css"),h=f?'[rel="stylesheet"]':"";if(i)for(let p=r.length-1;p>=0;p--){const m=r[p];if(m.href===d&&(!f||m.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${h}`))return;const u=document.createElement("link");if(u.rel=f?"stylesheet":ws,f||(u.as="script"),u.crossOrigin="",u.href=d,a&&u.setAttribute("nonce",a),document.head.appendChild(u),f)return new Promise((p,m)=>{u.addEventListener("load",p),u.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${d}`)))})}))}function o(r){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=r,window.dispatchEvent(c),!c.defaultPrevented)throw r}return s.then(r=>{for(const c of r||[])c.status==="rejected"&&o(c.reason);return e().catch(o)})};let I={isActive:!1,initialBoard:[],initialTurn:"white",moveIndex:-1,savedMoves:[],boardStates:[]};function oe(){return I.isActive}function Kt(){return I.moveIndex}function Ss(){return I.savedMoves.length}function rn(){return I.savedMoves}function ai(t,e){I={isActive:!0,initialBoard:kt(N()),initialTurn:$(),moveIndex:t.length-1,savedMoves:[...t],boardStates:[]},Ms()}function Cs(t=!0){if(Oe(),!t)for(let e=0;e<8;e++)for(let n=0;n<8;n++)B(e,n,[]);I={isActive:!0,initialBoard:kt(N()),initialTurn:"white",moveIndex:-1,savedMoves:[],boardStates:[{board:kt(N()),turn:"white",enPassantTarget:null,castlingRights:{white:{kingSide:!0,queenSide:!0},black:{kingSide:!0,queenSide:!0}},movedPawns:[]}]}}function Ps(){I={isActive:!1,initialBoard:[],initialTurn:"white",moveIndex:-1,savedMoves:[],boardStates:[]}}function Re(t){if(t<-1||t>=I.savedMoves.length)return;I.moveIndex=t;const e=t+1;if(e>=0&&e<I.boardStates.length){const n=I.boardStates[e];Ls(n)}}function Is(){Re(-1)}function li(){Re(I.savedMoves.length-1)}function Ts(){I.moveIndex>=0&&Re(I.moveIndex-1)}function _s(){I.moveIndex<I.savedMoves.length-1&&Re(I.moveIndex+1)}function cn(t){I.moveIndex<I.savedMoves.length-1&&(I.savedMoves=I.savedMoves.slice(0,I.moveIndex+1),I.boardStates=I.boardStates.slice(0,I.moveIndex+2)),I.savedMoves.push(t),I.boardStates.push(xs()),I.moveIndex=I.savedMoves.length-1}function kt(t){return t.map(e=>e.map(n=>({pieces:[...n.pieces]})))}function xs(){return{board:kt(N()),turn:$(),enPassantTarget:j(),castlingRights:JSON.parse(JSON.stringify(z())),movedPawns:Array.from(Q())}}function Ls(t){for(let e=0;e<8;e++)for(let n=0;n<8;n++)B(e,n,[...t.board[e][n].pieces]);for(;$()!==t.turn;)qe();bt(t.enPassantTarget),H()}function Ms(){I.boardStates=[{board:I.initialBoard,turn:I.initialTurn,enPassantTarget:null,castlingRights:{white:{kingSide:!0,queenSide:!0},black:{kingSide:!0,queenSide:!0}},movedPawns:[]}]}let he={isActive:!1,selectedPiece:null,turnToMove:"white"};const On={white:["K","Q","R","B","N","P0"],black:["k","q","r","b","n","p0"]};function Le(){return he.isActive}function di(){return he.selectedPiece}function Ns(){return he.turnToMove}function $s(){he={isActive:!0,selectedPiece:null,turnToMove:"white"}}function Vt(){he={isActive:!1,selectedPiece:null,turnToMove:"white"}}function qn(t){he.selectedPiece=t}function ui(t){for(he.turnToMove=t;$()!==t;)qe()}function As(t,e){if(!he.selectedPiece)return;const n=Je(t,e);let i=he.selectedPiece;if((i==="P0"||i==="p0")&&(i=qs(i[0])),n.length<2)if(n.some(r=>r==="K"||r==="k")||(i==="K"||i==="k"))B(t,e,[i]);else if(n.length>0){const r=n[0].toUpperCase()===n[0],c=i.toUpperCase()===i;r===c?B(t,e,[...n,i]):B(t,e,[i])}else B(t,e,[i]);else B(t,e,[i])}function Os(t,e,n){Je(t,e),B(t,e,[])}function hi(){for(let t=0;t<8;t++)for(let e=0;e<8;e++)B(t,e,[])}function fi(){Oe()}function qs(t){const e=N(),n=new Set;for(let i=0;i<8;i++)for(let s=0;s<8;s++)for(const o of e[i][s].pieces)o.startsWith(t)&&n.add(o);for(let i=0;i<16;i++){const s=`${t}${i}`;if(!n.has(s))return s}return`${t}0`}function Rs(){const t=N(),e=[];let n=0,i=0;for(let s=0;s<8;s++)for(let o=0;o<8;o++)for(const r of t[s][o].pieces)r==="K"&&n++,r==="k"&&i++;return n===0&&e.push("White needs a king"),n>1&&e.push("White has too many kings"),i===0&&e.push("Black needs a king"),i>1&&e.push("Black has too many kings"),{valid:e.length===0,errors:e}}function an(){const t=N(),e=[];for(let i=0;i<8;i++){let s="",o=0;for(let r=0;r<8;r++){const c=t[i][r].pieces;c.length===0?o++:(o>0&&(s+=o,o=0),c.length===1?s+=Rn(c[0]):s+="("+c.map(Rn).join("")+")")}o>0&&(s+=o),e.push(s)}const n=$()==="white"?"w":"b";return`${e.join("/")} ${n}`}function pi(t){try{const e=t.trim().split(" "),n=e[0],i=e[1]||"w";hi();const s=n.split("/");if(s.length!==8)return!1;for(let o=0;o<8;o++){let r=0,c=0;const a=s[o];for(;c<a.length&&r<8;){const l=a[c];if(l>="1"&&l<="8")r+=parseInt(l),c++;else if(l==="("){const d=a.indexOf(")",c);if(d===-1)return!1;const f=a.substring(c+1,d),h=[];for(const u of f){const p=Dn(u);p&&h.push(p)}B(o,r,h),r++,c=d+1}else{const d=Dn(l);d&&B(o,r,[d]),r++,c++}}}return ui(i==="b"?"black":"white"),!0}catch{return!1}}function Rn(t){const e=t[0];return"KQRBNPkqrbnp".includes(e),e}function Dn(t){const e={P:0,p:0};return t==="P"?`P${e.P++%8}`:t==="p"?`p${e.p++%8}`:"KQRBNkqrbn".includes(t)?t:null}function Ds(t){const i=['[Event "Klikschaak Game"]','[Site "Klikschaak Online"]',`[Date "${new Date().toISOString().split("T")[0].replace(/-/g,".")}"]`,'[Round "-"]',`[White "${t.white||"Player 1"}"]`,`[Black "${t.black||"Player 2"}"]`,`[Result "${t.result||"*"}"]`,'[Variant "Klikschaak"]'];t.fen&&(i.push(`[FEN "${t.fen}"]`),i.push('[SetUp "1"]'));const s=Us(t.moves);return i.join(`
`)+`

`+s+" "+(t.result||"*")}function Us(t){const e=[];let n="";for(let i=0;i<t.length;i+=2){const s=Math.floor(i/2)+1,o=t[i]?.notation||"",r=t[i+1]?.notation||"";let c=`${s}. ${o}`;r&&(c+=` ${r}`),n.length+c.length>75?(e.push(n.trim()),n=c+" "):n+=c+" "}return n.trim()&&e.push(n.trim()),e.join(`
`)}function Fs(t){try{const e=t.trim().split(`
`),n={};let i="";for(const o of e){const r=o.trim();if(r.startsWith("[")&&r.endsWith("]")){const c=r.match(/\[(\w+)\s+"(.*)"\]/);c&&(n[c[1].toLowerCase()]=c[2])}else r.length>0&&(i+=" "+r)}const s=Gs(i);return{event:n.event||"Unknown",site:n.site||"Unknown",date:n.date||"",round:n.round||"-",white:n.white||"White",black:n.black||"Black",result:n.result||"*",variant:n.variant||"Standard",fen:n.fen,moves:s}}catch(e){return console.error("Error parsing PGN:",e),null}}function Gs(t){const e=[],i=t.replace(/1-0|0-1|1\/2-1\/2|\*/g,"").replace(/\{[^}]*\}/g,"").replace(/\([^)]*\)/g,"").replace(/\$\d+/g,"").trim().split(/\s+/).filter(o=>o.length>0);let s="white";for(const o of i){if(/^\d+\.+$/.test(o)){s="white";continue}const r=o.match(/^(\d+)\.(.*)/);if(r&&r[2]){s="white",e.push({turn:s,notation:r[2]}),s="black";continue}o.length>0&&!o.match(/^\d+$/)&&(e.push({turn:s,notation:o}),s=s==="white"?"black":"white")}return e}function Hs(t,e="game.pgn"){const n=new Blob([t],{type:"application/x-chess-pgn"}),i=URL.createObjectURL(n),s=document.createElement("a");s.href=i,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i)}async function Ws(t){try{return await navigator.clipboard.writeText(t),!0}catch{return!1}}function Ks(t){return new Promise((e,n)=>{const i=new FileReader;i.onload=s=>{const o=s.target?.result;typeof o=="string"?e(o):n(new Error("Failed to read file"))},i.onerror=()=>n(i.error),i.readAsText(t)})}let ae=null;function ln(t,e,n){ae=document.getElementById("analysisContainer"),ae||(ae=document.createElement("div"),ae.id="analysisContainer",document.body.appendChild(ae)),t&&t.length>0?ai(t):Cs(!0),dn(e,n),x(),M(),ze(),un()}function Ot(){ae&&(ae.innerHTML=""),Ps(),Vt()}function dn(t,e){if(!ae)return;const n=rn(),i=Kt();ae.innerHTML=`
    <div class="analysis-panel">
      <div class="analysis-header">
        <h3>${y("analysisMode")}</h3>
        <button id="closeAnalysisBtn" class="analysis-close-btn">&times;</button>
      </div>

      <div class="analysis-players">
        ${t?`<span class="player-white">‚¨ú ${t}</span>`:""}
        ${e?`<span class="player-black">‚¨õ ${e}</span>`:""}
      </div>

      <div class="analysis-controls">
        <button id="goStartBtn" class="nav-btn" title="Go to start">‚èÆ</button>
        <button id="goBackBtn" class="nav-btn" title="Previous move">‚óÄ</button>
        <span class="move-counter">${i+1} / ${n.length}</span>
        <button id="goForwardBtn" class="nav-btn" title="Next move">‚ñ∂</button>
        <button id="goEndBtn" class="nav-btn" title="Go to end">‚è≠</button>
      </div>

      <div class="analysis-moves" id="analysisMoveList">
        ${mi(n,i)}
      </div>

      <div class="analysis-actions">
        <button id="toggleEditorBtn" class="analysis-btn">
          ${Le()?y("exitEditor"):y("boardEditor")}
        </button>
        <button id="exportPGNBtn" class="analysis-btn">${y("exportPGN")}</button>
        <button id="importPGNBtn" class="analysis-btn">${y("importPGN")}</button>
      </div>

      <div id="editorPanel" class="editor-panel ${Le()?"":"hidden"}">
        ${gi()}
      </div>

      <div class="engine-eval" id="engineEvalPanel">
        <div class="eval-header">
          <button id="engineToggleBtn" class="engine-toggle-btn active" title="Toggle engine">&#9881; Engine</button>
        </div>
        <div class="eval-content" id="evalContent">
          <div class="eval-bar-container">
            <div class="eval-bar" id="evalBar">
              <div class="eval-fill" id="evalFill"></div>
            </div>
            <span class="eval-score" id="evalScore">...</span>
          </div>
          <div class="eval-info" id="evalInfo"></div>
        </div>
      </div>

      <div class="engine-compare" id="engineComparePanel">
        <div class="compare-header">
          <span class="compare-status" id="engineStatus">Loading...</span>
        </div>
        <div class="compare-counts" id="compareCounts"></div>
        <div class="compare-diff hidden" id="compareDiff"></div>
      </div>

      <div class="analysis-footer">
        <button id="newGameFromHereBtn" class="analysis-btn primary">${y("playFromHere")}</button>
        <button id="exitAnalysisBtn" class="analysis-btn">${y("backToGame")}</button>
      </div>
    </div>
  `,Vs()}function mi(t,e){if(t.length===0)return'<p class="no-moves">No moves yet</p>';const n=[];for(let i=0;i<t.length;i+=2){const s=Math.floor(i/2)+1,o=t[i],r=t[i+1],c=i===e?"active":"",a=i+1===e?"active":"";n.push(`
      <div class="move-pair">
        <span class="move-number">${s}.</span>
        <span class="move-notation ${c}" data-index="${i}">${o?.notation||""}</span>
        <span class="move-notation ${a}" data-index="${i+1}">${r?.notation||""}</span>
      </div>
    `)}return n.join("")}function gi(){const t=di(),e=Ns();return`
    <div class="editor-section">
      <h4>${y("pieces")}</h4>
      <div class="piece-palette">
        <div class="palette-row">
          ${On.white.map(n=>`
            <button class="palette-piece ${t===n?"selected":""}" data-piece="${n}">
              <span class="piece piece-white">${q[n[0]]||q[n]}</span>
            </button>
          `).join("")}
        </div>
        <div class="palette-row">
          ${On.black.map(n=>`
            <button class="palette-piece ${t===n?"selected":""}" data-piece="${n}">
              <span class="piece piece-black">${q[n[0]]||q[n]}</span>
            </button>
          `).join("")}
        </div>
        <button class="palette-piece erase ${t===null?"selected":""}" data-piece="erase">
          üóëÔ∏è
        </button>
      </div>
    </div>

    <div class="editor-section">
      <h4>${y("turnToMove")}</h4>
      <div class="turn-selector">
        <button class="turn-btn ${e==="white"?"active":""}" data-turn="white">${y("white")}</button>
        <button class="turn-btn ${e==="black"?"active":""}" data-turn="black">${y("black")}</button>
      </div>
    </div>

    <div class="editor-section">
      <h4>Quick actions</h4>
      <div class="editor-actions">
        <button id="clearBoardBtn" class="editor-action-btn">${y("clearBoard")}</button>
        <button id="standardPosBtn" class="editor-action-btn">${y("standardPosition")}</button>
      </div>
    </div>

    <div class="editor-section">
      <h4>FEN</h4>
      <div class="fen-input-group">
        <input type="text" id="fenInput" class="fen-input" placeholder="${y("pasteHere")}" value="${an()}">
        <button id="loadFENBtn" class="fen-btn">${y("loadFEN")}</button>
        <button id="copyFENBtn" class="fen-btn">${y("copyFEN")}</button>
      </div>
    </div>
  `}function Vs(){document.getElementById("engineToggleBtn")?.addEventListener("click",()=>{Be=!Be;const t=document.getElementById("engineToggleBtn"),e=document.getElementById("evalContent");t&&t.classList.toggle("active",Be),e&&e.classList.toggle("hidden",!Be),Be?un():Se&&Se.abort()}),document.getElementById("closeAnalysisBtn")?.addEventListener("click",()=>{Ot(),Ae(),x(),M()}),document.getElementById("goStartBtn")?.addEventListener("click",()=>{Is(),ie()}),document.getElementById("goBackBtn")?.addEventListener("click",()=>{Ts(),ie()}),document.getElementById("goForwardBtn")?.addEventListener("click",()=>{_s(),ie()}),document.getElementById("goEndBtn")?.addEventListener("click",()=>{li(),ie()}),document.getElementById("analysisMoveList")?.addEventListener("click",t=>{const e=t.target;if(e.classList.contains("move-notation")){const n=parseInt(e.dataset.index||"-1");n>=0&&(Re(n),ie())}}),document.getElementById("toggleEditorBtn")?.addEventListener("click",()=>{Le()?Vt():$s(),dn(),x()}),document.getElementById("exportPGNBtn")?.addEventListener("click",()=>{js()}),document.getElementById("importPGNBtn")?.addEventListener("click",()=>{Ys()}),document.getElementById("newGameFromHereBtn")?.addEventListener("click",()=>{if(Le()){const t=Rs();if(!t.valid){alert(y("invalidPosition")+`:
`+t.errors.join(`
`));return}Vt()}Ot(),H(),x(),M()}),document.getElementById("exitAnalysisBtn")?.addEventListener("click",()=>{Ot(),Ae(),x(),M()}),yi()}function yi(){document.querySelectorAll(".palette-piece").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.piece;qn(e==="erase"?null:e),Un()})}),document.querySelectorAll(".turn-btn").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.turn;ui(e),Un()})}),document.getElementById("clearBoardBtn")?.addEventListener("click",()=>{hi(),x(),zt(),ze()}),document.getElementById("standardPosBtn")?.addEventListener("click",()=>{fi(),x(),zt(),ze()}),document.getElementById("loadFENBtn")?.addEventListener("click",()=>{const t=document.getElementById("fenInput");t?.value&&(pi(t.value)?(x(),ze()):alert(y("invalidFEN")))}),document.getElementById("copyFENBtn")?.addEventListener("click",async()=>{const t=an();try{await navigator.clipboard.writeText(t);const e=document.getElementById("copyFENBtn");e&&(e.textContent=y("copied"),setTimeout(()=>{e.textContent=y("copyFEN")},2e3))}catch{alert(y("invalidFEN"))}})}function ie(){x(),M();const t=document.getElementById("analysisMoveList");t&&(t.innerHTML=mi(rn(),Kt()),t.querySelectorAll(".move-notation").forEach(n=>{n.addEventListener("click",()=>{const i=parseInt(n.dataset.index||"-1");i>=0&&(Re(i),ie())})}));const e=document.querySelector(".move-counter");e&&(e.textContent=`${Kt()+1} / ${Ss()}`),ze(),un()}function Un(){const t=document.getElementById("editorPanel");t&&(t.innerHTML=gi(),yi())}function zt(){const t=document.getElementById("fenInput");t&&(t.value=an())}function ze(){const t=document.getElementById("engineStatus"),e=document.getElementById("compareCounts"),n=document.getElementById("compareDiff");!t||!e||(t.textContent="Comparing...",e.innerHTML="",n&&(n.innerHTML="",n.classList.add("hidden")),Pt(async()=>{const{comparePositionMoves:i}=await Promise.resolve().then(()=>Vi);return{comparePositionMoves:i}},void 0,import.meta.url).then(({comparePositionMoves:i})=>i()).then(i=>{const s=document.getElementById("engineStatus"),o=document.getElementById("compareCounts"),r=document.getElementById("compareDiff");if(!(!s||!o)){if(!i.engineOnline){s.textContent="Engine offline",s.className="compare-status offline",o.innerHTML=`<span class="webapp-count">Webapp: ${i.webappCount} moves</span>`;return}if(i.hasMismatch){if(s.textContent="MISMATCH",s.className="compare-status mismatch",o.innerHTML=`
        <span class="webapp-count">Webapp: <strong>${i.webappCount}</strong></span>
        <span class="separator">|</span>
        <span class="engine-count">Engine: <strong>${i.engineCount}</strong></span>
        <button id="toggleDiffBtn" class="diff-toggle-btn">
          Show diff (${i.webappOnly.length+i.engineOnly.length} different)
        </button>
      `,r){let c='<div class="diff-content">';if(i.webappOnly.length>0){c+='<div class="diff-section webapp-only">',c+=`<h5>Only in Webapp (${i.webappOnly.length}):</h5>`,c+='<div class="move-chips">';for(const a of i.webappOnly)c+=`<span class="move-chip webapp">${a}</span>`;c+="</div></div>"}if(i.engineOnly.length>0){c+='<div class="diff-section engine-only">',c+=`<h5>Only in Engine (${i.engineOnly.length}):</h5>`,c+='<div class="move-chips">';for(const a of i.engineOnly)c+=`<span class="move-chip engine">${a}</span>`;c+="</div></div>"}c+='<div class="diff-section matching">',c+=`<h5>Matching (${i.matching.length}):</h5>`,c+='<div class="move-chips">';for(const a of i.matching)c+=`<span class="move-chip match">${a}</span>`;c+="</div></div>",c+="</div>",r.innerHTML=c}document.getElementById("toggleDiffBtn")?.addEventListener("click",()=>{if(r){r.classList.toggle("hidden");const c=document.getElementById("toggleDiffBtn");c&&(c.textContent=r.classList.contains("hidden")?`Show diff (${i.webappOnly.length+i.engineOnly.length} different)`:"Hide diff")}})}else s.textContent="MATCH",s.className="compare-status match",o.innerHTML=`
        <span class="webapp-count">Webapp: <strong>${i.webappCount}</strong></span>
        <span class="separator">|</span>
        <span class="engine-count">Engine: <strong>${i.engineCount}</strong></span>
      `}}))}function Fn(t){return t>=1e6?(t/1e6).toFixed(1)+"M":t>=1e3?(t/1e3).toFixed(1)+"k":String(t)}let Be=!0,Se=null;function un(){if(!Be)return;const t=document.getElementById("evalScore");if(!t)return;Se&&Se.abort(),Se=new AbortController;const e=Se.signal;t.textContent="...",Pt(()=>Promise.resolve().then(()=>Vi),void 0,import.meta.url).then(async({fetchEngineEval:n,buildFullFEN:i})=>{const s=i(),o=10;for(let r=1;r<=o;r++){if(e.aborted)return;const c=await n(s,r);if(e.aborted)return;if(c.error){if(r===1){const a=document.getElementById("evalScore"),l=document.getElementById("evalFill"),d=document.getElementById("evalInfo");a&&(a.textContent="--"),l&&(l.style.width="50%"),d&&(d.innerHTML='<span style="color:#64748b">Engine offline</span>')}return}zs(c)}})}function zs(t){const e=document.getElementById("evalScore"),n=document.getElementById("evalFill"),i=document.getElementById("evalInfo");if(e){if(t.scoreType==="mate"){const s=t.score>0?"+":"";e.textContent=`M${s}${t.score}`}else{const s=t.score/100,o=s>0?"+":"";e.textContent=`${o}${s.toFixed(1)}`}if(n){let s;t.scoreType==="mate"?s=t.score>0?95:5:s=50+50*(2/(1+Math.exp(-t.score/400))-1),n.style.width=`${Math.max(2,Math.min(98,s))}%`}if(i){let s="";t.bestMove&&(s+=`<span class="eval-bestmove">Best: ${t.bestMove}</span>`),t.pv.length>1&&(s+=`<div class="eval-pv">${t.pv.slice(0,5).join(" ")}</div>`),s+=`<div class="eval-stats">depth ${t.depth} | ${Fn(t.nodes)} nodes | ${Fn(t.nps)} nps | ${t.time_ms}ms</div>`,i.innerHTML=s}}}function js(){const t=rn(),e=Ds({moves:t}),n=document.createElement("div");n.className="analysis-overlay",n.id="exportOverlay",n.innerHTML=`
    <div class="analysis-dialog">
      <h3>${y("exportPGN")}</h3>
      <textarea id="pgnOutput" class="pgn-textarea" readonly>${e}</textarea>
      <div class="dialog-buttons">
        <button id="copyPGNBtn" class="analysis-btn primary">${y("copyToClipboard")}</button>
        <button id="downloadPGNBtn" class="analysis-btn">${y("downloadFile")}</button>
        <button id="closeExportBtn" class="analysis-btn">${y("close")}</button>
      </div>
    </div>
  `,document.body.appendChild(n),document.getElementById("copyPGNBtn")?.addEventListener("click",async()=>{const i=await Ws(e),s=document.getElementById("copyPGNBtn");s&&(s.textContent=i?y("copied"):"Failed",setTimeout(()=>{s.textContent=y("copyToClipboard")},2e3))}),document.getElementById("downloadPGNBtn")?.addEventListener("click",()=>{const i=`klikschaak_${new Date().toISOString().split("T")[0]}.pgn`;Hs(e,i)}),document.getElementById("closeExportBtn")?.addEventListener("click",()=>{n.remove()})}function Ys(){const t=document.createElement("div");t.className="analysis-overlay",t.id="importOverlay",t.innerHTML=`
    <div class="analysis-dialog">
      <h3>${y("importPGN")}</h3>
      <textarea id="pgnInput" class="pgn-textarea" placeholder="${y("pasteHere")}"></textarea>
      <div class="file-input-wrapper">
        <input type="file" id="pgnFileInput" accept=".pgn,.txt">
        <label for="pgnFileInput" class="analysis-btn">${y("chooseFile")}</label>
      </div>
      <div class="dialog-buttons">
        <button id="loadPGNBtn" class="analysis-btn primary">${y("loadPGN")}</button>
        <button id="closeImportBtn" class="analysis-btn">${y("cancel")}</button>
      </div>
    </div>
  `,document.body.appendChild(t),document.getElementById("pgnFileInput")?.addEventListener("change",async e=>{const n=e.target;if(n.files&&n.files[0])try{const i=await Ks(n.files[0]),s=document.getElementById("pgnInput");s&&(s.value=i)}catch{alert("Failed to read file")}}),document.getElementById("loadPGNBtn")?.addEventListener("click",()=>{const e=document.getElementById("pgnInput");if(e?.value){const n=Fs(e.value);n?(n.fen?pi(n.fen):fi(),ai(n.moves),t.remove(),dn(n.white,n.black),li(),ie()):alert("Failed to parse PGN")}}),document.getElementById("closeImportBtn")?.addEventListener("click",()=>{t.remove()})}function Js(t,e){if(!Le())return;di()===null?Os(t,e):As(t,e),x(),zt()}function Qs(){return Le()}function vi(t,e,n){ln(t,e,n)}function Xs(){if(document.getElementById("analysisBtn"))return;const e=document.createElement("button");e.id="analysisBtn",e.className="analysis-mode-btn",e.textContent=y("analysis"),e.title=y("analysisMode"),e.addEventListener("click",()=>{ln()}),document.body.appendChild(e)}let de={from:null,to:null,moveType:null,unklikPieceIndex:null,promotionPiece:null};function Zs(){return de}function hn(){return de.from!==null&&de.to!==null}function eo(t,e,n,i,s){de={from:t,to:e,moveType:n,unklikPieceIndex:i??null,promotionPiece:null}}function le(){de={from:null,to:null,moveType:null,unklikPieceIndex:null,promotionPiece:null}}function to(t,e){return de.from?.row===t&&de.from?.col===e?"from":de.to?.row===t&&de.to?.col===e?"to":null}const re=Object.create(null);re.open="0";re.close="1";re.ping="2";re.pong="3";re.message="4";re.upgrade="5";re.noop="6";const lt=Object.create(null);Object.keys(re).forEach(t=>{lt[re[t]]=t});const jt={type:"error",data:"parser error"},bi=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",ki=typeof ArrayBuffer=="function",Ei=t=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(t):t&&t.buffer instanceof ArrayBuffer,fn=({type:t,data:e},n,i)=>bi&&e instanceof Blob?n?i(e):Gn(e,i):ki&&(e instanceof ArrayBuffer||Ei(e))?n?i(e):Gn(new Blob([e]),i):i(re[t]+(e||"")),Gn=(t,e)=>{const n=new FileReader;return n.onload=function(){const i=n.result.split(",")[1];e("b"+(i||""))},n.readAsDataURL(t)};function Hn(t){return t instanceof Uint8Array?t:t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}let qt;function no(t,e){if(bi&&t.data instanceof Blob)return t.data.arrayBuffer().then(Hn).then(e);if(ki&&(t.data instanceof ArrayBuffer||Ei(t.data)))return e(Hn(t.data));fn(t,!1,n=>{qt||(qt=new TextEncoder),e(qt.encode(n))})}const Wn="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",We=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let t=0;t<Wn.length;t++)We[Wn.charCodeAt(t)]=t;const io=t=>{let e=t.length*.75,n=t.length,i,s=0,o,r,c,a;t[t.length-1]==="="&&(e--,t[t.length-2]==="="&&e--);const l=new ArrayBuffer(e),d=new Uint8Array(l);for(i=0;i<n;i+=4)o=We[t.charCodeAt(i)],r=We[t.charCodeAt(i+1)],c=We[t.charCodeAt(i+2)],a=We[t.charCodeAt(i+3)],d[s++]=o<<2|r>>4,d[s++]=(r&15)<<4|c>>2,d[s++]=(c&3)<<6|a&63;return l},so=typeof ArrayBuffer=="function",pn=(t,e)=>{if(typeof t!="string")return{type:"message",data:wi(t,e)};const n=t.charAt(0);return n==="b"?{type:"message",data:oo(t.substring(1),e)}:lt[n]?t.length>1?{type:lt[n],data:t.substring(1)}:{type:lt[n]}:jt},oo=(t,e)=>{if(so){const n=io(t);return wi(n,e)}else return{base64:!0,data:t}},wi=(t,e)=>e==="blob"?t instanceof Blob?t:new Blob([t]):t instanceof ArrayBuffer?t:t.buffer,Bi="",ro=(t,e)=>{const n=t.length,i=new Array(n);let s=0;t.forEach((o,r)=>{fn(o,!1,c=>{i[r]=c,++s===n&&e(i.join(Bi))})})},co=(t,e)=>{const n=t.split(Bi),i=[];for(let s=0;s<n.length;s++){const o=pn(n[s],e);if(i.push(o),o.type==="error")break}return i};function ao(){return new TransformStream({transform(t,e){no(t,n=>{const i=n.length;let s;if(i<126)s=new Uint8Array(1),new DataView(s.buffer).setUint8(0,i);else if(i<65536){s=new Uint8Array(3);const o=new DataView(s.buffer);o.setUint8(0,126),o.setUint16(1,i)}else{s=new Uint8Array(9);const o=new DataView(s.buffer);o.setUint8(0,127),o.setBigUint64(1,BigInt(i))}t.data&&typeof t.data!="string"&&(s[0]|=128),e.enqueue(s),e.enqueue(n)})}})}let Rt;function ot(t){return t.reduce((e,n)=>e+n.length,0)}function rt(t,e){if(t[0].length===e)return t.shift();const n=new Uint8Array(e);let i=0;for(let s=0;s<e;s++)n[s]=t[0][i++],i===t[0].length&&(t.shift(),i=0);return t.length&&i<t[0].length&&(t[0]=t[0].slice(i)),n}function lo(t,e){Rt||(Rt=new TextDecoder);const n=[];let i=0,s=-1,o=!1;return new TransformStream({transform(r,c){for(n.push(r);;){if(i===0){if(ot(n)<1)break;const a=rt(n,1);o=(a[0]&128)===128,s=a[0]&127,s<126?i=3:s===126?i=1:i=2}else if(i===1){if(ot(n)<2)break;const a=rt(n,2);s=new DataView(a.buffer,a.byteOffset,a.length).getUint16(0),i=3}else if(i===2){if(ot(n)<8)break;const a=rt(n,8),l=new DataView(a.buffer,a.byteOffset,a.length),d=l.getUint32(0);if(d>Math.pow(2,21)-1){c.enqueue(jt);break}s=d*Math.pow(2,32)+l.getUint32(4),i=3}else{if(ot(n)<s)break;const a=rt(n,s);c.enqueue(pn(o?a:Rt.decode(a),e)),i=0}if(s===0||s>t){c.enqueue(jt);break}}}})}const Si=4;function D(t){if(t)return uo(t)}function uo(t){for(var e in D.prototype)t[e]=D.prototype[e];return t}D.prototype.on=D.prototype.addEventListener=function(t,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(e),this};D.prototype.once=function(t,e){function n(){this.off(t,n),e.apply(this,arguments)}return n.fn=e,this.on(t,n),this};D.prototype.off=D.prototype.removeListener=D.prototype.removeAllListeners=D.prototype.removeEventListener=function(t,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var n=this._callbacks["$"+t];if(!n)return this;if(arguments.length==1)return delete this._callbacks["$"+t],this;for(var i,s=0;s<n.length;s++)if(i=n[s],i===e||i.fn===e){n.splice(s,1);break}return n.length===0&&delete this._callbacks["$"+t],this};D.prototype.emit=function(t){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),n=this._callbacks["$"+t],i=1;i<arguments.length;i++)e[i-1]=arguments[i];if(n){n=n.slice(0);for(var i=0,s=n.length;i<s;++i)n[i].apply(this,e)}return this};D.prototype.emitReserved=D.prototype.emit;D.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]};D.prototype.hasListeners=function(t){return!!this.listeners(t).length};const It=typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,n)=>n(e,0),J=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),ho="arraybuffer";function Ci(t,...e){return e.reduce((n,i)=>(t.hasOwnProperty(i)&&(n[i]=t[i]),n),{})}const fo=J.setTimeout,po=J.clearTimeout;function Tt(t,e){e.useNativeTimers?(t.setTimeoutFn=fo.bind(J),t.clearTimeoutFn=po.bind(J)):(t.setTimeoutFn=J.setTimeout.bind(J),t.clearTimeoutFn=J.clearTimeout.bind(J))}const mo=1.33;function go(t){return typeof t=="string"?yo(t):Math.ceil((t.byteLength||t.size)*mo)}function yo(t){let e=0,n=0;for(let i=0,s=t.length;i<s;i++)e=t.charCodeAt(i),e<128?n+=1:e<2048?n+=2:e<55296||e>=57344?n+=3:(i++,n+=4);return n}function Pi(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function vo(t){let e="";for(let n in t)t.hasOwnProperty(n)&&(e.length&&(e+="&"),e+=encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e}function bo(t){let e={},n=t.split("&");for(let i=0,s=n.length;i<s;i++){let o=n[i].split("=");e[decodeURIComponent(o[0])]=decodeURIComponent(o[1])}return e}class ko extends Error{constructor(e,n,i){super(e),this.description=n,this.context=i,this.type="TransportError"}}class mn extends D{constructor(e){super(),this.writable=!1,Tt(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,n,i){return super.emitReserved("error",new ko(e,n,i)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const n=pn(e,this.socket.binaryType);this.onPacket(n)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,n={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(n)}_hostname(){const e=this.opts.hostname;return e.indexOf(":")===-1?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&Number(this.opts.port)!==443||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(e){const n=vo(e);return n.length?"?"+n:""}}class Eo extends mn{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const n=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let i=0;this._polling&&(i++,this.once("pollComplete",function(){--i||n()})),this.writable||(i++,this.once("drain",function(){--i||n()}))}else n()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const n=i=>{if(this.readyState==="opening"&&i.type==="open"&&this.onOpen(),i.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(i)};co(e,this.socket.binaryType).forEach(n),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,ro(e,n=>{this.doWrite(n,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",n=this.query||{};return this.opts.timestampRequests!==!1&&(n[this.opts.timestampParam]=Pi()),!this.supportsBinary&&!n.sid&&(n.b64=1),this.createUri(e,n)}}let Ii=!1;try{Ii=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const wo=Ii;function Bo(){}class So extends Eo{constructor(e){if(super(e),typeof location<"u"){const n=location.protocol==="https:";let i=location.port;i||(i=n?"443":"80"),this.xd=typeof location<"u"&&e.hostname!==location.hostname||i!==e.port}}doWrite(e,n){const i=this.request({method:"POST",data:e});i.on("success",n),i.on("error",(s,o)=>{this.onError("xhr post error",s,o)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(n,i)=>{this.onError("xhr poll error",n,i)}),this.pollXhr=e}}class se extends D{constructor(e,n,i){super(),this.createRequest=e,Tt(this,i),this._opts=i,this._method=i.method||"GET",this._uri=n,this._data=i.data!==void 0?i.data:null,this._create()}_create(){var e;const n=Ci(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");n.xdomain=!!this._opts.xd;const i=this._xhr=this.createRequest(n);try{i.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){i.setDisableHeaderCheck&&i.setDisableHeaderCheck(!0);for(let s in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(s)&&i.setRequestHeader(s,this._opts.extraHeaders[s])}}catch{}if(this._method==="POST")try{i.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{i.setRequestHeader("Accept","*/*")}catch{}(e=this._opts.cookieJar)===null||e===void 0||e.addCookies(i),"withCredentials"in i&&(i.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(i.timeout=this._opts.requestTimeout),i.onreadystatechange=()=>{var s;i.readyState===3&&((s=this._opts.cookieJar)===null||s===void 0||s.parseCookies(i.getResponseHeader("set-cookie"))),i.readyState===4&&(i.status===200||i.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof i.status=="number"?i.status:0)},0))},i.send(this._data)}catch(s){this.setTimeoutFn(()=>{this._onError(s)},0);return}typeof document<"u"&&(this._index=se.requestsCount++,se.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=Bo,e)try{this._xhr.abort()}catch{}typeof document<"u"&&delete se.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}se.requestsCount=0;se.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",Kn);else if(typeof addEventListener=="function"){const t="onpagehide"in J?"pagehide":"unload";addEventListener(t,Kn,!1)}}function Kn(){for(let t in se.requests)se.requests.hasOwnProperty(t)&&se.requests[t].abort()}const Co=(function(){const t=Ti({xdomain:!1});return t&&t.responseType!==null})();class Po extends So{constructor(e){super(e);const n=e&&e.forceBase64;this.supportsBinary=Co&&!n}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new se(Ti,this.uri(),e)}}function Ti(t){const e=t.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||wo))return new XMLHttpRequest}catch{}if(!e)try{return new J[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const _i=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class Io extends mn{get name(){return"websocket"}doOpen(){const e=this.uri(),n=this.opts.protocols,i=_i?{}:Ci(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(i.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,n,i)}catch(s){return this.emitReserved("error",s)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let n=0;n<e.length;n++){const i=e[n],s=n===e.length-1;fn(i,this.supportsBinary,o=>{try{this.doWrite(i,o)}catch{}s&&It(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",n=this.query||{};return this.opts.timestampRequests&&(n[this.opts.timestampParam]=Pi()),this.supportsBinary||(n.b64=1),this.createUri(e,n)}}const Dt=J.WebSocket||J.MozWebSocket;class To extends Io{createSocket(e,n,i){return _i?new Dt(e,n,i):n?new Dt(e,n):new Dt(e)}doWrite(e,n){this.ws.send(n)}}class _o extends mn{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(e){return this.emitReserved("error",e)}this._transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(e=>{const n=lo(Number.MAX_SAFE_INTEGER,this.socket.binaryType),i=e.readable.pipeThrough(n).getReader(),s=ao();s.readable.pipeTo(e.writable),this._writer=s.writable.getWriter();const o=()=>{i.read().then(({done:c,value:a})=>{c||(this.onPacket(a),o())}).catch(c=>{})};o();const r={type:"open"};this.query.sid&&(r.data=`{"sid":"${this.query.sid}"}`),this._writer.write(r).then(()=>this.onOpen())})})}write(e){this.writable=!1;for(let n=0;n<e.length;n++){const i=e[n],s=n===e.length-1;this._writer.write(i).then(()=>{s&&It(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;(e=this._transport)===null||e===void 0||e.close()}}const xo={websocket:To,webtransport:_o,polling:Po},Lo=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,Mo=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function Yt(t){if(t.length>8e3)throw"URI too long";const e=t,n=t.indexOf("["),i=t.indexOf("]");n!=-1&&i!=-1&&(t=t.substring(0,n)+t.substring(n,i).replace(/:/g,";")+t.substring(i,t.length));let s=Lo.exec(t||""),o={},r=14;for(;r--;)o[Mo[r]]=s[r]||"";return n!=-1&&i!=-1&&(o.source=e,o.host=o.host.substring(1,o.host.length-1).replace(/;/g,":"),o.authority=o.authority.replace("[","").replace("]","").replace(/;/g,":"),o.ipv6uri=!0),o.pathNames=No(o,o.path),o.queryKey=$o(o,o.query),o}function No(t,e){const n=/\/{2,9}/g,i=e.replace(n,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&i.splice(0,1),e.slice(-1)=="/"&&i.splice(i.length-1,1),i}function $o(t,e){const n={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(i,s,o){s&&(n[s]=o)}),n}const Jt=typeof addEventListener=="function"&&typeof removeEventListener=="function",dt=[];Jt&&addEventListener("offline",()=>{dt.forEach(t=>t())},!1);class me extends D{constructor(e,n){if(super(),this.binaryType=ho,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&typeof e=="object"&&(n=e,e=null),e){const i=Yt(e);n.hostname=i.host,n.secure=i.protocol==="https"||i.protocol==="wss",n.port=i.port,i.query&&(n.query=i.query)}else n.host&&(n.hostname=Yt(n.host).host);Tt(this,n),this.secure=n.secure!=null?n.secure:typeof location<"u"&&location.protocol==="https:",n.hostname&&!n.port&&(n.port=this.secure?"443":"80"),this.hostname=n.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=n.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},n.transports.forEach(i=>{const s=i.prototype.name;this.transports.push(s),this._transportsByName[s]=i}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},n),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=bo(this.opts.query)),Jt&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},dt.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const n=Object.assign({},this.opts.query);n.EIO=Si,n.transport=e,this.id&&(n.sid=this.id);const i=Object.assign({},this.opts,{query:n,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](i)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const e=this.opts.rememberUpgrade&&me.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const n=this.createTransport(e);n.open(),this.setTransport(n)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",n=>this._onClose("transport close",n))}onOpen(){this.readyState="open",me.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const n=new Error("server error");n.code=e.data,this._onError(n);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let n=1;for(let i=0;i<this.writeBuffer.length;i++){const s=this.writeBuffer[i].data;if(s&&(n+=go(s)),i>0&&n>this._maxPayload)return this.writeBuffer.slice(0,i);n+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,It(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,n,i){return this._sendPacket("message",e,n,i),this}send(e,n,i){return this._sendPacket("message",e,n,i),this}_sendPacket(e,n,i,s){if(typeof n=="function"&&(s=n,n=void 0),typeof i=="function"&&(s=i,i=null),this.readyState==="closing"||this.readyState==="closed")return;i=i||{},i.compress=i.compress!==!1;const o={type:e,data:n,options:i};this.emitReserved("packetCreate",o),this.writeBuffer.push(o),s&&this.once("flush",s),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},n=()=>{this.off("upgrade",n),this.off("upgradeError",n),e()},i=()=>{this.once("upgrade",n),this.once("upgradeError",n)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?i():e()}):this.upgrading?i():e()),this}_onError(e){if(me.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,n){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),Jt&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const i=dt.indexOf(this._offlineEventListener);i!==-1&&dt.splice(i,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,n),this.writeBuffer=[],this._prevBufferLen=0}}}me.protocol=Si;class Ao extends me{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let n=this.createTransport(e),i=!1;me.priorWebsocketSuccess=!1;const s=()=>{i||(n.send([{type:"ping",data:"probe"}]),n.once("packet",f=>{if(!i)if(f.type==="pong"&&f.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",n),!n)return;me.priorWebsocketSuccess=n.name==="websocket",this.transport.pause(()=>{i||this.readyState!=="closed"&&(d(),this.setTransport(n),n.send([{type:"upgrade"}]),this.emitReserved("upgrade",n),n=null,this.upgrading=!1,this.flush())})}else{const h=new Error("probe error");h.transport=n.name,this.emitReserved("upgradeError",h)}}))};function o(){i||(i=!0,d(),n.close(),n=null)}const r=f=>{const h=new Error("probe error: "+f);h.transport=n.name,o(),this.emitReserved("upgradeError",h)};function c(){r("transport closed")}function a(){r("socket closed")}function l(f){n&&f.name!==n.name&&o()}const d=()=>{n.removeListener("open",s),n.removeListener("error",r),n.removeListener("close",c),this.off("close",a),this.off("upgrading",l)};n.once("open",s),n.once("error",r),n.once("close",c),this.once("close",a),this.once("upgrading",l),this._upgrades.indexOf("webtransport")!==-1&&e!=="webtransport"?this.setTimeoutFn(()=>{i||n.open()},200):n.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const n=[];for(let i=0;i<e.length;i++)~this.transports.indexOf(e[i])&&n.push(e[i]);return n}}let Oo=class extends Ao{constructor(e,n={}){const i=typeof e=="object"?e:n;(!i.transports||i.transports&&typeof i.transports[0]=="string")&&(i.transports=(i.transports||["polling","websocket","webtransport"]).map(s=>xo[s]).filter(s=>!!s)),super(e,i)}};function qo(t,e="",n){let i=t;n=n||typeof location<"u"&&location,t==null&&(t=n.protocol+"//"+n.host),typeof t=="string"&&(t.charAt(0)==="/"&&(t.charAt(1)==="/"?t=n.protocol+t:t=n.host+t),/^(https?|wss?):\/\//.test(t)||(typeof n<"u"?t=n.protocol+"//"+t:t="https://"+t),i=Yt(t)),i.port||(/^(http|ws)$/.test(i.protocol)?i.port="80":/^(http|ws)s$/.test(i.protocol)&&(i.port="443")),i.path=i.path||"/";const o=i.host.indexOf(":")!==-1?"["+i.host+"]":i.host;return i.id=i.protocol+"://"+o+":"+i.port+e,i.href=i.protocol+"://"+o+(n&&n.port===i.port?"":":"+i.port),i}const Ro=typeof ArrayBuffer=="function",Do=t=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(t):t.buffer instanceof ArrayBuffer,xi=Object.prototype.toString,Uo=typeof Blob=="function"||typeof Blob<"u"&&xi.call(Blob)==="[object BlobConstructor]",Fo=typeof File=="function"||typeof File<"u"&&xi.call(File)==="[object FileConstructor]";function gn(t){return Ro&&(t instanceof ArrayBuffer||Do(t))||Uo&&t instanceof Blob||Fo&&t instanceof File}function ut(t,e){if(!t||typeof t!="object")return!1;if(Array.isArray(t)){for(let n=0,i=t.length;n<i;n++)if(ut(t[n]))return!0;return!1}if(gn(t))return!0;if(t.toJSON&&typeof t.toJSON=="function"&&arguments.length===1)return ut(t.toJSON(),!0);for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)&&ut(t[n]))return!0;return!1}function Go(t){const e=[],n=t.data,i=t;return i.data=Qt(n,e),i.attachments=e.length,{packet:i,buffers:e}}function Qt(t,e){if(!t)return t;if(gn(t)){const n={_placeholder:!0,num:e.length};return e.push(t),n}else if(Array.isArray(t)){const n=new Array(t.length);for(let i=0;i<t.length;i++)n[i]=Qt(t[i],e);return n}else if(typeof t=="object"&&!(t instanceof Date)){const n={};for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=Qt(t[i],e));return n}return t}function Ho(t,e){return t.data=Xt(t.data,e),delete t.attachments,t}function Xt(t,e){if(!t)return t;if(t&&t._placeholder===!0){if(typeof t.num=="number"&&t.num>=0&&t.num<e.length)return e[t.num];throw new Error("illegal attachments")}else if(Array.isArray(t))for(let n=0;n<t.length;n++)t[n]=Xt(t[n],e);else if(typeof t=="object")for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(t[n]=Xt(t[n],e));return t}const Wo=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"];var P;(function(t){t[t.CONNECT=0]="CONNECT",t[t.DISCONNECT=1]="DISCONNECT",t[t.EVENT=2]="EVENT",t[t.ACK=3]="ACK",t[t.CONNECT_ERROR=4]="CONNECT_ERROR",t[t.BINARY_EVENT=5]="BINARY_EVENT",t[t.BINARY_ACK=6]="BINARY_ACK"})(P||(P={}));class Ko{constructor(e){this.replacer=e}encode(e){return(e.type===P.EVENT||e.type===P.ACK)&&ut(e)?this.encodeAsBinary({type:e.type===P.EVENT?P.BINARY_EVENT:P.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let n=""+e.type;return(e.type===P.BINARY_EVENT||e.type===P.BINARY_ACK)&&(n+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(n+=e.nsp+","),e.id!=null&&(n+=e.id),e.data!=null&&(n+=JSON.stringify(e.data,this.replacer)),n}encodeAsBinary(e){const n=Go(e),i=this.encodeAsString(n.packet),s=n.buffers;return s.unshift(i),s}}class yn extends D{constructor(e){super(),this.reviver=e}add(e){let n;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");n=this.decodeString(e);const i=n.type===P.BINARY_EVENT;i||n.type===P.BINARY_ACK?(n.type=i?P.EVENT:P.ACK,this.reconstructor=new Vo(n),n.attachments===0&&super.emitReserved("decoded",n)):super.emitReserved("decoded",n)}else if(gn(e)||e.base64)if(this.reconstructor)n=this.reconstructor.takeBinaryData(e),n&&(this.reconstructor=null,super.emitReserved("decoded",n));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let n=0;const i={type:Number(e.charAt(0))};if(P[i.type]===void 0)throw new Error("unknown packet type "+i.type);if(i.type===P.BINARY_EVENT||i.type===P.BINARY_ACK){const o=n+1;for(;e.charAt(++n)!=="-"&&n!=e.length;);const r=e.substring(o,n);if(r!=Number(r)||e.charAt(n)!=="-")throw new Error("Illegal attachments");i.attachments=Number(r)}if(e.charAt(n+1)==="/"){const o=n+1;for(;++n&&!(e.charAt(n)===","||n===e.length););i.nsp=e.substring(o,n)}else i.nsp="/";const s=e.charAt(n+1);if(s!==""&&Number(s)==s){const o=n+1;for(;++n;){const r=e.charAt(n);if(r==null||Number(r)!=r){--n;break}if(n===e.length)break}i.id=Number(e.substring(o,n+1))}if(e.charAt(++n)){const o=this.tryParse(e.substr(n));if(yn.isPayloadValid(i.type,o))i.data=o;else throw new Error("invalid payload")}return i}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,n){switch(e){case P.CONNECT:return Vn(n);case P.DISCONNECT:return n===void 0;case P.CONNECT_ERROR:return typeof n=="string"||Vn(n);case P.EVENT:case P.BINARY_EVENT:return Array.isArray(n)&&(typeof n[0]=="number"||typeof n[0]=="string"&&Wo.indexOf(n[0])===-1);case P.ACK:case P.BINARY_ACK:return Array.isArray(n)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class Vo{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const n=Ho(this.reconPack,this.buffers);return this.finishedReconstruction(),n}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}function Vn(t){return Object.prototype.toString.call(t)==="[object Object]"}const zo=Object.freeze(Object.defineProperty({__proto__:null,Decoder:yn,Encoder:Ko,get PacketType(){return P}},Symbol.toStringTag,{value:"Module"}));function te(t,e,n){return t.on(e,n),function(){t.off(e,n)}}const jo=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Li extends D{constructor(e,n,i){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=n,i&&i.auth&&(this.auth=i.auth),this._opts=Object.assign({},i),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[te(e,"open",this.onopen.bind(this)),te(e,"packet",this.onpacket.bind(this)),te(e,"error",this.onerror.bind(this)),te(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...n){var i,s,o;if(jo.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(n.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(n),this;const r={type:P.EVENT,data:n};if(r.options={},r.options.compress=this.flags.compress!==!1,typeof n[n.length-1]=="function"){const d=this.ids++,f=n.pop();this._registerAckCallback(d,f),r.id=d}const c=(s=(i=this.io.engine)===null||i===void 0?void 0:i.transport)===null||s===void 0?void 0:s.writable,a=this.connected&&!(!((o=this.io.engine)===null||o===void 0)&&o._hasPingExpired());return this.flags.volatile&&!c||(a?(this.notifyOutgoingListeners(r),this.packet(r)):this.sendBuffer.push(r)),this.flags={},this}_registerAckCallback(e,n){var i;const s=(i=this.flags.timeout)!==null&&i!==void 0?i:this._opts.ackTimeout;if(s===void 0){this.acks[e]=n;return}const o=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let c=0;c<this.sendBuffer.length;c++)this.sendBuffer[c].id===e&&this.sendBuffer.splice(c,1);n.call(this,new Error("operation has timed out"))},s),r=(...c)=>{this.io.clearTimeoutFn(o),n.apply(this,c)};r.withError=!0,this.acks[e]=r}emitWithAck(e,...n){return new Promise((i,s)=>{const o=(r,c)=>r?s(r):i(c);o.withError=!0,n.push(o),this.emit(e,...n)})}_addToQueue(e){let n;typeof e[e.length-1]=="function"&&(n=e.pop());const i={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((s,...o)=>(this._queue[0],s!==null?i.tryCount>this._opts.retries&&(this._queue.shift(),n&&n(s)):(this._queue.shift(),n&&n(null,...o)),i.pending=!1,this._drainQueue())),this._queue.push(i),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const n=this._queue[0];n.pending&&!e||(n.pending=!0,n.tryCount++,this.flags=n.flags,this.emit.apply(this,n.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:P.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,n){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,n),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(i=>String(i.id)===e)){const i=this.acks[e];delete this.acks[e],i.withError&&i.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case P.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case P.EVENT:case P.BINARY_EVENT:this.onevent(e);break;case P.ACK:case P.BINARY_ACK:this.onack(e);break;case P.DISCONNECT:this.ondisconnect();break;case P.CONNECT_ERROR:this.destroy();const i=new Error(e.data.message);i.data=e.data.data,this.emitReserved("connect_error",i);break}}onevent(e){const n=e.data||[];e.id!=null&&n.push(this.ack(e.id)),this.connected?this.emitEvent(n):this.receiveBuffer.push(Object.freeze(n))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const n=this._anyListeners.slice();for(const i of n)i.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const n=this;let i=!1;return function(...s){i||(i=!0,n.packet({type:P.ACK,id:e,data:s}))}}onack(e){const n=this.acks[e.id];typeof n=="function"&&(delete this.acks[e.id],n.withError&&e.data.unshift(null),n.apply(this,e.data))}onconnect(e,n){this.id=e,this.recovered=n&&this._pid===n,this._pid=n,this.connected=!0,this.emitBuffered(),this._drainQueue(!0),this.emitReserved("connect")}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:P.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const n=this._anyListeners;for(let i=0;i<n.length;i++)if(e===n[i])return n.splice(i,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const n=this._anyOutgoingListeners;for(let i=0;i<n.length;i++)if(e===n[i])return n.splice(i,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const n=this._anyOutgoingListeners.slice();for(const i of n)i.apply(this,e.data)}}}function De(t){t=t||{},this.ms=t.min||100,this.max=t.max||1e4,this.factor=t.factor||2,this.jitter=t.jitter>0&&t.jitter<=1?t.jitter:0,this.attempts=0}De.prototype.duration=function(){var t=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),n=Math.floor(e*this.jitter*t);t=(Math.floor(e*10)&1)==0?t-n:t+n}return Math.min(t,this.max)|0};De.prototype.reset=function(){this.attempts=0};De.prototype.setMin=function(t){this.ms=t};De.prototype.setMax=function(t){this.max=t};De.prototype.setJitter=function(t){this.jitter=t};class Zt extends D{constructor(e,n){var i;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(n=e,e=void 0),n=n||{},n.path=n.path||"/socket.io",this.opts=n,Tt(this,n),this.reconnection(n.reconnection!==!1),this.reconnectionAttempts(n.reconnectionAttempts||1/0),this.reconnectionDelay(n.reconnectionDelay||1e3),this.reconnectionDelayMax(n.reconnectionDelayMax||5e3),this.randomizationFactor((i=n.randomizationFactor)!==null&&i!==void 0?i:.5),this.backoff=new De({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(n.timeout==null?2e4:n.timeout),this._readyState="closed",this.uri=e;const s=n.parser||zo;this.encoder=new s.Encoder,this.decoder=new s.Decoder,this._autoConnect=n.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var n;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(n=this.backoff)===null||n===void 0||n.setMin(e),this)}randomizationFactor(e){var n;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(n=this.backoff)===null||n===void 0||n.setJitter(e),this)}reconnectionDelayMax(e){var n;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(n=this.backoff)===null||n===void 0||n.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new Oo(this.uri,this.opts);const n=this.engine,i=this;this._readyState="opening",this.skipReconnect=!1;const s=te(n,"open",function(){i.onopen(),e&&e()}),o=c=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",c),e?e(c):this.maybeReconnectOnOpen()},r=te(n,"error",o);if(this._timeout!==!1){const c=this._timeout,a=this.setTimeoutFn(()=>{s(),o(new Error("timeout")),n.close()},c);this.opts.autoUnref&&a.unref(),this.subs.push(()=>{this.clearTimeoutFn(a)})}return this.subs.push(s),this.subs.push(r),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(te(e,"ping",this.onping.bind(this)),te(e,"data",this.ondata.bind(this)),te(e,"error",this.onerror.bind(this)),te(e,"close",this.onclose.bind(this)),te(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(n){this.onclose("parse error",n)}}ondecoded(e){It(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,n){let i=this.nsps[e];return i?this._autoConnect&&!i.active&&i.connect():(i=new Li(this,e,n),this.nsps[e]=i),i}_destroy(e){const n=Object.keys(this.nsps);for(const i of n)if(this.nsps[i].active)return;this._close()}_packet(e){const n=this.encoder.encode(e);for(let i=0;i<n.length;i++)this.engine.write(n[i],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,n){var i;this.cleanup(),(i=this.engine)===null||i===void 0||i.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,n),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const n=this.backoff.duration();this._reconnecting=!0;const i=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(s=>{s?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",s)):e.onreconnect()}))},n);this.opts.autoUnref&&i.unref(),this.subs.push(()=>{this.clearTimeoutFn(i)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const He={};function ht(t,e){typeof t=="object"&&(e=t,t=void 0),e=e||{};const n=qo(t,e.path||"/socket.io"),i=n.source,s=n.id,o=n.path,r=He[s]&&o in He[s].nsps,c=e.forceNew||e["force new connection"]||e.multiplex===!1||r;let a;return c?a=new Zt(i,e):(He[s]||(He[s]=new Zt(i,e)),a=He[s]),n.query&&!e.query&&(e.query=n.queryKey),a.socket(n.path,e)}Object.assign(ht,{Manager:Zt,Socket:Li,io:ht,connect:ht});const Mi="https://klikschaak-api.onrender.com",vn="klikschaak_token",bn="klikschaak_user";let Ce=null;function Ue(){return localStorage.getItem(vn)}function Qe(){if(Ce)return Ce;const t=localStorage.getItem(bn);if(t)try{return Ce=JSON.parse(t),Ce}catch{return null}return null}function Yo(){return Ue()!==null&&Qe()!==null}function Ni(t,e){localStorage.setItem(vn,e),localStorage.setItem(bn,JSON.stringify(t)),Ce=t}function Jo(){localStorage.removeItem(vn),localStorage.removeItem(bn),Ce=null}async function Qo(t,e,n){try{const i=await fetch(`${Mi}/api/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,email:e,password:n})}),s=await i.json();return i.ok?(Ni(s.user,s.token),{success:!0}):{success:!1,error:s.error||"Registration failed"}}catch(i){return console.error("Registration error:",i),{success:!1,error:"Network error"}}}async function Xo(t,e){try{const n=await fetch(`${Mi}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,password:e})}),i=await n.json();return n.ok?(Ni(i.user,i.token),{success:!0}):{success:!1,error:i.error||"Login failed"}}catch(n){return console.error("Login error:",n),{success:!1,error:"Network error"}}}function Zo(){Jo()}let Y=null;const er="https://klikschaak-api.onrender.com";function tr(){return new Promise((t,e)=>{const n=Ue();if(!n){e(new Error("Not authenticated"));return}if(Y?.connected){t(Y);return}Y=ht(er,{auth:{token:n},reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3}),Y.on("connect",()=>{console.log("Connected to server"),t(Y)}),Y.on("connect_error",i=>{console.error("Connection error:",i.message),e(i)}),Y.on("disconnect",i=>{console.log("Disconnected:",i)}),Y.on("reconnect",i=>{console.log("Reconnected after",i,"attempts")})})}function W(){return Y}function nr(){Y&&(Y.disconnect(),Y=null)}let E=null,je=!1,fe=null,$i=null,en=null,tn=null,Ai=null,Oi=null,qi=null,nn=null;function ir(){const t=W();t&&(t.on("game:created",e=>{E={gameId:e.gameId,gameCode:e.gameCode,myColor:e.color,board:jn(),currentTurn:"white",timer:{white:zn(e.timeControl),black:zn(e.timeControl)},opponent:null,moveHistory:[],enPassantTarget:null,castlingRights:{white:{kingSide:!0,queenSide:!0},black:{kingSide:!0,queenSide:!0}},movedPawns:[],gameStarted:!1,gameOver:!1,result:null},je=!0,$i?.(e.gameCode)}),t.on("game:joined",e=>{E={gameId:e.gameId,gameCode:e.gameCode,myColor:e.color,board:jn(),currentTurn:"white",timer:{white:42e4,black:42e4},opponent:e.opponent,moveHistory:[],enPassantTarget:null,castlingRights:{white:{kingSide:!0,queenSide:!0},black:{kingSide:!0,queenSide:!0}},movedPawns:[],gameStarted:!1,gameOver:!1,result:null},je=!0,en?.(E)}),t.on("game:started",e=>{E&&(E.board=e.board,E.currentTurn=e.currentTurn,E.timer=e.timer,E.gameStarted=!0,E.opponent=E.myColor==="white"?e.black:e.white,tn?.(E))}),t.on("game:move-made",e=>{E&&(E.board=e.board,E.currentTurn=e.currentTurn,E.timer=e.timer,E.enPassantTarget=e.enPassantTarget,E.castlingRights=e.castlingRights,E.movedPawns=e.movedPawns,E.moveHistory.push({turn:e.currentTurn==="white"?"black":"white",notation:e.notation}),Ai?.(E))}),t.on("game:move-rejected",e=>{nn?.(e.error)}),t.on("game:timer-sync",e=>{E&&(E.timer=e,Oi?.(e.white,e.black))}),t.on("game:over",e=>{E&&(E.gameOver=!0,E.result=e,e.whitePlayerId&&e.blackPlayerId&&(fe={opponentId:(e.whitePlayerId===E.myColor||E.myColor==="white"?e.whitePlayerId:e.blackPlayerId)===e.whitePlayerId?e.blackPlayerId:e.whitePlayerId,opponentName:E.opponent?.username||"Unknown",whitePlayerId:e.whitePlayerId,timeControl:e.timeControl||"standard",customSettings:e.customSettings}),qi?.(e))}),t.on("game:error",e=>{nn?.(e.message)}),t.on("game:state",e=>{e&&(E={gameId:e.id,gameCode:e.gameCode,myColor:e.yourColor,board:e.board,currentTurn:e.currentTurn,timer:e.timer,opponent:e.yourColor==="white"?e.blackPlayer:e.whitePlayer,moveHistory:e.moveHistory,enPassantTarget:e.enPassantTarget,castlingRights:e.castlingRights,movedPawns:e.movedPawns,gameStarted:e.gameStarted,gameOver:e.gameOver,result:e.result},je=!0,en?.(E),e.gameStarted&&tn?.(E))}))}function zn(t){switch(t){case"bullet":return 60*1e3;case"blitz-3":return 180*1e3;case"blitz-5":return 300*1e3;case"rapid-7":return 420*1e3;case"standard":return 420*1e3;default:return 420*1e3}}function jn(){return Array(8).fill(null).map(()=>Array(8).fill(null).map(()=>({pieces:[]})))}function sr(t){t.onGameCreated&&($i=t.onGameCreated),t.onGameJoined&&(en=t.onGameJoined),t.onGameStarted&&(tn=t.onGameStarted),t.onMoveMade&&(Ai=t.onMoveMade),t.onTimerUpdate&&(Oi=t.onTimerUpdate),t.onGameOver&&(qi=t.onGameOver),t.onError&&(nn=t.onError)}function or(t="standard",e){W()?.emit("game:create",{timeControl:t,customSettings:e})}function rr(t){W()?.emit("game:join",{gameCode:t.toUpperCase()})}function kn(t,e,n,i,s){if(!E)return;W()?.emit("game:move",{gameId:E.gameId,from:t,to:e,moveType:n,unklikIndex:i,promoteTo:s})}function cr(){if(!E)return;W()?.emit("game:resign",{gameId:E.gameId})}function ar(){if(!E)return;W()?.emit("game:draw-offer",{gameId:E.gameId})}function Yn(t){if(!E)return;W()?.emit("game:draw-response",{gameId:E.gameId,accept:t})}function sn(){return E}function we(){return je}function _t(){return E!==null&&E.currentTurn===E.myColor}function En(){return E?.myColor||null}function Ri(){E=null,je=!1}function lr(){return fe}function dr(){if(!fe)return;W()?.emit("game:rematch-request",{opponentId:fe.opponentId,timeControl:fe.timeControl,customSettings:fe.customSettings,previousWhiteId:fe.whitePlayerId})}function Di(){fe=null}let on=!1;function et(t){on=t}window.handleSquareClick=Xe;window.handleUnklikSelect=zi;window.initializeBoard=Ae;window.toggleAutoPromote=ji;window.executePromotion=Sn;window.executeCastling=Me;window.movePiece=Ne;window.switchLanguage=ur;function ur(){const t=ue()==="nl"?"en":"nl";as(t),x(),M(),hr()}function hr(){const t=document.querySelector(".header h1");t&&(t.textContent=`üëë ${y("title")}`);const e=document.querySelector(".header p");e&&(e.textContent=y("subtitle"));const n=document.querySelector(".new-game-btn");n&&(n.textContent=`üîÑ ${y("newGame")}`);const i=document.querySelector(".panel h2");if(i){const l=document.getElementById("moveCount")?.textContent||"0";i.innerHTML=`üìã ${y("moves")} (<span id="moveCount">${l}</span>)`}const s=document.querySelector(".rules h2");s&&(s.textContent=`‚ö° ${y("gameRules")}`);const o=document.querySelectorAll(".rules p");o.length>=4&&(o[0].innerHTML=`<strong style="color: #c084fc;">${y("klik")}</strong> ${ue()==="nl"?"Selecteer stuk, klik op veld met blauwe ring":"Select piece, click square with blue ring"}`,o[1].innerHTML=`<strong style="color: #60a5fa;">${y("unklik")}</strong> ${ue()==="nl"?"Klik op driehoek met het stuk":"Click triangle with the piece"}`,o[2].innerHTML=`‚ö†Ô∏è ${y("kingWarning")}`,o[3].innerHTML=`üí° ${y("promotionTip")}`);const r=document.querySelector('label[for="autoPromote"]');r&&(r.textContent=y("autoPromote"));const c=document.querySelector("#selectedInfo h2");c&&(c.textContent=y("selected"));const a=document.getElementById("langBtn");a&&(a.textContent=ue()==="nl"?"EN":"NL")}function fr(t,e,n,i){if(t.length===0)return"";const s=m=>w(m)?"piece piece-white":"piece piece-black";if(t.length===1)return`<div class="${s(t[0])}">${q[t[0]]}</div>`;const o=[...t].sort((m,g)=>$n(g)-$n(m)),r=o[0],c=o[1],a=w(t[0]),l=vt(),d=i&&l!==null&&t.indexOf(r)===l,f=i&&l!==null&&t.indexOf(c)===l,h=i&&l===null,u=$();let p;if(we()){const m=En();p=_t()&&(a&&m==="white"||!a&&m==="black")}else p=a&&u==="white"||!a&&u==="black";return`<div class="stacked-piece">
    <svg class="stacked-svg" viewBox="0 0 64 64">
      <line x1="32" y1="0" x2="0" y2="64" stroke="rgba(100,100,100,0.4)" stroke-width="2"/>
      <line x1="32" y1="0" x2="64" y2="64" stroke="rgba(100,100,100,0.4)" stroke-width="2"/>
    </svg>
    ${h?'<div class="whole-selected"></div>':""}
    <div class="stacked-center">
      <div class="stacked-top ${s(c)}">${q[c]}</div>
      <div class="stacked-bottom ${s(r)}">${q[r]}</div>
    </div>
    ${p?`
      <div class="triangle-left ${d?"selected":""}" onclick="handleUnklikSelect(${e},${n},${t.indexOf(r)},event)" title="${ue()==="nl"?"Zet met":"Move with"} ${gt(r)}">
        <span class="triangle-symbol left ${s(r)}">${q[r]}</span>
      </div>
      <div class="triangle-right ${f?"selected":""}" onclick="handleUnklikSelect(${e},${n},${t.indexOf(c)},event)" title="${ue()==="nl"?"Zet met":"Move with"} ${gt(c)}">
        <span class="triangle-symbol right ${s(c)}">${q[c]}</span>
      </div>
    `:""}
    ${!d&&!h?'<div class="triangle-bg-left"></div>':""}
    ${!f&&!h?'<div class="triangle-bg-right"></div>':""}
  </div>`}function x(){const t=document.getElementById("board");if(!t)return;const e=N(),n=yt(),i=_e(),s=t.offsetHeight;s>0&&(t.style.minHeight=s+"px"),t.innerHTML="";const o=on?[7,6,5,4,3,2,1,0]:[0,1,2,3,4,5,6,7],r=on?[7,6,5,4,3,2,1,0]:[0,1,2,3,4,5,6,7];for(const c of o){const a=document.createElement("div");a.className="board-row";for(const l of r){const d=document.createElement("div"),f=(c+l)%2===0;d.className=`square ${f?"light":"dark"}`,d.dataset.row=String(c),d.dataset.col=String(l),n&&n[0]===c&&n[1]===l&&d.classList.add("selected");const h=to(c,l);h==="from"?d.classList.add("premove-from"):h==="to"&&d.classList.add("premove-to");const u=e[c][l].pieces,p=n&&n[0]===c&&n[1]===l;d.innerHTML=fr(u,c,l,!!p);const m=i.find(g=>g.row===c&&g.col===l);if(m){const g=document.createElement("div");m.type==="klik"?g.className="valid-klik":m.type==="unklik-klik"?g.className="valid-unklik-klik":u.length>0?g.className="valid-capture":g.className="valid-move",d.appendChild(g)}d.onclick=g=>{const k=g.target;!k.classList.contains("triangle-left")&&!k.classList.contains("triangle-right")&&(Qs()?Js(c,l):Xe(c,l))},d.oncontextmenu=g=>{g.preventDefault(),Yi()},a.appendChild(d)}t.appendChild(a)}t.style.minHeight=""}function M(){const t=document.getElementById("turnIndicator");t&&(t.textContent=$()==="white"?y("whiteToMove"):y("blackToMove"),t.className=`turn-indicator ${$()==="white"?"turn-white":"turn-black"}`);const e=document.getElementById("moveCount");e&&(e.textContent=String(Math.ceil(Ye().length/2)));const n=document.getElementById("moveHistory"),i=Ye();if(n)if(i.length===0)n.innerHTML=`<p style="color:#94a3b8;text-align:center;padding:16px 0;">${y("noMoves")}</p>`;else{const s=[];for(let o=0;o<i.length;o+=2){const r=i[o],c=o+1<i.length?i[o+1]:null;s.push({moveNumber:Math.floor(o/2)+1,white:r,black:c})}n.innerHTML=s.slice(-10).reverse().map(o=>{const r=o.white?o.white.notation:"",c=o.black?o.black.notation:"";return`<div class="move-pair">
          <span class="move-number">${o.moveNumber}.</span>
          <span class="move-white">${r}</span>
          <span class="move-black">${c}</span>
        </div>`}).join("")}pr()}function pr(){const t=document.getElementById("selectedInfo");if(!t)return;const e=yt();if(e&&N()[e[0]][e[1]].pieces.length>0){t.classList.add("show");const n=N()[e[0]][e[1]].pieces,i=c=>w(c)?"selected-piece-icon piece piece-white":"selected-piece-icon piece piece-black",s=document.getElementById("selectedPieces");s&&(s.innerHTML=n.map(c=>`<div class="${i(c)}">${q[c]}</div>`).join(""));const o=document.getElementById("selectedNames");o&&(o.textContent=n.map(c=>gt(c)).join(" + "));const r=document.getElementById("selectedMoves");r&&(r.textContent=`${_e().length} ${y("possibleMoves")}`)}else t.classList.remove("show")}function mr(){const t=document.getElementById("checkIndicator");t&&t.remove();const e=document.createElement("div");e.id="checkIndicator",e.className="check-indicator",e.textContent=y("check");const n=document.querySelector(".board-container");n&&(n.style.position="relative",n.appendChild(e)),setTimeout(()=>{const i=document.getElementById("checkIndicator");i&&i.remove()},3e3)}function Et(t,e){const n=document.createElement("div");n.className="promotion-overlay",n.id="gameOverOverlay";const i=document.createElement("div");i.className="game-over-box";const s=document.createElement("button");s.className="game-over-close",s.textContent="√ó",s.onclick=()=>n.remove(),i.appendChild(s);const o=document.createElement("div");o.className="game-over-title",o.textContent=y(t==="checkmate"?"checkmate":"stalemate"),i.appendChild(o);const r=document.createElement("div");if(r.className="game-over-message",t==="stalemate")r.textContent=y("gameEndsDraw");else{const d=e==="white"?ue()==="nl"?"Wit":"White":ue()==="nl"?"Zwart":"Black";r.textContent=`${d} ${y("wins")}`}i.appendChild(r);const c=document.createElement("div");c.style.cssText="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;";const a=document.createElement("button");a.className="game-over-btn",a.textContent=ue()==="nl"?"Analyse":"Analysis",a.onclick=()=>{n.remove();const d=Ye();vi(d)},c.appendChild(a);const l=document.createElement("button");l.className="game-over-btn",l.textContent=y("newGame"),l.onclick=()=>Ae(),c.appendChild(l),i.appendChild(c),n.appendChild(i),n.onclick=d=>{d.target===n&&n.remove()},document.body.appendChild(n)}function Ut(){const t=ri();if(!t)return;const e=document.createElement("div");e.className="promotion-overlay",e.id="promotionOverlay";const n=t.isWhite,i=n?["Q","R","B","N"]:["q","r","b","n"],s=document.createElement("div");s.className="promotion-box";const o=document.createElement("div");o.className="promotion-title",o.textContent=y("choosePromotion"),s.appendChild(o);const r=document.createElement("div");r.className="promotion-pieces",i.forEach(c=>{const a=document.createElement("div");a.className="promotion-choice";const l=document.createElement("div");l.className=`promotion-piece piece ${n?"piece-white":"piece-black"}`,l.textContent=q[c],a.appendChild(l),a.onclick=()=>Sn(c),r.appendChild(a)}),s.appendChild(r),e.appendChild(s),document.body.appendChild(e)}function gr(t,e,n,i,s){const o=document.createElement("div");o.className="promotion-overlay",o.id="castlingChoiceOverlay";const c=s.includes("k")?7:0,l=N()[t][c].pieces,d=l.find(R=>O(R)==="r"),f=l.find(R=>O(R)!=="r"),h=w(d),u=document.createElement("div");u.className="promotion-box";const p=document.createElement("div");p.className="promotion-title",p.textContent=y("chooseCastling"),u.appendChild(p);const m=document.createElement("div");m.className="promotion-pieces",m.style.gap="20px";const g=document.createElement("div");g.className="promotion-choice",g.style.cssText="width:120px;height:100px;flex-direction:column;display:flex;justify-content:center;align-items:center;";const k=document.createElement("div");k.className=`promotion-piece piece ${h?"piece-white":"piece-black"}`,k.textContent=q[d],k.style.fontSize="48px",g.appendChild(k);const S=document.createElement("div");S.textContent=y("onlyRook"),S.style.cssText="font-size:12px;margin-top:5px;color:white;",g.appendChild(S),g.onclick=()=>{document.getElementById("castlingChoiceOverlay")?.remove(),Me(t,e,n,i,s.replace("-choice",""))},m.appendChild(g);const v=document.createElement("div");v.className="promotion-choice",v.style.cssText="width:120px;height:100px;flex-direction:column;display:flex;justify-content:center;align-items:center;";const T=document.createElement("div");T.style.cssText="display:flex;gap:5px;";const _=document.createElement("div");_.className=`piece ${h?"piece-white":"piece-black"}`,_.textContent=q[d],_.style.fontSize="36px";const U=document.createElement("div");U.className=`piece ${h?"piece-white":"piece-black"}`,U.textContent=q[f],U.style.fontSize="36px",T.appendChild(_),T.appendChild(U),v.appendChild(T);const L=document.createElement("div");L.textContent=y("bothPieces"),L.style.cssText="font-size:12px;margin-top:5px;color:white;",v.appendChild(L),v.onclick=()=>{document.getElementById("castlingChoiceOverlay")?.remove(),Me(t,e,n,i,s.replace("-choice","-both"))},m.appendChild(v),u.appendChild(m),o.appendChild(u),document.body.appendChild(o)}function yr(t,e,n,i){const s=document.createElement("div");s.className="promotion-overlay",s.id="enPassantChoiceOverlay";const r=N()[t][e].pieces,c=w(r[0]),a=r.find(L=>O(L)==="p"),l=r.find(L=>O(L)!=="p"),d=document.createElement("div");d.className="promotion-box";const f=document.createElement("div");f.className="promotion-title",f.textContent=y("chooseMove"),d.appendChild(f);const h=document.createElement("div");h.className="promotion-pieces",h.style.gap="20px";const u=document.createElement("div");u.className="promotion-choice",u.style.cssText="width:140px;height:110px;flex-direction:column;display:flex;justify-content:center;align-items:center;";const p=document.createElement("div");p.style.cssText="display:flex;gap:5px;";const m=document.createElement("div");m.className=`piece ${c?"piece-white":"piece-black"}`,m.textContent=q[a],m.style.fontSize="48px",p.appendChild(m),u.appendChild(p);const g=document.createElement("div");g.textContent=y("enPassant"),g.style.cssText="font-size:12px;margin-top:5px;color:white;",u.appendChild(g);const k=document.createElement("div");k.textContent=y("pawnCaptures"),k.style.cssText="font-size:10px;color:#64748b;",u.appendChild(k),u.onclick=()=>{document.getElementById("enPassantChoiceOverlay")?.remove(),Ne(t,e,n,i,"en-passant")},h.appendChild(u);const S=document.createElement("div");S.className="promotion-choice",S.style.cssText="width:140px;height:110px;flex-direction:column;display:flex;justify-content:center;align-items:center;";const v=document.createElement("div");v.style.cssText="display:flex;gap:5px;";const T=document.createElement("div");T.className=`piece ${c?"piece-white":"piece-black"}`,T.textContent=q[l],T.style.fontSize="48px",v.appendChild(T),S.appendChild(v);const _=document.createElement("div");_.textContent=y("normalMove"),_.style.cssText="font-size:12px;margin-top:5px;color:white;",S.appendChild(_);const U=document.createElement("div");U.textContent=`(${gt(l)} ${y("moves_")})`,U.style.cssText="font-size:10px;color:#64748b;",S.appendChild(U),S.onclick=()=>{document.getElementById("enPassantChoiceOverlay")?.remove(),Ne(t,e,n,i,"normal")},h.appendChild(S),d.appendChild(h),s.appendChild(d),document.body.appendChild(s)}const wn="http://localhost:5005";let G="loading",ce=null,vr=0;const ye=new Map;let Ui=null,Fi=null;function br(){try{ce=new Worker(new URL(""+new URL("engineWorker-CzxGyjzE.js",import.meta.url).href,import.meta.url),{type:"module"});const t=setTimeout(()=>{G==="loading"&&(console.warn("[Engine] Worker timeout, trying direct WASM"),ce?.terminate(),ce=null,ct())},5e3);ce.onmessage=e=>{const{id:n,result:i,error:s,type:o}=e.data;if(o==="ready"){clearTimeout(t),G="worker",console.log("[Engine] WASM worker ready");return}if(o==="error"){clearTimeout(t),console.warn("[Engine] Worker init failed:",s,"- trying direct WASM"),ce=null,ct();return}const r=ye.get(n);r&&(ye.delete(n),s?r.reject(new Error(s)):r.resolve(i))},ce.onerror=e=>{clearTimeout(t),console.warn("[Engine] Worker error:",e,"- trying direct WASM"),ce=null;for(const[,n]of ye)n.reject(new Error("Worker error"));ye.clear(),ct()}}catch(t){console.warn("[Engine] Worker creation failed:",t,"- trying direct WASM"),ct()}}async function ct(){if(!(G==="direct"||G==="worker"))try{const t=await Pt(()=>import("./klikschaak_engine-D9O90nrE.js"),[],import.meta.url);await t.default(),Ui=t.wasm_eval,Fi=t.wasm_get_moves,G="direct",console.log("[Engine] WASM direct (main thread) ready")}catch(t){console.error("[Engine] WASM direct load failed:",t),G="failed"}}br();function Gi(t,e,n){return G==="worker"&&ce?new Promise((i,s)=>{const o=vr++;ye.set(o,{resolve:i,reject:s}),ce.postMessage({id:o,type:t,fen:e,depth:n}),setTimeout(()=>{ye.has(o)&&(ye.delete(o),s(new Error("WASM timeout")))},6e4)}):G==="direct"?new Promise((i,s)=>{try{setTimeout(()=>{try{let o;if(t==="eval")o=Ui(e,n??4);else if(t==="moves")o=Fi(e);else{s(new Error(`Unknown type: ${t}`));return}i(JSON.parse(o))}catch(o){s(o)}},0)}catch(o){s(o)}}):Promise.reject(new Error("WASM not available"))}function Ee(){return G==="worker"||G==="direct"}function xt(t=8e3){return Ee()?Promise.resolve(!0):G==="failed"?Promise.resolve(!1):new Promise(e=>{const n=Date.now(),i=()=>{if(Ee()){e(!0);return}if(G==="failed"||Date.now()-n>t){e(!1);return}setTimeout(i,100)};i()})}function ft(t,e){const n=String.fromCharCode(97+e),i=String(8-t);return n+i}function Jn(t){return t[0]}function Lt(){const t=N(),e=$(),n=z(),i=j(),s=[];for(let a=0;a<8;a++){let l="",d=0;for(let f=0;f<8;f++){const h=t[a][f].pieces;h.length===0?d++:(d>0&&(l+=d,d=0),h.length===1?l+=Jn(h[0]):l+="("+h.map(Jn).join("")+")")}d>0&&(l+=d),s.push(l)}const o=e==="white"?"w":"b";let r="";n.white.kingSide&&(r+="K"),n.white.queenSide&&(r+="Q"),n.black.kingSide&&(r+="k"),n.black.queenSide&&(r+="q"),r||(r="-");let c="-";return i&&(c=ft(i.row,i.col)),`${s.join("/")} ${o} ${r} ${c} 0 1`}function Hi(){const t=N(),e=$(),n=z(),i=j(),s=Q(),o=e==="white",r=[],c=new Set;for(let a=0;a<8;a++)for(let l=0;l<8;l++){const d=t[a][l].pieces;if(d.length===0||w(d[0])!==o)continue;const f=ft(a,l),h=pe(t,a,l,d,n,i,s,null);for(const u of h){const p=ft(u.row,u.col);let m=f+p;u.type==="klik"?m+="k":u.type?.startsWith("castle-")&&(m+=":"+u.type);const g=o&&u.row===0||!o&&u.row===7,k=d.some(S=>F(S));if(g&&k&&u.type!=="klik"&&!u.type?.startsWith("castle-")){for(const S of["q","r","b","n"]){const v=f+p+S;c.has(v)||(c.add(v),r.push({uci:v,type:u.type||"promotion"}))}continue}c.has(m)||(c.add(m),r.push({uci:m,type:u.type||"normal"}))}if(d.length===2)for(let u=0;u<2;u++){const p=d[u],m=xe(t,a,l,p,n,i,s);for(const g of m){const[k,S]=g,v=ft(k,S),T=t[k][S];if((T.pieces.length===0||w(T.pieces[0])!==o)&&!ke(t,a,l,k,S,d,"unklik",u)){let _=f+v+`u${u}`;if((o&&k===0||!o&&k===7)&&F(p)){for(const L of["q","r","b","n"]){const R=f+v+L+`u${u}`;c.has(R)||(c.add(R),r.push({uci:R,type:"unklik-promotion"}))}continue}c.has(_)||(c.add(_),r.push({uci:_,type:"unklik"}))}if(T.pieces.length>0&&T.pieces.length<2&&w(T.pieces[0])===o&&!T.pieces.some(_=>O(_)==="k")&&O(p)!=="k"&&!ke(t,a,l,k,S,d,"unklik-klik",u)){const _=f+v+`U${u}`;c.has(_)||(c.add(_),r.push({uci:_,type:"unklik-klik"}))}}}}return{count:r.length,moves:r}}async function Wi(t){if(!Ee()&&G==="loading"&&await xt(3e3),Ee())try{const e=await Gi("moves",t);return e.error?{count:0,moves:[],error:e.error}:{count:e.count,moves:e.moves.map(n=>({uci:n.uci,type:n.type})),error:null}}catch{}try{const n=await(await fetch(`${wn}/moves`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fen:t}),signal:AbortSignal.timeout(5e3)})).json();return n.error?{count:0,moves:[],error:n.error}:{count:n.count,moves:n.moves.map(i=>({uci:i.uci,type:i.type})),error:null}}catch(e){const n=e instanceof Error?e.message:String(e);return n.includes("fetch")||n.includes("network")||n.includes("Failed")||n.includes("timeout")||n.includes("abort")?{count:0,moves:[],error:"Engine offline"}:{count:0,moves:[],error:n}}}async function Ki(){if(Ee())return!0;try{return(await(await fetch(`${wn}/health`,{signal:AbortSignal.timeout(2e3)})).json()).status==="ok"}catch{return!1}}async function Bn(t,e=4){const n={score:0,scoreType:"cp",bestMove:null,pv:[],depth:0,nodes:0,nps:0,time_ms:0,error:null};if(!Ee()&&G==="loading"&&await xt(3e3),Ee())try{const i=await Gi("eval",t,e);return i.error?{...n,error:i.error}:{score:i.score,scoreType:i.scoreType,bestMove:i.bestMove,pv:i.pv,depth:i.depth,nodes:i.nodes,nps:i.nps,time_ms:i.time_ms,error:null}}catch{}try{const s=await(await fetch(`${wn}/eval`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fen:t,depth:e}),signal:AbortSignal.timeout(3e4)})).json();return s.error?{...n,error:s.error}:{score:s.score,scoreType:s.scoreType,bestMove:s.bestMove,pv:s.pv,depth:s.depth,nodes:s.nodes,nps:s.nps,time_ms:s.time_ms,error:null}}catch(i){const s=i instanceof Error?i.message:String(i);return s.includes("fetch")||s.includes("network")||s.includes("Failed")||s.includes("timeout")||s.includes("abort")?{...n,error:"Engine offline"}:{...n,error:s}}}async function kr(){const t=Lt(),e=Hi(),n=await Wi(t);if(n.error)return{webappCount:e.count,engineCount:0,webappMoves:e.moves,engineMoves:[],matching:[],webappOnly:e.moves.map(a=>a.uci),engineOnly:[],hasMismatch:!1,engineOnline:!1,error:n.error};const i=new Set(e.moves.map(a=>a.uci)),s=new Set(n.moves.map(a=>a.uci)),o=[],r=[],c=[];for(const a of i)s.has(a)?o.push(a):r.push(a);for(const a of s)i.has(a)||c.push(a);return{webappCount:e.count,engineCount:n.count,webappMoves:e.moves,engineMoves:n.moves,matching:o.sort(),webappOnly:r.sort(),engineOnly:c.sort(),hasMismatch:r.length>0||c.length>0,engineOnline:!0,error:null}}const Vi=Object.freeze(Object.defineProperty({__proto__:null,buildFullFEN:Lt,checkEngineHealth:Ki,comparePositionMoves:kr,countAllWebappMoves:Hi,fetchEngineEval:Bn,fetchEngineMoves:Wi,waitForWasm:xt},Symbol.toStringTag,{value:"Module"})),Er=8,A={active:!1,engineColor:"black",thinking:!1};function wr(t){A.active=!0,A.engineColor=t==="white"?"black":"white",A.thinking=!1;const e=document.getElementById("gameOverOverlay");e&&e.remove(),Oe(),Ze(!1),x(),M(),A.engineColor==="white"&&Mt()}function Fe(){return A.active}function tt(){return A.active&&$()===A.engineColor}function Br(){return A.thinking}function Sr(){return A.engineColor}function Qn(){A.active=!1,A.thinking=!1}function Cr(){!A.active||ne()||(A.thinking=!1,Ze(!0),Et("checkmate",A.engineColor))}async function Pr(){if(!A.active||ne())return!1;const t=Lt(),e=await Bn(t,6);return e.error?!1:(A.engineColor==="white"?e.score:-e.score)<=0?(A.thinking=!1,Ze(!0),Et("stalemate",null),!0):!1}function Xn(t){const e=t.charCodeAt(0)-97;return[8-parseInt(t[1]),e]}function Ir(t){const e=t.substring(0,2),n=t.substring(2,4),i=t.substring(4),[s,o]=Xn(e),[r,c]=Xn(n);let a=null,l="",d=null;if(i)if(i.startsWith("U"))d=parseInt(i[1]),l="unklik-klik";else if(i.includes("u")){const f=i.indexOf("u");f>0&&(a=i.substring(0,f)),d=parseInt(i[f+1]),l="unklik"}else i==="k"?l="klik":"qrbn".includes(i)&&(a=i);return{fromRow:s,fromCol:o,toRow:r,toCol:c,promotion:a,suffix:l,unklikIndex:d}}async function Mt(){if(!(!A.active||ne())){A.thinking=!0,Ft();try{const t=Lt();console.log("[Engine] Requesting move for FEN:",t);const e=await Bn(t,Er);if(!A.active||ne())return;if(e.error||!e.bestMove){console.error("[Engine] Error:",e.error),A.thinking=!1,Ft();return}console.log("[Engine] Best move:",e.bestMove,"depth:",e.depth,"score:",e.score);const n=Ir(e.bestMove),i=await Pt(()=>Promise.resolve().then(()=>_r),void 0,import.meta.url);Tr(n,i)}catch(t){console.error("[Engine] Request failed:",t)}A.thinking=!1,Ft()}}function Tr(t,e){const{fromRow:n,fromCol:i,toRow:s,toCol:o,promotion:r,suffix:c,unklikIndex:a}=t,l=N(),d=l[n][i];let f;if(r&&(f=A.engineColor==="white"?r.toUpperCase():r.toLowerCase()),a!==null){be([n,i]),Pe(a);const m=d.pieces[a],g=xe(l,n,i,m,z(),j(),Q());let k=c==="unklik-klik"?"unklik-klik":"unklik";for(const S of g)if(S[0]===s&&S[1]===o&&S[2]==="en-passant"){k="en-passant-unklik";break}e.movePiece(n,i,s,o,k,f);return}const u=pe(l,n,i,d.pieces,z(),j(),Q(),null).filter(m=>m.row===s&&m.col===o);if(u.length===0){console.error("No matching move found for engine UCI:",t);return}let p;if(c==="klik"?p=u.find(m=>m.type==="klik")||u[0]:p=u.find(m=>m.type!=="klik")||u[0],p.type.startsWith("castle-")){e.executeCastling(n,i,s,o,p.type);return}e.movePiece(n,i,s,o,p.type,f)}function Ft(){const t=document.getElementById("engineThinking");t&&(t.style.display=A.thinking?"flex":"none")}function Xe(t,e){if(ne()&&!oe()||Fe()&&tt())return;if(we()&&!_t()&&!oe()){const o=N(),r=o[t][e],c=En(),a=yt();if(a){const d=_e().find(f=>f.row===t&&f.col===e);if(d){const[f,h]=a,u=vt();eo({row:f,col:h},{row:t,col:e},d.type,u!==null?u:void 0),H(),x(),M();return}}if(hn()&&le(),r.pieces.length>0&&w(r.pieces[0])===(c==="white")){be([t,e]),Pe(null);const l=pe(o,t,e,r.pieces,z(),j(),Q(),null);Ie(l)}else H();x(),M();return}const n=N(),i=n[t][e],s=yt();if(s){const[o,r]=s,a=_e().find(l=>l.row===t&&l.col===e);if(a){const l=a.type;l==="castle-k"||l==="castle-q"||l==="castle-k-klik"||l==="castle-q-klik"||l==="castle-k-unklik-klik"||l==="castle-q-unklik-klik"?Me(o,r,t,e,l):l==="castle-k-choice"||l==="castle-q-choice"?gr(o,r,t,e,l):l==="en-passant-choice"?yr(o,r,t,e):Ne(o,r,t,e,l)}else if(i.pieces.length>0&&w(i.pieces[0])===($()==="white")){be([t,e]),Pe(null);const l=pe(n,t,e,i.pieces,z(),j(),Q(),null);Ie(l)}else H()}else if(i.pieces.length>0){const o=w(i.pieces[0]);if(o&&$()==="white"||!o&&$()==="black"){be([t,e]),Pe(null);const r=pe(n,t,e,i.pieces,z(),j(),Q(),null);Ie(r)}}x(),M()}function zi(t,e,n,i){if(ne()&&!oe()||(i.stopPropagation(),Fe()&&tt())||we()&&!_t()&&!oe())return;const s=N(),o=s[t][e],r=o.pieces[n],c=w(r);if(c&&$()!=="white"||!c&&$()!=="black")return;if(be([t,e]),Pe(n),O(r)==="k"){const u=xe(s,t,e,r,z(),j(),Q()).map(p=>({row:p[0],col:p[1],type:"unklik"})).filter(p=>!ke(s,t,e,p.row,p.col,o.pieces,"unklik",n));Ie(u),x(),M();return}const a=xe(s,t,e,r,z(),j(),Q()),l=[],d=F(r);for(const h of a){const[u,p,m]=h,g=s[u][p];d&&(c&&u===7||!c&&u===0)||(m==="en-passant"?l.push({row:u,col:p,type:"en-passant-unklik"}):g.pieces.length===0||w(g.pieces[0])!==c?l.push({row:u,col:p,type:"unklik"}):g.pieces.length<2&&w(g.pieces[0])===c&&!g.pieces.some(S=>O(S)==="k")&&l.push({row:u,col:p,type:"unklik-klik"}))}const f=l.filter(h=>!ke(s,t,e,h.row,h.col,o.pieces,h.type,n));Ie(f),x(),M()}function Me(t,e,n,i,s){if(we()&&!oe()){kn({row:t,col:e},{row:n,col:i},s),H(),x(),M();return}const o=N(),r=s.startsWith("castle-k"),c=r?7:0,a=r?5:3,l=o[t][e].pieces;B(n,i,l),B(t,e,[]);const d=[...o[t][c].pieces];B(t,c,[]);let f=`O-O${r?"":"-O"}`;if(s.includes("unklik-klik")){const u=d.find(g=>O(g)==="r"),p=d.find(g=>O(g)!=="r"),m=[...o[t][a].pieces];B(t,a,[u,...m]),B(t,c,[p]),f+=" (toren klikt)"}else if(s.includes("klik")&&!s.includes("unklik")){const u=[...o[t][a].pieces];B(t,a,[...d,...u]),f+=" klikt"}else if(s.includes("both"))B(t,a,d),f+=" (beide)";else if(d.length===2){const u=d.find(m=>O(m)==="r"),p=d.find(m=>O(m)!=="r");B(t,a,[u]),B(t,c,[p]),f+=" (alleen toren)"}else B(t,a,d);Ht($()),H();const h=$();if(qe(),Ct({turn:h,notation:f}),oe()){cn({turn:h,notation:f}),x(),M(),$e(),ie();return}x(),M(),$e(),Fe()&&tt()&&!ne()&&setTimeout(()=>Mt(),100)}function Ne(t,e,n,i,s,o){if(we()&&!oe()){const v=vt(),_=N()[t][e],U=_.pieces.some(Z=>F(Z)),L=w(_.pieces[0]),R=L&&n===0||!L&&n===7;if(U&&R&&!o&&!st()){const Z={row:n,col:i,isWhite:L,moveNotation:""};Z.fromRow=t,Z.fromCol=e,Z.moveType=s,Z.unklikIndex=v,Ve(Z),Ut();return}const X=o||(st()&&U&&R?L?"Q":"q":void 0);kn({row:t,col:e},{row:n,col:i},s,v!==null?v:void 0,X),H(),x(),M();return}const r=N(),c=r[t][e],a=r[n][i];let l,d="";bt(null);const f=a.pieces.length>0,h=it(t,e),u=it(n,i),p=vt();if(s==="unklik"||s==="unklik-klik"||s==="en-passant-unklik"){const v=c.pieces[p],T=c.pieces.filter((L,R)=>R!==p);if(l=[v],B(t,e,T),d=`${q[v]}${h}-${u}`,s==="en-passant-unklik"){const L=$()==="white"?n+1:n-1;B(L,i,[]),B(n,i,[v]),d+=` x${it(L,i)} e.p.`,Ge(t,e,n,i,l),at(d);return}const _=F(v),U=w(v)&&n===0||!w(v)&&n===7;if(_&&U){s==="unklik-klik"?(B(n,i,[...a.pieces,v]),d+=" klikt"):a.pieces.length>0?(B(n,i,[v]),d+=" x"):B(n,i,[v]);const L=o||(st()?w(v)?"Q":"q":null);if(L){const X=Je(n,i).filter(Z=>!F(Z));X.unshift(L),B(n,i,X),d+="="+q[L],Ge(t,e,n,i,X),at(d)}else{const R={row:n,col:i,isWhite:w(v),moveNotation:d,wasCapture:a.pieces.length>1||s!=="unklik-klik"&&a.pieces.length>0};Ve(R),Ut()}return}s==="unklik-klik"?(B(n,i,[...a.pieces,v]),d+=" klikt"):(a.pieces.length>0&&(d=`${q[v]}${h}x${u}`),B(n,i,[v])),Ge(t,e,n,i,l)}else if(s==="en-passant"){l=[...c.pieces],B(t,e,[]);const v=$()==="white"?n+1:n-1;B(v,i,[]),B(n,i,l),d=`${At(l)}${h}x${it(v,i)} e.p.`}else{l=[...c.pieces],B(t,e,[]),d=`${At(l)}${h}-${u}`;const v=l.some(_=>F(_)),T=w(l[0])&&n===0||!w(l[0])&&n===7;if(v&&T){s==="klik"?(B(n,i,[...a.pieces,...l]),d+=" klikt"):(a.pieces.length>0&&(d+=" x"),B(n,i,l));const _=o||(st()?w(l[0])?"Q":"q":null);if(_){const L=Je(n,i).filter(R=>!F(R));L.unshift(_),B(n,i,L),d+="="+q[_],Ge(t,e,n,i,L),at(d)}else{const U={row:n,col:i,isWhite:w(l[0]),moveNotation:d,otherPieces:l.filter(L=>!F(L)),wasCapture:a.pieces.length>l.length};Ve(U),Ut()}return}s==="klik"?(B(n,i,[...a.pieces,...l]),d+=" klikt"):(a.pieces.length>0&&(d=`${At(l)}${h}x${u}`),B(n,i,l)),Ge(t,e,n,i,l)}const m=l.some(v=>F(v)),g=e===i,k=w(l[0])&&t===6||!w(l[0])&&t===1;if(m&&g&&k&&!f&&Math.abs(t-n)===2){const v=(t+n)/2;bt({row:v,col:i})}l.includes("K")?Ht("white"):l.includes("k")&&Ht("black");for(const v of l)F(v)&&ci(v);at(d)}function at(t){H();const e=$();if(qe(),Ct({turn:e,notation:t}),oe()){cn({turn:e,notation:t}),x(),M(),$e(),ie();return}x(),M(),$e(),Fe()&&tt()&&!ne()&&setTimeout(()=>Mt(),100)}function Sn(t){const e=ri();if(!e)return;const n=document.getElementById("promotionOverlay");if(n&&n.remove(),we()&&!oe()){const{fromRow:d,fromCol:f,moveType:h,unklikIndex:u}=e;kn({row:d,col:f},{row:e.row,col:e.col},h||"normal",u,t),H(),Ve(null),x(),M();return}const{row:i,col:s,moveNotation:o}=e,c=Je(i,s).filter(d=>!F(d));c.unshift(t),B(i,s,c);const a=o+"="+q[t];H();const l=$();if(qe(),Ct({turn:l,notation:a}),Ve(null),oe()){cn({turn:l,notation:a}),x(),M(),$e(),ie();return}x(),M(),$e(),Fe()&&tt()&&!ne()&&setTimeout(()=>Mt(),100)}function $e(){const t=N(),e=$(),n=ks(t,e);Es(t,e,z(),j(),Q())?n&&mr():(Ze(!0),n?Et("checkmate",e==="white"?"black":"white"):Et("stalemate",null))}function Ae(){const t=document.getElementById("gameOverOverlay");t&&t.remove(),Oe(),x(),M()}function ji(){const t=document.getElementById("autoPromote");vs(t.checked)}function Yi(){hn()&&(le(),H(),x(),M())}function Ji(){if(!hn())return!1;const t=Zs();if(!t.from||!t.to||!t.moveType)return le(),!1;const e=N(),n=e[t.from.row][t.from.col];if(n.pieces.length===0)return le(),!1;const i=En();if(!(w(n.pieces[0])===(i==="white")))return le(),!1;const r=pe(e,t.from.row,t.from.col,n.pieces,z(),j(),Q(),t.unklikPieceIndex).find(h=>h.row===t.to.row&&h.col===t.to.col);if(!r)return le(),!1;const{from:c,to:a,unklikPieceIndex:l,promotionPiece:d}=t;be([c.row,c.col]),l!==null&&Pe(l),le();const f=r.type;return f.startsWith("castle")?Me(c.row,c.col,a.row,a.col,f):Ne(c.row,c.col,a.row,a.col,f,d||void 0),!0}const _r=Object.freeze(Object.defineProperty({__proto__:null,executeCastling:Me,executePromotion:Sn,handleRightClick:Yi,handleSquareClick:Xe,handleUnklikSelect:zi,initGame:Ae,movePiece:Ne,toggleAutoPromote:ji,tryExecutePremove:Ji},Symbol.toStringTag,{value:"Module"})),C={dragging:!1,from:null,pieces:[],ghostElement:null,startX:0,startY:0,hasMoved:!1},Zn=10;function xr(){const t=document.getElementById("board");t&&(t.addEventListener("mousedown",Ar),t.addEventListener("touchstart",Rr,{passive:!1}),document.addEventListener("mousemove",Or),document.addEventListener("mouseup",qr),document.addEventListener("touchmove",Dr,{passive:!1}),document.addEventListener("touchend",ei),document.addEventListener("touchcancel",ei))}function Qi(t){const n=t.target.closest(".square");if(!n)return null;const i=parseInt(n.dataset.row||"-1"),s=parseInt(n.dataset.col||"-1");return i<0||s<0?null:{element:n,pos:{row:i,col:s}}}function Xi(t,e){const n=document.elementsFromPoint(t,e);for(const i of n)if(i.classList.contains("square")){const s=i,o=parseInt(s.dataset.row||"-1"),r=parseInt(s.dataset.col||"-1");if(o>=0&&r>=0)return{element:s,pos:{row:o,col:r}}}return null}function Lr(t){const e=document.createElement("div");return e.className="drag-ghost",e.innerHTML=t.map(n=>`<span class="piece ${w(n)?"piece-white":"piece-black"}">${q[n]}</span>`).join(""),document.body.appendChild(e),e}function Zi(t,e,n){t.style.left=`${e}px`,t.style.top=`${n}px`}function Mr(t){const e=N();document.querySelectorAll(".square").forEach(n=>{const i=n,s=parseInt(i.dataset.row||"-1"),o=parseInt(i.dataset.col||"-1"),r=t.find(c=>c.row===s&&c.col===o);r&&(i.classList.add("drag-valid-target"),e[s][o].pieces.length>0&&(r.type==="klik"||r.type==="unklik-klik"?i.classList.add("drag-klik-target"):i.classList.add("drag-capture-target")))})}function Nr(){document.querySelectorAll(".square").forEach(t=>{t.classList.remove("drag-valid-target","drag-capture-target","drag-klik-target","drag-over","dragging")})}function es(t,e){return e.find(n=>n.row===t.row&&n.col===t.col)}function ts(t,e,n){const s=N()[t.row][t.col].pieces;if(s.length===0)return!1;const o=w(s[0]),r=$();return o&&r!=="white"||!o&&r!=="black"?!1:(C.from=t,C.pieces=s,C.startX=e,C.startY=n,C.hasMoved=!1,C.dragging=!1,!0)}function $r(t,e){if(!C.from)return;C.dragging=!0,C.ghostElement=Lr(C.pieces),Zi(C.ghostElement,t,e);const n=document.querySelector(`.square[data-row="${C.from.row}"][data-col="${C.from.col}"]`);n&&n.classList.add("dragging");const i=pe(N(),C.from.row,C.from.col,C.pieces,z(),j(),Q(),null);Ie(i),Mr(i)}function ns(t,e){if(!C.from)return;if(!C.dragging){const i=Math.abs(t-C.startX),s=Math.abs(e-C.startY);(i>Zn||s>Zn)&&(C.hasMoved=!0,$r(t,e));return}C.ghostElement&&Zi(C.ghostElement,t,e),document.querySelectorAll(".square.drag-over").forEach(i=>{i.classList.remove("drag-over")});const n=Xi(t,e);if(n){const i=_e();es(n.pos,i)&&n.element.classList.add("drag-over")}}function is(t,e){const n=C.from,i=C.dragging,s=C.hasMoved;if(C.ghostElement&&(C.ghostElement.remove(),C.ghostElement=null),Nr(),C.from=null,C.pieces=[],C.dragging=!1,C.hasMoved=!1,!!n){if(!s){Xe(n.row,n.col);return}if(i){const o=Xi(t,e);if(o){const r=_e();if(es(o.pos,r)){be([n.row,n.col]),Xe(o.pos.row,o.pos.col);return}}H()}}}function Ar(t){if(t.button!==0||ne())return;const e=t.target;if(e.classList.contains("triangle-left")||e.classList.contains("triangle-right"))return;const n=Qi(t);n&&ts(n.pos,t.clientX,t.clientY)&&t.preventDefault()}function Or(t){C.from&&ns(t.clientX,t.clientY)}function qr(t){C.from&&is(t.clientX,t.clientY)}function Rr(t){if(ne()||t.touches.length!==1)return;const e=t.target;if(e.classList.contains("triangle-left")||e.classList.contains("triangle-right"))return;const n=t.touches[0],i=Qi(n);i&&ts(i.pos,n.clientX,n.clientY)}function Dr(t){if(!C.from||t.touches.length!==1)return;t.preventDefault();const e=t.touches[0];ns(e.clientX,e.clientY)}function ei(t){if(!C.from)return;const e=t.changedTouches[0];is(e.clientX,e.clientY)}let ee=[],Ke=null;function Ur(){const t=W();t&&(t.on("lobby:users",e=>{ee=e,Ke?.(ee)}),t.on("lobby:user-joined",e=>{ee.find(i=>i.id===e.id)||(ee.push({...e,status:"online"}),Ke?.(ee))}),t.on("lobby:user-left",e=>{ee=ee.filter(n=>n.id!==e.id),Ke?.(ee)}),t.on("lobby:user-status",e=>{const n=ee.find(i=>i.id===e.id);n&&(n.status=e.status,Ke?.(ee))}))}function Cn(t){Ke=t,t(ee)}let K=null,pt=null,mt=null,ve=null;function Fr(){K=document.getElementById("lobbyContainer"),K||(K=document.createElement("div"),K.id="lobbyContainer",document.body.appendChild(K)),wt(),In(),Cn(Pn)}function ss(){K&&(K.innerHTML="")}function wt(){if(!K)return;if(Fe()){Bt();return}if(K.innerHTML=`
    <div class="lobby-panel">
      <div class="lobby-header">
        <h3>Klikschaak</h3>
        <button id="lobbyToggleBtn" class="lobby-toggle" title="Minimize">‚àí</button>
      </div>
      <div id="lobbyBody" class="lobby-body">
        <div class="lobby-section">
          <h4 class="section-title">Play vs Engine</h4>
          <div class="engine-play">
            <select id="engineColorSelect">
              <option value="white">White</option>
              <option value="black">Black</option>
              <option value="random">Random</option>
            </select>
            <button id="enginePlayBtn" class="lobby-btn engine">Play</button>
          </div>
          <div id="engineStatus" class="engine-status"></div>
        </div>
        <div class="lobby-section">
          <h4 class="section-title">Online Play</h4>
          <div class="lobby-actions">
            <div class="create-game">
              <select id="timeControlSelect">
                <option value="bullet">1+0</option>
                <option value="blitz-3">3+0</option>
                <option value="blitz-5">5+0</option>
                <option value="rapid-7">7+0</option>
                <option value="standard" selected>7+5</option>
                <option value="custom">Custom</option>
              </select>
              <button id="createGameBtn" class="lobby-btn">Create</button>
            </div>
            <div class="custom-time hidden" id="customTimeInputs">
              <div class="custom-time-row">
                <input type="number" id="customMinutes" placeholder="Min" min="1" max="60" value="10">
                <span>+</span>
                <input type="number" id="customIncrement" placeholder="Sec" min="0" max="60" value="0">
              </div>
            </div>
            <div class="join-game">
              <input type="text" id="gameCodeInput" placeholder="Game Code" maxlength="6">
              <button id="joinGameBtn" class="lobby-btn">Join</button>
            </div>
          </div>
          <div id="gameCodeDisplay" class="game-code-display hidden"></div>
          <div id="waitingMessage" class="waiting-message hidden"></div>
          <div id="challengeNotification" class="challenge-notification hidden"></div>
          <div class="online-users">
            <h4>Online (<span id="onlineCount">0</span>)</h4>
            <ul id="onlineUsersList"></ul>
          </div>
        </div>
        <div class="lobby-section">
          <button id="lobbyAnalysisBtn" class="lobby-btn analysis">Analyse</button>
        </div>
      </div>
    </div>
  `,window.innerWidth<=768){const i=document.getElementById("lobbyBody"),s=document.getElementById("lobbyToggleBtn");i&&s&&(i.classList.add("collapsed"),s.textContent="+",s.title="Expand")}document.getElementById("lobbyToggleBtn")?.addEventListener("click",()=>{const i=document.getElementById("lobbyBody"),s=document.getElementById("lobbyToggleBtn");if(i&&s){const o=i.classList.toggle("collapsed");s.textContent=o?"+":"‚àí",s.title=o?"Expand":"Minimize"}}),document.getElementById("createGameBtn")?.addEventListener("click",Hr),document.getElementById("joinGameBtn")?.addEventListener("click",ti),document.getElementById("gameCodeInput")?.addEventListener("keyup",i=>{i.key==="Enter"&&ti()}),document.getElementById("lobbyAnalysisBtn")?.addEventListener("click",()=>{ss(),ln()}),document.getElementById("enginePlayBtn")?.addEventListener("click",Gr);const e=document.getElementById("engineStatus");e&&(e.textContent="Loading engine...",e.className="engine-status"),xt(1e4).then(async i=>{const s=i||await Ki(),o=document.getElementById("engineStatus");o&&(s?(o.textContent=i?"Engine ready (WASM)":"Engine online",o.className="engine-status online"):(o.textContent="Engine offline",o.className="engine-status offline"))});const n=document.getElementById("timeControlSelect");n?.addEventListener("change",()=>{const i=document.getElementById("customTimeInputs");i&&i.classList.toggle("hidden",n.value!=="custom")}),pt=document.getElementById("gameCodeDisplay"),Yr()}function Gr(){let e=document.getElementById("engineColorSelect")?.value||"white";e==="random"&&(e=Math.random()<.5?"white":"black"),et(e==="black"),wr(e),Bt()}function Bt(){if(!K)return;const e=Sr()==="white"?"Black":"White";K.innerHTML=`
    <div class="lobby-panel engine-game-panel">
      <div class="lobby-header">
        <h3>vs Engine</h3>
      </div>
      <div class="engine-game-body">
        <div class="engine-game-info">
          <span>You play ${e} (depth 8)</span>
        </div>
        <div id="engineThinking" class="engine-thinking" style="display: ${Br()?"flex":"none"}">
          <span class="thinking-dots"></span>
          <span>Engine thinking...</span>
        </div>
        <div class="engine-game-actions">
          <button id="engineResignBtn" class="lobby-btn danger" title="Resign">&#9873; Resign</button>
          <button id="engineDrawBtn" class="lobby-btn" title="Offer Draw">&frac12; Draw</button>
          <button id="engineNewGameBtn" class="lobby-btn engine">New Game</button>
          <button id="engineStopBtn" class="lobby-btn">Back to Lobby</button>
        </div>
      </div>
    </div>
  `,document.getElementById("engineResignBtn")?.addEventListener("click",()=>{Cr(),Bt()}),document.getElementById("engineDrawBtn")?.addEventListener("click",async()=>{const n=document.getElementById("engineDrawBtn");n.disabled=!0,n.textContent="...",await Pr()?Bt():(n.textContent="Declined!",setTimeout(()=>{n.textContent="¬Ω Draw",n.disabled=!1},2e3))}),document.getElementById("engineNewGameBtn")?.addEventListener("click",()=>{Qn(),wt()}),document.getElementById("engineStopBtn")?.addEventListener("click",()=>{Qn(),et(!1),Oe(),Ze(!1);const n=document.getElementById("gameOverOverlay");n&&n.remove(),x(),M(),wt(),In(),Cn(Pn)})}function Pn(t){const e=document.getElementById("onlineUsersList"),n=document.getElementById("onlineCount"),i=Qe();if(n&&(n.textContent=String(t.length)),e){const s=t.filter(o=>o.id!==i?.id);e.innerHTML=s.map(o=>`
        <li class="online-user ${o.status} ${o.status==="online"?"challengeable":""}"
            data-user-id="${o.id}"
            data-username="${o.username}"
            title="${o.status==="online"?"Click to challenge":o.status==="in-game"?"In a game":"Away"}">
          <span class="status-dot"></span>
          <span class="username">${o.username}</span>
          <span class="friend-code">#${o.friendCode}</span>
          ${o.status==="online"?'<span class="challenge-icon">‚öîÔ∏è</span>':""}
        </li>
      `).join("")||'<li class="no-users">No other players online</li>',e.querySelectorAll(".online-user.challengeable").forEach(o=>{o.addEventListener("click",()=>{const r=o.getAttribute("data-user-id"),c=o.getAttribute("data-username");r&&c&&zr(r,c)})})}}function Hr(){const e=document.getElementById("timeControlSelect")?.value||"standard";let n;if(e==="custom"){const s=parseInt(document.getElementById("customMinutes")?.value||"10"),o=parseInt(document.getElementById("customIncrement")?.value||"0");n={initialTime:s*60*1e3,increment:o*1e3}}or(e,n);const i=document.getElementById("waitingMessage");i&&(i.classList.remove("hidden"),i.textContent="Creating game...")}function ti(){const t=document.getElementById("gameCodeInput"),e=t?.value?.trim();e&&e.length>=4&&(rr(e),t.value="")}function In(){sr({onGameCreated:t=>{pt&&(pt.classList.remove("hidden"),pt.innerHTML=`
          <div class="game-code">
            <span>Share code:</span>
            <strong>${t}</strong>
            <button id="copyCodeBtn" class="copy-btn" title="Copy">üìã</button>
          </div>
          <p>Waiting for opponent...</p>
        `,document.getElementById("copyCodeBtn")?.addEventListener("click",()=>{navigator.clipboard.writeText(t)}))},onGameJoined:t=>{console.log("Joined game:",t.gameCode)},onGameStarted:t=>{const e=t.myColor==="black";if(et(e),K){const n=e?"white":"black",i=e?"black":"white",s=e?"White":"Black",o=e?"Black":"White",r=e?t.timer.white:t.timer.black,c=e?t.timer.black:t.timer.white;K.innerHTML=`
          <div class="game-info-panel">
            <div class="opponent-info">
              <span>vs ${t.opponent?.username||"Unknown"}</span>
            </div>
            <div id="timerDisplay" class="timer-display">
              <div class="timer ${n} ${t.currentTurn===n?"active":""}">
                <span class="label">${s}</span>
                <span class="time">${St(r)}</span>
              </div>
              <div class="timer ${i} ${t.currentTurn===i?"active":""}">
                <span class="label">${o}</span>
                <span class="time">${St(c)}</span>
              </div>
            </div>
            <div class="game-actions">
              <button id="drawBtn" class="game-btn">Draw</button>
              <button id="resignBtn" class="game-btn danger">Resign</button>
            </div>
            <div id="drawNotification" class="draw-notification hidden"></div>
          </div>
        `,mt=document.getElementById("timerDisplay"),document.getElementById("resignBtn")?.addEventListener("click",()=>{confirm("Are you sure you want to resign?")&&cr()}),document.getElementById("drawBtn")?.addEventListener("click",()=>{ar();const a=document.getElementById("drawBtn");a&&(a.textContent="Offered",a.disabled=!0)}),Vr()}ni(t),x(),M(),si()},onMoveMade:t=>{ni(t),x(),M(),ii(t.timer.white,t.timer.black,t.currentTurn),si(),t.currentTurn===t.myColor&&setTimeout(()=>{Ji()},50)},onTimerUpdate:(t,e)=>{const n=sn();n&&ii(t,e,n.currentTurn)},onGameOver:t=>{if(!t)return;le();const e=sn();let n="";t.type==="checkmate"?n=t.winner===e?.myColor?"You won by checkmate!":"You lost by checkmate.":t.type==="stalemate"?n="Draw by stalemate.":t.type==="timeout"?n=t.winner===e?.myColor?"You won on time!":"You lost on time.":t.type==="resignation"?n=t.winner===e?.myColor?"Opponent resigned. You won!":"You resigned.":t.type==="disconnect"?n=t.winner===e?.myColor?"Opponent disconnected. You won!":"Game ended due to disconnection.":t.type==="draw"&&(n="Game drawn by agreement."),Wr(n)},onError:t=>{alert(`Error: ${t}`)}})}function ni(t){Oe();for(let e=0;e<8;e++)for(let n=0;n<8;n++)B(e,n,[...t.board[e][n].pieces]);for(;$()!==t.currentTurn;)qe();bt(t.enPassantTarget);for(const e of t.movedPawns)ci(e);for(const e of t.moveHistory)Ye().find(n=>n.notation===e.notation)||Ct(e);H()}function ii(t,e,n){if(!mt)return;const i=mt.querySelector(".timer.white"),s=mt.querySelector(".timer.black");if(i){i.classList.toggle("active",n==="white");const o=i.querySelector(".time");o&&(o.textContent=St(t))}if(s){s.classList.toggle("active",n==="black");const o=s.querySelector(".time");o&&(o.textContent=St(e))}}function St(t){const e=Math.max(0,Math.floor(t/1e3)),n=Math.floor(e/60),i=e%60;return`${n}:${i.toString().padStart(2,"0")}`}function si(){const t=document.getElementById("currentTurnIndicator");if(t&&we()){const e=_t();t.classList.toggle("my-turn",e)}}function Wr(t){const e=document.createElement("div");e.className="game-over-modal",e.id="gameOverModal";const i=lr()!==null,s=sn();e.innerHTML=`
    <div class="modal-content">
      <button class="modal-close" id="modalCloseBtn">√ó</button>
      <h2>Game Over</h2>
      <p>${t}</p>
      <div class="modal-buttons">
        ${i?'<button id="rematchBtn" class="modal-btn primary">Rematch</button>':""}
        <button id="analyzeGameBtn" class="modal-btn">Analysis</button>
        <button id="closeGameOverBtn" class="modal-btn">Back to Lobby</button>
      </div>
      <div id="rematchStatus" class="rematch-status hidden"></div>
    </div>
  `,document.body.appendChild(e),document.getElementById("modalCloseBtn")?.addEventListener("click",()=>{Gt(e)}),e.addEventListener("click",o=>{o.target===e&&Gt(e)}),document.getElementById("analyzeGameBtn")?.addEventListener("click",()=>{e.remove();const o=s?.moveHistory||Ye(),r=s?.myColor==="white"?Qe()?.username:s?.opponent?.username,c=s?.myColor==="black"?Qe()?.username:s?.opponent?.username;Ri(),Di(),et(!1),vi(o,r,c)}),Kr(e),document.getElementById("rematchBtn")?.addEventListener("click",()=>{dr();const o=document.getElementById("rematchStatus");o&&(o.classList.remove("hidden"),o.textContent="Waiting for opponent...");const r=document.getElementById("rematchBtn");r&&(r.textContent="Waiting...",r.disabled=!0)}),document.getElementById("closeGameOverBtn")?.addEventListener("click",()=>{Gt(e)})}function Gt(t){t.remove(),Ri(),Di(),le(),et(!1),wt(),In(),Cn(Pn)}function Kr(t){const e=W();e&&(e.off("game:rematch-received"),e.off("game:rematch-sent"),e.off("game:rematch-declined"),e.off("game:rematch-expired"),e.off("game:rematch-error"),e.on("game:rematch-received",n=>{const i=document.getElementById("rematchStatus");i&&(i.classList.remove("hidden"),i.innerHTML=`
        <p><strong>${n.requesterName}</strong> wants a rematch!</p>
        <div class="rematch-buttons">
          <button id="acceptRematchBtn" class="lobby-btn primary">Accept</button>
          <button id="declineRematchBtn" class="lobby-btn">Decline</button>
        </div>
      `,document.getElementById("acceptRematchBtn")?.addEventListener("click",()=>{e.emit("game:rematch-accept",{rematchId:n.rematchId}),i.textContent="Starting game..."}),document.getElementById("declineRematchBtn")?.addEventListener("click",()=>{e.emit("game:rematch-decline",{rematchId:n.rematchId}),i.classList.add("hidden")}))}),e.on("game:rematch-declined",()=>{const n=document.getElementById("rematchStatus");n&&(n.textContent="Rematch declined.");const i=document.getElementById("rematchBtn");i&&(i.textContent="Rematch",i.disabled=!1)}),e.on("game:rematch-expired",()=>{const n=document.getElementById("rematchStatus");n&&(n.textContent="Rematch request expired.");const i=document.getElementById("rematchBtn");i&&(i.textContent="Rematch",i.disabled=!1)}),e.on("game:rematch-error",n=>{const i=document.getElementById("rematchStatus");i&&(i.textContent=n.message);const s=document.getElementById("rematchBtn");s&&(s.textContent="Rematch",s.disabled=!1)}),e.on("game:started",()=>{t.remove()}))}function Vr(){const t=W();t&&(t.off("game:draw-offered"),t.off("game:draw-declined"),t.on("game:draw-offered",()=>{const e=document.getElementById("drawNotification");e&&(e.classList.remove("hidden"),e.innerHTML=`
        <p>Opponent offers a draw</p>
        <div class="draw-buttons">
          <button id="acceptDrawBtn" class="game-btn primary-sm">Accept</button>
          <button id="declineDrawBtn" class="game-btn">Decline</button>
        </div>
      `,document.getElementById("acceptDrawBtn")?.addEventListener("click",()=>{Yn(!0),e.classList.add("hidden")}),document.getElementById("declineDrawBtn")?.addEventListener("click",()=>{Yn(!1),e.classList.add("hidden")}))}),t.on("game:draw-declined",()=>{const e=document.getElementById("drawNotification");e&&(e.classList.remove("hidden"),e.innerHTML="<p>Draw declined</p>",setTimeout(()=>e.classList.add("hidden"),3e3));const n=document.getElementById("drawBtn");n&&(n.textContent="Draw",n.disabled=!1)}))}function zr(t,e){const n=document.getElementById("challengeNotification");if(!n)return;const s=document.getElementById("timeControlSelect")?.value||"standard";let o=os(s);if(s==="custom"){const r=document.getElementById("customMinutes")?.value||"10",c=document.getElementById("customIncrement")?.value||"0";o=`${r}+${c}`}n.classList.remove("hidden"),n.innerHTML=`
    <div class="challenge-confirm">
      <p>Challenge <strong>${e}</strong> to a ${o} game?</p>
      <div class="challenge-buttons">
        <button id="confirmChallengeBtn" class="lobby-btn primary">Challenge</button>
        <button id="cancelChallengeBtn" class="lobby-btn">Cancel</button>
      </div>
    </div>
  `,document.getElementById("confirmChallengeBtn")?.addEventListener("click",()=>{jr(t,s),n.innerHTML=`
      <div class="challenge-pending">
        <p>Waiting for ${e} to accept...</p>
        <button id="cancelPendingChallengeBtn" class="lobby-btn small">Cancel</button>
      </div>
    `,document.getElementById("cancelPendingChallengeBtn")?.addEventListener("click",()=>{ve&&(W()?.emit("lobby:challenge-cancel",{challengeId:ve}),ve=null),n.classList.add("hidden")})}),document.getElementById("cancelChallengeBtn")?.addEventListener("click",()=>{n.classList.add("hidden")})}function jr(t,e){const n=W();if(!n)return;let i;if(e==="custom"){const s=parseInt(document.getElementById("customMinutes")?.value||"10"),o=parseInt(document.getElementById("customIncrement")?.value||"0");i={initialTime:s*60*1e3,increment:o*1e3}}n.emit("lobby:challenge",{targetId:t,timeControl:e,customSettings:i})}function Yr(){const t=W();t&&(t.off("lobby:challenge-received"),t.off("lobby:challenge-sent"),t.off("lobby:challenge-declined"),t.off("lobby:challenge-cancelled"),t.off("lobby:challenge-expired"),t.off("lobby:challenge-error"),t.on("lobby:challenge-received",e=>{const n=document.getElementById("challengeNotification");if(!n)return;let i=os(e.timeControl);if(e.timeControl==="custom"&&e.customSettings){const s=Math.floor(e.customSettings.initialTime/6e4),o=Math.floor(e.customSettings.increment/1e3);i=`${s}+${o}`}n.classList.remove("hidden"),n.innerHTML=`
      <div class="challenge-received">
        <p><strong>${e.challengerName}</strong> challenges you to a ${i} game!</p>
        <div class="challenge-buttons">
          <button id="acceptChallengeBtn" class="lobby-btn primary">Accept</button>
          <button id="declineChallengeBtn" class="lobby-btn">Decline</button>
        </div>
      </div>
    `,document.getElementById("acceptChallengeBtn")?.addEventListener("click",()=>{t.emit("lobby:challenge-accept",{challengeId:e.challengeId}),n.innerHTML="<p>Starting game...</p>"}),document.getElementById("declineChallengeBtn")?.addEventListener("click",()=>{t.emit("lobby:challenge-decline",{challengeId:e.challengeId}),n.classList.add("hidden")})}),t.on("lobby:challenge-sent",e=>{ve=e.challengeId}),t.on("lobby:challenge-declined",e=>{ve=null;const n=document.getElementById("challengeNotification");n&&(n.innerHTML=`<p>${e.declinedBy} declined the challenge.</p>`,setTimeout(()=>n.classList.add("hidden"),3e3))}),t.on("lobby:challenge-cancelled",()=>{const e=document.getElementById("challengeNotification");e&&(e.innerHTML="<p>Challenge was cancelled.</p>",setTimeout(()=>e.classList.add("hidden"),3e3))}),t.on("lobby:challenge-expired",()=>{ve=null;const e=document.getElementById("challengeNotification");e&&(e.innerHTML="<p>Challenge expired.</p>",setTimeout(()=>e.classList.add("hidden"),3e3))}),t.on("lobby:challenge-error",e=>{ve=null;const n=document.getElementById("challengeNotification");n&&(n.innerHTML=`<p class="error">${e.message}</p>`,setTimeout(()=>n.classList.add("hidden"),3e3))}))}function os(t){switch(t){case"bullet":return"1+0";case"blitz-3":return"3+0";case"blitz-5":return"5+0";case"rapid-7":return"7+0";case"standard":return"7+5";case"custom":return"Custom";default:return"7+5"}}const Nt="https://klikschaak-api.onrender.com";let ge=null,Tn=!1;async function Jr(){const t=Ue();if(!t)return!1;try{const e=await fetch(`${Nt}/api/auth/me`,{headers:{Authorization:`Bearer ${t}`}});return e.ok?(await e.json()).isAdmin===!0:!1}catch{return!1}}async function _n(){if(!await Jr())return;const e=document.getElementById("authContainer");if(!e)return;const n=document.createElement("button");n.id="adminBtn",n.className="auth-btn admin-btn",n.textContent="Admin",n.onclick=Qr;const i=e.querySelector(".user-status");i&&i.appendChild(n)}function Qr(){Tn?rs():Xr()}async function Xr(){Tn=!0,ge=document.createElement("div"),ge.id="adminPanel",ge.className="admin-panel",ge.innerHTML=`
    <div class="admin-panel-header">
      <h2>Admin Dashboard</h2>
      <button id="closeAdminBtn" class="admin-close-btn">&times;</button>
    </div>
    <div class="admin-panel-content">
      <div id="adminUserList">Loading...</div>
    </div>
  `,document.body.appendChild(ge),document.getElementById("closeAdminBtn")?.addEventListener("click",rs),await xn()}function rs(){Tn=!1,ge?.remove(),ge=null}async function xn(){const t=Ue();if(!t)return;const e=document.getElementById("adminUserList");if(e)try{const n=await fetch(`${Nt}/api/admin/users`,{headers:{Authorization:`Bearer ${t}`}});if(!n.ok){e.innerHTML='<p class="error">Failed to load users</p>';return}const{users:i}=await n.json();if(i.length===0){e.innerHTML="<p>No users found</p>";return}e.innerHTML=`
      <table class="admin-table">
        <thead>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Code</th>
            <th>Stats</th>
            <th>Admin</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${i.map(s=>`
            <tr data-user-id="${s.id}">
              <td>${s.username}</td>
              <td>${s.email}</td>
              <td>${s.friend_code}</td>
              <td>${s.stats.wins}W ${s.stats.losses}L ${s.stats.draws}D</td>
              <td>${s.is_admin?"‚úì":""}</td>
              <td>
                <button class="admin-action-btn toggle-admin" data-id="${s.id}" title="Toggle admin">
                  ${s.is_admin?"üë§":"üëë"}
                </button>
                <button class="admin-action-btn delete-user" data-id="${s.id}" title="Delete user">
                  üóëÔ∏è
                </button>
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `,e.querySelectorAll(".toggle-admin").forEach(s=>{s.addEventListener("click",()=>Zr(s.getAttribute("data-id")))}),e.querySelectorAll(".delete-user").forEach(s=>{s.addEventListener("click",()=>ec(s.getAttribute("data-id")))})}catch{e.innerHTML='<p class="error">Error loading users</p>'}}async function Zr(t){const e=Ue();if(e)try{const n=await fetch(`${Nt}/api/admin/users/${t}/toggle-admin`,{method:"POST",headers:{Authorization:`Bearer ${e}`}});if(n.ok)await xn();else{const i=await n.json();alert(i.error||"Failed to toggle admin status")}}catch{alert("Error toggling admin status")}}async function ec(t){if(!confirm("Are you sure you want to delete this user?"))return;const e=Ue();if(e)try{const n=await fetch(`${Nt}/api/admin/users/${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${e}`}});if(n.ok)await xn();else{const i=await n.json();alert(i.error||"Failed to delete user")}}catch{alert("Error deleting user")}}let V=null;function tc(){V=document.getElementById("authContainer"),V||(V=document.createElement("div"),V.id="authContainer",document.body.appendChild(V)),Yo()?(Ln(),Mn(),_n()):nt()}function nt(){V&&(V.innerHTML=`
    <div class="auth-buttons">
      <button id="loginBtn" class="auth-btn">Login</button>
      <button id="registerBtn" class="auth-btn">Register</button>
    </div>
  `,document.getElementById("loginBtn")?.addEventListener("click",nc),document.getElementById("registerBtn")?.addEventListener("click",ic))}function Ln(){if(!V)return;const t=Qe();if(!t){nt();return}V.innerHTML=`
    <div class="user-status">
      <span class="user-info">
        <span class="username">${t.username}</span>
        <span class="friend-code">#${t.friendCode}</span>
      </span>
      <span class="user-stats">${t.stats.wins}W ${t.stats.losses}L ${t.stats.draws}D</span>
      <button id="logoutBtn" class="auth-btn small">Logout</button>
    </div>
  `,document.getElementById("logoutBtn")?.addEventListener("click",rc)}function nc(){V&&(V.innerHTML=`
    <div class="auth-form">
      <h3>Login</h3>
      <form id="loginForm">
        <input type="text" id="loginUsername" placeholder="Username or Email" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <div class="auth-error" id="loginError"></div>
        <div class="auth-form-buttons">
          <button type="submit" class="auth-btn primary">Login</button>
          <button type="button" id="loginCancel" class="auth-btn">Cancel</button>
        </div>
      </form>
    </div>
  `,document.getElementById("loginForm")?.addEventListener("submit",sc),document.getElementById("loginCancel")?.addEventListener("click",nt))}function ic(){V&&(V.innerHTML=`
    <div class="auth-form">
      <h3>Register</h3>
      <form id="registerForm">
        <input type="text" id="regUsername" placeholder="Username" required minlength="3" maxlength="32">
        <input type="email" id="regEmail" placeholder="Email" required>
        <input type="password" id="regPassword" placeholder="Password" required minlength="6">
        <div class="auth-error" id="registerError"></div>
        <div class="auth-form-buttons">
          <button type="submit" class="auth-btn primary">Register</button>
          <button type="button" id="registerCancel" class="auth-btn">Cancel</button>
        </div>
      </form>
    </div>
  `,document.getElementById("registerForm")?.addEventListener("submit",oc),document.getElementById("registerCancel")?.addEventListener("click",nt))}async function sc(t){t.preventDefault();const e=document.getElementById("loginUsername").value,n=document.getElementById("loginPassword").value,i=document.getElementById("loginError"),s=await Xo(e,n);s.success?(Ln(),Mn(),_n()):i&&(i.textContent=s.error||"Login failed")}async function oc(t){t.preventDefault();const e=document.getElementById("regUsername").value,n=document.getElementById("regEmail").value,i=document.getElementById("regPassword").value,s=document.getElementById("registerError"),o=await Qo(e,n,i);o.success?(Ln(),Mn(),_n()):s&&(s.textContent=o.error||"Registration failed")}function rc(){Zo(),nr(),ss(),nt()}async function Mn(){try{await tr(),Ur(),ir(),Fr()}catch(t){console.error("Failed to connect:",t)}}ls();document.addEventListener("DOMContentLoaded",()=>{Ae(),xr(),tc(),Xs()});
